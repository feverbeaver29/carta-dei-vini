<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Wine's Fever</title>
  <!-- STILI INVARIATI -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display&family=Raleway&family=Dancing+Script&family=Montserrat&family=Roboto&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>

<!-- CONTENUTO INVARIATO -->

<script>
  let supabase, RESTAURANT_ID = null;

  document.addEventListener("DOMContentLoaded", () => {
    const SUPABASE_URL = "https://ldunvbftxhbtuyabgxwh.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    initDashboard();
  });

  async function initDashboard() {
    const { data: { user }, error } = await supabase.auth.getUser();
    if (error || !user) {
      alert("Utente non autenticato");
      window.location.href = "/";
      return;
    }
    RESTAURANT_ID = user.id;
    document.getElementById('ristoranteName').innerText = "Dashboard - " + (user.email || "Ristorante");
    fetchRistoranteData();
  }

  async function fetchRistoranteData() {
    const { data, error } = await supabase
      .from("ristoranti")
      .select("nome, font, palette_color")
      .eq("id", RESTAURANT_ID)
      .single();

    if (error || !data) return;

    document.getElementById("displayName").value = data.nome || "";
    document.getElementById("fontSelector").value = data.font || "Arial";
    document.getElementById("paletteSelector").value = data.palette_color || "#b00";
    updatePreview();
    updateColorPreview();
  }

  function updatePreview() {
    const name = document.getElementById('displayName').value;
    const font = document.getElementById('fontSelector').value;
    const preview = document.getElementById('namePreview');
    preview.innerText = name || "Anteprima Nome";
    preview.style.fontFamily = font;
    document.querySelectorAll('.wine-card').forEach(card => {
      card.style.fontFamily = font;
    });
  }

  function updateColorPreview() {
    const color = document.getElementById('paletteSelector').value;
    document.querySelectorAll('.wine-card').forEach(card => {
      card.style.color = color === '#000' ? '#fff' : color;
      card.style.backgroundColor = color === '#000' ? '#000' : '#fff';
    });
    document.getElementById('winePreview').style.backgroundColor = color === '#000' ? '#111' : '#fff9f4';
  }

  function saveSettings() {
    const displayName = document.getElementById('displayName').value;
    const font = document.getElementById('fontSelector').value;
    const paletteColor = document.getElementById('paletteSelector').value;

    if (!RESTAURANT_ID) return alert("Ristorante non autenticato.");

    fetch(`https://ldunvbftxhbtuyabgxwh.supabase.co/rest/v1/ristoranti?id=eq.${RESTAURANT_ID}`, {
      method: "PATCH",
      headers: {
        'Content-Type': 'application/json',
        'apikey': "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
      },
      body: JSON.stringify({ nome: displayName, font, palette_color: paletteColor })
    }).then(() => {
      alert("Impostazioni salvate con successo!");
    });
  }

  function generateQRCode() {
    const popup = document.getElementById('qrPopup');
    const content = document.getElementById('qrPopupContent');
    popup.style.display = "flex";
    content.innerHTML = "";

    const url = `https://carta-dei-vini.vercel.app/carta.html?ristorante_id=${RESTAURANT_ID}`;
    const qr = new QRCode(content, {
      text: url,
      width: 250,
      height: 250
    });

    setTimeout(() => {
      const img = content.querySelector('img');
      const link = document.createElement('a');
      link.href = img.src;
      link.download = "qr-code.png";
      link.innerText = "Scarica QR Code";
      content.appendChild(link);
    }, 500);

    popup.onclick = () => {
      popup.style.display = "none";
    };
  }
</script>
</body>
</html>