<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registrazione - Wine in App</title>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.42.3/dist/umd/supabase.min.js"></script>
  <style>
:root{
  --bg:#fff9f4;
  --card:#ffffff;
  --border:#e6e2da;
  --text:#1f2937;
  --muted:#6b7280;
  --brand:#b00;
  --brand2:#800000;
  --radius:16px;
}

*{box-sizing:border-box}
body{
  background:var(--bg);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--text);
  margin:0;
  padding:24px 14px;            /* pi√π aria e centratura */
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}

.container{
  background:var(--card);
  padding:28px;                 /* meno ‚Äúgigante‚Äù */
  border-radius:var(--radius);
  border:1px solid var(--border);
  box-shadow:0 10px 28px rgba(0,0,0,.08);
  width:100%;
  max-width:420px;
}

h1{
  color:var(--brand);
  margin:10px 0 16px;
  font-size:28px;
  letter-spacing:-.3px;
  text-align:center;
}

label{
  display:block;
  margin-top:14px;
  margin-bottom:6px;
  text-align:left;
  font-weight:650;
  font-size:14px;
  color:var(--text);
}

input[type="email"],
.password-wrapper input,
input[type="password"],
input[type="text"],
select{
  width:100%;
  padding:11px 12px;
  border:1px solid #d1d5db;
  border-radius:12px;
  font-size:15px;
  outline:none;
  background:#fff;
}

input:focus, select:focus{
  border-color:#c7b8b0;
  box-shadow:0 0 0 3px rgba(176,0,0,.08);
}

.password-wrapper{ position:relative; }
.toggle-password{
  position:absolute;
  right:10px;
  top:50%;
  transform:translateY(-50%);
  cursor:pointer;
  border:0;
  background:transparent;
  padding:6px 8px;
  border-radius:10px;
  font-size:16px;
  line-height:1;
}
.toggle-password:hover{ background:rgba(17,24,39,.06); }

button, .google-btn{
  width:100%;
  padding:12px 14px;
  margin-top:16px;
  border:0;
  border-radius:14px;
  font-size:16px;
  font-weight:750;
  cursor:pointer;
  transition:transform .15s ease, filter .15s ease;
}

button{
  background:var(--brand);
  color:#fff;
}
button:hover{ filter:brightness(.95); transform:translateY(-1px); }
button:active{ transform:translateY(0px); }

.google-btn{
  background:#4285F4;
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  user-select:none;
}
.google-btn:hover{ filter:brightness(.95); transform:translateY(-1px); }
.google-btn img{ width:22px; height:22px; }

.remember{
  text-align:left;
  margin-top:12px;
  font-size:14px;
  display:flex;
  align-items:center;
  gap:10px;
  color:var(--text);
}
.remember input{ transform:translateY(1px); }

footer{
  margin-top:18px;
  color:#9ca3af;
  font-size:13px;
  text-align:center;
}

.topbar{
  display:flex;
  align-items:center;
  justify-content:flex-end;
  gap:10px;
  margin-bottom:6px;
}
.lang-wrap{
  display:flex;
  align-items:center;
  gap:10px;
}
.lang-wrap label{ margin:0; font-size:13px; color:var(--muted); font-weight:600; }
.lang-wrap select{ padding:8px 10px; border-radius:12px; }

#resetBox{
  margin-top:14px;
  text-align:left;
}
#resetBox label{ margin-top:0; }
#resetMsg{ margin-top:10px; font-size:14px; }
.password-strength{ font-size:13px; color:var(--muted); margin-top:6px; }
.checkbox{ display:flex; align-items:flex-start; gap:10px; margin-top:14px; font-size:14px; color:var(--text); }
.checkbox label{ margin:0; font-weight:600; }
.checkbox input{ margin-top:3px; }
.helper-links{ margin-top:14px; text-align:center; font-size:14px; color:var(--muted); }
.helper-links a{ color:var(--brand); font-weight:800; text-decoration:none; }
.helper-links a:hover{ text-decoration:underline; }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="lang-wrap">
        <label id="langLabel" for="langSelect">Lingua</label>
        <select id="langSelect">
          <option value="it">Italiano</option>
          <option value="en">English</option>
          <option value="fr">Fran√ßais</option>
          <option value="es">Espa√±ol</option>
        </select>
      </div>
    </div>

    <h1 data-i18n="title">Crea un account</h1>

    <!-- cos√¨ Enter invia -->
    <form id="regForm">
      <label for="email" data-i18n="email_lbl">Email *</label>
      <input type="email" id="email" required data-i18n-placeholder="email_ph" placeholder="Email" autocomplete="email">

      <label for="password" data-i18n="password_lbl">Password *</label>
      <div class="password-wrapper">
        <input type="password" id="password" minlength="6" required oninput="checkPasswordStrength()"
               data-i18n-placeholder="password_ph" placeholder="Password" autocomplete="new-password">
        <button class="toggle-password" type="button" aria-label="Mostra/Nascondi password" data-target="password">üëÅÔ∏è</button>
      </div>
      <div class="password-strength" id="passwordStrength" data-i18n="pw_hint"></div>

      <label for="confirmPassword" data-i18n="confirm_lbl">Conferma Password *</label>
      <div class="password-wrapper">
        <input type="password" id="confirmPassword" required data-i18n-placeholder="confirm_ph"
               placeholder="Conferma password" autocomplete="new-password">
        <button class="toggle-password" type="button" aria-label="Mostra/Nascondi password" data-target="confirmPassword">üëÅÔ∏è</button>
      </div>

      <label for="ristorante" data-i18n="restaurant_lbl">Nome Ristorante *</label>
      <input type="text" id="ristorante" required data-i18n-placeholder="restaurant_ph"
             placeholder="Nome ristorante" autocomplete="organization">

      <div class="checkbox">
        <input type="checkbox" id="acceptPrivacy" required>
        <label for="acceptPrivacy" data-i18n="privacy_html">
          Accetto la <a href="privacy.html" target="_blank">Privacy Policy</a>
        </label>
      </div>

      <button class="btn" id="registerBtn" type="submit" data-i18n="register_btn">Registrati</button>
    </form>

    <div class="google-btn" id="googleBtn" role="button" tabindex="0" onclick="registerWithGoogle()">
      <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google Icon">
      <span data-i18n="register_google">Registrati con Google</span>
    </div>

    <div class="helper-links">
      <span data-i18n="have_account">Hai gi√† un account?</span>
      <a id="loginLink" href="login.html" data-i18n="go_login_inline">Accedi</a>
    </div>

    <div class="message" id="messageBox"></div>
    <footer data-i18n="footer">¬© 2025 Wine in App - Tutti i diritti riservati</footer>
  </div>

<script>
  const SUPABASE_URL = "https://ldunvbftxhbtuyabgxwh.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkdW52YmZ0eGhidHV5YWJneHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0NTMyOTYsImV4cCI6MjA2MjAyOTI5Nn0.0hjJASFktfHZHjVQzX9bq8xGBrf7o1Fya6lqnA2tvPo";
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // i18n
  const SUPPORTED_LANGS = ["it","en","fr","es"];
  let currentLang = "it";

  const TRANSLATIONS = {
    it:{
      language:"Lingua",
      title:"Crea un account",
      email_lbl:"Email *",
      password_lbl:"Password *",
      confirm_lbl:"Conferma Password *",
      restaurant_lbl:"Nome Ristorante *",
      privacy_html:'Accetto la <a href="privacy.html" target="_blank">Privacy Policy</a>',
      register_btn:"Registrati",
      register_google:"Registrati con Google",
      footer:"¬© 2025 Wine in App - Tutti i diritti riservati",
      pw_short:"Password troppo corta",
      pw_mid:"Aggiungi almeno una maiuscola e un numero",
      pw_ok:"Password sicura",
      must_accept:"Devi accettare la Privacy Policy per continuare.",
      pw_not_match:"Le password non coincidono.",
      invalid_email:"Inserisci un‚Äôemail valida.",
      min_pw:"La password deve avere almeno 6 caratteri.",
      reg_err:"Errore registrazione: ",
      save_rest_err:"Registrazione ok, ma errore nel salvare il nome del ristorante.",
      google_err:"Errore con Google: ",
      email_ph:"Inserisci la tua email",
      password_ph:"Inserisci la password",
      confirm_ph:"Conferma la password",
      restaurant_ph:"Nome del ristorante",
      pw_hint:"",
      email_exists_title:"Email gi√† registrata",
      email_exists_body:"Questa email √® gi√† associata a un account. Fai il login oppure usa un‚Äôaltra email.",
      go_login:"Vai al login",
      have_account:"Hai gi√† un account?",
      go_login_inline:"Accedi",
      creating:"Creazione account‚Ä¶"
    },
    en:{
      language:"Language",
      title:"Create an account",
      email_lbl:"Email *",
      password_lbl:"Password *",
      confirm_lbl:"Confirm password *",
      restaurant_lbl:"Restaurant name *",
      privacy_html:'I accept the <a href="privacy.html" target="_blank">Privacy Policy</a>',
      register_btn:"Sign up",
      register_google:"Continue with Google",
      footer:"¬© 2025 Wine in App - All rights reserved",
      pw_short:"Password too short",
      pw_mid:"Add at least one uppercase letter and one number",
      pw_ok:"Strong password",
      must_accept:"You must accept the Privacy Policy to continue.",
      pw_not_match:"Passwords do not match.",
      invalid_email:"Please enter a valid email.",
      min_pw:"Password must be at least 6 characters.",
      reg_err:"Signup error: ",
      save_rest_err:"Signup ok, but error saving the restaurant name.",
      google_err:"Google error: ",
      email_ph:"Enter your email",
      password_ph:"Enter your password",
      confirm_ph:"Confirm your password",
      restaurant_ph:"Restaurant name",
      pw_hint:"",
      email_exists_title:"Email already registered",
      email_exists_body:"This email is already linked to an account. Please log in or use another email.",
      go_login:"Go to login",
      have_account:"Already have an account?",
      go_login_inline:"Log in",
      creating:"Creating account‚Ä¶"
    },
    fr:{
      language:"Langue",
      title:"Cr√©er un compte",
      email_lbl:"E-mail *",
      password_lbl:"Mot de passe *",
      confirm_lbl:"Confirmer le mot de passe *",
      restaurant_lbl:"Nom du restaurant *",
      privacy_html:'J‚Äôaccepte la <a href="privacy.html" target="_blank">Politique de confidentialit√©</a>',
      register_btn:"S‚Äôinscrire",
      register_google:"Continuer avec Google",
      footer:"¬© 2025 Wine in App - Tous droits r√©serv√©s",
      pw_short:"Mot de passe trop court",
      pw_mid:"Ajoutez au moins une majuscule et un chiffre",
      pw_ok:"Mot de passe s√©curis√©",
      must_accept:"Vous devez accepter la politique de confidentialit√© pour continuer.",
      pw_not_match:"Les mots de passe ne correspondent pas.",
      invalid_email:"Veuillez saisir une adresse e-mail valide.",
      min_pw:"Le mot de passe doit contenir au moins 6 caract√®res.",
      reg_err:"Erreur d‚Äôinscription : ",
      save_rest_err:"Inscription ok, mais erreur lors de l‚Äôenregistrement du restaurant.",
      google_err:"Erreur Google : ",
      email_ph:"Saisissez votre e-mail",
      password_ph:"Saisissez votre mot de passe",
      confirm_ph:"Confirmez le mot de passe",
      restaurant_ph:"Nom du restaurant",
      pw_hint:"",
      email_exists_title:"E-mail d√©j√† enregistr√©",
      email_exists_body:"Cet e-mail est d√©j√† associ√© √† un compte. Connectez-vous ou utilisez une autre adresse.",
      go_login:"Aller √† la connexion",
      have_account:"Vous avez d√©j√† un compte ?",
      go_login_inline:"Se connecter",
      creating:"Cr√©ation du compte‚Ä¶"
    },
    es:{
      language:"Idioma",
      title:"Crear una cuenta",
      email_lbl:"Email *",
      password_lbl:"Contrase√±a *",
      confirm_lbl:"Confirmar contrase√±a *",
      restaurant_lbl:"Nombre del restaurante *",
      privacy_html:'Acepto la <a href="privacy.html" target="_blank">Pol√≠tica de privacidad</a>',
      register_btn:"Registrarse",
      register_google:"Continuar con Google",
      footer:"¬© 2025 Wine in App - Todos los derechos reservados",
      pw_short:"Contrase√±a demasiado corta",
      pw_mid:"A√±ade al menos una may√∫scula y un n√∫mero",
      pw_ok:"Contrase√±a segura",
      must_accept:"Debes aceptar la Pol√≠tica de privacidad para continuar.",
      pw_not_match:"Las contrase√±as no coinciden.",
      invalid_email:"Introduce un email v√°lido.",
      min_pw:"La contrase√±a debe tener al menos 6 caracteres.",
      reg_err:"Error de registro: ",
      save_rest_err:"Registro ok, pero error al guardar el restaurante.",
      google_err:"Error con Google: ",
      email_ph:"Introduce tu email",
      password_ph:"Introduce tu contrase√±a",
      confirm_ph:"Confirma la contrase√±a",
      restaurant_ph:"Nombre del restaurante",
      pw_hint:"",
      email_exists_title:"Email ya registrado",
      email_exists_body:"Este email ya est√° asociado a una cuenta. Inicia sesi√≥n o usa otro email.",
      go_login:"Ir a inicio de sesi√≥n",
      have_account:"¬øYa tienes una cuenta?",
      go_login_inline:"Iniciar sesi√≥n",
      creating:"Creando cuenta‚Ä¶"
    }
  };

  function normalizeLang(raw){
    const s=(raw||"").toLowerCase();
    if (s.startsWith("it")) return "it";
    if (s.startsWith("fr")) return "fr";
    if (s.startsWith("es")) return "es";
    return "en";
  }
  function t(key){
    const dict = TRANSLATIONS[currentLang] || TRANSLATIONS.en;
    return (dict && dict[key]) || (TRANSLATIONS.en && TRANSLATIONS.en[key]) || key;
  }
  function setLang(lang, persist=true){
    currentLang = SUPPORTED_LANGS.includes(normalizeLang(lang)) ? normalizeLang(lang) : "en";
    document.documentElement.lang = currentLang;
    if (persist) localStorage.setItem("wf_lang", currentLang);
    const sel = document.getElementById("langSelect");
    if (sel) sel.value = currentLang;
    applyTranslations();
    checkPasswordStrength();
    // aggiorna link login con lang
    const loginLink = document.getElementById("loginLink");
    if (loginLink) loginLink.href = `login.html?lang=${currentLang}`;
    // aggiorna link privacy con lang (nel checkbox)
document.querySelectorAll('a[href^="privacy.html"]').forEach(a => {
  a.href = `privacy.html?lang=${currentLang}`;
});
  }
  function initLanguage(){
    const qp = new URLSearchParams(window.location.search);
    const langFromUrl = qp.get("lang");
    const saved = localStorage.getItem("wf_lang");
    const auto  = normalizeLang(navigator.language||"");
    setLang(langFromUrl || saved || auto, !saved);

    const sel = document.getElementById("langSelect");
    if (sel){
      sel.addEventListener("change", e => setLang(e.target.value, true));
    }
  }
  function applyTranslations(){
    const langLbl = document.getElementById("langLabel");
    if (langLbl) langLbl.textContent = t("language");

    document.querySelectorAll("[data-i18n]").forEach(el=>{
      const key = el.getAttribute("data-i18n");
      if (key === "pw_hint") return;
      if (key === "privacy_html") el.innerHTML = t(key);
      else el.textContent = t(key);
    });

    document.querySelectorAll("[data-i18n-placeholder]").forEach(el=>{
      el.setAttribute("placeholder", t(el.getAttribute("data-i18n-placeholder")));
    });
  }

  function showMsg(html, type="error"){
    const box = document.getElementById("messageBox");
    box.className = "message";
    box.style.color = (type==="ok") ? "#0a7a3a" : "#c00";
    box.innerHTML = html;
  }
  function escapeHtml(s){
    return (s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function checkPasswordStrength() {
    const password = document.getElementById('password').value;
    const strengthBox = document.getElementById('passwordStrength');
    if (!password) { strengthBox.textContent = ""; return; }

    if (password.length < 6) {
      strengthBox.textContent = t("pw_short");
      strengthBox.style.color = "#c00";
    } else if (!/[A-Z]/.test(password) || !/[0-9]/.test(password)) {
      strengthBox.textContent = t("pw_mid");
      strengthBox.style.color = "#b36b00";
    } else {
      strengthBox.textContent = t("pw_ok");
      strengthBox.style.color = "green";
    }
  }

  function setLoading(isLoading){
    const btn = document.getElementById("registerBtn");
    const gbtn = document.getElementById("googleBtn");
    if (!btn || !gbtn) return;

    btn.disabled = isLoading;
    btn.textContent = isLoading ? t("creating") : t("register_btn");
    gbtn.setAttribute("aria-disabled", isLoading ? "true" : "false");
    gbtn.style.pointerEvents = isLoading ? "none" : "auto";
  }

  async function register() {
    showMsg("");
    setLoading(true);

    // leggi campi (FIX: prima erano usati senza essere definiti)
    const email = (document.getElementById('email').value || "").trim();
    const password = document.getElementById('password').value || "";
    const confirmPassword = document.getElementById('confirmPassword').value || "";
    const ristorante = (document.getElementById('ristorante').value || "").trim();
    const privacyAccepted = document.getElementById('acceptPrivacy').checked;

    try {
      if (!email || !/^\S+@\S+\.\S+$/.test(email)) { showMsg(t("invalid_email")); return; }
      if (!password || password.length < 6) { showMsg(t("min_pw")); return; }
      if (!ristorante || ristorante.length < 2) { showMsg(t("restaurant_ph")); return; }
      if (!privacyAccepted) { showMsg(t("must_accept")); return; }
      if (password !== confirmPassword) { showMsg(t("pw_not_match")); return; }

      const emailRedirectTo = `${window.location.origin}/login.html?lang=${currentLang}`;
      const { data, error } = await sb.auth.signUp({ email, password, options: { emailRedirectTo } });

      // Caso: Supabase non ritorna error, ma l'utente esiste gi√† (o non crea un nuovo user)
      if (!error && (!data || !data.user || !data.user.id)) {
        showMsg(
          `<b>${t("email_exists_title")}</b><br>${t("email_exists_body")}<br><br>
          <a href="login.html?lang=${currentLang}" style="color:#b00;font-weight:700">${t("go_login")}</a>`
        );
        return;
      }

      if (error) {
        const msg = (error.message||"").toLowerCase();
        if (msg.includes("already") || msg.includes("registered") || msg.includes("exists")) {
          showMsg(
            `<b>${t("email_exists_title")}</b><br>${t("email_exists_body")}<br><br>
             <a href="login.html?lang=${currentLang}" style="color:#b00;font-weight:700">${t("go_login")}</a>`
          );
          return;
        }
        showMsg(`${t("reg_err")}${escapeHtml(error.message)}`);
        return;
      }

      const userId = data.user.id;
      localStorage.setItem(`wf_lang_${userId}`, currentLang);

      const { error: insertError } = await sb.from('ristoranti').insert([{ id: userId, nome: ristorante, email }]);
      if (insertError) {
      const msg = (insertError.message || "").toLowerCase();
      // se fallisce perch√© esiste gi√† (id/email)
      if (msg.includes("duplicate") || msg.includes("already") || msg.includes("exists") || msg.includes("unique")) {
        showMsg(
          `<b>${t("email_exists_title")}</b><br>${t("email_exists_body")}<br><br>
          <a href="login.html?lang=${currentLang}" style="color:#b00;font-weight:700">${t("go_login")}</a>`
        );
        return;
      }
      showMsg(`${t("save_rest_err")}<br><small>${escapeHtml(insertError.message)}</small>`);
      return;
    }

      showMsg("‚úÖ OK", "ok");
      window.location.href = `email-inviata.html?lang=${currentLang}`;
    } finally {
      setLoading(false);
    }
  }

  async function registerWithGoogle() {
    const gbtn = document.getElementById("googleBtn");
    if (gbtn && gbtn.getAttribute("aria-disabled") === "true") return;

    const { error } = await sb.auth.signInWithOAuth({
      provider: 'google',
      options: { redirectTo: window.location.origin + '/setup-ristorante.html' }
    });
    if (error) showMsg(`${t("google_err")}${escapeHtml(error.message)}`);
  }

  // üëÅÔ∏è toggle show/hide password + change icon
  document.addEventListener("click", (e) => {
    const btn = e.target.closest(".toggle-password");
    if (!btn) return;
    const id = btn.getAttribute("data-target");
    const field = document.getElementById(id);
    if (!field) return;
    const show = field.type === "password";
    field.type = show ? "text" : "password";
    btn.textContent = show ? "üôà" : "üëÅÔ∏è";
  });

  document.addEventListener("DOMContentLoaded", () => {
    initLanguage();
    applyTranslations();

    // submit con Enter
    const form = document.getElementById("regForm");
    if (form) form.addEventListener("submit", (e) => { e.preventDefault(); register(); });

    // Enter/Space sul bottone google
    const gbtn = document.getElementById("googleBtn");
    if (gbtn) {
      gbtn.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") { e.preventDefault(); registerWithGoogle(); }
      });
    }
  });
</script>
</body>
</html>