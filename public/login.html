<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - Wine in App</title>
  <style>
    body {
      background-color: #fff9f4;
      font-family: 'Segoe UI', Tahoma, sans-serif;
      color: #333;
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      background: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 400px;
      text-align: center;
    }
    h1 {
      color: #b00;
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-top: 15px;
      text-align: left;
    }
    .password-wrapper {
      position: relative;
    }
    .password-wrapper input {
      width: 100%;
      padding: 12px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1em;
    }
    .toggle-password {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
    }
    input[type="email"] {
      width: 100%;
      padding: 12px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1em;
    }
    button, .google-btn {
      width: 100%;
      padding: 12px;
      margin-top: 20px;
      background-color: #b00;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1.1em;
      cursor: pointer;
      transition: background 0.3s, transform 0.2s;
      display: inline-block;
    }
    button:hover, .google-btn:hover {
      background-color: #800000;
      transform: translateY(-3px);
    }
    .google-btn {
      background-color: #4285F4;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      text-align: center;
    }
    .google-btn img {
      width: 24px;
      height: 24px;
    }
    .remember {
      text-align: left;
      margin-top: 10px;
      font-size: 0.9em;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    footer {
      margin-top: 20px;
      color: #aaa;
      font-size: 0.9em;
    }
    .topbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom: 10px;
}
.lang-wrap{
  display:flex;
  align-items:center;
  gap:8px;
}
.lang-wrap label{ margin:0; font-size:0.9em; color:#555; }
.lang-wrap select{
  padding:6px 10px;
  border-radius:10px;
  border:1px solid #ccc;
  background:#fff;
}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.42.3/dist/umd/supabase.min.js"></script>
</head>
<body>
<div class="container">
<div class="topbar">
  <div></div>
  <div class="lang-wrap">
    <label id="langLabel" for="langSelect">Lingua</label>
    <select id="langSelect">
      <option value="it">Italiano</option>
      <option value="en">English</option>
      <option value="fr">Fran√ßais</option>
      <option value="es">Espa√±ol</option>
    </select>
  </div>
</div>
  <div id="successMessage"
     style="display:none; background-color:#e6ffea; border: 1px solid #00a152; color: #007b4b; padding: 12px; border-radius: 8px; margin-bottom: 20px;"
     data-i18n="pay_success">
  ‚úÖ Pagamento completato con successo. Effettua il login per accedere alla tua dashboard.
</div>
  <h1 data-i18n="title">Login</h1>
  <label data-i18n="email_lbl">Email <span style="color: red">*</span></label>
  <input type="email" id="email" placeholder="Inserisci la tua email" data-i18n-placeholder="email_ph" required>

  <label data-i18n="password_lbl">Password <span style="color: red">*</span></label>
  <div class="password-wrapper">
    <input type="password" id="password" placeholder="Inserisci la password" data-i18n-placeholder="password_ph" required>
    <span class="toggle-password" onclick="toggleVisibility('password')">üëÅÔ∏è</span>
  </div>

  <div class="remember">
    <input type="checkbox" id="remember">
    <label for="remember" data-i18n="remember">Ricordati di me</label>
  </div>

  <button onclick="login()" data-i18n="login_btn">Accedi</button>
  <div class="google-btn" onclick="loginWithGoogle()">
    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google Icon">
    <span data-i18n="login_google">Accedi con Google</span>
  </div>
  <div style="margin-top:14px; text-align:center; font-size:0.95em;">
  <a href="#" id="forgotPassLink" style="color:#b00; font-weight:700; text-decoration:none;" data-i18n="forgot_pass">Password dimenticata?</a>
  <span style="margin:0 8px; color:#bbb;">‚Ä¢</span>
  <a href="mailto:info@wineinapp.com" id="forgotEmailLink" style="color:#b00; font-weight:700; text-decoration:none;" data-i18n="forgot_email">Email dimenticata?</a>
</div>

<div id="resetBox" style="display:none; margin-top:14px; text-align:left;">
  <label data-i18n="reset_lbl">Inserisci la tua email per ricevere il link di reset</label>
  <input type="email" id="resetEmail" placeholder="Email" style="width:100%; padding:12px; margin-top:6px; border:1px solid #ccc; border-radius:8px; font-size:1em;">
  <button id="resetBtn" style="width:100%; padding:12px; margin-top:12px; background:#b00; color:#fff; border:0; border-radius:8px; font-size:1.05em; cursor:pointer;" data-i18n="reset_btn">
    Invia link di reset
  </button>
  <div id="resetMsg" style="margin-top:10px; font-size:.95em;"></div>
</div>
  <footer data-i18n="footer">¬© 2025 Wine in App - Tutti i diritti riservati</footer>

</div>

<script>
  const SUPABASE_URL = "https://ldunvbftxhbtuyabgxwh.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkdW52YmZ0eGhidHV5YWJneHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0NTMyOTYsImV4cCI6MjA2MjAyOTI5Nn0.0hjJASFktfHZHjVQzX9bq8xGBrf7o1Fya6lqnA2tvPo";
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const SUPPORTED_LANGS = ["it","en","fr","es"];
let currentLang = "it";

const TRANSLATIONS = {
  it: {
    forgot_pass:"Password dimenticata?",
    forgot_email:"Email dimenticata?",
    reset_lbl:"Inserisci la tua email per ricevere il link di reset",
    reset_btn:"Invia link di reset",
    reset_ok:"‚úÖ Ti abbiamo inviato un‚Äôemail con il link per reimpostare la password.",
    reset_err:"Errore invio email: ",
    language:"Lingua",
    title:"Login",
    pay_success:"‚úÖ Pagamento completato con successo. Effettua il login per accedere alla tua dashboard.",
    email_lbl:"Email <span style='color:red'>*</span>",
    email_ph:"Inserisci la tua email",
    password_lbl:"Password <span style='color:red'>*</span>",
    password_ph:"Inserisci la password",
    remember:"Ricordati di me",
    login_btn:"Accedi",
    login_google:"Accedi con Google",
    footer:"¬© 2025 Wine in App - Tutti i diritti riservati",
    fill_all:"Compila tutti i campi.",
    login_err:"Errore login: ",
    google_err:"Errore login con Google: ",
    sub_check_err:"Errore nel controllo abbonamento. Accesso bloccato."
  },
  en: {
    forgot_pass:"Forgot password?",
    forgot_email:"Forgot email?",
    reset_lbl:"Enter your email to receive the reset link",
    reset_btn:"Send reset link",
    reset_ok:"‚úÖ We sent you an email with a link to reset your password.",
    reset_err:"Error sending email: ",
    language:"Language",
    title:"Login",
    pay_success:"‚úÖ Payment completed successfully. Log in to access your dashboard.",
    email_lbl:"Email <span style='color:red'>*</span>",
    email_ph:"Enter your email",
    password_lbl:"Password <span style='color:red'>*</span>",
    password_ph:"Enter your password",
    remember:"Remember me",
    login_btn:"Log in",
    login_google:"Continue with Google",
    footer:"¬© 2025 Wine in App - All rights reserved",
    fill_all:"Please fill in all fields.",
    login_err:"Login error: ",
    google_err:"Google login error: ",
    sub_check_err:"Error checking subscription. Access blocked."
  },
  fr: {
    forgot_pass:"Mot de passe oubli√© ?",
    forgot_email:"E-mail oubli√© ?",
    reset_lbl:"Saisissez votre e-mail pour recevoir le lien de r√©initialisation",
    reset_btn:"Envoyer le lien",
    reset_ok:"‚úÖ Nous vous avons envoy√© un e-mail avec un lien pour r√©initialiser votre mot de passe.",
    reset_err:"Erreur d‚Äôenvoi : ",
    language:"Langue",
    title:"Connexion",
    pay_success:"‚úÖ Paiement effectu√© avec succ√®s. Connectez-vous pour acc√©der √† votre tableau de bord.",
    email_lbl:"E-mail <span style='color:red'>*</span>",
    email_ph:"Saisissez votre e-mail",
    password_lbl:"Mot de passe <span style='color:red'>*</span>",
    password_ph:"Saisissez votre mot de passe",
    remember:"Se souvenir de moi",
    login_btn:"Se connecter",
    login_google:"Continuer avec Google",
    footer:"¬© 2025 Wine in App - Tous droits r√©serv√©s",
    fill_all:"Veuillez remplir tous les champs.",
    login_err:"Erreur de connexion : ",
    google_err:"Erreur Google : ",
    sub_check_err:"Erreur de v√©rification de l‚Äôabonnement. Acc√®s bloqu√©."
  },
  es: {
    forgot_pass:"¬øOlvidaste tu contrase√±a?",
    forgot_email:"¬øOlvidaste tu email?",
    reset_lbl:"Introduce tu email para recibir el enlace de restablecimiento",
    reset_btn:"Enviar enlace",
    reset_ok:"‚úÖ Te enviamos un email con un enlace para restablecer tu contrase√±a.",
    reset_err:"Error al enviar el email: ",
    language:"Idioma",
    title:"Iniciar sesi√≥n",
    pay_success:"‚úÖ Pago completado con √©xito. Inicia sesi√≥n para acceder a tu panel.",
    email_lbl:"Email <span style='color:red'>*</span>",
    email_ph:"Introduce tu email",
    password_lbl:"Contrase√±a <span style='color:red'>*</span>",
    password_ph:"Introduce tu contrase√±a",
    remember:"Recu√©rdame",
    login_btn:"Entrar",
    login_google:"Continuar con Google",
    footer:"¬© 2025 Wine in App - Todos los derechos reservados",
    fill_all:"Completa todos los campos.",
    login_err:"Error de inicio de sesi√≥n: ",
    google_err:"Error con Google: ",
    sub_check_err:"Error comprobando la suscripci√≥n. Acceso bloqueado."
  }
};

function normalizeLang(raw){
  const s=(raw||"").toLowerCase();
  if (s.startsWith("it")) return "it";
  if (s.startsWith("fr")) return "fr";
  if (s.startsWith("es")) return "es";
  return "en";
}
function t(key){
  const dict = TRANSLATIONS[currentLang] || TRANSLATIONS.en;
  return (dict && dict[key]) || (TRANSLATIONS.en && TRANSLATIONS.en[key]) || key;
}
function setLang(lang, persist=true){
  currentLang = SUPPORTED_LANGS.includes(normalizeLang(lang)) ? normalizeLang(lang) : "en";
  document.documentElement.lang = currentLang;
  if (persist) localStorage.setItem("wf_lang", currentLang);
  applyTranslations();
}
function initLanguage(){
  const qp = new URLSearchParams(window.location.search);
  const langFromUrl = qp.get("lang");
  const saved = localStorage.getItem("wf_lang");
  const auto = normalizeLang(navigator.language||"");
  setLang(langFromUrl || saved || auto, !saved);

  const sel = document.getElementById("langSelect");
  if (sel){
    sel.value = currentLang;
    sel.addEventListener("change", e => setLang(e.target.value, true));
  }
}
function applyTranslations(){
  const langLbl = document.getElementById("langLabel");
  if (langLbl) langLbl.textContent = t("language");

  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const key = el.getAttribute("data-i18n");
    // email/password label contengono HTML
    if (key === "email_lbl" || key === "password_lbl") el.innerHTML = t(key);
    else el.textContent = t(key);
  });
  document.querySelectorAll("[data-i18n-placeholder]").forEach(el=>{
    el.setAttribute("placeholder", t(el.getAttribute("data-i18n-placeholder")));
  });
}

  function toggleVisibility(id) {
    const field = document.getElementById(id);
    field.type = field.type === "password" ? "text" : "password";
  }

document.addEventListener("DOMContentLoaded", async () => {
  initLanguage();
  // --- Password recovery (forgot password) ---
const forgotLink = document.getElementById("forgotPassLink");
const resetBox = document.getElementById("resetBox");
const resetBtn = document.getElementById("resetBtn");
const resetMsg = document.getElementById("resetMsg");

if (forgotLink && resetBox) {
  forgotLink.addEventListener("click", (e) => {
    e.preventDefault();
    resetBox.style.display = (resetBox.style.display === "none" || !resetBox.style.display) ? "block" : "none";
    // precompila se email gi√† inserita sopra
    const emailNow = (document.getElementById("email")?.value || "").trim();
    if (emailNow) document.getElementById("resetEmail").value = emailNow;
    resetMsg.textContent = "";
  });
}

async function sendReset() {
  const email = (document.getElementById("resetEmail").value || "").trim();
  if (!email) return;

  resetBtn.disabled = true;
  resetBtn.style.opacity = "0.7";
  resetMsg.style.color = "#333";
  resetMsg.textContent = "";

  try {
    const redirectTo = `${window.location.origin}/account.html?mode=recovery&lang=${currentLang}`;
    const { error } = await sb.auth.resetPasswordForEmail(email, { redirectTo });
    if (error) {
      resetMsg.style.color = "#c00";
      resetMsg.textContent = t("reset_err") + error.message;
      return;
    }
    resetMsg.style.color = "#0a7a3a";
    resetMsg.textContent = t("reset_ok");
  } finally {
    resetBtn.disabled = false;
    resetBtn.style.opacity = "1";
  }
}

if (resetBtn) resetBtn.addEventListener("click", sendReset);
const resetEmailInput = document.getElementById("resetEmail");
if (resetEmailInput) {
  resetEmailInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") { e.preventDefault(); sendReset(); }
  });
}

  const params = new URLSearchParams(window.location.search);
  if (params.get("checkout") === "success") {
    document.getElementById("successMessage").style.display = "block";
  }

  async function handleEmailConfirmCallback() {
    const hash = window.location.hash.startsWith("#")
      ? window.location.hash.slice(1)
      : "";
    const hp = new URLSearchParams(hash);
    const access_token = hp.get("access_token");
    const refresh_token = hp.get("refresh_token");

    if (access_token && refresh_token) {
      const { data, error } = await sb.auth.setSession({ access_token, refresh_token });
      history.replaceState(null, "", window.location.pathname + window.location.search);
      if (!error && data?.user) return data.user;
    }

    const qp = new URLSearchParams(window.location.search);
    const code = qp.get("code");
    if (code) {
      const { data, error } = await sb.auth.exchangeCodeForSession(code);
      qp.delete("code");
      history.replaceState(null, "", window.location.pathname + (qp.toString() ? `?${qp}` : ""));
      if (!error && data?.user) return data.user;
    }

    return null;
  }

  const confirmedUser = await handleEmailConfirmCallback();
  if (confirmedUser) {
    const { data: ristoData, error: ristoError } = await sb
      .from("ristoranti")
      .select("subscription_status")
      .eq("id", confirmedUser.id)
      .single();

    localStorage.setItem(`wf_lang_${confirmedUser.id}`, currentLang);

    if (ristoError) {
      alert(t("sub_check_err"));
      return;
    }

    if (!ristoData || ristoData.subscription_status !== "active") {
      window.location.href = `abbonamento.html?lang=${currentLang}`;
    } else {
      window.location.href = `dashboard.html?ristorante_id=${confirmedUser.id}&lang=${currentLang}`;
    }
    return;
  }

    window.login = async function () {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const remember = document.getElementById('remember').checked;

      if (!email || !password) return alert(t("fill_all"));

      const { data, error } = await sb.auth.signInWithPassword({ email, password });
      if (error) return alert(t("login_err") + error.message);

      localStorage.setItem("sb-access-token", data.session.access_token);
      if (remember) {
        localStorage.setItem("rememberedEmail", email);
      } else {
        localStorage.removeItem("rememberedEmail");
      }

      const { data: ristoData, error: ristoError } = await sb
  .from("ristoranti")
  .select("subscription_status")
  .eq("id", data.user.id)
  .single();

  // salva lingua anche ‚Äúper ristorante‚Äù
localStorage.setItem(`wf_lang_${data.user.id}`, currentLang);

if (ristoError) {
  alert(t("sub_check_err"));
  return;
}

if (!ristoData || ristoData.subscription_status !== "active") {
  // primo login oppure abbonamento non ancora attivo
  window.location.href = `abbonamento.html?lang=${currentLang}`;
} else {
  window.location.href = `dashboard.html?ristorante_id=${data.user.id}&lang=${currentLang}`;
}

    }

window.loginWithGoogle = async function () {
  const { data, error } = await sb.auth.signInWithOAuth({
    provider: 'google',
    options: {
      redirectTo: window.location.origin + '/dashboard.html?from=google'
    }
  });
  if (error) alert(t("google_err") + error.message);
}

    const rememberedEmail = localStorage.getItem("rememberedEmail");
    if (rememberedEmail) {
      document.getElementById('email').value = rememberedEmail;
      document.getElementById('remember').checked = true;
    }
  });
</script>
</body>
</html>

