<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Account - Wine in App</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.42.3/dist/umd/supabase.min.js"></script>

  <style>
    *{ box-sizing:border-box; }
    :root{
      --bg:#F7F4EF; --card:#fff; --text:#1F2937; --muted:#6B7280; --border:#E6E2DA;
      --accent:#6B1E2B; --accent-700:#4C1420; --accent-soft:#F3E7E9;
      --radius:18px; --radius-pill:999px; --shadow:0 10px 30px rgba(17,24,39,.08);
      --content:980px;
    }
    html,body{ margin:0; height:100%; background:var(--bg); color:var(--text); font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .page-title{ background:#fff; border-bottom:1px solid #ddd; padding:10px 14px; }
    .topbar{ max-width:var(--content); margin:0 auto; display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .topbar h1{ margin:0; font-family:'Playfair Display', serif; font-size:1.1em; }
    .lang-switch{ display:flex; align-items:center; gap:8px; }
    #langSelect{ padding:6px 8px; border-radius:10px; border:1px solid #ddd; background:#fff; }
    main{ max-width:var(--content); margin:0 auto; padding:22px 16px 90px; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; }
    .settings-actions{ display:flex; gap:8px; overflow-x:auto; -webkit-overflow-scrolling:touch; padding:6px 2px 14px; }
    .settings-actions::-webkit-scrollbar{ display:none; }
    .pill-btn{
      background:var(--card); border:1px solid var(--border); color:var(--text);
      padding:10px 14px; border-radius:var(--radius-pill); cursor:pointer; white-space:nowrap;
      box-shadow:0 6px 18px rgba(17,24,39,.06); font-size:0.92em;
    }
    .pill-btn.active{ background:var(--accent-soft); color:var(--accent); border-color:rgba(107,30,43,.35); }
    label{ display:block; margin-top:12px; margin-bottom:6px; font-weight:600; }
    input{
      width:100%; max-width:520px; padding:10px 12px; border-radius:12px; border:1px solid #ddd; background:#fff;
    }

    /* Password eye toggle */
.pw-wrap{
  position: relative;
  max-width: 520px;
}
.pw-wrap input{
  padding-right: 46px; /* spazio per l‚Äôocchio */
}
.pw-toggle{
  position:absolute;
  right:10px;
  top:50%;
  transform:translateY(-50%);
  border:0;
  background:transparent;
  cursor:pointer;
  font-size:18px;
  line-height:1;
  color:#333;
  padding:6px;
  border-radius:10px;
}
.pw-toggle:hover{
  background: rgba(17,24,39,.06);
}

    .btn{
      margin-top:14px; background:var(--accent); color:#fff; border:0; border-radius:14px;
      padding:10px 14px; cursor:pointer; font-weight:700;
    }
    .btn:hover{ background:var(--accent-700); }
    .hint{ color:var(--muted); font-size:0.92em; line-height:1.35; }
    .msg{ margin-top:10px; font-weight:700; display:none; }
    .msg.ok{ color:green; }
    .msg.err{ color:#b00; }

    .bottom-nav{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:10px; width:min(100% - 20px, var(--content));
      backdrop-filter: blur(10px);
      display:flex; justify-content: space-around;
      padding: 8px 6px calc(8px + env(safe-area-inset-bottom));
      z-index: 1800;
      border: 1px solid var(--border);
      border-radius: 22px;
      box-shadow: var(--shadow);
      background: rgba(255,255,255,.92);
    }
    .bn-item{
      background:transparent; border:none; display:flex; flex-direction:column; align-items:center;
      gap:4px; cursor:pointer; color:#333; font-size:0.72em; padding:6px 8px; border-radius:14px;
    }
    .bn-item.active{ color:var(--accent); background: rgba(107,30,43,.08); }
    .bn-item .icon{ font-size:1.2em; line-height:1; }
  </style>
</head>

<body>
  <div class="page-title">
    <div class="topbar">
      <h1 id="pageTitle">Account</h1>
      <div class="lang-switch">
        <label id="langLabel" for="langSelect" style="font-weight:600;">Lingua</label>
        <select id="langSelect">
          <option value="it">Italiano</option>
          <option value="en">English</option>
          <option value="fr">Fran√ßais</option>
          <option value="es">Espa√±ol</option>
        </select>
      </div>
    </div>
  </div>

  <main>
    <div class="settings-actions" id="tabs">
      <button class="pill-btn active" data-tab="emailTab" type="button" id="tabEmail">Cambia email</button>
      <button class="pill-btn" data-tab="passTab" type="button" id="tabPass">Cambia password</button>
    </div>

<div class="card" id="emailTab">
  <div class="hint" id="authMethodsLine" style="margin-top:10px;">
    Metodi di accesso: <strong id="authMethods">‚Äî</strong>
  </div>

  <div class="hint" id="currentEmailLine" style="margin-top:10px;">
    La tua mail √® <strong id="currentEmail">‚Äî</strong>
  </div>

  <div class="hint" id="emailHint" style="margin-top:10px;">
    Inserisci la nuova email. Potrebbe arrivarti una mail di conferma (dipende dalle impostazioni di autenticazione).
  </div>

  <label for="newEmail" id="newEmailLbl">Nuova email</label>
  <input id="newEmail" type="email" placeholder="nome@esempio.com" autocomplete="email"/>

      <button class="btn" id="saveEmailBtn" type="button">Aggiorna email</button>
      <div class="msg ok" id="emailOk">‚úÖ Email aggiornata. Controlla la posta per eventuale conferma.</div>
      <div class="msg err" id="emailErr">‚ùå Errore: </div>
    </div>

    <div class="card" id="passTab" style="display:none;">
      <div class="hint" id="oauthHint" style="display:none;">
        Stai usando Google per accedere. Non hai una password ‚Äúattuale‚Äù.
        Puoi aggiungere una password per accedere anche con email e password.
      </div>

      <button class="btn" id="sendSetPasswordEmailBtn" type="button" style="display:none;">
        Invia email per impostare una password
      </button>
      <div class="msg ok" id="setPassEmailOk">‚úÖ Email inviata. Apri il link e imposta la password.</div>
      <div class="msg err" id="setPassEmailErr">‚ùå Errore: </div>

      <div id="classicPassBox">
        <div class="hint" id="passHint">
          Scegli una password sicura (almeno 8 caratteri). Se sei loggato, l‚Äôaggiornamento √® immediato.
        </div>

        <label for="currPass" id="currPassLbl">Password attuale</label>
        <div class="pw-wrap">
  <input id="currPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"/>
  <button class="pw-toggle" type="button" aria-label="Mostra/Nascondi password" data-target="currPass">üëÅÔ∏è</button>
</div>

        <label for="newPass" id="newPassLbl">Nuova password</label>
        <div class="pw-wrap">
  <input id="newPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password"/>
  <button class="pw-toggle" type="button" aria-label="Mostra/Nascondi password" data-target="newPass">üëÅÔ∏è</button>
</div>

        <label for="newPass2" id="newPass2Lbl">Ripeti password</label>
        <div class="pw-wrap">
  <input id="newPass2" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password"/>
  <button class="pw-toggle" type="button" aria-label="Mostra/Nascondi password" data-target="newPass2">üëÅÔ∏è</button>
</div>

        <button class="btn" id="savePassBtn" type="button">Aggiorna password</button>
        <div class="msg ok" id="passOk">‚úÖ Password aggiornata.</div>
        <div class="msg err" id="passErr">‚ùå Errore: </div>
      </div>
    </div>
  </main>

  <div class="bottom-nav">
    <button class="bn-item" type="button" onclick="goTo('dashboard.html')"><span class="icon">‚öôÔ∏è</span><span class="label" id="navDash">Dashboard</span></button>
    <button class="bn-item active" type="button"><span class="icon">üë§</span><span class="label" id="navAcc">Account</span></button>
    <button class="bn-item" type="button" onclick="goTo('aiuto.html')"><span class="icon">‚ùì</span><span class="label" id="navHelp">Aiuto</span></button>
  </div>

<script>
  // Supabase (stesse credenziali del tuo dashboard.html)
  const sb = window.supabase.createClient(
    "https://ldunvbftxhbtuyabgxwh.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkdW52YmZ0eGhidHV5YWJneHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0NTMyOTYsImV4cCI6MjA2MjAyOTI5Nn0.0hjJASFktfHZHjVQzX9bq8xGBrf7o1Fya6lqnA2tvPo"
  );

  const SUPPORTED = ["it","en","fr","es"];
  let currentLang = "it";
  let RESTAURANT_ID = null;

  const TR = {
    it:{
      auth_methods: "Metodi di accesso:",
      current_pass: "Password attuale",
current_pass_required: "Inserisci la password attuale.",
current_pass_wrong: "Password attuale non corretta.",
      current_email_line: "La tua mail √®",
      language:"Lingua",
      account:"Account",
      change_email:"Cambia email",
      change_password:"Cambia password",
      email_hint:"Inserisci la nuova email. Potrebbe arrivarti una mail di conferma (dipende dalle impostazioni di autenticazione).",
      pass_hint:"Scegli una password sicura (almeno 8 caratteri). Se sei loggato, l‚Äôaggiornamento √® immediato.",
      new_email:"Nuova email",
      update_email:"Aggiorna email",
      email_ok:"‚úÖ Email aggiornata. Controlla la posta per eventuale conferma.",
      new_pass:"Nuova password",
      repeat_pass:"Ripeti password",
      update_pass:"Aggiorna password",
      pass_ok:"‚úÖ Password aggiornata.",
      err_prefix:"‚ùå Errore: ",
      pass_mismatch:"Le password non coincidono.",
      pass_short:"Password troppo corta (min 8).",
      nav_dash:"Dashboard",
      nav_acc:"Account",
      nav_help:"Aiuto",
    },
    en:{
      auth_methods: "Sign-in methods:",
      current_pass: "Current password",
current_pass_required: "Enter your current password.",
current_pass_wrong: "Current password is incorrect.",
      current_email_line: "Your email is",
      language:"Language",
      account:"Account",
      change_email:"Change email",
      change_password:"Change password",
      email_hint:"Enter the new email. You may receive a confirmation email (depending on auth settings).",
      pass_hint:"Choose a secure password (at least 8 characters). If you‚Äôre logged in, the update is immediate.",
      new_email:"New email",
      update_email:"Update email",
      email_ok:"‚úÖ Email updated. Check your inbox for any confirmation.",
      new_pass:"New password",
      repeat_pass:"Repeat password",
      update_pass:"Update password",
      pass_ok:"‚úÖ Password updated.",
      err_prefix:"‚ùå Error: ",
      pass_mismatch:"Passwords do not match.",
      pass_short:"Password too short (min 8).",
      nav_dash:"Dashboard",
      nav_acc:"Account",
      nav_help:"Help",
    },
    fr:{
      auth_methods: "M√©thodes de connexion :",
      current_pass: "Mot de passe actuel",
current_pass_required: "Saisissez le mot de passe actuel.",
current_pass_wrong: "Mot de passe actuel incorrect.",
      current_email_line: "Votre email est",
      language:"Langue",
      account:"Compte",
      change_email:"Changer l‚Äôemail",
      change_password:"Changer le mot de passe",
      email_hint:"Saisissez le nouvel email. Un email de confirmation peut √™tre envoy√© (selon la config).",
      pass_hint:"Choisissez un mot de passe s√ªr (au moins 8 caract√®res). Si vous √™tes connect√©, la mise √† jour est imm√©diate.",
      new_email:"Nouvel email",
      update_email:"Mettre √† jour l‚Äôemail",
      email_ok:"‚úÖ Email mis √† jour. V√©rifiez votre bo√Æte mail pour confirmer si n√©cessaire.",
      new_pass:"Nouveau mot de passe",
      repeat_pass:"R√©p√©ter le mot de passe",
      update_pass:"Mettre √† jour le mot de passe",
      pass_ok:"‚úÖ Mot de passe mis √† jour.",
      err_prefix:"‚ùå Erreur : ",
      pass_mismatch:"Les mots de passe ne correspondent pas.",
      pass_short:"Mot de passe trop court (min 8).",
      nav_dash:"Tableau",
      nav_acc:"Compte",
      nav_help:"Aide",
    },
    es:{
      auth_methods: "M√©todos de acceso:",
      current_pass: "Contrase√±a actual",
current_pass_required: "Introduce la contrase√±a actual.",
current_pass_wrong: "La contrase√±a actual no es correcta.",
      current_email_line: "Tu email es",
      language:"Idioma",
      account:"Cuenta",
      change_email:"Cambiar email",
      change_password:"Cambiar contrase√±a",
      email_hint:"Introduce el nuevo email. Puede que recibas un correo de confirmaci√≥n (seg√∫n configuraci√≥n).",
      pass_hint:"Elige una contrase√±a segura (m√≠nimo 8 caracteres). Si est√°s logueado, el cambio es inmediato.",
      new_email:"Nuevo email",
      update_email:"Actualizar email",
      email_ok:"‚úÖ Email actualizado. Revisa tu bandeja por si hay confirmaci√≥n.",
      new_pass:"Nueva contrase√±a",
      repeat_pass:"Repite la contrase√±a",
      update_pass:"Actualizar contrase√±a",
      pass_ok:"‚úÖ Contrase√±a actualizada.",
      err_prefix:"‚ùå Error: ",
      pass_mismatch:"Las contrase√±as no coinciden.",
      pass_short:"Contrase√±a demasiado corta (m√≠n 8).",
      nav_dash:"Panel",
      nav_acc:"Cuenta",
      nav_help:"Ayuda",
    }
  };

  function t(k){ return (TR[currentLang] && TR[currentLang][k]) || TR.en[k] || k; }
  function normLang(l){
    const s=(l||"").toLowerCase();
    if (s.startsWith("it")) return "it";
    if (s.startsWith("fr")) return "fr";
    if (s.startsWith("es")) return "es";
    return "en";
  }

  function setLang(lang, persist=true){
    currentLang = SUPPORTED.includes(normLang(lang)) ? normLang(lang) : "en";
    document.documentElement.lang = currentLang;
    if (persist){
      localStorage.setItem("wf_lang", currentLang);
      if (RESTAURANT_ID) localStorage.setItem(`wf_lang_${RESTAURANT_ID}`, currentLang);
    }
    applyTranslations();
  }

  function applyTranslations(){
    document.title = `Wine in App - ${t("account")}`;
    document.getElementById("pageTitle").textContent = t("account");
    document.getElementById("langLabel").textContent = t("language");
    document.getElementById("tabEmail").textContent = t("change_email");
    document.getElementById("tabPass").textContent  = t("change_password");
    document.getElementById("emailHint").textContent = t("email_hint");
    document.getElementById("authMethodsLine").childNodes[0].textContent = t("auth_methods") + " ";
    document.getElementById("passHint").textContent  = t("pass_hint");
    document.getElementById("newEmailLbl").textContent = t("new_email");
    document.getElementById("saveEmailBtn").textContent = t("update_email");
    document.getElementById("emailOk").textContent = t("email_ok");
    document.getElementById("newPassLbl").textContent = t("new_pass");
    document.getElementById("newPass2Lbl").textContent = t("repeat_pass");
    document.getElementById("savePassBtn").textContent = t("update_pass");
    document.getElementById("passOk").textContent = t("pass_ok");
    document.getElementById("navDash").textContent = t("nav_dash");
    document.getElementById("navAcc").textContent  = t("nav_acc");
    document.getElementById("navHelp").textContent = t("nav_help");
    document.getElementById("currentEmailLine").childNodes[0].textContent = t("current_email_line") + " ";
    document.getElementById("currPassLbl").textContent = t("current_pass");
    const sel = document.getElementById("langSelect");
    if (sel) sel.value = currentLang;
  }

  function getProviders(user){
  const ids = Array.isArray(user?.identities) ? user.identities : [];
  const fromIdentities = ids.map(i => i.provider).filter(Boolean);
  const fromMeta = Array.isArray(user?.app_metadata?.providers) ? user.app_metadata.providers : [];
  const all = [...new Set([...fromIdentities, ...fromMeta])];
  return all;
}

function hasProvider(user, p){
  return getProviders(user).includes(p);
}

  function goTo(path){
    const qs = new URLSearchParams();
    if (RESTAURANT_ID) qs.set("ristorante_id", RESTAURANT_ID);
    qs.set("lang", currentLang);
    window.location.href = `${path}?${qs.toString()}`;
  }

  function showTab(tabId){
    document.getElementById("emailTab").style.display = (tabId==="emailTab") ? "block":"none";
    document.getElementById("passTab").style.display  = (tabId==="passTab") ? "block":"none";
    document.querySelectorAll(".pill-btn").forEach(b => b.classList.toggle("active", b.dataset.tab===tabId));
  }

  function resetMsgs(){
    ["emailOk","emailErr","passOk","passErr","setPassEmailOk","setPassEmailErr"].forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.style.display="none";
      if (id.endsWith("Err")) el.textContent = t("err_prefix");
    });
  }

  async function handleAuthCallbackFromHash() {
  const hash = window.location.hash.startsWith("#") ? window.location.hash.slice(1) : "";
  if (!hash) return null;

  const hp = new URLSearchParams(hash);
  const access_token = hp.get("access_token");
  const refresh_token = hp.get("refresh_token");

  if (access_token && refresh_token) {
    const { data, error } = await sb.auth.setSession({ access_token, refresh_token });
    // pulisci hash (mantieni query)
    history.replaceState(null, "", window.location.pathname + window.location.search);
    if (!error && data?.user) return data.user;
  }
  return null;
}

  async function requireUser(){
    const { data:{ user } } = await sb.auth.getUser();
    if (!user) { window.location.href="/"; return null; }
    return user;
  }

  document.addEventListener("DOMContentLoaded", async () => {
    
    // 1) se arrivi da email recovery con #access_token, crea sessione
    const recoveredUser = await handleAuthCallbackFromHash();
    // 2) ora prendi utente (se non c'√®, redirect)
    const user = recoveredUser || await requireUser();
    const providers = getProviders(user);
    const hasPassword = user?.user_metadata?.has_password === true;
    const googleOnly = providers.includes("google") && !hasPassword;
    const prettyProviders = (providers.length ? providers : ["email"]).map(p => p === "google" ? "Google" : (p === "email" ? "Email" : p));
document.getElementById("authMethods").textContent = prettyProviders.join(", ");

    const isGoogle = hasProvider(user, "google");
    const isEmail = hasProvider(user, "email"); // spesso true se esiste identity email

    if (!user) return;
    document.getElementById("currentEmail").textContent = user.email || "‚Äî";

    const urlParams = new URLSearchParams(window.location.search);
    RESTAURANT_ID = urlParams.get("ristorante_id") || user.id;

    const saved = localStorage.getItem(`wf_lang_${RESTAURANT_ID}`) || localStorage.getItem("wf_lang") || normLang(navigator.language);
    const qpLang = urlParams.get("lang");
    setLang(qpLang || saved, true);

    document.getElementById("tabs").querySelectorAll(".pill-btn").forEach(btn=>{
      btn.addEventListener("click", ()=> { resetMsgs(); showTab(btn.dataset.tab); });
    });

    document.getElementById("langSelect").addEventListener("change", (e)=> setLang(e.target.value, true));

    // üëÅÔ∏è Toggle show/hide password (sempre)
document.querySelectorAll(".pw-toggle").forEach(btn => {
  btn.addEventListener("click", () => {
    const id = btn.getAttribute("data-target");
    const input = document.getElementById(id);
    if (!input) return;

    const show = input.type === "password";
    input.type = show ? "text" : "password";
    btn.textContent = show ? "üôà" : "üëÅÔ∏è";
  });
});

    document.getElementById("sendSetPasswordEmailBtn").addEventListener("click", async () => {
  resetMsgs();

  const { data: userData } = await sb.auth.getUser();
  const email = userData?.user?.email;
  if (!email) return;

  const redirectTo = `${window.location.origin}/account.html?mode=recovery&lang=${currentLang}`;

  const { error } = await sb.auth.resetPasswordForEmail(email, { redirectTo });
  if (error) {
    const e = document.getElementById("setPassEmailErr");
    e.textContent = t("err_prefix") + (error.message || "Unknown");
    e.style.display = "block";
    return;
  }

  document.getElementById("setPassEmailOk").style.display = "block";
});

    document.getElementById("saveEmailBtn").addEventListener("click", async () => {
      resetMsgs();
      const email = (document.getElementById("newEmail").value || "").trim();
      if (!email) return;

      const { error } = await sb.auth.updateUser({ email });
      if (error){
        const e = document.getElementById("emailErr");
        e.textContent = t("err_prefix") + (error.message || "Unknown");
        e.style.display="block";
        return;
      }
      document.getElementById("emailOk").style.display="block";
    });

    const isRecoveryMode = urlParams.get("mode") === "recovery";
if (googleOnly && !isRecoveryMode) {
  document.getElementById("tabPass").textContent = "Aggiungi password";
  document.getElementById("oauthHint").style.display = "block";
  document.getElementById("sendSetPasswordEmailBtn").style.display = "inline-block";
  document.getElementById("classicPassBox").style.display = "none";
}

if (isRecoveryMode) {
  // 1) apri direttamente il tab password
  showTab("passTab");
  resetMsgs();

  // 2) in recovery non serve password attuale
  document.getElementById("currPassLbl").style.display = "none";
  document.getElementById("currPass").style.display = "none";
  document.getElementById("currPass").closest(".pw-wrap").style.display = "none";

  // 3) mostra un hint chiaro e nascondi il bottone "invio email" (ormai sei gi√† nel link)
  document.getElementById("oauthHint").style.display = "block";
  document.getElementById("sendSetPasswordEmailBtn").style.display = "none";
  document.getElementById("classicPassBox").style.display = "block";
}


// ‚úÖ Se siamo in recovery, permettiamo di impostare password SENZA password attuale
if (isRecoveryMode) {
  // trucco: clono il bottone per rimuovere eventuali vecchi listener
  const oldBtn = document.getElementById("savePassBtn");
  const newBtn = oldBtn.cloneNode(true);
  oldBtn.parentNode.replaceChild(newBtn, oldBtn);

  newBtn.addEventListener("click", async () => {
    resetMsgs();

    const p1 = document.getElementById("newPass").value || "";
    const p2 = document.getElementById("newPass2").value || "";

    if (p1.length < 8) {
      const e = document.getElementById("passErr");
      e.textContent = t("err_prefix") + t("pass_short");
      e.style.display = "block";
      return;
    }
    if (p1 !== p2) {
      const e = document.getElementById("passErr");
      e.textContent = t("err_prefix") + t("pass_mismatch");
      e.style.display = "block";
      return;
    }

    const { error } = await sb.auth.updateUser({ password: p1, data: { has_password: true } });
    if (error) {
      const e = document.getElementById("passErr");
      e.textContent = t("err_prefix") + (error.message || "Unknown");
      e.style.display = "block";
      return;
    }

    document.getElementById("passOk").textContent = "‚úÖ Password impostata. Ora puoi accedere anche con email e password.";
    document.getElementById("passOk").style.display = "block";
    document.getElementById("newPass").value = "";
    document.getElementById("newPass2").value = "";
  });

} else if (!googleOnly) {
  // ‚úÖ Flusso normale: verifica password attuale + update password
  document.getElementById("savePassBtn").addEventListener("click", async () => {
    resetMsgs();

    const curr = document.getElementById("currPass").value || "";
    const p1 = document.getElementById("newPass").value || "";
    const p2 = document.getElementById("newPass2").value || "";

    if (!curr){
      const e = document.getElementById("passErr");
      e.textContent = t("err_prefix") + t("current_pass_required");
      e.style.display = "block";
      return;
    }

    if (p1.length < 8){
      const e = document.getElementById("passErr");
      e.textContent = t("err_prefix") + t("pass_short");
      e.style.display="block";
      return;
    }
    if (p1 !== p2){
      const e = document.getElementById("passErr");
      e.textContent = t("err_prefix") + t("pass_mismatch");
      e.style.display="block";
      return;
    }

    const { data: userData } = await sb.auth.getUser();
    const email = userData?.user?.email;

    if (!email){
      const e = document.getElementById("passErr");
      e.textContent = t("err_prefix") + "User email not found";
      e.style.display="block";
      return;
    }

    const { error: signErr } = await sb.auth.signInWithPassword({ email, password: curr });
    if (signErr){
      const e = document.getElementById("passErr");
      e.textContent = t("err_prefix") + t("current_pass_wrong");
      e.style.display="block";
      return;
    }

    const { error } = await sb.auth.updateUser({ password: p1 });
    if (error){
      const e = document.getElementById("passErr");
      e.textContent = t("err_prefix") + (error.message || "Unknown");
      e.style.display="block";
      return;
    }

    document.getElementById("passOk").style.display="block";
    document.getElementById("currPass").value = "";
    document.getElementById("newPass").value = "";
    document.getElementById("newPass2").value = "";
  });
}

  });
</script>
</body>
</html>
