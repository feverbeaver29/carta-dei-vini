<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Account - Wine in App</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.42.3/dist/umd/supabase.min.js"></script>

  <style>
    *{ box-sizing:border-box; }
    :root{
      --bg:#F7F4EF; --card:#fff; --text:#1F2937; --muted:#6B7280; --border:#E6E2DA;
      --accent:#6B1E2B; --accent-700:#4C1420; --accent-soft:#F3E7E9;
      --radius:18px; --radius-pill:999px; --shadow:0 10px 30px rgba(17,24,39,.08);
      --content:980px;
    }
    html,body{ margin:0; height:100%; background:var(--bg); color:var(--text); font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .page-title{ background:#fff; border-bottom:1px solid #ddd; padding:10px 14px; }
    .topbar{ max-width:var(--content); margin:0 auto; display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .topbar h1{ margin:0; font-family:'Playfair Display', serif; font-size:1.1em; }
    .lang-switch{ display:flex; align-items:center; gap:8px; }
    #langSelect{ padding:6px 8px; border-radius:10px; border:1px solid #ddd; background:#fff; }
    main{ max-width:var(--content); margin:0 auto; padding:22px 16px 90px; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; }
    .settings-actions{ display:flex; gap:8px; overflow-x:auto; -webkit-overflow-scrolling:touch; padding:6px 2px 14px; }
    .settings-actions::-webkit-scrollbar{ display:none; }
    .pill-btn{
      background:var(--card); border:1px solid var(--border); color:var(--text);
      padding:10px 14px; border-radius:var(--radius-pill); cursor:pointer; white-space:nowrap;
      box-shadow:0 6px 18px rgba(17,24,39,.06); font-size:0.92em;
    }
    .pill-btn.active{ background:var(--accent-soft); color:var(--accent); border-color:rgba(107,30,43,.35); }
    label{ display:block; margin-top:12px; margin-bottom:6px; font-weight:600; }
    input{
      width:100%; max-width:520px; padding:10px 12px; border-radius:12px; border:1px solid #ddd; background:#fff;
    }
    .btn{
      margin-top:14px; background:var(--accent); color:#fff; border:0; border-radius:14px;
      padding:10px 14px; cursor:pointer; font-weight:700;
    }
    .btn:hover{ background:var(--accent-700); }
    .hint{ color:var(--muted); font-size:0.92em; line-height:1.35; }
    .msg{ margin-top:10px; font-weight:700; display:none; }
    .msg.ok{ color:green; }
    .msg.err{ color:#b00; }

    .bottom-nav{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:10px; width:min(100% - 20px, var(--content));
      backdrop-filter: blur(10px);
      display:flex; justify-content: space-around;
      padding: 8px 6px calc(8px + env(safe-area-inset-bottom));
      z-index: 1800;
      border: 1px solid var(--border);
      border-radius: 22px;
      box-shadow: var(--shadow);
      background: rgba(255,255,255,.92);
    }
    .bn-item{
      background:transparent; border:none; display:flex; flex-direction:column; align-items:center;
      gap:4px; cursor:pointer; color:#333; font-size:0.72em; padding:6px 8px; border-radius:14px;
    }
    .bn-item.active{ color:var(--accent); background: rgba(107,30,43,.08); }
    .bn-item .icon{ font-size:1.2em; line-height:1; }
  </style>
</head>

<body>
  <div class="page-title">
    <div class="topbar">
      <h1 id="pageTitle">Account</h1>
      <div class="lang-switch">
        <label id="langLabel" for="langSelect" style="font-weight:600;">Lingua</label>
        <select id="langSelect">
          <option value="it">Italiano</option>
          <option value="en">English</option>
          <option value="fr">Fran√ßais</option>
          <option value="es">Espa√±ol</option>
        </select>
      </div>
    </div>
  </div>

  <main>
    <div class="settings-actions" id="tabs">
      <button class="pill-btn active" data-tab="emailTab" type="button" id="tabEmail">Cambia email</button>
      <button class="pill-btn" data-tab="passTab" type="button" id="tabPass">Cambia password</button>
    </div>

    <div class="card" id="emailTab">
      <div class="hint" id="emailHint">
        Inserisci la nuova email. Potrebbe arrivarti una mail di conferma (dipende dalle impostazioni di autenticazione).
      </div>
      <label for="newEmail" id="newEmailLbl">Nuova email</label>
      <input id="newEmail" type="email" placeholder="nome@esempio.com" autocomplete="email"/>

      <button class="btn" id="saveEmailBtn" type="button">Aggiorna email</button>
      <div class="msg ok" id="emailOk">‚úÖ Email aggiornata. Controlla la posta per eventuale conferma.</div>
      <div class="msg err" id="emailErr">‚ùå Errore: </div>
    </div>

    <div class="card" id="passTab" style="display:none;">
      <div class="hint" id="passHint">
        Scegli una password sicura (almeno 8 caratteri). Se sei loggato, l‚Äôaggiornamento √® immediato.
      </div>

      <label for="newPass" id="newPassLbl">Nuova password</label>
      <input id="newPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password"/>

      <label for="newPass2" id="newPass2Lbl">Ripeti password</label>
      <input id="newPass2" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password"/>

      <button class="btn" id="savePassBtn" type="button">Aggiorna password</button>
      <div class="msg ok" id="passOk">‚úÖ Password aggiornata.</div>
      <div class="msg err" id="passErr">‚ùå Errore: </div>
    </div>
  </main>

  <div class="bottom-nav">
    <button class="bn-item" type="button" onclick="goTo('dashboard.html')"><span class="icon">‚öôÔ∏è</span><span class="label" id="navDash">Dashboard</span></button>
    <button class="bn-item active" type="button"><span class="icon">üë§</span><span class="label" id="navAcc">Account</span></button>
    <button class="bn-item" type="button" onclick="goTo('aiuto.html')"><span class="icon">‚ùì</span><span class="label" id="navHelp">Aiuto</span></button>
  </div>

<script>
  // Supabase (stesse credenziali del tuo dashboard.html)
  const sb = window.supabase.createClient(
    "https://ldunvbftxhbtuyabgxwh.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkdW52YmZ0eGhidHV5YWJneHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0NTMyOTYsImV4cCI6MjA2MjAyOTI5Nn0.0hjJASFktfHZHjVQzX9bq8xGBrf7o1Fya6lqnA2tvPo"
  );

  const SUPPORTED = ["it","en","fr","es"];
  let currentLang = "it";
  let RESTAURANT_ID = null;

  const TR = {
    it:{
      language:"Lingua",
      account:"Account",
      change_email:"Cambia email",
      change_password:"Cambia password",
      email_hint:"Inserisci la nuova email. Potrebbe arrivarti una mail di conferma (dipende dalle impostazioni di autenticazione).",
      pass_hint:"Scegli una password sicura (almeno 8 caratteri). Se sei loggato, l‚Äôaggiornamento √® immediato.",
      new_email:"Nuova email",
      update_email:"Aggiorna email",
      email_ok:"‚úÖ Email aggiornata. Controlla la posta per eventuale conferma.",
      new_pass:"Nuova password",
      repeat_pass:"Ripeti password",
      update_pass:"Aggiorna password",
      pass_ok:"‚úÖ Password aggiornata.",
      err_prefix:"‚ùå Errore: ",
      pass_mismatch:"Le password non coincidono.",
      pass_short:"Password troppo corta (min 8).",
      nav_dash:"Dashboard",
      nav_acc:"Account",
      nav_help:"Aiuto",
    },
    en:{
      language:"Language",
      account:"Account",
      change_email:"Change email",
      change_password:"Change password",
      email_hint:"Enter the new email. You may receive a confirmation email (depending on auth settings).",
      pass_hint:"Choose a secure password (at least 8 characters). If you‚Äôre logged in, the update is immediate.",
      new_email:"New email",
      update_email:"Update email",
      email_ok:"‚úÖ Email updated. Check your inbox for any confirmation.",
      new_pass:"New password",
      repeat_pass:"Repeat password",
      update_pass:"Update password",
      pass_ok:"‚úÖ Password updated.",
      err_prefix:"‚ùå Error: ",
      pass_mismatch:"Passwords do not match.",
      pass_short:"Password too short (min 8).",
      nav_dash:"Dashboard",
      nav_acc:"Account",
      nav_help:"Help",
    },
    fr:{
      language:"Langue",
      account:"Compte",
      change_email:"Changer l‚Äôemail",
      change_password:"Changer le mot de passe",
      email_hint:"Saisissez le nouvel email. Un email de confirmation peut √™tre envoy√© (selon la config).",
      pass_hint:"Choisissez un mot de passe s√ªr (au moins 8 caract√®res). Si vous √™tes connect√©, la mise √† jour est imm√©diate.",
      new_email:"Nouvel email",
      update_email:"Mettre √† jour l‚Äôemail",
      email_ok:"‚úÖ Email mis √† jour. V√©rifiez votre bo√Æte mail pour confirmer si n√©cessaire.",
      new_pass:"Nouveau mot de passe",
      repeat_pass:"R√©p√©ter le mot de passe",
      update_pass:"Mettre √† jour le mot de passe",
      pass_ok:"‚úÖ Mot de passe mis √† jour.",
      err_prefix:"‚ùå Erreur : ",
      pass_mismatch:"Les mots de passe ne correspondent pas.",
      pass_short:"Mot de passe trop court (min 8).",
      nav_dash:"Tableau",
      nav_acc:"Compte",
      nav_help:"Aide",
    },
    es:{
      language:"Idioma",
      account:"Cuenta",
      change_email:"Cambiar email",
      change_password:"Cambiar contrase√±a",
      email_hint:"Introduce el nuevo email. Puede que recibas un correo de confirmaci√≥n (seg√∫n configuraci√≥n).",
      pass_hint:"Elige una contrase√±a segura (m√≠nimo 8 caracteres). Si est√°s logueado, el cambio es inmediato.",
      new_email:"Nuevo email",
      update_email:"Actualizar email",
      email_ok:"‚úÖ Email actualizado. Revisa tu bandeja por si hay confirmaci√≥n.",
      new_pass:"Nueva contrase√±a",
      repeat_pass:"Repite la contrase√±a",
      update_pass:"Actualizar contrase√±a",
      pass_ok:"‚úÖ Contrase√±a actualizada.",
      err_prefix:"‚ùå Error: ",
      pass_mismatch:"Las contrase√±as no coinciden.",
      pass_short:"Contrase√±a demasiado corta (m√≠n 8).",
      nav_dash:"Panel",
      nav_acc:"Cuenta",
      nav_help:"Ayuda",
    }
  };

  function t(k){ return (TR[currentLang] && TR[currentLang][k]) || TR.en[k] || k; }
  function normLang(l){
    const s=(l||"").toLowerCase();
    if (s.startsWith("it")) return "it";
    if (s.startsWith("fr")) return "fr";
    if (s.startsWith("es")) return "es";
    return "en";
  }

  function setLang(lang, persist=true){
    currentLang = SUPPORTED.includes(normLang(lang)) ? normLang(lang) : "en";
    document.documentElement.lang = currentLang;
    if (persist){
      localStorage.setItem("wf_lang", currentLang);
      if (RESTAURANT_ID) localStorage.setItem(`wf_lang_${RESTAURANT_ID}`, currentLang);
    }
    applyTranslations();
  }

  function applyTranslations(){
    document.title = `Wine in App - ${t("account")}`;
    document.getElementById("pageTitle").textContent = t("account");
    document.getElementById("langLabel").textContent = t("language");
    document.getElementById("tabEmail").textContent = t("change_email");
    document.getElementById("tabPass").textContent  = t("change_password");
    document.getElementById("emailHint").textContent = t("email_hint");
    document.getElementById("passHint").textContent  = t("pass_hint");
    document.getElementById("newEmailLbl").textContent = t("new_email");
    document.getElementById("saveEmailBtn").textContent = t("update_email");
    document.getElementById("emailOk").textContent = t("email_ok");
    document.getElementById("newPassLbl").textContent = t("new_pass");
    document.getElementById("newPass2Lbl").textContent = t("repeat_pass");
    document.getElementById("savePassBtn").textContent = t("update_pass");
    document.getElementById("passOk").textContent = t("pass_ok");
    document.getElementById("navDash").textContent = t("nav_dash");
    document.getElementById("navAcc").textContent  = t("nav_acc");
    document.getElementById("navHelp").textContent = t("nav_help");
    const sel = document.getElementById("langSelect");
    if (sel) sel.value = currentLang;
  }

  function goTo(path){
    const qs = new URLSearchParams();
    if (RESTAURANT_ID) qs.set("ristorante_id", RESTAURANT_ID);
    qs.set("lang", currentLang);
    window.location.href = `${path}?${qs.toString()}`;
  }

  function showTab(tabId){
    document.getElementById("emailTab").style.display = (tabId==="emailTab") ? "block":"none";
    document.getElementById("passTab").style.display  = (tabId==="passTab") ? "block":"none";
    document.querySelectorAll(".pill-btn").forEach(b => b.classList.toggle("active", b.dataset.tab===tabId));
  }

  function resetMsgs(){
    ["emailOk","emailErr","passOk","passErr"].forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.style.display="none";
      if (id.endsWith("Err")) el.textContent = t("err_prefix");
    });
  }

  async function requireUser(){
    const { data:{ user } } = await sb.auth.getUser();
    if (!user) { window.location.href="/"; return null; }
    return user;
  }

  document.addEventListener("DOMContentLoaded", async () => {
    const user = await requireUser();
    if (!user) return;

    const urlParams = new URLSearchParams(window.location.search);
    RESTAURANT_ID = urlParams.get("ristorante_id") || user.id;

    const saved = localStorage.getItem(`wf_lang_${RESTAURANT_ID}`) || localStorage.getItem("wf_lang") || normLang(navigator.language);
    const qpLang = urlParams.get("lang");
    setLang(qpLang || saved, true);

    document.getElementById("tabs").querySelectorAll(".pill-btn").forEach(btn=>{
      btn.addEventListener("click", ()=> { resetMsgs(); showTab(btn.dataset.tab); });
    });

    document.getElementById("langSelect").addEventListener("change", (e)=> setLang(e.target.value, true));

    document.getElementById("saveEmailBtn").addEventListener("click", async () => {
      resetMsgs();
      const email = (document.getElementById("newEmail").value || "").trim();
      if (!email) return;

      const { error } = await sb.auth.updateUser({ email });
      if (error){
        const e = document.getElementById("emailErr");
        e.textContent = t("err_prefix") + (error.message || "Unknown");
        e.style.display="block";
        return;
      }
      document.getElementById("emailOk").style.display="block";
    });

    document.getElementById("savePassBtn").addEventListener("click", async () => {
      resetMsgs();
      const p1 = document.getElementById("newPass").value || "";
      const p2 = document.getElementById("newPass2").value || "";
      if (p1.length < 8){
        const e = document.getElementById("passErr");
        e.textContent = t("err_prefix") + t("pass_short");
        e.style.display="block";
        return;
      }
      if (p1 !== p2){
        const e = document.getElementById("passErr");
        e.textContent = t("err_prefix") + t("pass_mismatch");
        e.style.display="block";
        return;
      }
      const { error } = await sb.auth.updateUser({ password: p1 });
      if (error){
        const e = document.getElementById("passErr");
        e.textContent = t("err_prefix") + (error.message || "Unknown");
        e.style.display="block";
        return;
      }
      document.getElementById("passOk").style.display="block";
      document.getElementById("newPass").value = "";
      document.getElementById("newPass2").value = "";
    });
  });
</script>
</body>
</html>
