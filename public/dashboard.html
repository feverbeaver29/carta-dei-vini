<!DOCTYPE html>
<html lang="it">
<head>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Wine in App</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600&family=Playfair+Display:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.42.3/dist/umd/supabase.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
* { box-sizing: border-box; }
:root{
  --bg: #F7F4EF;            /* fondo caldo, elegante */
  --card: #FFFFFF;          /* card */
  --text: #1F2937;          /* quasi nero */
  --muted: #6B7280;         /* grigio testi secondari */
  --border: #E6E2DA;        /* bordi morbidi */

  --accent: #6B1E2B;        /* vino scuro (premium) */
  --accent-700: #4C1420;    /* hover/active */
  --accent-soft: #F3E7E9;   /* pill ‚Äúsoft‚Äù */

  --radius: 18px;
  --radius-pill: 999px;
  --shadow: 0 10px 30px rgba(17,24,39,.08);
  --content: 980px;
}

.switch {
  position: relative;
  display: inline-block;
  width: 48px;
  height: 26px;
}
.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}
.slider {
  position: absolute;
  cursor: pointer;
  top: 0; left: 0;
  right: 0; bottom: 0;
  background-color: #ccc;
  transition: 0.4s;
  border-radius: 34px;
}
.slider:before {
  position: absolute;
  content: "";
  height: 20px;
  width: 20px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: 0.4s;
  border-radius: 50%;
}
input:checked + .slider {
  background-color: #4CAF50; /* verde attivo */
}
input:checked + .slider:before {
  transform: translateX(22px);
}

.row-toggle {
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  max-width: 400px;
}

.mockup iframe {
  width: 100%;
  height: 100%;
  border: none;
  display: block;
}

html, body {
  height: 100%;
  margin: 0;
  padding: 0;
  display: flex;
  flex-direction: column;
  font-family: 'Segoe UI', sans-serif;
  background-color: var(--bg);
color: var(--text);
  overflow-x: hidden;
}

body {
  flex: 1 0 auto;
}

input[type="color"] {
  height: 24px;
  width: 32px;
}
input[type="range"] {
  height: 18px;
}

.mini-save-btn {
  background-color: var(--accent);
  color: white;
  padding: 6px 14px;
  border: none;
  border-radius: 16px;
  font-size: 0.85em;
  margin-top: 12px;
  cursor: pointer;
}
.mini-save-btn:hover {
  background-color: var(--accent-700);
}

#checkSlugBtn{
  padding: 5px 10px;
  font-size: 0.82em;
  margin-top: 8px;
}
#slugPreview{
  font-size: 0.85em;
  margin-top: 6px;
}

.page-title {
  background: #fff;
  text-align: center;
  padding: 0.8em 1em;
  border-bottom: 1px solid #ddd;
}
.page-title h1 {
  font-size: 1.2em;
  font-weight: bold;
  font-family: 'Playfair Display', serif;
  color: #333;
  letter-spacing: 0.4px;
  margin: 0;
}

main {
  flex-grow: 1;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  max-width: var(--content);
  margin: auto;
  padding: 80px 20px 60px;
  gap: 40px;
  width: 100%;
padding-left: 16px;
padding-right: 16px;
padding-bottom: calc(90px + env(safe-area-inset-bottom)); /* spazio per bottom bar */
}

.section {
  display: flex;
  flex-wrap: wrap;
  gap: 40px;
}
    #sommelierSettings label {
      margin-top: 8px;
      margin-bottom: 4px;
      font-size: 0.95em;
    }
    #sommelierSettings select,
    #sommelierSettings input[type="text"],
    #sommelierSettings input[type="file"] {
      padding: 6px 10px;
      font-size: 0.95em;
      border-radius: 6px;
    }

#boostContainer {
        min-height: 120px;
      display: flex;
      flex-direction: column;
      gap: 10px;
}

#boostContainer input[type="text"] {
  display: block;
  width: 100%;
  margin-bottom: 0;
}


label {
  display: block;
  margin-top: 12px;
  margin-bottom: 4px;
  font-size: 1em;
}

input[type="text"], select {
  width: 100%;
  max-width: 400px;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
  margin-top: 5px;
}
.palette-option {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-top: 8px;
}
.color-box {
  width: 16px;
  height: 16px;
  border-radius: 3px;
}
.default-avatar {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid transparent;
  cursor: pointer;
  transition: border 0.2s ease;
}
.default-avatar.selected {
  border: 3px solid #b00;
  box-shadow: 0 0 4px rgba(255, 0, 0, 0.3);
}

.logo-preview {
  margin-top: 10px;
  max-height: 60px;
}

.mockup {
  border: 1px solid var(--border);
  border-radius: var(--radius);
  width: min(360px, 92vw);
  height: min(640px, 70vh);
  background: white;
  overflow: hidden;
  box-shadow: var(--shadow);
  margin-bottom: 140px; /* spazio fisso per il footer */
}

.save-btn {
  margin-top: 30px;
  background-color: var(--accent);
  color: white;
  padding: 15px 30px;
  border: none;
  border-radius: 25px;
  font-size: 1.1em;
  cursor: pointer;
}
.save-btn:hover {
  background-color: var(--accent-700);
}

footer {
  text-align: center;
  font-size: 0.9em;
  color: #999;
  padding: 20px;
  margin-top: auto;
}

#qrPopup {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0,0,0,0.6);
  justify-content: center;
  align-items: center;
  z-index: 2000;
}
#qrPopupContent {
  background: #fff;
  padding: 20px;
  border-radius: 16px;
  text-align: center;
}
#qrPopupContent button {
  margin-top: 10px;
  background-color: var(--accent);
  color: white;
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}
#qrPopupContent button:hover {
  background-color: var(--accent-700);
}
#titoloCartaVini {
  text-align: center;
  font-size: 1.4em;
  margin: 0 auto 1em auto;
  padding: 0;
  font-family: 'Playfair Display', serif;
  font-weight: 600;
  color: #333;
  width: 100%;
  max-width: 100%;
  display: block;
}
/* --- Slug: layout & compact --- */
.slug-row {
  display: flex;
  align-items: center;
  gap: 8px;
  max-width: 100%;
}
.slug-row input[type="text"] {
  flex: 1 1 auto;
  max-width: none;
  padding: 6px 8px;
  font-size: 0.9em;
}
.slug-row button {
  flex: 0 0 auto;
  width: auto; /* evita il width:100% globale dei bottoni */
}
#accNomeLogo label[for="slugInput"]{
  font-size: 0.85em;
  margin-top: 6px !important;
  margin-bottom: 2px !important;
}

/* testi compatti */
.slug-help { display:block; color:#555; margin-top:4px; font-size:0.70em; }
.slug-status { margin-top:4px; font-size:0.9em; }
.slug-preview { margin-top:6px; font-size:0.9em; color:#333; }

/* compattiamo l'intero blocco "Nome o Logo" */
.impostazione .accordion-content{
  padding: 6px 10px;
}

.impostazione label{
  margin-top: 6px;
  margin-bottom: 3px;
  font-size: 0.92em;
}

.impostazione input[type="text"],
.impostazione select{
  padding: 7px 9px;
  font-size: 0.95em;
}

#accOrdina .mini-save-btn{
  padding: 6px 12px;
  font-size: 0.85em;
  margin-top: 8px;
}

.file-field{
  display:flex;
  align-items:center;
  gap:10px;
  justify-content:flex-start;   /* ‚úÖ bottone a sinistra */
  flex-wrap:nowrap;             /* ‚úÖ nome a destra */
  margin-top: 6px;
}
.file-btn{
  background: #E5E7EB;          /* grigio */
  color: #111827;
  border: 1px solid #D1D5DB;
  border-radius: 14px;
  padding: 6px 10px;
  cursor:pointer;
  font-size: 0.85em;
  text-align: center;
  width: fit-content;
flex: 0 0 auto;
white-space: nowrap;
}
.file-btn:hover{ background: #DDE1E6; }
.file-name{
  color: var(--muted);
  font-size: 0.9em;
  flex: 1 1 auto;               /* ‚úÖ prende lo spazio a destra */
  max-width: none;              /* ‚úÖ lascia che si allarghi */
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
  min-width: 0;
}

/* mobile: impediamo ai bottoni di occupare tutta la riga in quest'area */
@media (max-width:768px) {
  .slug-row { flex-wrap: wrap; }
  .slug-row input[type="text"] { flex: 1 1 100%; }
  .slug-row button { width: auto !important; }
  /* riduciamo ancora un filo spazi e dimensioni */
  .impostazione .accordion-content { padding: 6px 10px; }
  .mini-save-btn { padding: 6px 12px; font-size: 0.85em; }
  .file-btn{
    padding: 5px 8px;
    font-size: 0.78em;
    border-radius: 12px;
  }
  #cartaQuickActions{
    justify-content: center !important;  /* invece di flex-start */
    padding-left: 0 !important;
    padding-right: 0 !important;
    overflow-x: visible !important;      /* non serve scroll: sono solo 3 */
  }
}


@media (max-width: 768px) {
  #titoloCartaVini {
  font-size: 1.1em;
  margin-bottom: 12px;
  }

.accordion:last-child {
  margin-bottom: 0 !important;
  padding-bottom: 0 !important;
}
.accordion-header:hover {
  background-color: #f9f9f9;
}

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(-4px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Navigazione e struttura */
  .desktop-nav,
  nav.desktop {
    display: none !important;
  }

  .mobile-nav-toggle {
    display: block;
  }

  main {
    padding: 18px 16px calc(90px + env(safe-area-inset-bottom));
  }

  /* Griglie e layout */
.dashboard-grid {
  display: flex;
  flex-direction: column;
  align-items: stretch; /* invece di center */
  padding-left: 0;
  padding-right: 0;
  padding-top: 0.25em;
  padding-bottom: 0.25em;
  gap: 0.25em;
}

  .dashboard-grid label {
    margin-top: 12px;
    font-size: 1em;
    text-align: center;
  }

  .dashboard-grid select,
  .dashboard-grid input[type="text"],
  .dashboard-grid input[type="file"],
  .dashboard-grid button:not(.file-btn) {
    width: 100%;
    max-width: 100%;
    font-size: 1em;
    margin-bottom: 0.4em;
    text-align: center;
  }

  .dashboard-grid h2 {
    max-width: 360px;
    margin: 0.4em auto 0.6em auto;
    font-size: 1.05em;
    text-align: center;
  }

#impostazioniCarta {
  margin-bottom: 0 !important;
  padding-bottom: 0 !important;
  gap: 0 !important; /* importantissimo */
}
  #sommelierSettings {
    display: none;
    padding: 0 1em;
  }

  #sommelierSettings.active {
    display: block;
  }

#impostazioniSommelier {
  padding: 0;
  display: flex;
  flex-direction: column;
  gap: 12px;

  /* ‚úÖ centra la colonna */
  align-items: center;
  width: 100%;
}

/* ‚úÖ ogni ‚Äúriga‚Äù dentro sommelier resta centrata e con larghezza controllata */
#impostazioniSommelier > * {
  width: 100%;
  max-width: 420px;
}

  #boostContainer {
    display: block;
    min-height: 100px;
    padding-top: 6px;
  }

  #boostContainer input[type="text"] {
    display: block;
    margin-bottom: 12px;
  }

  /* Mockup */
  .mockup {
    width: 100%;
    max-width: 360px;
    height: 450px;
    margin-top: 10px !important; /* prima era 1em (16px) */
  margin-bottom: 140px;
  }

  #mockupWrapper {
    margin-top: 6px !important;
    width: 100%;
    display: flex;
    justify-content: center;
    overflow-x: hidden;
  }
  #cartaSection {
  gap: 6px !important;
  flex-direction: column;
  align-items: center;
  }

  #impostazioniCarta{
    width: 100%;
  }

  /* ‚úÖ i ‚Äúrettangoli‚Äù (accordion-content) devono prendere tutta la larghezza */
  #impostazioniCarta .accordion.open .accordion-content{
    width: 100%;
  }
}

/* Extra small screens */
@media (max-width: 480px) {
  header h1 {
    font-size: 1em;
  }
  nav button {
    font-size: 0.75em;
    padding: 6px 10px;
  }
  .save-btn {
    padding: 8px 16px;
    font-size: 0.95em;
  }
  .mockup {
    height: 60vh;
    margin-top: 1em;
  }
}

/* Desktop layout */
@media (min-width: 769px) {
  .accordion-header .accordion-icon {
  display: none;
}
  .desktop-nav button:hover {
    background-color: var(--accent);
    color: #fff;
  }

#cartaSection {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 40px;
}

#impostazioniCarta {
  flex: 1;
  max-width: 700px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

#cartaSection {
  align-items: center;
}

  #mockupWrapper {
    width: 360px;
    flex-shrink: 0;
      min-width: 360px; /* ‚úÖ impedisce di stringersi */
  }
  .mockup {
    margin-top: 0;
    margin-bottom: 0;
  }
#sommelierSettings {
  display: none;
}
#sommelierSettings.active {
  display: flex !important;
  flex-direction: row;
  align-items: flex-start;
  justify-content: center;
  gap: 40px;
  max-width: 1200px;
  margin: auto;
  padding: 60px 20px;
  margin-top: -40px;
}

#sommelierSection {
  display: flex;
  flex-direction: row;
  gap: 40px;
  max-width: 1200px;
  width: 100%;
  justify-content: space-between;
}

#impostazioniSommelier {
  flex: 1;
  max-width: 700px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

#impostazioniSommelier h2 {
  text-align: center;
  font-size: 1.4em;
  font-family: 'Playfair Display', serif;
  font-weight: 600;
  color: #333;
  margin: 0 auto 1em auto;
}

  main.sommelier-mode {
    padding-top: 15px; /* Ridotto rispetto agli 80px normali */
  }
}

/* Animazioni */
@keyframes slideDownFade {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ============================
   NUOVO LAYOUT (stile Canva)
   ============================ */

.settings-actions{
  display:flex;
  gap:8px;
  flex-wrap:nowrap;              /* sempre in riga */
  overflow-x:auto;               /* scroll orizzontale se serve */
  -webkit-overflow-scrolling: touch;
  padding: 6px 2px 14px;
  justify-content:flex-start;    /* ‚úÖ non center: evita tagli ai bordi */
  scroll-snap-type: x mandatory; /* ‚úÖ ‚Äúsnap‚Äù pi√π bello */
  padding-left: 8px;
  padding-right: 8px;
}
.settings-actions::-webkit-scrollbar{ display:none; }

.pill-btn{
  background: var(--card);
  color: var(--text);
  border: 1px solid var(--border);
  padding: 10px 14px;
  border-radius: var(--radius-pill);
  font-size: 0.92em;
  cursor: pointer;
  white-space: nowrap;
  box-shadow: 0 6px 18px rgba(17,24,39,.06);
}
.pill-btn:hover{
  border-color: rgba(107,30,43,.35);
}
.pill-btn.active{
  background: var(--accent-soft);
  color: var(--accent);
  border-color: rgba(107,30,43,.35);
}
@media (max-width: 420px){
  .pill-btn{
    padding: 8px 10px;     /* ‚úÖ pi√π strette */
    font-size: 0.82em;     /* ‚úÖ testo pi√π piccolo */
    box-shadow: none;      /* ‚úÖ meno ‚Äúpeso‚Äù visivo */
  }
  .settings-actions{
    gap:6px;
  }
  .pill-btn{
    scroll-snap-align: start; /* ‚úÖ ogni pill ‚Äúaggancia‚Äù */
  }
}


#impostazioniCarta .accordion-header{ display:none !important; }

#impostazioniCarta .accordion-content{
  display:none;
  max-height:0;
  overflow:hidden;
  transition: max-height .35s ease, padding .35s ease;
  padding: 0 12px !important;
}
#impostazioniCarta .accordion.open .accordion-content{
  display:block;
  max-height: 4000px;
  padding: 12px !important;
  border: 1px solid #eee;
  border-radius: 16px;
  background: #fff;
  box-shadow: 0 8px 22px rgba(17,24,39,.06);
border-color: var(--border);
}

.bottom-nav{
  position: fixed;
  left: 50%;
transform: translateX(-50%);
bottom: 10px;
width: min(100% - 20px, var(--content));
  backdrop-filter: blur(10px);
  display:flex;
  justify-content: space-around;
  padding: 8px 6px calc(8px + env(safe-area-inset-bottom));
  z-index: 1800;
  border: 1px solid var(--border);
border-radius: 22px;
box-shadow: var(--shadow);
background: rgba(255,255,255,.92);
}
.bottom-nav .bn-item{
  background: transparent;
  border: none;
  display:flex;
  flex-direction: column;
  align-items:center;
  gap:4px;
  cursor:pointer;
  color:#333;
  font-size:0.72em;
  padding: 6px 8px;
  border-radius: 14px;
}
.bottom-nav .bn-item .icon{ font-size:1.2em; line-height:1; }
.bottom-nav .bn-item.active{ color: var(--accent); background: rgba(107,30,43,.08); }

.more-menu{
  position: fixed;
  right: 10px;
  bottom: calc(72px + env(safe-area-inset-bottom));
  background:#fff;
  border:1px solid #eee;
  border-radius:16px;
  box-shadow: 0 12px 30px rgba(0,0,0,0.12);
  display:none;
  flex-direction: column;
  min-width: 220px;
  overflow:hidden;
  z-index: 1900;
}
.more-menu.show{
  display:flex;
  animation: slideUpFade .18s ease-out;
}
.more-menu button{
  width:100%;
  text-align:left;
  padding: 12px 14px;
  background:#fff;
  border:0;
  border-bottom:1px solid #f1f1f1;
  font-size:0.95em;
  cursor:pointer;
}
.more-menu button:last-child{ border-bottom:0; }
.more-menu button:hover{ background:#fafafa; }

@keyframes slideUpFade{
  from{ opacity:0; transform: translateY(8px); }
  to{ opacity:1; transform: translateY(0); }
}
.page-title{
  background:#fff;
  border-bottom:1px solid #ddd;
  padding: 10px 14px;
  text-align: left; /* non pi√π center */
}

.topbar{
  max-width: var(--content);
  margin: 0 auto;
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 12px;
}

.lang-switch{
  display:flex;
  align-items:center;
  gap: 8px;
}

@media (max-width: 520px){
  .topbar{
    flex-wrap: nowrap;              /* ‚úÖ non va a capo */
    justify-content: space-between; /* ‚úÖ titolo a sinistra, lingua a destra */
    align-items: center;
  }

  #ristoranteName{
    width: auto;                    /* ‚úÖ non 100% */
    text-align: left;
    flex: 1 1 auto;
    min-width: 0;                   /* ‚úÖ evita overflow */
    font-size: 1.05em;
  }

  .lang-switch{
    width: auto;                    /* ‚úÖ non 100% */
    justify-content: flex-end;
    flex: 0 0 auto;
    gap: 6px;
  }

  /* opzionale: compattiamo leggermente select su schermi piccoli */
  #langSelect{
    padding: 6px 8px;
    font-size: 0.9em;
  }
  #langLabel{
    font-size: 0.9em;
    white-space: nowrap;
  }
}

  </style>
</head>
<body>
  <div class="page-title">
  <div class="topbar">
    <h1 id="ristoranteName">Nome Ristorante - Dashboard</h1>

    <div class="lang-switch" aria-label="Language selector">
      <label id="langLabel" for="langSelect">Lingua</label>
      <select id="langSelect">
        <option value="it">Italiano</option>
        <option value="en">English</option>
        <option value="fr">Fran√ßais</option>
        <option value="es">Espa√±ol</option>
      </select>
      </div>
  </div>
</div>

<main>
  <!-- SEZIONE IMPOSTAZIONI CARTA -->
  <div id="cartaSettings">
    <h2 id="titoloCartaVini">Impostazioni Carta dei Vini</h2>
<div class="settings-actions" id="cartaQuickActions">
  <button type="button" class="pill-btn active" data-target="accNomeLogo">Nome o Logo</button>
  <button type="button" class="pill-btn" data-target="accStile">Stile carta</button>
  <button type="button" class="pill-btn" data-target="accOrdina">Ordina le voci</button>
</div>

    <div class="section" id="cartaSection">
      <!-- Colonna sinistra: impostazioni -->
      <div id="impostazioniCarta" class="dashboard-grid">
        <!-- BLOCCO: Nome o Logo -->
        <div class="impostazione accordion" id="accNomeLogo">
          <h3 class="accordion-header">Nome o Logo <span class="accordion-icon">+</span></h3>
          <div class="accordion-content">
        <!-- URL pubblico (slug) -->
        <label for="slugInput" style="margin-top:10px;">URL pubblico</label>
        <div class="slug-row">
          <input type="text" id="slugInput">
        <small id="slugHelp" class="slug-help">
          Solo lettere, numeri e trattini. Esempio: <code>ristorante-mario-rossi</code>
        </small>
        </div>
          <button type="button" id="checkSlugBtn" class="mini-save-btn">Controlla</button>
        <div id="slugStatus" class="slug-status"></div>

        <!-- Anteprima URL -->
        <div id="slugPreview" class="slug-preview">
          URL: <span id="slugPreviewUrl">https://www.wineinapp.com/</span>
        </div>
            <label for="displayName">Nome da visualizzare</label>
            <input type="text" id="displayName">
            <div id="nameOptions">
              <label>Font Nome:
                <select id="nameFont">
                  <option value="Edu NSW ACT Hand Pre">Corsivo a mano</option>
                  <option value="sans-serif">Sans Serif</option>
                  <option value="Lavishly Yours">Calligrafico</option>
                  <option value="cursive">Cursive</option>
                  <option value="monospace">Monospace</option>
                  <option value="Kolker Brush">Pennello</option>
                  <option value="custom">Altri font...</option>
                </select>
              </label>
              <label>Dimensione Nome:
                <input type="range" id="nameSize" min="20" max="40" value="24"> px
              </label>
              <label>Colore Nome:
                <input type="color" id="nameColor" value="#000000">
              </label>
              <label><input type="checkbox" id="nameBold"> Grassetto</label>
            </div>
            <label for="logoUpload" id="logoUploadLabel">oppure carica il logo del tuo ristorante</label>

            <div class="file-field" id="logoFileField">
              <input type="file" id="logoUpload" accept="image/*" hidden>
              <button type="button" class="file-btn" id="logoChooseBtn"></button>
              <span class="file-name" id="logoFileName"></span>
            </div>
            <div id="logoOptions" style="display: none; margin-top: 12px;">
              <label>Dimensione Logo:
                <input type="range" id="logoSize" min="30" max="120" value="40"> px
              </label>
            </div>
            <button class="mini-save-btn" onclick="saveSettings()">Salva</button>
          </div>
        </div>

        <!-- BLOCCO: Stile Carta -->
        <div class="impostazione accordion" id="accStile">
          <h3 class="accordion-header">Stile carta dei vini<span class="accordion-icon">+</span></h3>
          <div class="accordion-content">
            <label for="fontSelector">Font principale</label>
            <select id="fontSelector">
              <option value="Arial" style="font-family: Arial;">Arial</option>
              <option value="Montserrat" style="font-family: Montserrat;">Montserrat</option>
              <option value="Raleway" style="font-family: Raleway;">Raleway</option>
              <option value="Dancing Script" style="font-family: 'Dancing Script';">Dancing Script</option>
              <option value="Playfair Display" style="font-family: 'Playfair Display';">Playfair Display</option>
              <option value="custom">Altri font...</option>
            </select>

            <label for="paletteSelector">Palette Colori</label>
            <div class="palette-option">
              <select id="paletteSelector">
                <option value="rosso" data-palette="rosso">Rosso</option>
                <option value="oro" data-palette="oro">Oro</option>
                <option value="blu-elegante" data-palette="blu-elegante">Blu Elegante</option>
                <option value="verde-salvia" data-palette="verde-salvia">Verde Salvia</option>
                <option value="grigio-minimal" data-palette="grigio-minimal">Grigio Minimal</option>
                <option value="crema-nero" data-palette="crema-nero">Crema & Nero Elegante</option>
                <option value="black-white" data-palette="black-white">Black & White</option>
                <option value="tortora" data-palette="tortora">tortora</option>
                <option value="vino-rosso" data-palette="vino-rosso">vino-rosso</option>
                <option value="notte-blu" data-palette="notte-blu">notte-blu</option>
                <option value="tramonto" data-palette="tramonto">tramonto</option>
              </select>
            </div>

            <button class="mini-save-btn" onclick="saveSettings()">Salva</button>
          </div>
        </div>

        <div id="saveMessage" style="margin-top: 10px; color: green; display: none;">
          ‚úÖ Impostazioni salvate con successo
        </div>

        <!-- BLOCCO: Ordina Voci -->
        <div class="impostazione accordion" id="accOrdina">
          <h3 class="accordion-header">Ordina le voci<span class="accordion-icon">+</span></h3>
          <div class="accordion-content">
            <div>
              <button class="mini-save-btn" id="ordinaCategorieBtn" onclick="toggleReorder('categorie')">Ordina Categorie</button>
              <button class="mini-save-btn" id="ordinaSottocategorieBtn" onclick="toggleReorder('sottocategorie')">Ordina Sottocategorie</button>
            </div>
            <label for="wineOrder">Ordina i vini per:</label>
            <select id="wineOrder">
              <option value="prezzo">Prezzo</option>
              <option value="annata">Annata</option>
              <option value="nome">Alfabetico</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Colonna destra: anteprima -->
      <div id="mockupWrapper">
        <div class="mockup">
          <iframe id="previewFrame"></iframe>
        </div>
      </div>
    </div>
  </div>

  <div id="sommelierSettings" class="section">
  <div id="sommelierSection" class="section">
    <div id="impostazioniSommelier" class="dashboard-grid">
    <h2>Impostazioni Sommelier Virtuale</h2>

    <div class="row-toggle">
  <label for="toggleSommelierBtn" style="font-size: 0.95em;"><strong>Abilita sommelier virtuale</strong></label>
  <label class="switch">
    <input type="checkbox" id="toggleSommelierBtn">
    <span class="slider"></span>
  </label>
</div>

<label id="sommelierLogoTitle"><strong>Logo del sommelier</strong></label>
<small style="text-align: center; display: block; font-family: 'Cormorant Garamond', serif; font-size: 0.85em; margin-top: -4px;">
  Scegli tra i nostri sommelier
</small>

<!-- scelta default -->
<div id="defaultSommelierChoice" style="display: flex; gap: 12px; justify-content: center; margin: 12px 0;">
  <input type="hidden" id="sommelierGender" value="uomo">
  <img src="sommelier.png" alt="Sommelier Uomo" class="default-avatar" onclick="selezionaDefaultSommelier('uomo')">
  <img src="sommelier_femmina.png" alt="Sommelier Donna" class="default-avatar" onclick="selezionaDefaultSommelier('donna')">
</div>

<!-- o logo personalizzato -->
<div style="display: flex; align-items: center; gap: 6px;">
  <label for="sommelierLogoUpload" style="margin-top: 4px;">oppure carica un logo personalizzato</label>
  <span id="lockIcon" title="Disponibile solo per utenti PRO" style="font-size: 1em; color: var(--accent);; cursor: pointer;">üîí</span>
</div>
<input type="file" id="sommelierLogoUpload" accept="image/*" hidden>

<div class="file-field" id="sommelierFileField">
  <button type="button" class="file-btn" id="sommelierChooseBtn"></button>
  <span class="file-name" id="sommelierFileName"></span>
</div>
<div id="proTooltip" style="display: none; font-size: 0.85em; margin-top: 4px; color: #555;">
  üîí Disponibile solo per utenti <strong>PRO</strong>. 
  <a href="#" id="upgradeLink" style="color:#b00; text-decoration:underline;">Passa ora al piano superiore</a>
</div>

      <label for="sommelierRange"><strong>Numero di vini da consigliare</strong></label>
      <select id="sommelierRange">
        <option value="1-3">Da 1 a 3</option>
        <option value="3-5">Da 3 a 5</option>
        <option value="5-7">Da 5 a 7</option>
      </select>

      <label id="boostWinesLabel"><strong>Vini da spingere in carta</strong></label>
      <div id="boostContainer"></div>

<div style="position: relative; display: inline-flex; align-items: center; gap: 8px; margin-top: 6px;">
  <button id="addBoostBtn" type="button" onclick="addBoostInput()" style="
    background: transparent;
    color: var(--accent);
    border: 1px solid var(--accent);
    border-radius: 20px;
    padding: 6px 14px;
    font-size: 0.9em;
    cursor: pointer;
    transition: 0.3s;
  ">+ Aggiungi vino da spingere</button>
  <span id="boostLockIcon" title="Solo per utenti PRO" style="cursor: pointer; color: var(--accent); font-size: 1.2em;">üîí</span>
</div>
<div id="boostLockTooltip" style="display: none; font-size: 0.85em; margin-top: 4px; color: #555;">
  üîí Solo per utenti <strong>PRO</strong>. 
  <a href="abbonamento.html" id="boostUpgradeLink" style="color:#b00; text-decoration:underline;">Passa ora al piano superiore</a>
</div>

      <button class="save-btn" style="margin-top: 16px;" onclick="saveSommelierSettings()">Salva Impostazioni Sommelier</button>
    </div>
  </div>
  </div>
</main>

  <!-- POPUP SELEZIONE FONT -->
<div id="fontPopup" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.6); z-index:1000; justify-content:center; align-items:center;">
  <div style="background:white; padding:20px; border-radius:12px; max-width:90vw; max-height:80vh; overflow:auto;">
    <h3 style="margin-top:0;">Scegli un font</h3>
    <div id="fontChoices" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(140px, 1fr)); gap:15px;"></div>
    <button onclick="document.getElementById('fontPopup').style.display='none'" style="margin-top:20px;">Chiudi</button>
  </div>
</div>

<!-- Popup QR -->
<div id="qrPopup">
  <div id="qrPopupContent">
    <div id="qrCodeContainer"></div>
    <button id="downloadQr">Scarica QR Code</button>
  </div>
</div>


<!-- Popup Abbonamento non attivo -->
<div id="subPopup" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:1200; align-items:center; justify-content:center; padding:18px;">
  <div style="max-width:520px; width:100%; background:#fff; border-radius:18px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.25); text-align:center;">
    <div id="subPopupTitle" style="font-size:20px; font-weight:700; margin-bottom:6px;">Carta non disponibile</div>
    <div id="subPopupMsg" style="font-size:14px; color:#555; line-height:1.4; margin-bottom:14px;">
      Il ristorante non ha un abbonamento attivo.
    </div>
    <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
      <button id="subPopupClose" type="button" style="padding:10px 14px; border-radius:12px; border:1px solid #ddd; background:#fafafa; cursor:pointer; font-weight:600;">Chiudi</button>
      <button id="subPopupReactivate" type="button" style="padding:10px 14px; border-radius:12px; border:0; background:#b00; color:#fff; cursor:pointer; font-weight:700;">Riattiva abbonamento</button>
    </div>
  </div>
</div>
<!-- Bottom navigation (stile Canva) -->
<div id="bottomNav" class="bottom-nav">
  <button id="bnCarta" class="bn-item active" type="button" onclick="showSettings('carta')">
    <span class="icon">‚öôÔ∏è</span><span class="label">Carta</span>
  </button>
  <button id="bnSommelier" class="bn-item" type="button" onclick="showSettings('sommelier')">
    <span class="icon">üç∑</span><span class="label">Sommelier</span>
  </button>
  <button id="bnVini" class="bn-item" type="button" onclick="goTo('admin.html')">
    <span class="icon">üóÇÔ∏è</span><span class="label">Vini</span>
  </button>
  <button id="bnVista" class="bn-item" type="button" onclick="goTo('carta.html')">
    <span class="icon">üìñ</span><span class="label">Visualizza</span>
  </button>
  <button id="moreBtn" class="bn-item" type="button" aria-expanded="false" onclick="toggleMoreMenu()">
    <span class="icon">‚ãØ</span><span class="label">Altro</span>
  </button>
</div>

<!-- Menu "Altro" -->
<div id="moreMenu" class="more-menu" role="menu" aria-label="Altro">
  <button type="button" role="menuitem" onclick="showQRCode(); toggleMoreMenu(false)">Scarica QR Code</button>
  <button type="button" role="menuitem" onclick="downloadCartaPDF(); toggleMoreMenu(false)">Scarica carta in PDF</button>
  <button type="button" role="menuitem" onclick="goTo('abbonamento.html'); toggleMoreMenu(false)">Gestisci abbonamento</button>
  <button type="button" role="menuitem" onclick="logout();">Logout</button>
</div>

  <footer>¬© 2025 Wine in App - Tutti i diritti riservati</footer>
  <script>

  let sb, RESTAURANT_ID = null;
  // ==========================
  // i18n (Dashboard only)
  // ==========================
  const SUPPORTED_LANGS = ["it", "en", "fr", "es"];
  let currentLang = "it";
  window.__WF_LANG = () => currentLang;

  const TRANSLATIONS = {
    it: {
      language: "Lingua",
      dashboard_title: "{name} - Dashboard",
      restaurant_default: "Ristorante",

      settings_wine_list: "Impostazioni Carta dei Vini",
      tab_name_logo: "Nome o Logo",
      tab_style: "Stile carta",
      tab_order: "Ordina le voci",

      public_url: "URL pubblico",
      slug_help_html: "Solo lettere, numeri e trattini. Esempio: <code>ristorante-mario-rossi</code>",
      check: "Controlla",
      url_prefix: "URL:",
      display_name: "Nome da visualizzare",
      name_font: "Font Nome",
      name_size: "Dimensione Nome",
      name_color: "Colore Nome",
      bold: "Grassetto",
      or_upload_logo: "oppure carica il logo del tuo ristorante",
      logo_size: "Dimensione Logo",
      save: "Salva",

      style_wine_list: "Stile carta dei vini",
      main_font: "Font principale",
      colors_palette: "Palette Colori",
      other_fonts: "Altri font...",
      settings_saved: "‚úÖ Impostazioni salvate con successo",

      order_entries: "Ordina le voci",
      order_categories: "Ordina Categorie",
      order_subcategories: "Ordina Sottocategorie",
      order_wines_by: "Ordina i vini per:",
      order_price: "Prezzo",
      order_vintage: "Annata",
      order_alpha: "Alfabetico",
      save_order: "Salva Ordine",

      sommelier_settings: "Impostazioni Sommelier Virtuale",
      enable_virtual_sommelier: "Abilita sommelier virtuale",
      sommelier_logo: "Logo del sommelier",
      choose_our_sommeliers: "Scegli tra i nostri sommelier",
      sommelier_man_alt: "Sommelier Uomo",
      sommelier_woman_alt: "Sommelier Donna",
      or_upload_custom_logo: "oppure carica un logo personalizzato",
      pro_only_title: "Disponibile solo per utenti PRO",
      pro_only: "üîí Disponibile solo per utenti PRO.",
      pro_only_html: "üîí Disponibile solo per utenti <strong>PRO</strong>.",
      upgrade_now: "Passa ora al piano superiore",

      sub_only_title: "Disponibile solo per utenti abbonati",
      sub_only_short: "Solo per utenti abbonati",
      sub_only_html: "üîí Disponibile solo per utenti <strong>abbonati</strong>.",
      subscribe_now: "Attiva ora un abbonamento",

      sub_popup_title: "Carta non disponibile",
      sub_popup_msg: "Il ristorante non ha un abbonamento attivo.",
      reactivate_subscription: "Riattiva abbonamento",

      wines_to_recommend: "Numero di vini da consigliare",
      range_1_3: "Da 1 a 3",
      range_3_5: "Da 3 a 5",
      range_5_7: "Da 5 a 7",

      boost_wines: "Vini da spingere in carta",
      add_boost: "Aggiungi vino da spingere",
      pro_only_short: "Solo per utenti PRO",
      save_sommelier_settings: "Salva Impostazioni Sommelier",

      choose_font: "Scegli un font",
      close: "Chiudi",

      download_qr: "Scarica QR Code",
      download_pdf: "Scarica carta in PDF",
      manage_subscription: "Gestisci abbonamento",
      logout: "Logout",

      nav_card: "Carta",
      nav_sommelier: "Sommelier",
      nav_wines: "Vini",
      nav_view: "Visualizza",
      nav_more: "Altro",

      footer_rights: "¬© 2025 Wine in App - Tutti i diritti riservati",

      // Dynamic messages / alerts
      logo_preview_alt: "Anteprima Logo",
      remove_logo: "‚úï Rimuovi logo",
      logo_removed_success: "Logo rimosso con successo!",
      sommelier_logo_alt: "Logo Sommelier",
      sommelier_logo_removed: "Logo del sommelier rimosso!",
      remove: "Rimuovi",
      search_wine_placeholder: "Cerca un vino dalla tua carta",

      slug_enter: "Inserisci uno slug.",
      slug_invalid: "Formato non valido. Usa solo lettere, numeri e trattini.",
      slug_available: "Disponibile ‚úÖ",
      slug_taken: "Gi√† in uso ‚ùå Scegline un altro",
      slug_verify_error: "Impossibile verificare. Riprova.",
      slug_not_valid_alert: "Lo slug non √® valido. Usa solo lettere, numeri e trattini.",
      slug_taken_alert: "Questo URL √® gi√† in uso. Scegline un altro.",
      slug_verify_error_alert: "Impossibile verificare la disponibilit√† dello slug. Riprova.",

      sommelier_toggle_save_error: "Errore nel salvataggio dell'impostazione sommelier.",
      unsupported_format: "Formato non supportato. Usa JPG, PNG, WEBP o GIF.",
      logo_upload_error: "Errore nel caricamento del logo.",
      logo_upload_success: "Logo caricato con successo!",
      order_save_error: "Errore durante il salvataggio dell'ordine",
      order_saved: "Ordine {type} salvato!",
      need_open_category: "Devi prima aprire una categoria per ordinare le sottocategorie.",
      preview_not_available: "Anteprima carta non disponibile. Ricarica la pagina e riprova.",
      save_error: "Errore nel salvataggio. Riprova.",
      saved_short: "‚úÖ Salvato!",
      sommelier_saved: "Impostazioni del sommelier salvate!",
      sommelier_pro_only_alert: "Questa funzione √® disponibile solo per utenti PRO. Passa al piano superiore nella sezione Abbonamento.",
      sommelier_logo_upload_error: "Errore nel caricamento del logo del sommelier.",
      choose_file: "Scegli file",
      no_file_selected: "Nessun file selezionato",
    },

    en: {
      language: "Language",
      dashboard_title: "{name} - Dashboard",
      restaurant_default: "Restaurant",

      settings_wine_list: "Wine List Settings",
      tab_name_logo: "Name or Logo",
      tab_style: "Menu style",
      tab_order: "Reorder items",

      public_url: "Public URL",
      slug_help_html: "Only letters, numbers and hyphens. Example: <code>restaurant-mario-rossi</code>",
      check: "Check",
      url_prefix: "URL:",
      display_name: "Display name",
      name_font: "Name font",
      name_size: "Name size",
      name_color: "Name color",
      bold: "Bold",
      or_upload_logo: "or upload your restaurant logo",
      logo_size: "Logo size",
      save: "Save",

      style_wine_list: "Wine list style",
      main_font: "Main font",
      colors_palette: "Color palette",
      other_fonts: "More fonts...",
      settings_saved: "‚úÖ Settings saved successfully",

      order_entries: "Reorder items",
      order_categories: "Reorder categories",
      order_subcategories: "Reorder subcategories",
      order_wines_by: "Sort wines by:",
      order_price: "Price",
      order_vintage: "Vintage",
      order_alpha: "Alphabetical",
      save_order: "Save order",

      sommelier_settings: "Virtual Sommelier Settings",
      enable_virtual_sommelier: "Enable virtual sommelier",
      sommelier_logo: "Sommelier logo",
      choose_our_sommeliers: "Choose from our sommeliers",
      sommelier_man_alt: "Male sommelier",
      sommelier_woman_alt: "Female sommelier",
      or_upload_custom_logo: "or upload a custom logo",
      pro_only_title: "Available for PRO users only",
      pro_only: "üîí Available for PRO users only.",
      pro_only_html: "üîí Available for <strong>PRO</strong> users only.",
      upgrade_now: "Upgrade now",

      sub_only_title: "Available for subscribed users",
      sub_only_short: "Subscribed users only",
      sub_only_html: "üîí Available for <strong>subscribed</strong> users only.",
      subscribe_now: "Subscribe now",

      sub_popup_title: "Menu unavailable",
      sub_popup_msg: "This restaurant doesn't have an active subscription.",
      reactivate_subscription: "Reactivate subscription",

      wines_to_recommend: "Number of wines to recommend",
      range_1_3: "From 1 to 3",
      range_3_5: "From 3 to 5",
      range_5_7: "From 5 to 7",

      boost_wines: "Wines to boost on the list",
      add_boost: "Add a wine to boost",
      pro_only_short: "PRO only",
      save_sommelier_settings: "Save Sommelier Settings",

      choose_font: "Choose a font",
      close: "Close",

      download_qr: "Download QR Code",
      download_pdf: "Download PDF wine list",
      manage_subscription: "Manage subscription",
      logout: "Logout",

      nav_card: "Menu",
      nav_sommelier: "Sommelier",
      nav_wines: "Wines",
      nav_view: "View",
      nav_more: "More",

      footer_rights: "¬© 2025 Wine in App - All rights reserved",

      logo_preview_alt: "Logo preview",
      remove_logo: "‚úï Remove logo",
      logo_removed_success: "Logo removed successfully!",
      sommelier_logo_alt: "Sommelier logo",
      sommelier_logo_removed: "Sommelier logo removed!",
      remove: "Remove",
      search_wine_placeholder: "Search a wine from your list",

      slug_enter: "Enter a slug.",
      slug_invalid: "Invalid format. Use only letters, numbers and hyphens.",
      slug_available: "Available ‚úÖ",
      slug_taken: "Already taken ‚ùå Choose another",
      slug_verify_error: "Could not verify. Try again.",
      slug_not_valid_alert: "The slug is not valid. Use only letters, numbers and hyphens.",
      slug_taken_alert: "This URL is already taken. Choose another.",
      slug_verify_error_alert: "Could not verify slug availability. Try again.",

      sommelier_toggle_save_error: "Error saving the sommelier setting.",
      unsupported_format: "Unsupported format. Use JPG, PNG, WEBP or GIF.",
      logo_upload_error: "Error uploading the logo.",
      logo_upload_success: "Logo uploaded successfully!",
      order_save_error: "Error while saving the order",
      order_saved: "{type} order saved!",
      need_open_category: "Open a category first to reorder subcategories.",
      preview_not_available: "Preview not available. Reload the page and try again.",
      save_error: "Error while saving. Try again.",
      saved_short: "‚úÖ Saved!",
      sommelier_saved: "Sommelier settings saved!",
      sommelier_pro_only_alert: "This feature is available for PRO users only. Upgrade in the Subscription section.",
      sommelier_logo_upload_error: "Error uploading the sommelier logo.",
      choose_file: "Choose file",
      no_file_selected: "No file selected",
    },

    fr: {
      language: "Langue",
      dashboard_title: "{name} - Tableau de bord",
      restaurant_default: "Restaurant",

      settings_wine_list: "Param√®tres de la carte des vins",
      tab_name_logo: "Nom ou logo",
      tab_style: "Style de la carte",
      tab_order: "R√©organiser",

      public_url: "URL publique",
      slug_help_html: "Uniquement lettres, chiffres et tirets. Exemple : <code>restaurant-mario-rossi</code>",
      check: "V√©rifier",
      url_prefix: "URL :",
      display_name: "Nom affich√©",
      name_font: "Police du nom",
      name_size: "Taille du nom",
      name_color: "Couleur du nom",
      bold: "Gras",
      or_upload_logo: "ou t√©l√©versez le logo de votre restaurant",
      logo_size: "Taille du logo",
      save: "Enregistrer",

      style_wine_list: "Style de la carte des vins",
      main_font: "Police principale",
      colors_palette: "Palette de couleurs",
      other_fonts: "Autres polices‚Ä¶",
      settings_saved: "‚úÖ Param√®tres enregistr√©s",

      order_entries: "R√©organiser",
      order_categories: "R√©organiser les cat√©gories",
      order_subcategories: "R√©organiser les sous-cat√©gories",
      order_wines_by: "Trier les vins par :",
      order_price: "Prix",
      order_vintage: "Mill√©sime",
      order_alpha: "Alphab√©tique",
      save_order: "Enregistrer l‚Äôordre",

      sommelier_settings: "Param√®tres du sommelier virtuel",
      enable_virtual_sommelier: "Activer le sommelier virtuel",
      sommelier_logo: "Logo du sommelier",
      choose_our_sommeliers: "Choisissez parmi nos sommeliers",
      sommelier_man_alt: "Sommelier homme",
      sommelier_woman_alt: "Sommelier femme",
      or_upload_custom_logo: "ou t√©l√©versez un logo personnalis√©",
      pro_only_title: "Disponible uniquement pour les utilisateurs PRO",
      pro_only: "üîí Disponible uniquement pour les utilisateurs PRO.",
      pro_only_html: "üîí Disponible uniquement pour les utilisateurs <strong>PRO</strong>.",
      upgrade_now: "Passer √† PRO",

      sub_only_title: "Disponible pour les abonn√©s",
      sub_only_short: "Abonn√©s uniquement",
      sub_only_html: "üîí Disponible uniquement pour les <strong>abonn√©s</strong>.",
      subscribe_now: "S‚Äôabonner maintenant",

      sub_popup_title: "Carte indisponible",
      sub_popup_msg: "Le restaurant n‚Äôa pas d‚Äôabonnement actif.",
      reactivate_subscription: "R√©activer l‚Äôabonnement",

      wines_to_recommend: "Nombre de vins √† recommander",
      range_1_3: "De 1 √† 3",
      range_3_5: "De 3 √† 5",
      range_5_7: "De 5 √† 7",

      boost_wines: "Vins √† mettre en avant",
      add_boost: "Ajouter un vin √† mettre en avant",
      pro_only_short: "PRO uniquement",
      save_sommelier_settings: "Enregistrer les param√®tres",

      choose_font: "Choisir une police",
      close: "Fermer",

      download_qr: "T√©l√©charger le QR Code",
      download_pdf: "T√©l√©charger la carte en PDF",
      manage_subscription: "G√©rer l‚Äôabonnement",
      logout: "D√©connexion",

      nav_card: "Carte",
      nav_sommelier: "Sommelier",
      nav_wines: "Vins",
      nav_view: "Voir",
      nav_more: "Plus",

      footer_rights: "¬© 2025 Wine in App - Tous droits r√©serv√©s",

      logo_preview_alt: "Aper√ßu du logo",
      remove_logo: "‚úï Supprimer le logo",
      logo_removed_success: "Logo supprim√© !",
      sommelier_logo_alt: "Logo du sommelier",
      sommelier_logo_removed: "Logo du sommelier supprim√© !",
      remove: "Supprimer",
      search_wine_placeholder: "Rechercher un vin dans votre carte",

      slug_enter: "Saisissez un slug.",
      slug_invalid: "Format invalide. Utilisez seulement lettres, chiffres et tirets.",
      slug_available: "Disponible ‚úÖ",
      slug_taken: "D√©j√† utilis√© ‚ùå Choisissez-en un autre",
      slug_verify_error: "Impossible de v√©rifier. R√©essayez.",
      slug_not_valid_alert: "Le slug n‚Äôest pas valide. Utilisez seulement lettres, chiffres et tirets.",
      slug_taken_alert: "Cette URL est d√©j√† utilis√©e. Choisissez-en une autre.",
      slug_verify_error_alert: "Impossible de v√©rifier la disponibilit√© du slug. R√©essayez.",

      sommelier_toggle_save_error: "Erreur lors de l‚Äôenregistrement du param√®tre sommelier.",
      unsupported_format: "Format non pris en charge. Utilisez JPG, PNG, WEBP ou GIF.",
      logo_upload_error: "Erreur lors du t√©l√©versement du logo.",
      logo_upload_success: "Logo t√©l√©vers√© avec succ√®s !",
      order_save_error: "Erreur lors de l‚Äôenregistrement de l‚Äôordre",
      order_saved: "Ordre {type} enregistr√© !",
      need_open_category: "Ouvrez d‚Äôabord une cat√©gorie pour r√©organiser les sous-cat√©gories.",
      preview_not_available: "Aper√ßu indisponible. Rechargez la page et r√©essayez.",
      save_error: "Erreur lors de l‚Äôenregistrement. R√©essayez.",
      saved_short: "‚úÖ Enregistr√© !",
      sommelier_saved: "Param√®tres du sommelier enregistr√©s !",
      sommelier_pro_only_alert: "Cette fonctionnalit√© est r√©serv√©e aux utilisateurs PRO. Passez √† PRO dans la section Abonnement.",
      sommelier_logo_upload_error: "Erreur lors du t√©l√©versement du logo du sommelier.",
      choose_file: "Choisir un fichier",
      no_file_selected: "Aucun fichier s√©lectionn√©",
    },

    es: {
      language: "Idioma",
      dashboard_title: "{name} - Panel",
      restaurant_default: "Restaurante",

      settings_wine_list: "Ajustes de la carta de vinos",
      tab_name_logo: "Nombre o logo",
      tab_style: "Estilo de la carta",
      tab_order: "Reordenar",

      public_url: "URL p√∫blica",
      slug_help_html: "Solo letras, n√∫meros y guiones. Ejemplo: <code>restaurante-mario-rossi</code>",
      check: "Comprobar",
      url_prefix: "URL:",
      display_name: "Nombre a mostrar",
      name_font: "Fuente del nombre",
      name_size: "Tama√±o del nombre",
      name_color: "Color del nombre",
      bold: "Negrita",
      or_upload_logo: "o sube el logo de tu restaurante",
      logo_size: "Tama√±o del logo",
      save: "Guardar",

      style_wine_list: "Estilo de la carta de vinos",
      main_font: "Fuente principal",
      colors_palette: "Paleta de colores",
      other_fonts: "M√°s fuentes‚Ä¶",
      settings_saved: "‚úÖ Ajustes guardados",

      order_entries: "Reordenar",
      order_categories: "Reordenar categor√≠as",
      order_subcategories: "Reordenar subcategor√≠as",
      order_wines_by: "Ordenar vinos por:",
      order_price: "Precio",
      order_vintage: "A√±ada",
      order_alpha: "Alfab√©tico",
      save_order: "Guardar orden",

      sommelier_settings: "Ajustes del sumiller virtual",
      enable_virtual_sommelier: "Activar sumiller virtual",
      sommelier_logo: "Logo del sumiller",
      choose_our_sommeliers: "Elige entre nuestros sumilleres",
      sommelier_man_alt: "Sumiller hombre",
      sommelier_woman_alt: "Sumiller mujer",
      or_upload_custom_logo: "o sube un logo personalizado",
      pro_only_title: "Disponible solo para usuarios PRO",
      pro_only: "üîí Disponible solo para usuarios PRO.",
      pro_only_html: "üîí Disponible solo para usuarios <strong>PRO</strong>.",
      upgrade_now: "Mejorar a PRO",

      sub_only_title: "Solo para usuarios suscritos",
      sub_only_short: "Solo suscriptores",
      sub_only_html: "üîí Disponible solo para usuarios <strong>suscritos</strong>.",
      subscribe_now: "Suscr√≠bete ahora",

      sub_popup_title: "Carta no disponible",
      sub_popup_msg: "El restaurante no tiene una suscripci√≥n activa.",
      reactivate_subscription: "Reactivar suscripci√≥n",

      wines_to_recommend: "N√∫mero de vinos a recomendar",
      range_1_3: "De 1 a 3",
      range_3_5: "De 3 a 5",
      range_5_7: "De 5 a 7",

      boost_wines: "Vinos para destacar",
      add_boost: "A√±adir vino para destacar",
      pro_only_short: "Solo PRO",
      save_sommelier_settings: "Guardar ajustes del sumiller",

      choose_font: "Elegir una fuente",
      close: "Cerrar",

      download_qr: "Descargar QR Code",
      download_pdf: "Descargar carta en PDF",
      manage_subscription: "Gestionar suscripci√≥n",
      logout: "Cerrar sesi√≥n",

      nav_card: "Carta",
      nav_sommelier: "Sumiller",
      nav_wines: "Vinos",
      nav_view: "Ver",
      nav_more: "M√°s",

      footer_rights: "¬© 2025 Wine in App - Todos los derechos reservados",

      logo_preview_alt: "Vista previa del logo",
      remove_logo: "‚úï Quitar logo",
      logo_removed_success: "¬°Logo eliminado!",
      sommelier_logo_alt: "Logo del sumiller",
      sommelier_logo_removed: "¬°Logo del sumiller eliminado!",
      remove: "Quitar",
      search_wine_placeholder: "Busca un vino en tu carta",

      slug_enter: "Introduce un slug.",
      slug_invalid: "Formato inv√°lido. Usa solo letras, n√∫meros y guiones.",
      slug_available: "Disponible ‚úÖ",
      slug_taken: "Ya est√° en uso ‚ùå Elige otro",
      slug_verify_error: "No se puede verificar. Int√©ntalo de nuevo.",
      slug_not_valid_alert: "El slug no es v√°lido. Usa solo letras, n√∫meros y guiones.",
      slug_taken_alert: "Esta URL ya est√° en uso. Elige otra.",
      slug_verify_error_alert: "No se pudo verificar la disponibilidad del slug. Int√©ntalo de nuevo.",

      sommelier_toggle_save_error: "Error al guardar la opci√≥n del sumiller.",
      unsupported_format: "Formato no compatible. Usa JPG, PNG, WEBP o GIF.",
      logo_upload_error: "Error al subir el logo.",
      logo_upload_success: "¬°Logo subido con √©xito!",
      order_save_error: "Error al guardar el orden",
      order_saved: "¬°Orden de {type} guardado!",
      need_open_category: "Abre primero una categor√≠a para reordenar subcategor√≠as.",
      preview_not_available: "Vista previa no disponible. Recarga la p√°gina e int√©ntalo de nuevo.",
      save_error: "Error al guardar. Int√©ntalo de nuevo.",
      saved_short: "‚úÖ ¬°Guardado!",
      sommelier_saved: "¬°Ajustes del sumiller guardados!",
      sommelier_pro_only_alert: "Esta funci√≥n es solo para usuarios PRO. Mejora en la secci√≥n Suscripci√≥n.",
      sommelier_logo_upload_error: "Error al subir el logo del sumiller.",
      choose_file: "Elegir archivo",
      no_file_selected: "Ning√∫n archivo seleccionado",
    }
  };

  function normalizeLang(raw) {
    const s = (raw || "").toLowerCase();
    if (s.startsWith("it")) return "it";
    if (s.startsWith("fr")) return "fr";
    if (s.startsWith("es")) return "es";
    return "en";
  }
  function normalize(str) {
  return str
    ? str.toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu, "").trim()
    : "";
}

  function t(key, vars = {}) {
    const dict = TRANSLATIONS[currentLang] || TRANSLATIONS.en;
    let out = (dict && dict[key]) || (TRANSLATIONS.en && TRANSLATIONS.en[key]) || key;
    for (const [k, v] of Object.entries(vars)) {
      out = out.replaceAll(`{${k}}`, String(v));
    }
    return out;
  }

  function setText(sel, text) {
    const el = document.querySelector(sel);
    if (el) el.textContent = text;
  }
  function setHTML(sel, html) {
    const el = document.querySelector(sel);
    if (el) el.innerHTML = html;
  }

  function setHeaderText(sel, txt) {
    const el = document.querySelector(sel);
    if (!el) return;
    const icon = el.querySelector('.accordion-icon');
    // Preserve the icon span if present
    if (icon) {
      // Ensure there is a text node before the icon
      if (!el.firstChild || el.firstChild.nodeType !== Node.TEXT_NODE) {
        el.insertBefore(document.createTextNode(''), icon);
      }
      el.firstChild.textContent = txt + ' ';
    } else {
      el.textContent = txt;
    }
  }

  function setRestaurantTitle(name) {
    const n = (name || "").trim() || t("restaurant_default");
    setText("#ristoranteName", t("dashboard_title", { name: n }));
  }

  function applyTranslations() {
    // language selector
    setText("#langLabel", t("language"));
    const langSelect = document.getElementById("langSelect");
    if (langSelect) langSelect.value = currentLang;

    // page
    document.title = t("dashboard_title", { name: "Wine in App" });

    // Carta settings
    setText("#titoloCartaVini", t("settings_wine_list"));
    setText('#cartaQuickActions .pill-btn[data-target="accNomeLogo"]', t("tab_name_logo"));
    setText('#cartaQuickActions .pill-btn[data-target="accStile"]', t("tab_style"));
    setText('#cartaQuickActions .pill-btn[data-target="accOrdina"]', t("tab_order"));

    // Accordion headers (mobile)
    setHeaderText('#accNomeLogo .accordion-header', t("tab_name_logo"));
    setHeaderText('#accStile .accordion-header', t("style_wine_list"));
    setHeaderText('#accOrdina .accordion-header', t("order_entries"));

    setText('label[for="slugInput"]', t("public_url"));
    setHTML("#slugHelp", t("slug_help_html"));
    setText("#checkSlugBtn", t("check"));

    // URL preview prefix
    const slugPreview = document.getElementById("slugPreview");
    if (slugPreview && slugPreview.childNodes && slugPreview.childNodes.length) {
      slugPreview.childNodes[0].textContent = t("url_prefix") + " ";
    }

    setText('label[for="displayName"]', t("display_name"));

    // "Font Nome:" label prefix
    const nameFontSel = document.getElementById("nameFont");
    if (nameFontSel && nameFontSel.closest("label")) {
      // first child is usually a text node: "Font Nome:"
      const lbl = nameFontSel.closest("label");
      if (lbl.childNodes && lbl.childNodes.length) lbl.childNodes[0].textContent = t("name_font") + ": ";
    }

    // Name size label prefix
    const nameSizeEl = document.getElementById("nameSize");
    if (nameSizeEl && nameSizeEl.closest("label")) {
      const lbl = nameSizeEl.closest("label");
      if (lbl.childNodes && lbl.childNodes.length) lbl.childNodes[0].textContent = t("name_size") + ": ";
    }

    // Name color label prefix
    const nameColorEl = document.getElementById("nameColor");
    if (nameColorEl && nameColorEl.closest("label")) {
      const lbl = nameColorEl.closest("label");
      if (lbl.childNodes && lbl.childNodes.length) lbl.childNodes[0].textContent = t("name_color") + ": ";
    }

    // Bold checkbox label text node after input
    const boldCb = document.getElementById("nameBold");
    if (boldCb && boldCb.parentElement) {
      // label contains input then text
      const lbl = boldCb.parentElement;
      lbl.childNodes.forEach(n => {
        if (n.nodeType === Node.TEXT_NODE) n.textContent = " " + t("bold");
      });
    }

    setText('label[for="logoUpload"]', t("or_upload_logo"));

    // Logo size label prefix
    const logoSizeEl = document.getElementById("logoSize");
    if (logoSizeEl && logoSizeEl.closest("label")) {
      const lbl = logoSizeEl.closest("label");
      if (lbl.childNodes && lbl.childNodes.length) lbl.childNodes[0].textContent = t("logo_size") + ": ";
    }

    // Save buttons (2 in carta settings)
    document.querySelectorAll('button.mini-save-btn[onclick="saveSettings()"]').forEach(b => b.textContent = t("save"));

    setText('label[for="fontSelector"]', t("main_font"));
    setText('label[for="paletteSelector"]', t("colors_palette"));

    // "Altri font..."
    const nameFontOpt = document.querySelector('#nameFont option[value="custom"]');
    if (nameFontOpt) nameFontOpt.textContent = t("other_fonts");
    const bodyFontOpt = document.querySelector('#fontSelector option[value="custom"]');
    if (bodyFontOpt) bodyFontOpt.textContent = t("other_fonts");

    // save message
    setText("#saveMessage", t("settings_saved"));

    // Ordering section
    setText("#ordinaCategorieBtn", t("order_categories"));
    setText("#ordinaSottocategorieBtn", t("order_subcategories"));
    setText('label[for="wineOrder"]', t("order_wines_by"));
    const wOrder = document.getElementById("wineOrder");
    if (wOrder) {
      const o1 = wOrder.querySelector('option[value="prezzo"]'); if (o1) o1.textContent = t("order_price");
      const o2 = wOrder.querySelector('option[value="annata"]'); if (o2) o2.textContent = t("order_vintage");
      const o3 = wOrder.querySelector('option[value="nome"]');   if (o3) o3.textContent = t("order_alpha");
    }

    // Sommelier section
    setText("#impostazioniSommelier > h2", t("sommelier_settings"));
    const toggleLblStrong = document.querySelector('label[for="toggleSommelierBtn"] strong');
    if (toggleLblStrong) toggleLblStrong.textContent = t("enable_virtual_sommelier");

    setText("#sommelierLogoTitle strong", t("sommelier_logo"));
    setText('#impostazioniSommelier small', t("choose_our_sommeliers"));

    const imgMan = document.querySelector('img[src="sommelier.png"]'); if (imgMan) imgMan.alt = t("sommelier_man_alt");
    const imgWoman = document.querySelector('img[src="sommelier_femmina.png"]'); if (imgWoman) imgWoman.alt = t("sommelier_woman_alt");

    setText('label[for="sommelierLogoUpload"]', t("or_upload_custom_logo"));
    const isActive = (window.SUBSCRIPTION_STATUS || "").toLowerCase() === "active";
    const gate = isActive
      ? { title: t("pro_only_title"), short: t("pro_only_short"), html: t("pro_only_html"), cta: t("upgrade_now") }
      : { title: t("sub_only_title"), short: t("sub_only_short"), html: t("sub_only_html"), cta: t("subscribe_now") };

    const lockIcon = document.getElementById("lockIcon"); if (lockIcon) lockIcon.title = gate.title;
    const boostLockIcon = document.getElementById("boostLockIcon"); if (boostLockIcon) boostLockIcon.title = gate.short;

    // pro/sub tooltip
    setHTML("#proTooltip", `${gate.html} <a href="#" id="upgradeLink" style="color:#b00; text-decoration:underline;">${gate.cta}</a>`);
    if (typeof RESTAURANT_ID === "string" && RESTAURANT_ID) {
      const up = document.getElementById("upgradeLink");
      if (up) up.href = `abbonamento.html?ristorante_id=${RESTAURANT_ID}`;
    }

    // range lock tooltip (solo se presente)
    const rangeLock = document.getElementById("rangeLockTooltip");
    if (rangeLock && typeof RESTAURANT_ID === "string" && RESTAURANT_ID) {
      rangeLock.innerHTML = `${gate.html} <a href="abbonamento.html?ristorante_id=${RESTAURANT_ID}" style="color:#b00; text-decoration:underline;">${gate.cta}</a>`;
    }

    const rangeStrong = document.querySelector('label[for="sommelierRange"] strong');
    if (rangeStrong) rangeStrong.textContent = t("wines_to_recommend");

    const sRange = document.getElementById("sommelierRange");
    if (sRange) {
      const a = sRange.querySelector('option[value="1-3"]'); if (a) a.textContent = t("range_1_3");
      const b = sRange.querySelector('option[value="3-5"]'); if (b) b.textContent = t("range_3_5");
      const c = sRange.querySelector('option[value="5-7"]'); if (c) c.textContent = t("range_5_7");
    }

    const boostStrong = document.querySelector('#impostazioniSommelier label strong:nth-child(1)'); // might be brittle
    setText("#boostWinesLabel strong", t("boost_wines"));

    // add boost button
    const addBoostBtn = document.getElementById("addBoostBtn");
    if (addBoostBtn) addBoostBtn.textContent = `+ ${t("add_boost")}`;

    setHTML("#boostLockTooltip", `${gate.html} <a href="abbonamento.html" id="boostUpgradeLink" style="color:#b00; text-decoration:underline;">${gate.cta}</a>`);
    if (typeof RESTAURANT_ID === "string" && RESTAURANT_ID) {
      const up2 = document.getElementById("boostUpgradeLink");
      if (up2) up2.href = `abbonamento.html?ristorante_id=${RESTAURANT_ID}`;
    }

    const saveSomBtn = document.querySelector('button.save-btn[onclick="saveSommelierSettings()"]');
    if (saveSomBtn) saveSomBtn.textContent = t("save_sommelier_settings");

    // font popup
    setText("#fontPopup h3", t("choose_font"));
    const closeBtn = document.querySelector('#fontPopup button[onclick*="fontPopup"]');
    if (closeBtn) closeBtn.textContent = t("close");

    // QR popup
    setText("#downloadQr", t("download_qr"));

    // bottom nav
    setText("#bnCarta .label", t("nav_card"));
    setText("#bnSommelier .label", t("nav_sommelier"));
    setText("#bnVini .label", t("nav_wines"));
    setText("#bnVista .label", t("nav_view"));
    setText("#moreBtn .label", t("nav_more"));

    // more menu
    const moreBtns = document.querySelectorAll("#moreMenu button");
    if (moreBtns && moreBtns.length >= 4) {
      moreBtns[0].textContent = t("download_qr");
      moreBtns[1].textContent = t("download_pdf");
      moreBtns[2].textContent = t("manage_subscription");
      moreBtns[3].textContent = t("logout");
    }

    const removeLogoBtn = document.getElementById("removeLogoBtn");
    if (removeLogoBtn) removeLogoBtn.textContent = t("remove_logo");

    const removeSomBtn = document.getElementById("removeSommelierLogoBtn");
    if (removeSomBtn) removeSomBtn.textContent = t("remove_logo");

    // footer
    setText("footer", t("footer_rights"));
    applyFileTranslations();
    // subscription popup
    setText("#subPopupTitle", t("sub_popup_title"));
    setText("#subPopupMsg", t("sub_popup_msg"));
    setText("#subPopupClose", t("close"));
    setText("#subPopupReactivate", t("reactivate_subscription"));
    document.querySelectorAll("#boostContainer input").forEach(inp => {
  inp.placeholder = t("search_wine_placeholder");
});
  }


  function showNoSubPopup() {
    const p = document.getElementById("subPopup");
    if (!p) return;
    p.style.display = "flex";
  }
  function hideNoSubPopup() {
    const p = document.getElementById("subPopup");
    if (!p) return;
    p.style.display = "none";
  }
  // bind popup buttons (once)
  (function bindSubPopup() {
    const p = document.getElementById("subPopup");
    if (!p) return;

    const closeBtn = document.getElementById("subPopupClose");
    const reactBtn = document.getElementById("subPopupReactivate");

    if (closeBtn) closeBtn.onclick = hideNoSubPopup;

    if (reactBtn) reactBtn.onclick = () => {
      const base = (typeof RESTAURANT_ID === "string" && RESTAURANT_ID)
        ? `abbonamento.html?ristorante_id=${RESTAURANT_ID}&lang=${currentLang}`
        : `abbonamento.html?lang=${currentLang}`;
      window.location.href = base;
    };

    // click outside
    p.addEventListener("click", (e) => {
      if (e.target === p) hideNoSubPopup();
    });
  })();

  function bindCustomFileUI(inputId, btnId, nameId) {
  const input = document.getElementById(inputId);
  const btn = document.getElementById(btnId);
  const name = document.getElementById(nameId);
  if (!input || !btn || !name) return;

  btn.addEventListener("click", () => input.click());

  const renderName = () => {
    const file = input.files && input.files[0];
    name.textContent = file ? file.name : t("no_file_selected");
  };

  input.addEventListener("change", renderName);
  renderName();

  // espongo una mini-fn per aggiornare testi al cambio lingua
  input.__wfRenderFileName = renderName;
}

function setLogoUploadUIVisible(visible) {
  const label = document.getElementById("logoUploadLabel");
  const row = document.getElementById("logoFileField");
  if (label) label.style.display = visible ? "block" : "none";
  if (row) row.style.display = visible ? "flex" : "none";
}

function setSommelierUploadUIVisible(visible) {
  const row = document.getElementById("sommelierFileField");
  // la label del sommelier √® dentro un <div> con lock, quindi lasciamo quella com‚Äô√®
  if (row) row.style.display = visible ? "flex" : "none";
}

function applyFileTranslations() {
  const logoChooseBtn = document.getElementById("logoChooseBtn");
  const somChooseBtn  = document.getElementById("sommelierChooseBtn");
  if (logoChooseBtn) logoChooseBtn.textContent = t("choose_file");
  if (somChooseBtn)  somChooseBtn.textContent  = t("choose_file");

  // aggiorna anche ‚Äúnessun file selezionato‚Äù se non c‚Äô√® file
  ["logoUpload", "sommelierLogoUpload"].forEach(id => {
    const inp = document.getElementById(id);
    if (inp && typeof inp.__wfRenderFileName === "function") inp.__wfRenderFileName();
  });
}

  function setLang(lang, persist = true) {
    const normalized = normalizeLang(lang);
    currentLang = SUPPORTED_LANGS.includes(normalized) ? normalized : "en";
    document.documentElement.lang = currentLang;
    if (persist) {
  // lingua ‚Äúglobale‚Äù (fallback)
  localStorage.setItem("wf_lang", currentLang);

  // lingua ‚Äúper ristorante‚Äù
  if (typeof RESTAURANT_ID === "string" && RESTAURANT_ID) {
    localStorage.setItem(`wf_lang_${RESTAURANT_ID}`, currentLang);
  }
}
    applyTranslations();
    // refresh dynamic title if we already know it
    if (window.__WF_REST_NAME !== undefined) setRestaurantTitle(window.__WF_REST_NAME);
// üëá manda la lingua anche alla carta nell'iframe
const iframe = document.getElementById("previewFrame");
if (iframe && iframe.contentWindow) {
  iframe.contentWindow.postMessage({ action: "setLanguage", lang: currentLang }, "*");
}
  }

  function initLanguage() {
    const saved = localStorage.getItem("wf_lang");
    const auto = normalizeLang(navigator.language || "");
    setLang(saved || auto, !saved); // persist only if it's a first-time auto choice
    const sel = document.getElementById("langSelect");
    if (sel) sel.addEventListener("change", (e) => setLang(e.target.value, true));
  }

  let isPro = false;
  let boostCount = 0;
  const maxBoosts = 5;

function updatePaletteLivePreview() {
  const paletteEl = document.getElementById("paletteSelector");
  const palette = paletteEl.options[paletteEl.selectedIndex].getAttribute("data-palette");

  // invia solo il nome della palette alla carta
  const iframe = document.getElementById("previewFrame");
  if (!iframe || !iframe.contentWindow) return;

  iframe.contentWindow.postMessage({
    action: "updatePaletteLive",
    palette
  }, "*");
}

// --- Nuova UI: bottoni orizzontali per le 3 impostazioni carta ---
let currentCartaPanel = "accNomeLogo";

function openCartaPanel(panelId) {
  currentCartaPanel = panelId;

  document.querySelectorAll("#impostazioniCarta .accordion").forEach(acc => {
    acc.classList.toggle("open", acc.id === panelId);
  });

  document.querySelectorAll("#cartaQuickActions .pill-btn").forEach(btn => {
    btn.classList.toggle("active", btn.dataset.target === panelId);
  });
}

function initCartaQuickActions() {
  const wrap = document.getElementById("cartaQuickActions");
  if (!wrap) return;

  if (wrap.dataset.bound === "1") return;
  wrap.dataset.bound = "1";

  wrap.querySelectorAll(".pill-btn").forEach(btn => {
    btn.addEventListener("click", () => openCartaPanel(btn.dataset.target));
  });

  openCartaPanel(currentCartaPanel);
}

  function updateFontLivePreview() {
  const font = document.getElementById("fontSelector").value;

  const iframe = document.getElementById("previewFrame");
  if (!iframe || !iframe.contentWindow) return;

  iframe.contentWindow.postMessage({
    action: "updateFontLive",
    font
  }, "*");

  // carica dinamicamente il font se serve
  if (font && font !== "Arial" && font !== "custom" && !["sans-serif", "cursive", "monospace"].includes(font)) {
    const fontLinkId = "customGoogleFontBody";
    let existing = document.getElementById(fontLinkId);
    if (existing) existing.remove();

    const encodedFont = encodeURIComponent(font.trim()).replace(/%20/g, "+");
    const link = document.createElement("link");
    link.id = fontLinkId;
    link.rel = "stylesheet";
    link.href = `https://fonts.googleapis.com/css2?family=${encodedFont}&display=swap`;
    document.head.appendChild(link);
  }
}

  // üîß 1. Funzione per inviare il logo in live
function updateLogoPreviewLive() {
  const iframe = document.getElementById("previewFrame");
  if (!iframe || !iframe.contentWindow) return;

  const size = document.getElementById("logoSize").value;
  const logoEl = document.getElementById("previewLogo");

  iframe.contentWindow.postMessage({
    action: "updateLogoLive",
    size,
    logoUrl: logoEl?.src || null
  }, "*");
}

// üîß 2. Funzione per mostrare/nascondere le opzioni nome/logo
function toggleNameLogoOptions(showLogo) {
  const nameOptions = document.getElementById("nameOptions");
  const logoOptions = document.getElementById("logoOptions");

  if (showLogo) {
    nameOptions.style.display = "none";
    logoOptions.style.display = "block";
  } else {
    nameOptions.style.display = "block";
    logoOptions.style.display = "none";
  }
}

// üîß 3. Funzione per mostrare l'anteprima del logo e bottone rimozione
function renderLogoPreview(url) {
  const oldPreview = document.getElementById("previewLogo");
  if (oldPreview) oldPreview.remove();

  const preview = document.createElement("img");
  preview.src = url + "?t=" + new Date().getTime();
  preview.alt = t("logo_preview_alt");
  preview.className = "logo-preview";
  preview.id = "previewLogo";
  preview.style.display = "block";
  preview.style.margin = "10px auto";

const anchor = document.getElementById("logoFileField") || document.getElementById("logoUpload");
anchor.insertAdjacentElement("afterend", preview);

  const oldRemoveBtn = document.getElementById("removeLogoBtn");
  if (oldRemoveBtn) oldRemoveBtn.remove();

  const removeBtn = document.createElement("button");
  removeBtn.textContent = t("remove_logo");
  removeBtn.id = "removeLogoBtn";
  removeBtn.style.background = "none";
  removeBtn.style.border = "none";
  removeBtn.style.color = "#b00";
  removeBtn.style.cursor = "pointer";
  removeBtn.style.margin = "5px auto 10px";
  removeBtn.style.display = "block";
  removeBtn.style.fontSize = "0.9em";
  removeBtn.id = "removeLogoBtn";
  removeBtn.onclick = async () => {
    const ext = preview.src.split('.').pop().split('?')[0];
    const filePath = `${RESTAURANT_ID}.${ext}`;
    await sb.storage.from("loghi").remove([`ristoranti/${filePath}`]);
    await sb.from("ristoranti").update({ logo_url: null }).eq("id", RESTAURANT_ID);
    preview.remove();
    removeBtn.remove();
    document.getElementById("logoOptions").style.display = "none";
    toggleNameLogoOptions(false);
    // mostra di nuovo UI upload + reset testo
    setLogoUploadUIVisible(true);
      const inp = document.getElementById("logoUpload");
      if (inp) inp.value = "";
      const name = document.getElementById("logoFileName");
      if (name) name.textContent = t("no_file_selected");
    alert(t("logo_removed_success"));
    updatePreview();
  };

preview.insertAdjacentElement("afterend", removeBtn);
}

function renderSommelierLogoPreview(url) {
  const oldPreview = document.getElementById("previewSommelierLogo");
  if (oldPreview) oldPreview.remove();

  const preview = document.createElement("img");
  preview.src = url + "?t=" + new Date().getTime();
  preview.alt = t("sommelier_logo_alt");
  preview.className = "logo-preview";
  preview.id = "previewSommelierLogo";
  preview.style.display = "block";
  preview.style.margin = "10px auto";

  const uploadField = document.getElementById("sommelierLogoUpload");
  uploadField.insertAdjacentElement("afterend", preview);

  // se √® il logo di default, NON mostrare il pulsante "Rimuovi"
  if (url.includes("sommelier.png")) return;

  const oldRemoveBtn = document.getElementById("removeSommelierLogoBtn");
  if (oldRemoveBtn) oldRemoveBtn.remove();

  const removeBtn = document.createElement("button");
  removeBtn.textContent = t("remove_logo");
  removeBtn.id = "removeSommelierLogoBtn";
  removeBtn.style.background = "none";
  removeBtn.style.border = "none";
  removeBtn.style.color = "#b00";
  removeBtn.style.cursor = "pointer";
  removeBtn.style.margin = "5px auto 10px";
  removeBtn.style.display = "block";
  removeBtn.style.fontSize = "0.9em";

  removeBtn.onclick = async () => {
    const ext = preview.src.split('.').pop().split('?')[0];
    const filePath = `sommelier_${RESTAURANT_ID}.${ext}`;
    await sb.storage.from("sommelier").remove([filePath]);
    await sb.from("ristoranti").update({ sommelier_url: null }).eq("id", RESTAURANT_ID);
    preview.remove();
    removeBtn.remove();
    alert(t("sommelier_logo_removed"));
    updatePreviewLive();
  };

  preview.insertAdjacentElement("afterend", removeBtn);
}

function selezionaDefaultSommelier(gender) {
  document.getElementById("sommelierGender").value = gender;

  document.querySelectorAll(".default-avatar").forEach(img => {
    img.classList.remove("selected");
  });

  const selectedImg = gender === "donna"
    ? document.querySelector('img[src*="sommelier_femmina.png"]')
    : document.querySelector('img[src*="sommelier.png"]:not([src*="femmina"])');

  if (selectedImg) selectedImg.classList.add("selected");
}

// üîß 4. Collega gli eventi live del logo
function attachLogoListeners() {
  ["logoSize"].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      const type = el.tagName === "SELECT" || el.type === "checkbox" ? "change" : "input";
      el.addEventListener(type, updateLogoPreviewLive);
    }
  });
}

  function addBoostInput(value = "") {
  if (boostCount >= maxBoosts) return;

  const container = document.getElementById("boostContainer");

  const wrapper = document.createElement("div");
  wrapper.style.position = "relative";
wrapper.style.maxWidth = "400px";
wrapper.style.margin = "0 auto 10px";   // ‚úÖ centrato

  const input = document.createElement("input");
  input.type = "text";
  input.className = "awesomplete";
  input.id = `boostInput${boostCount}`; // ‚úÖ aggiunto ID univoco
  input.name = `boostInput${boostCount}`; // ‚úÖ aggiunto name
  input.placeholder = t("search_wine_placeholder");
  input.style.paddingRight = "2.2em";
  input.style.width = "100%";
  input.style.boxSizing = "border-box";
  input.value = value; // üî• essenziale per farlo apparire al refresh

  const clearBtn = document.createElement("span");
  clearBtn.textContent = "√ó";
  clearBtn.title = t("remove");
  clearBtn.style.cssText = `
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    font-weight: bold;
    color: var(--accent);
    font-size: 16px;
    background: white;
    padding: 0 5px;
    border-radius: 50%;
    line-height: 1;
    cursor: pointer;
    user-select: none;
  `;

  clearBtn.onclick = () => {
    wrapper.remove();
    boostCount--;
  };

  wrapper.appendChild(input);
  wrapper.appendChild(clearBtn);
  container.appendChild(wrapper);
  boostCount++;

  if (window.viniList) {
    setTimeout(() => {
      new Awesomplete(input, {
        list: window.viniList,
        minChars: 1,
        maxItems: 10,
        autoFirst: true
      });
    }, 0);
  }
}

function slugify(str) {
  return (str || "")
    .toString()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // rimuove accenti
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, "-")  // non alfanumerico -> trattino
    .replace(/^-+|-+$/g, "")      // trim trattini
    .substring(0, 60);            // limite di sicurezza
}

function isValidSlug(s) {
  return /^[a-z0-9]+(?:-[a-z0-9]+)*$/.test(s);
}

function debounce(fn, ms=350) {
  let t;
  return (...args) => {
    clearTimeout(t);
    t = setTimeout(() => fn.apply(this, args), ms);
  };
}

async function checkSlugAvailability(s) {
  // returns: { ok: boolean, code: 'ok'|'empty'|'invalid'|'error'|'taken' }
  if (!s) return { ok: false, code: "empty" };
  if (!isValidSlug(s)) return { ok: false, code: "invalid" };

  const { data, error } = await sb
    .from("ristoranti")
    .select("id")
    .eq("slug", s)
    .neq("id", RESTAURANT_ID)
    .limit(1);

  if (error) {
    console.warn("Errore check slug:", error);
    return { ok: false, code: "error" };
  }
  const taken = Array.isArray(data) && data.length > 0;
  return { ok: !taken, code: taken ? "taken" : "ok" };
}

  document.addEventListener("DOMContentLoaded", async () => {
    if (window.location.hash === "#") {
  history.replaceState(null, "", window.location.pathname);
}
    // init language (auto + saved choice)
    initLanguage();
    // üëá quando l'iframe finisce di caricare, reinvia la lingua corrente
const _iframe = document.getElementById("previewFrame");
if (_iframe && !_iframe.dataset.langBound) {
  _iframe.dataset.langBound = "1";
  _iframe.addEventListener("load", () => {
    try {
      _iframe.contentWindow?.postMessage({ action: "setLanguage", lang: currentLang }, "*");
    } catch(e) {}
  });
}
    sb = window.supabase.createClient("https://ldunvbftxhbtuyabgxwh.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkdW52YmZ0eGhidHV5YWJneHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0NTMyOTYsImV4cCI6MjA2MjAyOTI5Nn0.0hjJASFktfHZHjVQzX9bq8xGBrf7o1Fya6lqnA2tvPo");
    const { data: { user }, error } = await sb.auth.getUser();
      if (!user) return (window.location.href = '/');
      const urlParams = new URLSearchParams(window.location.search);
RESTAURANT_ID = urlParams.get("ristorante_id");

if (!RESTAURANT_ID && user) {
  RESTAURANT_ID = user.id;
  window.location.href = `dashboard.html?ristorante_id=${RESTAURANT_ID}`;
  return; // Evita di eseguire altro codice fino al reload
}

const { data: info } = await sb
  .from("ristoranti")
  .select("nome, font, palette_color, logo_url, sommelier_url, sommelier_range, sommelier_boost_multi, logo_size, name_size, name_color, name_bold, name_font, ordine_vini, sommelier_attivo, sommelier_gender, subscription_plan, subscription_status, slug")
  .eq("id", RESTAURANT_ID)
  .single();

window.RISTORANTE_SLUG = (info?.slug || "").trim();
// --- Inizializza UI slug ---
const slugInput = document.getElementById("slugInput");
const slugStatus = document.getElementById("slugStatus");
const slugPreviewUrl = document.getElementById("slugPreviewUrl");
const checkSlugBtn = document.getElementById("checkSlugBtn");
const displayNameInput = document.getElementById("displayName");

function renderSlugPreview(s) {
  const base = "https://www.wineinapp.com/";
  slugPreviewUrl.textContent = s ? base + s : base;
}

slugInput.value = window.RISTORANTE_SLUG || "";
renderSlugPreview(slugInput.value);

checkSlugBtn.addEventListener("click", () => {
  // forza una verifica immediata sul valore attuale
  (async () => {
    const s = slugInput.value.trim();
    if (!s) {
      slugStatus.textContent = t("slug_enter");
      slugStatus.style.color = "#b00";
      renderSlugPreview("");
      return;
    }
    if (!isValidSlug(s)) {
      slugStatus.textContent = t("slug_invalid");
      slugStatus.style.color = "#b00";
      renderSlugPreview(s);
      return;
    }
    const res = await checkSlugAvailability(s);
    if (res.ok) {
      slugStatus.textContent = t("slug_available");
      slugStatus.style.color = "green";
    } else {
      slugStatus.textContent = (res.code === "taken")
        ? t("slug_taken")
        : t("slug_verify_error");
      slugStatus.style.color = "#b00";
    }
    renderSlugPreview(s);
  })();
});

const debouncedCheck = debounce(async () => {
  const s = slugInput.value.trim();
  if (!s) {
    slugStatus.textContent = t("slug_enter");
    slugStatus.style.color = "#b00";
    renderSlugPreview("");
    return;
  }

  if (!isValidSlug(s)) {
    slugStatus.textContent = t("slug_invalid");
    slugStatus.style.color = "#b00";
    renderSlugPreview(s);
    return;
  }

  const res = await checkSlugAvailability(s);
  if (res.ok) {
    slugStatus.textContent = t("slug_available");
    slugStatus.style.color = "green";
  } else {
    slugStatus.textContent = (res.reason === "Gi√† in uso")
      ? "Gi√† in uso ‚ùå Scegline un altro"
      : "Impossibile verificare. Riprova.";
    slugStatus.style.color = "#b00";
  }
  renderSlugPreview(s);
}, 400);

slugInput.addEventListener("input", (e) => {
  // normalizza in tempo reale (consente solo set valido)
  const raw = e.target.value;
  const fixed = slugify(raw);
  if (raw !== fixed) e.target.value = fixed;
  debouncedCheck();
});

// Suggerimento automatico quando digiti il ‚ÄúNome da visualizzare‚Äù, se lo slug √® ancora vuoto
displayNameInput.addEventListener("blur", () => {
  if (!slugInput.value.trim()) {
    const suggestion = slugify(displayNameInput.value || "");
    slugInput.value = suggestion;
    debouncedCheck();
  }
});

      const { data: vini } = await sb
        .from("wines")
        .select("nome")
        .eq("ristorante_id", RESTAURANT_ID)
        .order("nome", { ascending: true });

      window.viniList = vini ? vini.map(v => v.nome) : [];
      window._sommelierBoostRaw = info?.sommelier_boost_multi;

// imposta valori iniziali
        const nameFont = info?.name_font || "Arial";
    const fontSelect = document.getElementById("nameFont");
    let option = [...fontSelect.options].find(o => o.value === nameFont);
    if (!option) {
      option = new Option(nameFont, nameFont);
      fontSelect.add(option);
    }
    fontSelect.value = nameFont;
const toggle = document.getElementById("toggleSommelierBtn");
if (toggle) {
  const rawValue = info?.sommelier_attivo ?? false;

  const checked = rawValue === true || rawValue === "true";
  toggle.checked = checked;
}
    document.getElementById("nameSize").value = info?.name_size || "28";
    document.getElementById("nameColor").value = info?.name_color || "#000000";
    document.getElementById("nameBold").checked = info?.name_bold || false;
    document.getElementById("logoSize").value = info?.logo_size || "64";
    document.getElementById("sommelierRange").value = info?.sommelier_range || "1-3";
    const gender = info?.sommelier_gender || "uomo";
    isPro = info?.subscription_plan === "pro";
    window.SUBSCRIPTION_STATUS = (info?.subscription_status || "").toLowerCase();
const isSubActive = () => window.SUBSCRIPTION_STATUS === "active";
    // Blocco accesso al pulsante boost
if (isPro) {
  document.getElementById("boostLockIcon").style.display = "none";
  document.getElementById("boostLockTooltip").style.display = "none";
} else {
  const btn = document.getElementById("addBoostBtn");
  const tooltip = document.getElementById("boostLockTooltip");
  const link = document.getElementById("boostUpgradeLink");
  const lockIcon = document.getElementById("boostLockIcon");

  btn.disabled = true;
  btn.style.opacity = "0.4";
  btn.style.cursor = "not-allowed";

  const showTooltip = () => {
    tooltip.style.display = "block";
    setTimeout(() => {
      tooltip.style.display = "none";
    }, 4000);
  };

  btn.addEventListener("click", showTooltip);
  lockIcon.addEventListener("click", showTooltip);

  link.href = `abbonamento.html?ristorante_id=${RESTAURANT_ID}`;
}

    const sommelierRangeSelect = document.getElementById("sommelierRange");
const sommelierRangeLabel = sommelierRangeSelect.previousElementSibling;

if (!isPro) {
  sommelierRangeSelect.disabled = true;
  sommelierRangeSelect.style.opacity = "0.5";
  sommelierRangeSelect.style.cursor = "not-allowed";

  const rangeTooltip = document.createElement("div");
  rangeTooltip.id = "rangeLockTooltip";
  rangeTooltip.style.fontSize = "0.85em";
  rangeTooltip.style.color = "#555";
  rangeTooltip.style.marginTop = "4px";
  // contenuto tradotto in applyTranslations(), in base a subscription/pro
  rangeTooltip.innerHTML = "";

  sommelierRangeLabel.insertAdjacentElement("afterend", rangeTooltip);
}

if (isPro) {
  document.getElementById("lockIcon").style.display = "none";
  document.getElementById("proTooltip").style.display = "none";
}

if (!isPro) {
  const inputFile = document.getElementById("sommelierLogoUpload");
  if (inputFile) {
    inputFile.disabled = true;
    inputFile.style.opacity = "0.5";
    inputFile.style.cursor = "not-allowed";
    const lockIcon = document.getElementById("lockIcon");
    const tooltip = document.getElementById("proTooltip");
    const upgradeLink = document.getElementById("upgradeLink");

    lockIcon.addEventListener("click", () => {
      tooltip.style.display = "block";
    });

    upgradeLink.href = `abbonamento.html?ristorante_id=${RESTAURANT_ID}`;
  }
}
    const sommelierUrl = info?.sommelier_url || (gender === "donna" ? "sommelier_femmina.png" : "sommelier.png");
      if (!info?.sommelier_url) {
        document.getElementById("defaultSommelierChoice").style.display = "flex";
        selezionaDefaultSommelier(info?.sommelier_gender || "uomo");
      } else {
        renderSommelierLogoPreview(sommelierUrl);
      }
    window.__WF_REST_NAME = info?.nome || '';
    setRestaurantTitle(window.__WF_REST_NAME);
    document.getElementById("displayName").value = info?.nome || "";
    document.getElementById("wineOrder").value = info?.ordine_vini || "prezzo";
    document.getElementById("displayName").addEventListener("input", (e) => {
    window.__WF_REST_NAME = e.target.value || '';
    setRestaurantTitle(window.__WF_REST_NAME);
});
  const fontBody = info?.font || "Arial";
const bodyFontSelect = document.getElementById("fontSelector");
let fontOption = [...bodyFontSelect.options].find(o => o.value === fontBody);
if (!fontOption) {
  fontOption = new Option(fontBody, fontBody);
  bodyFontSelect.add(fontOption);
}
bodyFontSelect.value = fontBody;
    document.getElementById("nameFont").addEventListener("change", () => {
  const font = document.getElementById("nameFont").value;
  if (font === "custom") {
    showFontPopup();
  } else {
    updateNamePreviewLive();
  }
});
document.getElementById("fontSelector").addEventListener("change", () => {
  const font = document.getElementById("fontSelector").value;
  if (font === "custom") {
    showFontPopupForBody();
  }
});
document.getElementById("paletteSelector").addEventListener("change", () => {
  updatePaletteLivePreview();
});
document.getElementById("wineOrder").addEventListener("change", async (e) => {
  const ordine = e.target.value;
  await sb
    .from("ristoranti")
    .update({ ordine_vini: ordine })
    .eq("id", RESTAURANT_ID);
    updatePreview(); // forza il refresh dell‚Äôanteprima
    updatePreviewLive(); // se gi√† presente, pu√≤ restare
});

    const paletteSelector = document.getElementById("paletteSelector");
const savedPalette = info?.palette_color || "rosso";

for (let option of paletteSelector.options) {
  if (option.getAttribute("data-palette") === savedPalette) {
    paletteSelector.value = option.value;
    break;
  }
}
updateNamePreviewLive();
updateLogoPreviewLive();

    if (info?.logo_url) {
  setLogoUploadUIVisible(false);
  toggleNameLogoOptions(true);
  renderLogoPreview(info.logo_url);
  attachLogoListeners();
  updateLogoPreviewLive();
} else {
  setLogoUploadUIVisible(true); 
  toggleNameLogoOptions(false);
}

const iframe = document.getElementById("previewFrame");
iframe.addEventListener("load", () => {
  updateNamePreviewLive(); // aggiorna subito una volta
    updateLogoPreviewLive(); // ‚úÖ aggiungi anche questo!

  ["nameSize", "nameColor", "nameBold", "nameFont", "displayName"].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      const type = el.tagName === "SELECT" || el.type === "checkbox" ? "change" : "input";
      el.addEventListener(type, updateNamePreviewLive);
    }
  });
});

    updatePreview();
// Mostra la sezione carta dei vini all‚Äôavvio
showSettings('carta');
    // ensure translations apply after initial rendering
    applyTranslations();

      document.getElementById("fontSelector").addEventListener("change", () => {
        updateFontLivePreview(); // anteprima live font body
      });
      bindCustomFileUI("logoUpload", "logoChooseBtn", "logoFileName");
      bindCustomFileUI("sommelierLogoUpload", "sommelierChooseBtn", "sommelierFileName");
  });
  document.getElementById("toggleSommelierBtn").addEventListener("change", async function () {
  const showSommelier = this.checked;

  const { error } = await sb
    .from("ristoranti")
    .update({ sommelier_attivo: showSommelier })
    .eq("id", RESTAURANT_ID);

  if (error) {
    alert(t("sommelier_toggle_save_error"));
    console.error("Errore Supabase:", error);
  } else {
    console.log("‚úîÔ∏è Impostazione sommelier salvata:", showSommelier);
  }
});

document.getElementById("logoUpload").addEventListener("change", async (event) => {
  const file = event.target.files[0];
  const allowedTypes = ["image/jpeg", "image/png", "image/webp", "image/gif"];
if (!allowedTypes.includes(file.type)) {
  return alert(t("unsupported_format"));
}

  if (!file) return;

  const ext = file.name.split('.').pop();
  const fileName = `${RESTAURANT_ID}.${ext}`;
  const filePath = `ristoranti/${fileName}`;

  const { data: existing } = await sb
    .storage
    .from("loghi")
    .list("ristoranti", { search: fileName });

  if (existing?.length > 0) {
    await sb.storage.from("loghi").remove([filePath]);
  }

  const { error: uploadError } = await sb.storage
    .from("loghi")
    .upload(filePath, file, {
      contentType: file.type
    });

  if (uploadError) {
    console.error(uploadError);
    return alert(t("logo_upload_error"));
  }

const { data: { publicUrl } } = sb
  .storage
  .from("loghi")
  .getPublicUrl(filePath);

  await sb
    .from("ristoranti")
    .update({ logo_url: publicUrl })
    .eq("id", RESTAURANT_ID);

  alert(t("logo_upload_success"));
  toggleNameLogoOptions(true);
  renderLogoPreview(publicUrl);
  setLogoUploadUIVisible(false);
  attachLogoListeners();
  updateLogoPreviewLive();
});

let reorderMode = null;

// --- Bottom nav: menu "Altro" ---
function toggleMoreMenu(force) {
  const menu = document.getElementById("moreMenu");
  const btn = document.getElementById("moreBtn");
  if (!menu) return;

  const shouldShow = (typeof force === "boolean") ? force : !menu.classList.contains("show");
  menu.classList.toggle("show", shouldShow);
  if (btn) btn.setAttribute("aria-expanded", shouldShow ? "true" : "false");
}

document.addEventListener("click", (e) => {
  const menu = document.getElementById("moreMenu");
  const btn = document.getElementById("moreBtn");
  if (!menu || !btn) return;
  if (!menu.classList.contains("show")) return;
  if (menu.contains(e.target) || btn.contains(e.target)) return;
  toggleMoreMenu(false);
});

function setBottomNavActive(which) {
  const map = { carta: "bnCarta", sommelier: "bnSommelier" };
  document.querySelectorAll("#bottomNav .bn-item").forEach(b => b.classList.remove("active"));
  const id = map[which];
  if (id) document.getElementById(id)?.classList.add("active");
}

function toggleReorder(type) {
  const iframe = document.getElementById("previewFrame");
  const btn = document.getElementById(`ordina${capitalize(type)}Btn`);

  if (type === 'sottocategorie') {
    // chiedi a carta se sei dentro una categoria
    iframe.contentWindow.postMessage({ action: 'checkSubcategoryContext' }, '*');
    return; // il resto viene gestito dopo la conferma dal messaggio di ritorno
  }

  if (reorderMode === type) {
    iframe.contentWindow.postMessage({ action: 'getReorder', type }, '*');
    btn.textContent = (type === "categorie") ? t("order_categories") : t("order_subcategories");
    reorderMode = null;
  } else {
    iframe.contentWindow.postMessage({ action: 'startReorder', type }, '*');
    btn.textContent = t("save_order");
    reorderMode = type;
  }
}

window.addEventListener("message", async (event) => {
  if (event.data?.action === 'saveReorder') {
    const type = event.data.type;
   if (!type || (type === 'categorie' && !Array.isArray(event.data.ordine))) return;
   if (type === "sottocategorie" && (!event.data.sottocategorieMap || typeof event.data.sottocategorieMap !== "object")) {
  return;
}

let update;

if (type === "categorie") {
  update = { ordine_categorie: event.data.ordine };
} else {
  // ‚úÖ MERGE: aggiorna solo la categoria corrente senza toccare le altre
  const { data: row, error: readErr } = await sb
    .from("ristoranti")
    .select("ordine_sottocategorie")
    .eq("id", RESTAURANT_ID)
    .single();

  let existing = row?.ordine_sottocategorie || {};
  if (typeof existing === "string") {
    try { existing = JSON.parse(existing); } catch { existing = {}; }
  }

  const merged = {};

  // normalizzo e porto dentro tutto l'esistente
  for (const [catName, arr] of Object.entries(existing || {})) {
    merged[normalize(catName)] = Array.isArray(arr) ? arr : [];
  }

  // applico SOLO la categoria che arriva da carta
  const incoming = event.data.sottocategorieMap || {};
  for (const [catKey, arr] of Object.entries(incoming)) {
    merged[normalize(catKey)] = Array.isArray(arr) ? arr : [];
  }

  update = { ordine_sottocategorie: merged };
}

    const { error } = await sb.from("ristoranti").update(update).eq("id", RESTAURANT_ID);
    if (error) return alert("Errore durante il salvataggio dell'ordine");
    alert(t("order_saved", { type: type === "categorie" ? t("order_categories") : t("order_subcategories") }));
    updatePreview();
  }

  if (event.data?.action === 'subcatReady') {
    const iframe = document.getElementById("previewFrame");
    const btn = document.getElementById("ordinaSottocategorieBtn");

    if (!event.data.allowed) {
      alert(t("need_open_category"));
      return;
    }

    if (reorderMode === 'sottocategorie') {
      iframe.contentWindow.postMessage({ action: 'getReorder', type: 'sottocategorie' }, '*');
      btn.textContent = t("order_subcategories");
      reorderMode = null;
    } else {
      iframe.contentWindow.postMessage({ action: 'startReorder', type: 'sottocategorie' }, '*');
      btn.textContent = t("save_order");
      reorderMode = 'sottocategorie';
    }
  }
});


function capitalize(str) {
  return str.charAt(0).toUpperCase() + str.slice(1);
}

function updatePreview() {
  if (!RESTAURANT_ID) return;

  const qs = new URLSearchParams({
    ristorante_id: RESTAURANT_ID,
    preview: "1",
    lang: currentLang
  }).toString();

  document.getElementById("previewFrame").src = `carta.html?${qs}`;
}

function goTo(path) {
    if (path === "carta.html" && !isSubActive()) {
    showNoSubPopup();
    return;
  }
  if (path === 'carta.html' && window.RISTORANTE_SLUG) {
    // URL bello
    window.location.href = `/${window.RISTORANTE_SLUG}`;
  } else {
    // fallback con ?ristorante_id=
    window.location.href = `${path}?ristorante_id=${RESTAURANT_ID}&lang=${currentLang}`;
  }
}


    async function logout() {
      await sb.auth.signOut();
      window.location.href = "/";
    }
    function showSettings(type, doScroll = true) {
const main = document.querySelector("main");
const showCarta = type === "carta";
document.getElementById("cartaSettings").style.display = showCarta ? "block" : "none";
document.getElementById("sommelierSettings").classList.toggle("active", !showCarta);
main.classList.toggle("sommelier-mode", !showCarta);
setBottomNavActive(type);
toggleMoreMenu(false);
if (showCarta) initCartaQuickActions();

      if (type === "sommelier" && !document.querySelector("#boostContainer input")) {
        const container = document.getElementById("boostContainer");
        container.innerHTML = "";

        let savedBoosts = [];
        try {
          const raw = window._sommelierBoostRaw;
          savedBoosts = typeof raw === "string" ? JSON.parse(raw) : raw;
        } catch (e) {
          console.warn("Errore nel parsing sommelier_boost_multi", e);
        }

        if (Array.isArray(savedBoosts) && savedBoosts.length > 0) {
          savedBoosts.forEach(val => addBoostInput(val));
        } else {
          addBoostInput();
        }
      }

      if (doScroll) window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function showQRCode() {
  if (!isSubActive()) {
    showNoSubPopup();
    return;
  }
      const popup = document.getElementById('qrPopup');
      const container = document.getElementById('qrCodeContainer');
      container.innerHTML = '';
      const base = "https://www.wineinapp.com/";
      const url = window.RISTORANTE_SLUG
        ? `${base}/${window.RISTORANTE_SLUG}`                 // es. /osteria-pippo
        : `${base}/carta.html?ristorante_id=${RESTAURANT_ID}`; // fallback
      new QRCode(container, { text: url, width: 250, height: 250 });
      popup.style.display = 'flex';
      setTimeout(() => {
        const img = container.querySelector('img');
        document.getElementById('downloadQr').onclick = () => {
          const a = document.createElement('a');
          a.href = img.src;
          a.download = 'qr-code.png';
          a.click();
        }
      }, 500);
      popup.onclick = (e) => { if (e.target === popup) popup.style.display = 'none'; }
    }

function downloadCartaPDF() {
  if (!isSubActive()) {
    showNoSubPopup();
    return;
  }
  const iframe = document.getElementById("previewFrame");
  if (!iframe || !iframe.contentWindow) {
    alert(t("preview_not_available"));
    return;
  }

  // Chiede alla carta (iframe) di generare il PDF
  iframe.contentWindow.postMessage({ action: "downloadPDF" }, "*");
}

    function updatePreviewLive() {
  const iframe = document.getElementById("previewFrame");
  if (!iframe) return;
  const currentUrl = new URL(iframe.src);
  currentUrl.searchParams.set("preview", Date.now()); // forza reload
  iframe.src = currentUrl.toString();
}

async function saveSettings() {
  const showSommelier = document.getElementById("toggleSommelierBtn").checked;
  const nameFont = document.getElementById("nameFont").value;
  const nameSize = document.getElementById("nameSize").value;
  const nameColor = document.getElementById("nameColor").value;
  const nameBold = document.getElementById("nameBold").checked;
  const logoSize = document.getElementById("logoSize").value;
  const nome = document.getElementById("displayName").value;
  const font = document.getElementById("fontSelector").value;

  const paletteSelect = document.getElementById("paletteSelector");
  const selectedOption = paletteSelect.options[paletteSelect.selectedIndex];
  const palette_color = selectedOption?.getAttribute("data-palette") || "rosso";

  // --- NUOVO: slug ---
  const slugInput = document.getElementById("slugInput");
  const wantedSlug = slugInput.value.trim();

  // Se l‚Äôutente ha inserito uno slug, validalo e verifica che non sia occupato
  let slugToSave = null;
  if (wantedSlug) {
    if (!isValidSlug(wantedSlug)) {
      alert(t("slug_not_valid_alert"));
      return;
    }
    const res = await checkSlugAvailability(wantedSlug);
    if (!res.ok) {
      alert(res.code === "taken"
        ? t("slug_taken_alert")
        : t("slug_verify_error_alert"));
      return;
    }
    slugToSave = wantedSlug;
  } else {
    // se vuoto, consenti salvare slug NULL (URL vecchio con query)
    slugToSave = null;
  }

  const updatePayload = {
    nome,
    font,
    palette_color,
    logo_size: logoSize,
    name_size: nameSize,
    name_color: nameColor,
    name_bold: nameBold,
    name_font: nameFont,
    sommelier_attivo: showSommelier,
    sommelier_gender: document.getElementById("sommelierGender").value,
    slug: slugToSave
  };

  const { error } = await sb
    .from("ristoranti")
    .update(updatePayload)
    .eq("id", RESTAURANT_ID);

  if (error) {
    console.error("Errore salvataggio:", error);
    alert(t("save_error"));
    return;
  }

  // Aggiorna lo stato in pagina
  window.RISTORANTE_SLUG = slugToSave || "";
  const msg = document.getElementById("saveMessage");
  msg.style.display = "block";
  setTimeout(() => { msg.style.display = "none"; }, 3000);

  // feedback sul bottone principale (se presente)
  const btn = document.querySelector(".save-btn");
  if (btn) {
    const originalText = btn.textContent;
    btn.textContent = t("saved_short");
    setTimeout(() => { btn.textContent = originalText; }, 2000);
  }

  // Aggiorna anteprima/iframe e (indirettamente) QR
  updatePreview();
  updatePreviewLive();
}

async function saveSommelierSettings() {
  const range = document.getElementById("sommelierRange").value;
  const gender = document.getElementById("sommelierGender").value;

  const inputs = document.querySelectorAll("#boostContainer input");
  const boostMulti = Array.from(inputs)
    .map(i => i.value.trim())
    .filter(Boolean);

  await sb.from("ristoranti").update({
    sommelier_range: range,
    sommelier_boost_multi: boostMulti,
    sommelier_gender: gender
  }).eq("id", RESTAURANT_ID);

  alert(t("sommelier_saved"));
}


document.getElementById("sommelierLogoUpload").addEventListener("change", async (event) => {
  if (!isPro) {
    return alert(t("sommelier_pro_only_alert"));
  }
  const file = event.target.files[0];
  const allowedTypes = ["image/jpeg", "image/png", "image/webp", "image/gif"];
if (!allowedTypes.includes(file.type)) {
  return alert(t("unsupported_format"));
}

  if (!file) return;

  const ext = file.name.split('.').pop();
  const fileName = `sommelier_${RESTAURANT_ID}.${ext}`;

  await sb.storage.from("sommelier").remove([fileName]); // optional: pulizia

  const { error: uploadError } = await sb.storage
    .from("sommelier")
    .upload(fileName, file, {
      contentType: file.type,
      upsert: true
    });

  if (uploadError) {
    console.error(uploadError);
    return alert(t("sommelier_logo_upload_error"));
  }

  const { data: { publicUrl } } = sb
    .storage
    .from("sommelier")
    .getPublicUrl(fileName);

  await sb.from("ristoranti").update({ sommelier_url: publicUrl }).eq("id", RESTAURANT_ID);

  renderSommelierLogoPreview(publicUrl);

  const iframe = document.getElementById("previewFrame");
  if (iframe?.contentWindow) {
    iframe.contentWindow.postMessage({ action: "updateSommelierLogo", url: publicUrl }, "*");
  }
});

  window.updateNamePreviewLive = function () {
  let font = document.getElementById("nameFont").value;
  const size = document.getElementById("nameSize").value;
  const color = document.getElementById("nameColor").value;
  const bold = document.getElementById("nameBold").checked;
  const name = document.getElementById("displayName").value;

  const iframe = document.getElementById("previewFrame");
  if (!iframe || !iframe.contentWindow) return;

  iframe.contentWindow.postMessage({
    action: "updateNameLive",
    size,
    color,
    bold,
    font,
    name
  }, "*");

  // carica dinamicamente il font se non gi√† incluso
  // carica dinamicamente il font se non gi√† incluso
if (
  font &&
  font !== "Arial" &&
  font !== "custom" &&
  !["sans-serif", "cursive", "monospace"].includes(font)
) {
  const fontLinkId = "customGoogleFont";
  let existing = document.getElementById(fontLinkId);
  if (existing) existing.remove();

  const encodedFont = encodeURIComponent(font.trim()).replace(/%20/g, "+");
  const link = document.createElement("link");
  link.id = fontLinkId;
  link.rel = "stylesheet";
  link.href = `https://fonts.googleapis.com/css2?family=${encodedFont}&display=swap`;
  document.head.appendChild(link);
}
}

function showFontPopup() {
  const fonts = [
  "Cormorant Garamond",
  "Great Vibes",
  "Bebas Neue",
  "Merriweather",
  "Abril Fatface",
  "Lobster",
  "Oswald",
  "Amatic SC",
  "Bitter",
  "Quicksand"
];

  const container = document.getElementById("fontChoices");
  container.innerHTML = "";
  fonts.forEach(font => {
    const div = document.createElement("div");
div.innerHTML = `<div style="font-family: '${font}'; font-size: 1.2em;">${font}</div>`;
    div.textContent = font;
    div.style.fontFamily = `'${font}', cursive`;
    div.style.padding = "10px";
    div.style.textAlign = "center";
    div.style.border = "1px solid #ccc";
    div.style.borderRadius = "6px";
    div.style.cursor = "pointer";
    div.style.fontSize = "1.1em";
    div.onclick = () => {
  document.getElementById("fontPopup").style.display = "none";

  const select = document.getElementById("nameFont");
  let option = [...select.options].find(o => o.value === font);

  if (!option) {
    option = new Option(font, font);
    select.add(option);
  }
  select.value = font;
  updateNamePreviewLive();

  // carica dinamicamente il font se non √® generico
  if (!["sans-serif", "cursive", "monospace"].includes(font)) {
    const fontLinkId = "customGoogleFont";
    let existing = document.getElementById(fontLinkId);
    if (existing) existing.remove();

    const encodedFont = encodeURIComponent(font.trim()).replace(/%20/g, "+");
    const link = document.createElement("link");
    link.id = fontLinkId;
    link.rel = "stylesheet";
    link.href = `https://fonts.googleapis.com/css2?family=${encodedFont}&display=swap`;
    document.head.appendChild(link);
  }
};
    container.appendChild(div);
  });

  document.getElementById("fontPopup").style.display = "flex";
}
function showFontPopupForBody() {
  const fonts = [
    "Cormorant Garamond", "Great Vibes", "Bebas Neue", "Merriweather",
    "Abril Fatface", "Lobster", "Oswald", "Amatic SC", "Bitter", "Quicksand"
  ];

  const container = document.getElementById("fontChoices");
  container.innerHTML = "";
  fonts.forEach(font => {
    const div = document.createElement("div");
    div.innerHTML = `<div style="font-family: '${font}'; font-size: 1.2em;">${font}</div>`;
    div.style.fontFamily = `'${font}', cursive`;
    div.style.padding = "10px";
    div.style.textAlign = "center";
    div.style.border = "1px solid #ccc";
    div.style.borderRadius = "6px";
    div.style.cursor = "pointer";
    div.style.fontSize = "1.1em";

    div.onclick = () => {
      document.getElementById("fontPopup").style.display = "none";

      const select = document.getElementById("fontSelector");
      let option = [...select.options].find(o => o.value === font);
      if (!option) {
        option = new Option(font, font);
        select.add(option);
      }
      select.value = font;
      updateFontLivePreview(); // ‚úÖ aggiunto per aggiornare l'iframe

      if (!["sans-serif", "cursive", "monospace"].includes(font)) {
        const fontLinkId = "customGoogleFontBody";
        let existing = document.getElementById(fontLinkId);
        if (existing) existing.remove();

        const encodedFont = encodeURIComponent(font.trim()).replace(/%20/g, "+");
        const link = document.createElement("link");
        link.id = fontLinkId;
        link.rel = "stylesheet";
        link.href = `https://fonts.googleapis.com/css2?family=${encodedFont}&display=swap`;
        document.head.appendChild(link);
      }
    };
    container.appendChild(div);
  });

  document.getElementById("fontPopup").style.display = "flex";
}
  </script>
</body>
</html>