<!DOCTYPE html>
<html lang="it">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<script>  document.documentElement.classList.add('boot-loading'); </script>
<title>Carta dei Vini</title>
<style id="dynamic-style">
/* =========================
   VARIABILI BASE
========================= */
:root{
  --accent-color: #b00;
  --bg-default: #fff9f4;
  --bottom-bar-height: 56px;
  --sommelier-side-gap: 12px;         /* margine ai lati */
  --sommelier-height:   64px;         /* leggermente > della bottom bar (56px) */
  --safe-bottom-gap: 24px; /* margine extra per ombre/animazioni */
}

/* =========================
   ELEMENTI COMUNI
========================= */
body{
  font-family: sans-serif;
  background: var(--bg-default);
  color:#333;
  margin:0;
  padding-top:60px;
}

/* ===== BOOT SPLASH: evita flash e scatti iniziali ===== */
#bootSplash{
  position:fixed; inset:0;
  display:none;
  align-items:center; justify-content:center;
  background: var(--bg-default);
  z-index: 99999;
  font-family: sans-serif;
}
#bootSplash .box{
  padding:14px 16px;
  border-radius:14px;
  border:1px solid rgba(0,0,0,.12);
  background: rgba(255,255,255,.75);
  backdrop-filter: blur(6px);
  box-shadow: 0 10px 30px rgba(0,0,0,.12);
  font-weight:700;
}
html.boot-loading #bootSplash{ display:flex; }
html.boot-loading body{ overflow:hidden; } /* evita scroll durante lo splash */
html.boot-loading #app,
html.boot-loading nav,
html.boot-loading #bottomBar,
html.boot-loading #helperBanner{ visibility:hidden; } /* nasconde UI, lascia visibile lo splash */

button, .save-btn{ background-color: var(--accent-color); }

#restaurantName{ cursor:pointer; margin:0 auto; display:flex; align-items:center; justify-content:center; gap:10px; font-size:1.2em; line-height:1.2; text-align:center; white-space:normal; }
#restaurantName span{ display:block; line-height:1.2; }
#restaurantLogo{ display:block; max-height:120px; object-fit:contain; border-radius:6px; }

/* Helper banner */
.helper-banner{ position:relative; z-index:900; margin:14px 16px; padding:0; font-weight:600; text-align:center; border:0; box-shadow:none; background:transparent; color:inherit; }
:root .helper-banner{ background: var(--bg-default); border-color:#ddd; color:#333; }
@media (max-width:480px){ .helper-banner{ margin:10px; font-size:.95em; } }

/* =========================
   NAVBAR
========================= */
nav{
  position:fixed; top:0; left:0; right:0;
  background:#fff; display:flex; justify-content:space-between; align-items:center;
  padding:.5em 1em; border-bottom:1px solid #ddd; z-index:1000; min-height:60px;
}
nav button{ background:none; border:none; font-size:1em; cursor:pointer; color:var(--accent-color); }

/* =========================
   LISTE / CARD
========================= */
.category-list, .subcategory-list, .wine-list{padding: .5em 1em;padding-bottom: calc(var(--bottom-bar-height) + var(--sommelier-height) + var(--safe-bottom-gap));}
.category, .subcategory, .wine-card{
  background:inherit; margin-bottom:.6em; padding:1em; border:1px solid; border-radius:12px;
  box-shadow:0 2px 4px rgba(0,0,0,.1);
  transition: background-color .3s ease, color .3s ease, box-shadow .3s ease, transform .2s ease;
  cursor:pointer;
}
.category:hover, .subcategory:hover, .wine-card:hover{ transform:scale(1.02); }

.category-list{ display:grid; grid-template-columns:1fr; gap:1em; }
.subcategory-list{ display:grid; grid-template-columns: repeat(auto-fit, minmax(120px,1fr)); gap:1em; }
.subcategory{ text-align:center; }

/* Prezzi nelle card vino */
.price-row{ display:flex; align-items:center; flex-wrap:wrap; gap:12px; margin:6px 0 4px; }
.price-chip{ display:inline-flex; align-items:center; gap:6px; font-size:.95em; }
.price-chip img.icon{ width:25px; height:25px; vertical-align:middle; object-fit:contain; }
.price-chip strong{ font-weight:600; }

/* =========================
   BOTTOM BAR FISSA
========================= */
#bottomBar{
  position:fixed; left:0; right:0; bottom:0;
  height:var(--bottom-bar-height);
  background: var(--navbar-color, #222);
  display:grid;
  grid-template-columns: 1fr auto 1fr; /* sinistra | centro | destra */
  align-items:center;
  padding:8px 12px;                   /* üëà pi√π respiro */
  z-index:980;
  box-shadow:0 -2px 8px rgba(0,0,0,.15);
}

.bottom-btn{
  height:44px; min-width:44px;
  padding:0 10px;
  border:none; border-radius:12px;
  background: rgba(255,255,255,0.06);          /* ghost */
  color: var(--bottom-bar-foreground, #fff);
  display:flex; align-items:center; gap:8px; justify-content:center;
  font-weight:700;
  transition: transform .12s ease, background .2s ease, box-shadow .2s ease;
}
.bottom-btn:hover{ transform: translateY(-1px); }
.bottom-btn img{ width:24px; height:24px; display:block; }

.bottom-btn.active{
  background: rgba(255,255,255,0.18);
  outline: 2px solid rgba(255,255,255,0.28);
  box-shadow: 0 4px 14px rgba(0,0,0,.18);
}

/* Gruppo formati come "segment control" */
#formatBtnGroup{
  justify-self:end;
  display:flex;
  gap:4px;                                /* üëà ravvicinati */
  padding:4px;
  background: rgba(255,255,255,0.10);
  border-radius:14px;
  backdrop-filter: blur(6px);
}
#formatBtnGroup .bottom-btn{
  width:44px; height:44px;
  padding:0;
  border-radius:10px;
  background: transparent;                /* fantasma dentro il group */
}
#formatBtnGroup .bottom-btn.active{
  background: rgba(255,255,255,0.22);
  outline: 2px solid rgba(255,255,255,0.30);
}
/* Effetto visivo ‚ÄúGlass Mode‚Äù quando il filtro al calice √® attivo */
.bottom-btn.glass-mode {
  background: linear-gradient(135deg, rgba(255,255,255,0.4), rgba(255,255,255,0.15));
  box-shadow: 0 0 15px rgba(255,255,255,0.6), inset 0 0 10px rgba(255,255,255,0.3);
  transform: scale(1.05);
  transition: all 0.25s ease;
}

/* =========================
   BOTTONE SOMMELIER (pulito)
========================= */
/* ‚Äî Posizionamento e layout */
#sommelierBtn{
  position:fixed;
  bottom: calc(var(--bottom-bar-height) + 22px);
  left: var(--sommelier-side-gap);
  right: var(--sommelier-side-gap);
  transform: none;                     /* niente translateX */
  width: auto;                         /* occupa tutto tra left e right */
  max-width: none;                     /* niente limite */
  height: var(--sommelier-height);
  min-height: var(--sommelier-height);
  padding: 8px 16px;                   /* pi√π snello */
  gap: 10px;
  z-index:1000;

  /* aspetto ‚Äúprimo screen‚Äù */
  background: linear-gradient(90deg,
  color-mix(in srgb, var(--accent-color) 92%, #000),
  color-mix(in srgb, var(--accent-color) 78%, #fff)
);
border: 1px solid rgba(255,255,255,.35);
  color:#fff; border:none; border-radius:999px;
  display:flex; align-items:center; gap:12px; box-sizing:border-box;
  box-shadow:0 14px 28px rgba(0,0,0,.2), 0 0 0 6px rgba(255,255,255,.35) inset;
  font-size:1rem; font-weight:700; cursor:pointer;
  transition: transform .15s ease, filter .2s ease, box-shadow .2s ease;
  white-space:normal; /* consente al testo di andare a capo dentro al bottone */
}
#sommelierBtn:hover  { transform: scale(1.01); }
#sommelierBtn:active { transform: scale(.98);  }

/* ‚Äî Avatar */
#sommelierBtn img{
  width:32px; height:32px; border-radius:50%; object-fit:cover; flex:0 0 auto;
  box-shadow:0 0 0 2px rgba(255,255,255,.6);
}

/* ‚Äî Testo e badge */
#sommelierBtn .somm-text{ display:flex; flex-direction:column; line-height:1.05; max-width: none;white-space: normal;flex: 1 1 auto; }
#sommelierBtn .somm-title{ font-weight:800; letter-spacing:.2px;font-size: 0.95em; }
#sommelierBtn .somm-sub{ font-size: 0.82em; opacity: .95; font-weight:600; margin-top:2px; }

/* ‚Äî Effetti */
#sommelierBtn.glow{ box-shadow:0 14px 28px rgba(0,0,0,.2), 0 0 0 6px rgba(255,255,255,.35) inset, 0 0 24px rgba(255,60,120,.35); }
@keyframes sommWiggle{
  0%,100% { transform: rotate(0deg); }
  15%     { transform: rotate(-2deg); }
  30%     { transform: rotate( 2deg); }
  45%     { transform: rotate(-1.4deg); }
  60%     { transform: rotate( 1.4deg); }
  75%     { transform: rotate(-.6deg); }
  90%     { transform: rotate( .6deg); }
}
#sommelierBtn.wiggle { animation: sommWiggle .9s ease; }
#sommelierBtn.pulse{ animation:sommPulse 1.8s ease-out infinite; }
@keyframes sommPulse{
  0%{ box-shadow:0 0 0 0 rgba(0,0,0,.22), 0 10px 24px rgba(0,0,0,.18); }
  100%{ box-shadow:0 0 0 16px rgba(0,0,0,0), 0 10px 24px rgba(0,0,0,.18); }
}

/* Popover posizionati sopra la bar */
#searchPopover{ bottom: calc(var(--bottom-bar-height) + 22px) !important; }
#filterMenu{    bottom: calc(var(--bottom-bar-height) + 14px) !important; }

/* =========================
   POPUP SOMMELIER
========================= */
#sommelierOverlay{ position:fixed; inset:0; background:rgba(0,0,0,.25); z-index:1000; display:none; justify-content:center; align-items:center; }
#sommelierPopup{
  background:#fff; border-radius:16px; padding:30px; width:90vw; max-width:500px;
  box-shadow:0 8px 24px rgba(0,0,0,.2); position:relative; animation: popupEnter .35s ease-out;
  max-height:90vh; overflow-y:auto; overscroll-behavior:contain; scrollbar-width:thin;
}
#sommelierPopup h3{ margin-top:0; }
#sommelierPopup input{
  width:100%; padding:12px; font-size:1em; border-radius:8px; border:1px solid #ccc; margin-top:10px;
}
#sommelierPopup .close-btn{ position:absolute; top:10px; left:10px; background:none; border:none; font-size:1.2em; cursor:pointer; }

/* =========================
   POPUP DESCRIZIONE VINO
========================= */
.popup-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:flex; justify-content:center; align-items:center; z-index:9999; }
.popup-descrizione{
  background:#fff; padding:20px; border-radius:16px; max-width:400px; width:90%;
  box-shadow:0 6px 16px rgba(0,0,0,.2); position:relative;
}
.popup-descrizione h3{ margin-top:0; font-size:1.2em; }
.popup-descrizione .close-btn{ position:absolute; top:10px; right:12px; font-size:1.2em; background:none; border:none; cursor:pointer; }

/* Dropdown categorie nel popup sommelier */
#wineTypeDropdown{
  position:fixed; background:#fff; border:1px solid #ccc; border-radius:8px; padding:8px 12px;
  box-shadow:0 4px 12px rgba(0,0,0,.1); z-index:3000; display:none; font-size:.95em; min-width:220px; animation: slideDown .2s ease-out;
}

/* =========================
   ANIMAZIONI GENERICHE
========================= */
.fade-in{ animation: fadeIn .4s ease forwards; opacity:0; }
.fade-out{ animation: fadeOut .3s ease forwards; opacity:1; }
.sommelier-fadein{ animation: fadeIn .5s ease both; }
.sommelier-card{ animation: fadeInUp .4s ease forwards; opacity:0; }

@keyframes slideDown{ from{opacity:0; transform:translateY(-5px);} to{opacity:1; transform:translateY(0);} }
@keyframes popupEnter{ from{opacity:0; transform:scale(.95) translateY(20px);} to{opacity:1; transform:scale(1) translateY(0);} }
@keyframes fadeIn{ to{opacity:1;} }
@keyframes fadeOut{ to{opacity:0; display:none;} }
@keyframes fadeInUp{ from{ transform:translateY(20px); opacity:0; } to{ transform:translateY(0); opacity:1; } }
@keyframes fadeSlideIn{ from{ opacity:0; transform:translateY(10px);} to{ opacity:1; transform:translateY(0);} }

/* =========================
   GLASS EFFECT (palette)
========================= */
.glass{ background:rgba(255,255,255,.3); backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px); border:1px solid rgba(255,255,255,.4); }
.glass-dark{ background:rgba(20,20,20,.3); backdrop-filter:blur(6px); border:1px solid rgba(255,255,255,.1); }

/* =========================
   SCHEDA VINO
========================= */
.vino-card{ border-radius:12px; padding:12px; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,.06); }
.vino-card h4{ margin:0 0 6px 0; font-size:1.05em; }
.vino-card p.summary{ margin:6px 0 10px; }
.vino-bars .bar{ display:grid; grid-template-columns:64px 1fr 84px; gap:8px; align-items:center; margin:6px 0; }
.vino-bars .track{ height:6px; background:#eee; border-radius:999px; position:relative; }
.vino-bars .knob{ position:absolute; top:-4px; width:14px; height:14px; border-radius:50%; background: var(--accent-color,#c41d1d); left:0; transform:translateX(-50%); }
.vino-chips{ display:flex; flex-wrap:wrap; gap:6px; margin:8px 0; }
.vino-chips span{ background:#f6f6f6; border-radius:999px; padding:6px 10px; font-size:.9em; }
.vino-chips.muted span{ background:#fafafa; color:#666; }
.vino-toggle{ margin-top:8px; font-size:.9em; border:none; background:transparent; color:var(--accent-color,#b00); cursor:pointer; }

.vino-section { margin-top: 8px; }
.vino-section-title { font-weight: 700; font-size: .9em; margin-bottom: 6px; opacity: .9; }
.vino-chips .chip { background:#f6f6f6; border-radius:999px; padding:6px 10px; font-size:.9em; }

/* ‚Äî Sommelier (card zig-zag + badge/pill fissi agli angoli) ‚Äî */
.somm-list .sommelier-card{ max-width:540px; }
.somm-list .sommelier-card:nth-child(even){ margin-left:auto; } /* zig-zag dx/sx */

/* contenitore card */
.sommelier-card{
  position: relative;           /* NECESSARIO: √†ncora per gli elementi assoluti */
  background:#fff;
  border:1px solid var(--card-border, rgba(0,0,0,.12));
  border-radius:12px;
  padding:14px 12px;
  margin:8px 0;
  box-shadow:0 2px 6px rgba(0,0,0,.06);
}

/* badge cluster (‚≠ê/üëç/‚ú®) in alto a sinistra ‚Äî pi√π vicino al titolo */
.sommelier-card .badge-stack{
  position:absolute; top:4px; left:8px;
  display:flex; gap:4px; font-size:1rem; line-height:1;
}

/* pill del colore in alto a destra ‚Äî stessa altezza dei badge */
.sommelier-card .color-pill{
  position:absolute; top:6px; right:8px;
  font-size:.78em; font-weight:800; line-height:1;
  padding:3px 10px; border-radius:999px;
  border:1px solid rgba(0,0,0,.12);
}

/* header: riduco il padding-top cos√¨ il nome ‚Äúsale‚Äù sotto i badge */
.sommelier-card .vino-header{
  display:flex;
  align-items:flex-start;
  flex-wrap:wrap;
  padding-top:18px;          /* ‚Üê era 32px */
  padding-left:10px;
  padding-right:10px;
}
.sommelier-card .titolo{
  flex:1 1 100%;
  font-weight:700;
  font-size:1em;
  white-space:normal;
  word-break:break-word;
  line-height:1.22;
  text-align:left;
  margin-top:2px;            /* leggerissimo avvicinamento */
}

/* riga prezzi/uvaggio */
.sommelier-card .meta{ margin-top:4px; font-size:.9em; color:#666; }
.sommelier-card .price-row{ margin:4px 0 0; gap:10px; }

/* motivazione: riquadro con bordo sinistro colorato */
.sommelier-card .motive-wrap{ margin-top:10px; }
.sommelier-card .motive-box{
  background: color-mix(in srgb, var(--bg-default, #fff9f4) 65%, #ffffff);
  border:1px solid rgba(0,0,0,.08);
  border-left:6px solid var(--accent-color, #b00);
  border-radius:10px;
  padding:10px 12px;
  line-height:1.35;
}
.sommelier-card .motive-box .label{ font-weight:800; margin-right:.25em; }

/* elimina qualsiasi ‚Äúzig zag‚Äù vecchio residuo */
.sommelier-card .zigzag{ display:none !important; }

/* =========================
   RESPONSIVE
========================= */
@media (max-width:768px){
  :root{ --sommelier-height: 68px; }
  .wine-card{ font-size:1em; padding:1em; }
  #restaurantName{ font-size:1.1em; }
}
@media (max-width:480px){
  #wineTypeDropdown{ min-width:160px; font-size:.85em; padding:6px; }
  #wineTypeDropdown label{ display:block; margin-bottom:6px; }
  #priceFilter{ font-size:.95em; }
  .wine-card{ font-size:.95em; padding:.8em; }
  #restaurantName{ font-size:1em; gap:6px; }
  #sommelierPopup{ padding:20px 16px; width:95vw; border-radius:12px; }
  .sommelier-card{ font-size:.95em; }
  .sommelier-card .vino-header{ flex-direction:column; align-items:flex-start; }
  #sommelierPopup input{ font-size:1em; max-width:100%; box-sizing:border-box; }
  nav{ padding:.3em .6em; height:auto !important; }
  #restaurantLogo{ max-height:120px; }
  #restaurantName{ font-size:1em !important; gap:6px; flex-direction:column; }
  .category, .subcategory, .wine-card{ font-size:.95em; padding:.8em; }
}
@media (max-width: 420px){
  :root{ --sommelier-height: 60px; }
  #sommelierBtn{ padding: 8px 14px; }
  #sommelierBtn img{ width:28px; height:28px; }
  #sommelierBtn .somm-title{ font-size: 0.9em; }
  #sommelierBtn .somm-sub{   font-size: 0.78em; }
}

/* --- Modalit√† export PDF: nasconde elementi di UI inutili --- */
/* ============ LAYOUT CARTA STAMPABILE (PDF) ============ */

/* ============ LAYOUT CARTA STAMPABILE (PDF) ============ */

.print-carta-root {
  max-width: 18cm;
  margin: 0 auto;
  padding: 0.9cm 0.8cm 0.9cm;
  font-size: 0.92rem;
  background: linear-gradient(#fffdf8, #fffaf2);
  color: #222;
  font-family: inherit; /* usa il font scelto dal ristorante */
}

/* HEADER PRINCIPALE */
.print-header {
  text-align: center;
  margin-bottom: 0.9cm;
}

.print-header h1 {
  font-size: 1.7rem;
  letter-spacing: 0.16em;
  text-transform: uppercase;
  margin: 0;
  color: var(--accent-color, #b00);
  font-weight: 700;
}

/* eventuale sottotitolo (es. solo vini al calice) */
.print-subtitle {
  text-align: center;
  font-size: 0.85rem;
  margin-top: 0.25cm;
  margin-bottom: 0.4cm;
  color: var(--accent-color, #b00);
  font-style: italic;
}

/* BLOCCO CATEGORIA (ROSSI, BIANCHI, BOLLICINE, ‚Ä¶) */
.print-category-block {
  margin-bottom: 0.85cm;
  page-break-inside: auto;
  break-inside: auto;
}

/* Nome categoria: pill colorata elegante */
.print-category-title {
  display: inline-flex;
  align-items: center;
  gap: 0.25cm;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.18em;
  font-size: 0.95rem;
  margin: 0 0 0.25cm;
  padding: 0.13cm 0.5cm;
  border-radius: 999px;
  border: 1px solid var(--accent-color, #b00);
  color: var(--accent-color, #b00);
  background: rgba(255, 255, 255, 0.85);
}

/* Nome sottocategoria (es. Abruzzo, Bolgheri, Champagne‚Ä¶) */
.print-subcategory-title {
  font-weight: 600;
  margin: 0.35cm 0 0.18cm;
  font-size: 0.9rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  border-bottom: 0.5pt solid rgba(0, 0, 0, 0.25);
  padding-bottom: 0.04cm;
}

/* BLOCCO VINO ‚Äì con separatore e DIVIETO di spezzarlo tra le pagine */
.print-wine-block {
  margin-bottom: 0.12cm;        /* meno spazio tra un vino e l‚Äôaltro */
  padding: 0.03cm 0 0.06cm;     /* blocco pi√π compatto */
  border-bottom: 0.4pt solid rgba(0, 0, 0, 0.10);
  page-break-inside: avoid;
  break-inside: avoid;
}

.print-category-block .print-wine-block:last-child {
  border-bottom: none;
}

/* Riga principale: nome vino + prezzi allineati a destra */
.print-wine-row {
  display: flex;
  justify-content: space-between;
  gap: 0.4cm;
  line-height: 1.25;
}

/* Nome vino bello presente */
.print-wine-name {
  flex: 1 1 auto;
  font-weight: 700;
  letter-spacing: 0.02em;
  font-size: 0.86rem;   /* leggermente pi√π piccolo della sottocategoria */
}

/* Prezzi (riusiamo le chip esistenti, ma allineate a destra) */
.print-wine-prices {
  flex: 0 0 auto;
  white-space: nowrap;
  text-align: right;
}

.print-wine-prices .price-row {
  justify-content: flex-end;
  gap: 4px;
  flex-wrap: wrap;
}

/* Uvaggio sotto in corsivo, pi√π leggero */
.print-wine-uvaggio {
  margin-left: 0;
  margin-top: 0;                /* attaccato al nome vino */
  font-size: 0.8rem;
  font-style: italic;
  color: #555;
}

/* --- Modalit√† export: nasconde elementi di UI inutili --- */
body.pdf-export nav,
body.pdf-export #fab,
body.pdf-export #bottomBar,
body.pdf-export #helperBanner,
body.pdf-export #sommelierOverlay,
body.pdf-export #sommelierBtn,
body.pdf-export #searchPopover,
body.pdf-export #filterMenu {
  display: none !important;
}

body.pdf-export {
  background: #ffffff !important;
}

</style>
</head>
<body>
<nav>
  <button onclick="goBack()" style="background:none; border:none; padding:0; cursor:pointer;">
  <img src="arrowicon.png" alt="Indietro" style="width:50px; height:50px; display:block;">
</button>
  <div style="flex: 1; display: flex; justify-content: center;">
    <div id="restaurantName"><span>CARTA DEI VINI</span></div>
  </div>
    <select id="langSelector" onchange="changeLanguage()" style="margin-left: 10px; font-size: 1.5em;">
    <option value="it">üáÆüáπ</option>
    <option value="en">üá¨üáß</option>
    <option value="fr">üá´üá∑</option>
    <option value="de">üá©üá™</option>
    <option value="es">üá™üá∏</option>
    <option value="zh">üá®üá≥</option>
    <option value="ko">üá∞üá∑</option>
    <option value="ru">üá∑üá∫</option>
  </select>
</nav>

<div id="helperBanner" class="helper-banner" aria-live="polite">
  Scegli una categoria!
</div>

<div id="app" class="flipbook">
  <div class="category-list page" id="category-list"></div>
  <div class="subcategory-list page" id="subcategory-list"></div>
  <div class="wine-list page" id="wine-list"></div>
</div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.42.3/dist/umd/supabase.min.js"></script>
<script>
const translations = {
  it: {
    wineList: "Carta dei Vini",
    grape: "Uvaggio",
    price: "Prezzo",
    sommelierTitle: "Il nostro sommelier ti consiglia:",
    noDescription: "Nessuna descrizione trovata.",
    filterPrice: "Filtra per prezzo",
    filterCategory: "Filtra per categoria",
    searchLabel: "Ricerca piatti per abbinamento",
    sendButton: "INVIA",
    allLabel: "Tutti",
    placeholder: "Separa piatti con le virgole.",
    loadingDescription: "Sto caricando una descrizione...",
    emptyInput: "Inserisci un piatto!",
    thinking: "Sto pensando...",
    noMatch: "Non ho trovato nessun abbinamento per questi piatti...",
    alreadyAsked: "Hai gi√† chiesto per:",
    sommelierFooter: "Il tuo Sommelier Virtuale üç∑",
    sommelierTitleBox: "Dimmi cosa mangerai e ti suggerir√≤ il vino perfetto!",
    anyPrice: "Indifferente",   // it
    motive:   "Motivazione",
    helperChooseCategory: "Scegli una categoria!",          // it
    helperClickWine: "Clicca sul vino per maggiori dettagli.", // it
    filterLabel: "Filtra",
    search:"Cerca",
    searchPlaceholder: "Cerca nome, uvaggio, note‚Ä¶",
    filterBy: "Filtra per:",
    searchButton: "Cerca",
    formatBottle: "Bottiglia",
    formatGlass: "Bicchiere",
    noSearchResult: "Nessun vino per questa ricerca.",
    sommelierBtnTitle: "Chiedi al Sommelier üç∑",
    sommelierBtnSubTpl:"Scrivi il piatto ‚Üí ti propongo {range} vini perfetti",
    sommelierBtnSub:   "Scrivi il piatto ‚Üí ti propongo i vini perfetti",
    sommelierBtn:      "Consiglio vino",
    sommelierBtnBadge: "Novit√†",
    helperGlassMode: "üç∑ Stai visualizzando solo i vini al calice",
  },
  en: {
    wineList: "Wine List",
    grape: "Grape variety",
    price: "Price",
    sommelierTitle: "Our sommelier recommends:",
    noDescription: "No description available.",
    filterPrice: "Filter by price",
    filterCategory: "Filter by category",
    searchLabel: "Pairing dish search",
    sendButton: "SEND",
    allLabel: "All",
    placeholder: "Separate dishes with commas.",
    loadingDescription: "Loading a description...",
    emptyInput: "Please enter a dish!",
    thinking: "Thinking...",
    noMatch: "I couldn't find a match for these dishes...",
    alreadyAsked: "You already asked for:",
    sommelierFooter: "Your Virtual Sommelier üç∑",
    sommelierTitleBox: "Tell me what you'll eat and I'll suggest the perfect wine!",
    anyPrice: "Any",
    motive:   "Rationale",
    helperChooseCategory: "Choose a category!",        
    helperClickWine: "Click a wine for details.",
    filterLabel: "Filter",
    search:"Search",
    searchPlaceholder: "Search name, grape, notes‚Ä¶",
    filterBy: "Filter by:",
    searchButton: "Search",
    formatBottle: "Bottle",
    formatGlass: "By the glass",
    noSearchResult: "No wines found for this search.",
    sommelierBtnTitle: "Ask the Sommelier üç∑",
    sommelierBtnSubTpl:"Type your dish ‚Üí get {range} perfect wine picks",
    sommelierBtnSub:   "Type your dish ‚Üí get the perfect wine picks",
    sommelierBtn:      "Wine advice",
    sommelierBtnBadge: "New",
    helperGlassMode: "üç∑ You are viewing only wines by the glass",
  },
  fr: {
    wineList: "Carte des Vins",
    grape: "C√©page",
    price: "Prix",
    sommelierTitle: "Notre sommelier vous recommande :",
    noDescription: "Aucune description disponible.",
    filterPrice: "Filtrer par prix",
    filterCategory: "Filtrer par cat√©gorie",
    searchLabel: "Recherche de plats √† associer",
    sendButton: "ENVOYER",
    allLabel: "Tous",
    placeholder: "S√©parez les plats avec des virgules.",
    loadingDescription: "Chargement de la description...",
    emptyInput: "Veuillez saisir un plat !",
    thinking: "Je r√©fl√©chis...",
    noMatch: "Aucun accord trouv√© pour ces plats...",
    alreadyAsked: "Vous avez d√©j√† demand√© pour :",
    sommelierFooter: "Votre Sommelier Virtuel üç∑",
    sommelierTitleBox: "Dites-moi ce que vous mangez et je vous sugg√®re le vin id√©al !",
    anyPrice: "Sans pr√©f√©rence",
    motive:   "Justification",
    helperChooseCategory: "Choisissez une cat√©gorie !",          // it
    helperClickWine: "Cliquez sur le vin pour plus de d√©tails.",
    filterLabel: "Filtrer",
    search:"Chercher",
    searchPlaceholder: "Rechercher nom, c√©page, notes‚Ä¶",
    filterBy: "Filtrer par :",
    searchButton: "Chercher",
    formatBottle: "Bouteille", formatGlass: "Au verre",
      noSearchResult: "Aucun vin trouv√© pour cette recherche.",
sommelierBtnTitle: "Demandez au sommelier üç∑",
sommelierBtnSubTpl:"√âcrivez le plat ‚Üí {range} vins parfaitement choisis",
sommelierBtnSub:   "√âcrivez le plat ‚Üí des vins parfaitement choisis",
sommelierBtn:      "Conseil vin",
sommelierBtnBadge: "Nouveaut√©",
helperGlassMode: "üç∑ Vous voyez uniquement les vins au verre",
  },
  de: {
    wineList: "Weinkarte",
    grape: "Rebsorte",
    price: "Preis",
    sommelierTitle: "Unser Sommelier empfiehlt:",
    noDescription: "Keine Beschreibung verf√ºgbar.",
    filterPrice: "Nach Preis filtern",
    filterCategory: "Nach Kategorie filtern",
    searchLabel: "Gerichte zum Kombinieren suchen",
    sendButton: "SENDEN",
    allLabel: "Alle",
    placeholder: "Trenne Gerichte mit Kommas.",
    loadingDescription: "Beschreibung wird geladen...",
    emptyInput: "Bitte ein Gericht eingeben!",
    thinking: "Ich denke nach...",
    noMatch: "Keine passende Empfehlung gefunden...",
    alreadyAsked: "Du hast bereits gefragt nach:",
    sommelierFooter: "Dein virtueller Sommelier üç∑",
    sommelierTitleBox: "Sag mir, was du isst, und ich empfehle dir den perfekten Wein!",
    anyPrice: "Beliebig",
    motive:   "Begr√ºndung",
    helperChooseCategory: "W√§hlen Sie eine Kategorie!",          // it
    helperClickWine: "Klicken Sie auf den Wein, um weitere Details zu erhalten.",
    filterLabel: "Filtern",
    search:"Suchen",
    searchPlaceholder: "Suche Name, Rebsorte, Notizen‚Ä¶",
    filterBy: "Filtern nach:",
    searchButton: "Suchen",
    formatBottle: "Flasche",   formatGlass: "Im Glas",
sommelierBtnTitle: "Fragen Sie den Sommelier üç∑",
sommelierBtnSubTpl:"Gericht eingeben ‚Üí {range} perfekt passende Wein-Tipps",
sommelierBtnSub:   "Gericht eingeben ‚Üí perfekt passende Wein-Tipps",
sommelierBtn:      "Weintipp",
sommelierBtnBadge: "Neu",
helperGlassMode: "üç∑ Sie sehen nur Weine im Glas",
  },
  es: {
    wineList: "Carta de Vinos",
    grape: "Variedad de uva",
    price: "Precio",
    sommelierTitle: "Nuestro sumiller recomienda:",
    noDescription: "No hay descripci√≥n disponible.",
    filterPrice: "Filtrar por precio",
    filterCategory: "Filtrar por categor√≠a",
    searchLabel: "Buscar platos para maridar",
    sendButton: "ENVIAR",
    allLabel: "Todos",
    placeholder: "Separe los platos con comas.",
    loadingDescription: "Cargando descripci√≥n...",
    emptyInput: "¬°Introduce un plato!",
    thinking: "Pensando...",
    noMatch: "No encontr√© una combinaci√≥n para esos platos...",
    alreadyAsked: "Ya preguntaste por:",
    sommelierFooter: "Tu Sumiller Virtual üç∑",
    sommelierTitleBox: "Dime qu√© comer√°s y te sugiero el vino perfecto",
    anyPrice: "Cualquiera",
    motive:   "Motivaci√≥n",
    helperChooseCategory: "¬°Elige una categor√≠a!",          // it
    helperClickWine: "Haz clic en el vino para m√°s detalles.",
    filterLabel: "Filtrar",
    search:"Buscar",
    searchPlaceholder: "Buscar nombre, uva, notas‚Ä¶",
    filterBy: "Filtrar por:",
    searchButton: "Buscar",
    formatBottle: "Botella",   formatGlass: "Copa",
    noSearchResult: "No se encontraron vinos para esta b√∫squeda.",
sommelierBtnTitle: "Pregunta al sumiller üç∑",
sommelierBtnSubTpl:"Escribe el plato ‚Üí {range} vinos perfectos para ti",
sommelierBtnSub:   "Escribe el plato ‚Üí vinos perfectos para ti",
sommelierBtn:      "Consejo de vino",
sommelierBtnBadge: "Novedad",
helperGlassMode: "üç∑ Est√°s viendo solo los vinos por copa",
  },
  zh: {
    wineList: "ÈÖíÂçï",
    grape: "Ëë°ËêÑÂìÅÁßç",
    price: "‰ª∑Ê†º",
    sommelierTitle: "Êàë‰ª¨ÁöÑ‰æçÈÖíÂ∏àÊé®ËçêÔºö",
    noDescription: "ÊöÇÊó†ÊèèËø∞„ÄÇ",
    filterPrice: "Êåâ‰ª∑Ê†ºÁ≠õÈÄâ",
    filterCategory: "ÊåâÁ±ªÂà´Á≠õÈÄâ",
    searchLabel: "Êü•ÊâæÂèØÊê≠ÈÖçÁöÑËèúÂìÅ",
    sendButton: "ÂèëÈÄÅ",
    allLabel: "ÂÖ®ÈÉ®",
    placeholder: "Áî®ÈÄóÂè∑ÂàÜÈöîËèúÂìÅ„ÄÇ",
    loadingDescription: "Ê≠£Âú®Âä†ËΩΩÊèèËø∞...",
    emptyInput: "ËØ∑ËæìÂÖ•‰∏ÄÈÅìËèúÔºÅ",
    thinking: "ÊÄùËÄÉ‰∏≠...",
    noMatch: "Êú™ÊâæÂà∞‰∏éËøô‰∫õËèúÂìÅÂåπÈÖçÁöÑÈÖí...",
    alreadyAsked: "‰Ω†Â∑≤ÁªèÊü•ËØ¢ËøáÔºö",
    sommelierFooter: "ÊÇ®ÁöÑËôöÊãü‰æçÈÖíÂ∏à üç∑",
    sommelierTitleBox: "ÂëäËØâÊàë‰Ω†Ë¶ÅÂêÉ‰ªÄ‰πàÔºåÊàë‰ºöÊé®ËçêÊúÄÈÄÇÂêàÁöÑÈÖíÔºÅ",
    anyPrice: "‰∏çÈôê",
    motive:   "ÁêÜÁî±",
    helperChooseCategory: "ÈÄâÊã©‰∏Ä‰∏™Á±ªÂà´ÔºÅ",          
    helperClickWine: "ÁÇπÂáªËë°ËêÑÈÖí‰∫ÜËß£Êõ¥Â§öËØ¶ÊÉÖ„ÄÇ",
    filterLabel: "Á≠õÈÄâ",
    search:"ÊêúÁ¥¢",
    searchPlaceholder: "ÊêúÁ¥¢ÂêçÁß∞„ÄÅËë°ËêÑÂìÅÁßç„ÄÅÂ§áÊ≥®‚Ä¶",
    filterBy: "Á≠õÈÄâÊù°‰ª∂Ôºö",
    searchButton: "ÊêúÁ¥¢",
    formatBottle: "Áì∂",   formatGlass: "ÊùØ",
    noSearchResult: "Êú™ÊâæÂà∞Á¨¶ÂêàÊ≠§ÊêúÁ¥¢ÁöÑËë°ËêÑÈÖí„ÄÇ",
sommelierBtnTitle: "ÈóÆÈóÆ‰æçÈÖíÂ∏àüç∑",
sommelierBtnSubTpl:"ËæìÂÖ•ËèúÂìÅ ‚Üí Êé®Ëçê{range}Ê¨æÊúÄÂêàÈÄÇÁöÑÈÖí",
sommelierBtnSub:   "ËæìÂÖ•ËèúÂìÅ ‚Üí Êé®ËçêÊúÄÂêàÈÄÇÁöÑÈÖí",
sommelierBtn:      "Ëë°ËêÑÈÖíÊé®Ëçê",
sommelierBtnBadge: "Êñ∞ÂìÅ",
helperGlassMode: "üç∑ ÊÇ®Ê≠£Âú®Êü•Áúã‰ªÖÊåâÊùØ‰æõÂ∫îÁöÑËë°ËêÑÈÖí",
  }
    ,
  ko: {
    wineList: "ÏôÄÏù∏ Î¶¨Ïä§Ìä∏",
    grape: "Ìè¨ÎèÑ ÌíàÏ¢Ö",
    price: "Í∞ÄÍ≤©",
    sommelierTitle: "Ïö∞Î¶¨ ÏÜåÎØàÎ¶¨ÏóêÏùò Ï∂îÏ≤ú:",
    noDescription: "ÏÑ§Î™ÖÏù¥ ÏóÜÏäµÎãàÎã§.",
    filterPrice: "Í∞ÄÍ≤©Î≥Ñ ÌïÑÌÑ∞",
    filterCategory: "Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ ÌïÑÌÑ∞",
    searchLabel: "ÏöîÎ¶¨Ïóê Ïñ¥Ïö∏Î¶¨Îäî ÏôÄÏù∏ Ï∞æÍ∏∞",
    sendButton: "Î≥¥ÎÇ¥Í∏∞",
    allLabel: "Ï†ÑÏ≤¥",
    placeholder: "ÏöîÎ¶¨Î•º ÏâºÌëúÎ°ú Íµ¨Î∂ÑÌïòÏÑ∏Ïöî.",
    loadingDescription: "ÏÑ§Î™ÖÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...",
    emptyInput: "ÏöîÎ¶¨Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî!",
    thinking: "ÏÉùÍ∞Å Ï§ë...",
    noMatch: "Ìï¥Îãπ ÏöîÎ¶¨Ïóê ÎßûÎäî ÏôÄÏù∏ÏùÑ Ï∞æÏßÄ Î™ªÌñàÏäµÎãàÎã§...",
    alreadyAsked: "Ïù¥ÎØ∏ ÏöîÏ≤≠ÌïòÏã† ÏöîÎ¶¨:",
    sommelierFooter: "ÎãπÏã†Ïùò Í∞ÄÏÉÅ ÏÜåÎØàÎ¶¨Ïóê üç∑",
    sommelierTitleBox: "Î®πÏùÑ ÏöîÎ¶¨Î•º ÏïåÎ†§Ï£ºÏãúÎ©¥ Ïñ¥Ïö∏Î¶¨Îäî ÏôÄÏù∏ÏùÑ Ï∂îÏ≤úÌï¥ ÎìúÎ¶ΩÎãàÎã§!",
    anyPrice: "Î¨¥Í¥Ä",
    motive: "Ïù¥Ïú†",
    helperChooseCategory: "Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî!",
    helperClickWine: "ÏôÄÏù∏ÏùÑ ÌÅ¥Î¶≠ÌïòÎ©¥ ÏûêÏÑ∏Ìûà Î≥º Ïàò ÏûàÏäµÎãàÎã§.",
    filterLabel: "ÌïÑÌÑ∞",
    search: "Í≤ÄÏÉâ",
    searchPlaceholder: "Ïù¥Î¶Ñ, ÌíàÏ¢Ö, ÎÖ∏Ìä∏Î°ú Í≤ÄÏÉâ‚Ä¶",
    filterBy: "ÌïÑÌÑ∞ Í∏∞Ï§Ä:",
    searchButton: "Í≤ÄÏÉâ",
    formatBottle: "Î≥ë",
    formatGlass: "Ïûî",
    noSearchResult: "Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.",
sommelierBtnTitle: "ÏÜåÎØàÎ¶¨ÏóêÏóêÍ≤å Î¨ºÏñ¥Î≥¥ÏÑ∏Ïöî üç∑",
sommelierBtnSubTpl:"ÏöîÎ¶¨Î•º ÏûÖÎ†•ÌïòÎ©¥ {range}Í∞ÄÏßÄ ÏôÄÏù∏ÏùÑ Ï∂îÏ≤úÌï¥Ïöî",
sommelierBtnSub:   "ÏöîÎ¶¨Î•º ÏûÖÎ†•ÌïòÎ©¥ ÏôÄÏù∏ÏùÑ Ï∂îÏ≤úÌï¥Ïöî",
sommelierBtn:      "ÏôÄÏù∏ Ï∂îÏ≤ú",
    sommelierBtnBadge: "Ïã†Í∑ú",
    helperGlassMode: "üç∑ ÏûîÏúºÎ°ú Ï†úÍ≥µÎêòÎäî ÏôÄÏù∏Îßå ÌëúÏãú Ï§ë",
  },
  ru: {
    wineList: "–í–∏–Ω–Ω–∞—è –∫–∞—Ä—Ç–∞",
    grape: "–°–æ—Ä—Ç –≤–∏–Ω–æ–≥—Ä–∞–¥–∞",
    price: "–¶–µ–Ω–∞",
    sommelierTitle: "–ù–∞—à —Å–æ–º–µ–ª—å–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç:",
    noDescription: "–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.",
    filterPrice: "–§–∏–ª—å—Ç—Ä –ø–æ —Ü–µ–Ω–µ",
    filterCategory: "–§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏",
    searchLabel: "–ü–æ–∏—Å–∫ –≤–∏–Ω –∫ –±–ª—é–¥–∞–º",
    sendButton: "–û–¢–ü–†–ê–í–ò–¢–¨",
    allLabel: "–í—Å–µ",
    placeholder: "–†–∞–∑–¥–µ–ª—è–π—Ç–µ –±–ª—é–¥–∞ –∑–∞–ø—è—Ç—ã–º–∏.",
    loadingDescription: "–ó–∞–≥—Ä—É–∑–∫–∞ –æ–ø–∏—Å–∞–Ω–∏—è...",
    emptyInput: "–í–≤–µ–¥–∏—Ç–µ –±–ª—é–¥–æ!",
    thinking: "–î—É–º–∞—é...",
    noMatch: "–ù–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –≤–∏–Ω –∫ —ç—Ç–∏–º –±–ª—é–¥–∞–º...",
    alreadyAsked: "–í—ã —É–∂–µ —Å–ø—Ä–∞—à–∏–≤–∞–ª–∏:",
    sommelierFooter: "–í–∞—à –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Å–æ–º–µ–ª—å–µ üç∑",
    sommelierTitleBox: "–°–∫–∞–∂–∏—Ç–µ, —á—Ç–æ –±—É–¥–µ—Ç–µ –µ—Å—Ç—å, –∏ —è –ø–æ–¥–±–µ—Ä—É –∏–¥–µ–∞–ª—å–Ω–æ–µ –≤–∏–Ω–æ!",
    anyPrice: "–õ—é–±–∞—è",
    motive: "–ü—Ä–∏—á–∏–Ω–∞",
    helperChooseCategory: "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é!",
    helperClickWine: "–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –≤–∏–Ω–æ, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ.",
    filterLabel: "–§–∏–ª—å—Ç—Ä",
    search: "–ü–æ–∏—Å–∫",
    searchPlaceholder: "–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, —Å–æ—Ä—Ç—É, –∑–∞–º–µ—Ç–∫–∞–º‚Ä¶",
    filterBy: "–§–∏–ª—å—Ç—Ä –ø–æ:",
    searchButton: "–ü–æ–∏—Å–∫",
    formatBottle: "–ë—É—Ç—ã–ª–∫–∞",
    formatGlass: "–ë–æ–∫–∞–ª",
    noSearchResult: "–ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –≤–∏–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.",
sommelierBtnTitle: "–°–ø—Ä–æ—Å–∏—Ç–µ —Å–æ–º–µ–ª—å–µ üç∑",
sommelierBtnSubTpl:"–í–≤–µ–¥–∏—Ç–µ –±–ª—é–¥–æ ‚Üí –ø–æ–¥–±–µ—Ä—É {range} –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –≤–∏–Ω",
sommelierBtnSub:   "–í–≤–µ–¥–∏—Ç–µ –±–ª—é–¥–æ ‚Üí –ø–æ–¥–±–µ—Ä—É –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –≤–∏–Ω–∞",
sommelierBtn:      "–°–æ–≤–µ—Ç –ø–æ –≤–∏–Ω—É",
    sommelierBtnBadge: "–ù–æ–≤–∏–Ω–∫–∞",
    helperGlassMode: "üç∑ –û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤–∏–Ω–∞ –ø–æ –±–æ–∫–∞–ª–∞–º",
  }
};

function getSommelierRangePretty(){
  const r = String(ristorante?.sommelier_range || "").trim();
  if (!r) return null;
  const norm = r.replace(/[‚Äì‚Äî]/g, "-").replace(/\s+/g, "");
  const m = norm.match(/^(\d+)-(\d+)$/);
  if (m) return `${m[1]}‚Äì${m[2]}`; // en-dash pi√π bello
  const n = norm.match(/^(\d+)$/);
  if (n) return n[1];
  return null;
}

function getSommelierBtnSubText(){
  const t = translations[currentLang] || translations.it;
  const range = getSommelierRangePretty();
  const tpl = t.sommelierBtnSubTpl || t.sommelierBtnSub || "";
  if (range && tpl.includes("{range}")) return tpl.replace("{range}", range);
  return t.sommelierBtnSub || "";
}

function refreshSommelierBtnCopy(){
  const btn = document.getElementById("sommelierBtn");
  if (!btn) return;
  const t = translations[currentLang] || translations.it;

  const titleEl = btn.querySelector('[data-key="sommelierBtnTitle"]');
  const subEl   = btn.querySelector('[data-key="sommelierBtnSub"]');

  if (titleEl) titleEl.textContent = t.sommelierBtnTitle || "";
  if (subEl)   subEl.textContent   = getSommelierBtnSubText();

  // aria-label pi√π descrittivo
  btn.setAttribute("aria-label", t.sommelierBtnTitle || t.sommelierBtn || "Sommelier");
}

function isGlassOnly(){
  const checks = document.querySelectorAll('#filterOptions input[type="checkbox"]');
  const checked = Array.from(checks).filter(cb => cb.checked).map(cb => cb.value);
  return (checked.length === 1 && checked[0] === 'glass');
}

function setHelper(text){
  const el = document.getElementById('helperBanner');
  if (!el) return;
  const t = translations[currentLang];
  if (isGlassOnly()){
    const sub = t?.helperGlassMode || "üç∑ Stai visualizzando solo i vini al calice";
    // entrambe NERE (niente colore rosso)
    el.innerHTML = `${text}<br><span>${sub}</span>`;
  } else {
    el.textContent = text;
  }
}

function setHelperByKey(key){
  const t = translations[currentLang];
  const main = (t && t[key]) ? t[key] : key;
  setHelper(main);
}

async function setHelperCategoryName(category){
  let label = String(category || "");
  if (currentLang !== "it" && label) {
    try {
      const res = await fetch("https://ldunvbftxhbtuyabgxwh.functions.supabase.co/traduci-categoria", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: label, targetLang: currentLang })
      });
      const data = await res.json();
      label = (data.text || label).trim();
    } catch(e){ /* fallback: label originale */ }
  }
  setHelper(label.toUpperCase());
}

  function getContrastingTextColor(bgColor) {
  if (!bgColor) return "#000000";
  const hex = bgColor.replace("#", "");
  if (hex.length !== 6) return "#000000"; // fallback per codici non validi
  const r = parseInt(hex.substring(0, 2), 16);
  const g = parseInt(hex.substring(2, 4), 16);
  const b = parseInt(hex.substring(4, 6), 16);
  const brightness = (r * 299 + g * 587 + b * 114) / 1000;
  return brightness > 150 ? "#000000" : "#ffffff";
}

const SUPABASE_URL = "https://ldunvbftxhbtuyabgxwh.supabase.co";
const SUPABASE_API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkdW52YmZ0eGhidHV5YWJneHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0NTMyOTYsImV4cCI6MjA2MjAyOTI5Nn0.0hjJASFktfHZHjVQzX9bq8xGBrf7o1Fya6lqnA2tvPo";


// Supabase via UMD (come in admin.html)
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_API_KEY);
function loadScriptOnce(id, src) {
  return new Promise((resolve, reject) => {
    if (document.getElementById(id)) return resolve();
    const s = document.createElement("script");
    s.id = id;
    s.src = src;
    s.async = true;
    s.onload = () => resolve();
    s.onerror = () => reject(new Error("Failed to load " + src));
    document.head.appendChild(s);
  });
}

// üî¥ Disattiva/attiva la descrizione vino dalla UI
const DESCRIZIONE_VINO_ABILITATA = true;

let RESTAURANT_ID = null;
let slug = null;

// Risolve RESTAURANT_ID partendo da:
//  - ?ristorante_id=...
//  - ?slug=...
//  - /:slug o /:slug.cartadeivini
//  - utente loggato (dashboard/admin)
async function ensureRestaurantId() {
  const urlParams = new URLSearchParams(window.location.search);
  RESTAURANT_ID = urlParams.get("ristorante_id");
  slug = urlParams.get("slug");

  // Se la pagina √® stata aperta come /mioslug o /mioslug.cartadeivini, estraggo lo slug dal path
  if (!slug) {
    const path = location.pathname.replace(/^\//, ""); // toglie lo slash iniziale
    if (path && !/\.html$/i.test(path)) {
      // rimuove l‚Äôeventuale .cartadeivini
      slug = path.replace(/\.cartadeivini$/i, "");
    }
  }

  // Se ho uno slug, provo a risolvere il ristorante da Supabase
  if (slug) {
    try {
      const { data: r, error } = await supabase
        .from("ristoranti")
        .select("id, slug")
        .eq("slug", slug)
        .single();

      if (error) {
        console.warn("Errore lookup slug:", error);
      }

      if (r?.id) {
        RESTAURANT_ID = r.id;

        // Mantieni l‚ÄôURL "bello" in barra (niente query string)
        const pretty = `/${r.slug}${
          /\.cartadeivini$/i.test(location.pathname) ? ".cartadeivini" : ""
        }`;
        if (location.pathname !== pretty) {
          history.replaceState({}, "", pretty);
        }
      } else {
        console.warn("Slug non trovato, uso eventuale query string o utente loggato.");
      }
    } catch (e) {
      console.error("Eccezione durante lookup slug:", e);
    }
  }

  // Fallback: se ancora non ho l'ID, provo con l'utente loggato (solo in area riservata)
  if (!RESTAURANT_ID) {
    try {
      const { data } = await supabase.auth.getUser();
      const user = data?.user;
      if (user) RESTAURANT_ID = user.id;
    } catch (e) {
      console.error("Errore durante getUser():", e);
    }
  }

  // Demo: disabilita sommelier per un ristorante specifico
  if (RESTAURANT_ID === "fc28c874-b195-4660-9c78-c58d8dc3c092") {
    window.suggestWine = () => {
      const suggestion = document.getElementById("wineSuggestion");
      if (suggestion) {
        suggestion.innerHTML = `
          <div style="background:#fff3f0; padding:15px; border-radius:12px; border:1px solid #ddd; color:#b00; font-weight:bold;">
            Funzione disabilitata per la demo.
          </div>`;
      }
    };
  }
}

// ========= SOMMELIER ANALYTICS (MVP) =========
function getSessionId() {
  const k = "sid_v1";
  const ttlMs = 24 * 60 * 60 * 1000; // 24h
  let obj = null;

  try { obj = JSON.parse(localStorage.getItem(k) || "null"); } catch {}

  const expired = !obj?.id || !obj?.t || (Date.now() - obj.t > ttlMs);

  if (expired) {
    const id = (crypto?.randomUUID?.() || (Date.now()+"_"+Math.random().toString(16).slice(2)));
    obj = { id, t: Date.now() };
    localStorage.setItem(k, JSON.stringify(obj));
  }
  return obj.id;
}

let __tracked = new Set(); // per eventi "una tantum" nella sessione

async function trackSommelier(event, props = {}, onceKey = null){
  try {
    if (onceKey) {
      const key = event + "::" + onceKey;
      if (__tracked.has(key)) return;
      __tracked.add(key);
    }

    const payload = {
      restaurant_id: RESTAURANT_ID || null,
      session_id: getSessionId(),
      event,
      props,
      path: location.pathname + location.search + location.hash,
      ua: navigator.userAgent
    };

    // Inserimento diretto su tabella Supabase (richiede policy INSERT su sommelier_events)
    const { error } = await supabase
  .from("sommelier_events")
  .insert([payload], { returning: "minimal" });

if (error) {
  console.warn("[trackSommelier] insert error:", error, payload);
  return false;
}
return true;
  } catch (e) {
    console.warn("[trackSommelier] failed:", e);
    return false;
  }
}

function nudgeSommelier(reason) {
  const btn = document.getElementById("sommelierBtn");
  if (!btn) return;
  if (localStorage.getItem("sommelier_seen")) return;
const dayKey = "sommelier_nudge_day";
const today = new Date().toISOString().slice(0,10);
if (localStorage.getItem(dayKey) === today) return;
localStorage.setItem(dayKey, today);

  btn.classList.add("pulse");
  trackSommelier("sommelier_nudge", { lang: currentLang, reason });

  setTimeout(() => btn.classList.remove("pulse"), 5000);
}

let wines = [];
let ristorante = null;
let ristoranteSommelierURL = null;
let currentCategory = '';
let currentView = 'categories';
let sommelierAperto = false;
let currentLang = "it"; // default

window.paletteColors = {
  background: null,
  cardBackground: null,
  borderColor: null,
  textColor: null,
  boxShadow: null
};

function changeLanguage() {
  const langSelector = document.getElementById("langSelector");
  currentLang = langSelector.value;
  if (!translations[currentLang]) { currentLang = "en"; langSelector.value = "en"; }

  applyTranslations();
  refreshFilterOptionsPreservingState();

  // üëá evita nuovi pushState durante la sola traduzione/rerender
  const prev = window._manualNavigation;
  window._manualNavigation = true;

  if (currentView === 'categories') {
    showCategories();
  } else if (currentView === 'subcategory') {
    showSubcategories(currentCategory);
  } else if (currentView === 'wines') {
    if (window.currentSubcategory) {
      showWinesBySubcategory(window.currentSubcategory);
    } else {
      showWinesForCategory(currentCategory);
    }
  }

  window._manualNavigation = prev;

  if (window.showSommelier === true) {
    setupSommelierUI();
  } else {
    document.getElementById("sommelierBtn")?.remove();
    document.getElementById("tooltipSommelier")?.remove();
  }
}
  window.changeLanguage = changeLanguage;

function applyTranslations() {
  const t = translations[currentLang];

  const foodInput = document.getElementById("foodInput");
if (foodInput && translations[currentLang].placeholder) {
  foodInput.placeholder = translations[currentLang].placeholder;
}

  // cambia titolo principale
  const titleEl = document.querySelector("#restaurantName span");
  if (titleEl) titleEl.textContent = t.wineList;

  // aggiorna descrizione popup (se presente)
  const descrEl = document.getElementById("descrizioneTesto");
  if (descrEl && descrEl.textContent.includes("Nessuna descrizione")) {
    descrEl.textContent = t.noDescription;
  }

  document.querySelectorAll('.wine-card').forEach(card => {
  const text = card.innerHTML;
  const match = text.match(/<small>.*?: (.*?)<\/small>/);
  const grapeValue = match?.[1] || "";

  const t = translations[currentLang];
  card.innerHTML = text.replace(/<small>.*?: .*?<\/small>/, `<small>${t.grape}: ${grapeValue}</small>`);
});
// Etichette translate-label
document.querySelectorAll(".translate-label").forEach(el => {
  const key = el.dataset.key;
  if (translations[currentLang][key]) {
    el.textContent = translations[currentLang][key];
  }
});

// Pulsante invia
const sendBtn = document.getElementById("sendFoodBtn");
if (sendBtn && translations[currentLang].sendButton) {
  sendBtn.textContent = translations[currentLang].sendButton;
}

const priceAnyOpt = document.querySelector('#priceFilter option[value=""]');
if (priceAnyOpt) priceAnyOpt.textContent = t.anyPrice;

// aggiorna testo del bottone sommelier
const sBtn = document.getElementById("sommelierBtn");
if (sBtn) {
  const lbl = sBtn.querySelector(".label");
  if (lbl) lbl.textContent = translations[currentLang].sommelierBtn;
  sBtn.setAttribute("aria-label", translations[currentLang].sommelierBtn);
}

// 1) placeholder dell'input di ricerca (popover)
const si = document.getElementById("searchInput");
if (si && t.searchPlaceholder) {
  si.placeholder = t.searchPlaceholder;
}

// 2) titolo del menu filtro ("Filtra per:")
const filterTitle = document.querySelector('#filterMenu .translate-text[data-key="filterBy"]');
if (filterTitle && t.filterBy) {
  filterTitle.textContent = t.filterBy;
}

// 3) bottone "Cerca" dentro al popover
const searchBtnInside = document.querySelector('#searchPopover button.save-btn.translate-label[data-key="searchButton"]');
if (searchBtnInside && t.searchButton) {
  searchBtnInside.textContent = t.searchButton;
}
refreshSommelierBtnCopy();
}

function aggiornaAltezzaNavbar() {
  const nav = document.querySelector("nav");
  const nameBlock = document.getElementById("restaurantName");
  if (!nav || !nameBlock) return;

  const rect = nameBlock.getBoundingClientRect();
  const height = rect.height + 20;      // altezza effettiva navbar

  nav.style.minHeight = height + "px";
  document.body.style.paddingTop = height + "px";  // sposta tutta la pagina sotto la navbar

  // ‚ùå rimuovi il codice che faceva paddingTop sulle liste
}
window.addEventListener('resize', aggiornaAltezzaNavbar);

window.addEventListener("message", async (event) => {
  if (event.data?.action === "updateNameLive" || event.data?.action === "updateLogoLive") {
    setTimeout(() => aggiornaAltezzaNavbar(), 30);
  }
});
function toggleSommelier() {
  trackSommelier("sommelier_popup_open", { lang: currentLang });
  const overlay = document.getElementById('sommelierOverlay');
    overlay.classList.remove("fade-out");
    overlay.classList.add("fade-in");
    overlay.style.display = 'flex';

  const popup = document.getElementById("sommelierPopup");
  const palette = window.ristorantePalette;
    if (popup) {
popup.style.boxShadow = palette && window.paletteColors?.boxShadow || "0 2px 6px rgba(0,0,0,0.15)";
}

const input = document.getElementById("foodInput");
if (input) {
  input.style.backgroundColor = "#ffffff"; // sempre bianco
  input.style.color = "#000000"; // sempre nero
}

  const inputEl = document.getElementById('foodInput');
if (inputEl) inputEl.focus();
  history.pushState({ sommelier: true }, '', '#sommelier');
  sommelierAperto = true;
}

function closeSommelierPopup() {
  const hadText = !!document.getElementById('foodInput')?.value?.trim();
const hadResults = !!document.getElementById('wineSuggestion')?.innerHTML?.trim();

trackSommelier("sommelier_popup_close", {
  lang: currentLang,
  had_text: hadText,
  had_results: hadResults
});

const overlay = document.getElementById('sommelierOverlay');
if (overlay) {
  overlay.classList.remove("fade-in");
  overlay.classList.add("fade-out");
  setTimeout(() => {
    overlay.style.display = "none";
  }, 300);
}
const foodInput = document.getElementById('foodInput');
if (foodInput) foodInput.value = '';
const wineSuggestion = document.getElementById('wineSuggestion');
if (wineSuggestion) wineSuggestion.innerHTML = '';

  // Puliamo l‚ÄôURL (togliamo #sommelier) e azzeriamo lo stato
  if (location.hash === "#sommelier") {
    history.replaceState({}, '', location.pathname); // resetta l‚ÄôURL
  }
}

window.handleSommelierKey = function (e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    suggestWine();
    const input = document.getElementById('foodInput');
if (input) input.blur();
  }
}

function flipToPage(fromId, toId) {
const from = document.getElementById(fromId);
const to = document.getElementById(toId);

if (from && to) {
  from.classList.remove("flip-out");
  from.classList.add("flip-in");
  to.classList.remove("flip-in");
  to.classList.add("flip-out");
  setTimeout(() => {
    from.style.display = 'none';
    to.style.display = 'block';
  }, 600);
}
}

window.suggestWine = async function () {
    if (RESTAURANT_ID === "fc28c874-b195-4660-9c78-c58d8dc3c092") {
    const suggestion = document.getElementById('wineSuggestion');
    if (suggestion) {
      suggestion.innerHTML = `
        <div style="background:#fff3f0; padding:15px; border-radius:12px; border:1px solid #ddd; color:#b00; font-weight:bold;">
          Funzione disabilitata per la demo.
        </div>`;
    }
    return; // üîí blocca esecuzione
  }

  const paroleBloccate = [
    "come ti chiami", "come stai", "ciao", "chi sei", "sei reale", "sei umano",
    "parolacce", "cazzo", "merda", "stronzo", "scemo", "stupido", "ubriaco",
    "sposato", "fidanzato", "intelligenza", "chi ha vinto", "quanto costi", "gpt"
  ];
  const input = document.getElementById('foodInput').value.trim();
  const suggestion = document.getElementById('wineSuggestion');
  const inputLower = input.toLowerCase();
  const contieneOffensivo = paroleBloccate.some(p => inputLower.includes(p));

  if (contieneOffensivo) {
    suggestion.innerHTML = `
      <div style="background:#fff3f0; padding:15px; border-radius:12px; border:1px solid #ddd; color:#333; font-style:italic;">
        Per favore scrivimi il nome di un piatto, cos√¨ posso consigliarti il vino perfetto! üç∑
      </div>`;
      trackSommelier("sommelier_submit_blocked", { lang: currentLang });
    return;
  }

  if (!input) {
    suggestion.innerHTML = translations[currentLang].emptyInput;
    trackSommelier("sommelier_submit_empty", { lang: currentLang });
    return;
  }

  suggestion.innerHTML = translations[currentLang].thinking;

try {
  const priceLimit = document.getElementById("priceFilter").value;
  const wineColorChecks = document.querySelectorAll("#wineTypeDropdown input[type='checkbox']");
  const wineColors = Array.from(wineColorChecks).filter(cb => cb.checked).map(cb => cb.value);

  trackSommelier("sommelier_submit", {
  lang: currentLang,
  has_price_limit: !!document.getElementById("priceFilter")?.value,
  colors_selected: Array.from(document.querySelectorAll("#wineTypeDropdown input[type='checkbox']"))
    .filter(cb => cb.checked).map(cb => cb.value),
  input_len: input.length,
  commas: (input.match(/,/g) || []).length
});
  const response = await fetch("https://ldunvbftxhbtuyabgxwh.functions.supabase.co/consiglia-vino", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      vini: wines,
      piatto: input,
      ristorante_id: RESTAURANT_ID,
      prezzo_massimo: priceLimit ? parseInt(priceLimit) : null,
      colori: wineColors,
      lang: (currentLang === "gb" ? "en" : currentLang)  // << invia sempre en, non gb
    })
  });


    const data = await response.json();
    const reply = data.suggestion || "";
    const rawBlocks = reply.split(/^- /m).map(b => b.trim()).filter(Boolean);

const popupBg      = window.paletteColors?.background    || "#ffffff";
const responseBg   = window.paletteColors?.cardBackground || "#ffffff";
const vignetteColor= window.paletteColors?.borderColor    || "#cccccc";
const textColor    = window.paletteColors?.textColor      || "#000000";
const vignetteTextColor = textColor;
const shadow       = window.paletteColors?.boxShadow      || "0 2px 6px rgba(0,0,0,0.15)";
const prezzoColor = getContrastingTextColor(responseBg);

// ---------- COLORE: usa categoria + sottocategoria + nome + denominazione; fallback da uvaggio ----------
function colorInfoFromWine(w) {
  const bag = `${w?.categoria||""} ${w?.sottocategoria||""} ${w?.denominazione||""} ${w?.nome||""}`.toLowerCase();

  // 1) parole chiave dirette
  // Bollicine
  if (/\b(spumante|bollicine|metodo classico|franciacorta|champagne|trentodoc|prosecco|col.?fondo|saten|sat√®n|extra\s*dry|brut|pas do[sz]e|dosaggio zero)\b/.test(bag)) {
    return { label: "Bollicine", hex: "#8EC9FF" };
  }
  // Rosato / Ramato ‚Üí "Rosa"
  if (/\b(rosato|ros[e√©]|rose|ramato|cerasuolo)\b/.test(bag)) {
    return { label: "Rosa", hex: "#FF7FB3" };
  }
  // Bianco
  if (/\b(bianco|bianchi|white|blanc)\b/.test(bag)) {
    return { label: "Bianco", hex: "#FFD24D" };
  }
  // Rosso
  if (/\b(rosso|rossi|red|rouge)\b/.test(bag)) {
    return { label: "Rosso", hex: "#E04B4B" };
  }
  // Dolce / Passito
  if (/\b(dolce|passito|vendemmia tardiva|late harvest|vin santo|sauternes|moscato passito)\b/.test(bag)) {
    return { label: "Dolce", hex: "#FFA94D" };
  }

  // 2) Fallback da UVAGGIO (bianco/rosso ‚Äúprobabile‚Äù)
  const WHITE = new Set([
    "chardonnay","sauvignon","sauvignon blanc","pinot grigio","pinot bianco","vermentino",
    "glera","greco","fiano","verdicchio","trebbiano","garganega","ribolla","zibibbo","moscato",
    "grillo","gewurztraminer","traminer","catarratto","cortese","passerina","pecorino",
    "falanghina","inzolia","malvasia","vernaccia","timorasso","arvine","arneis"
  ]);
  const RED = new Set([
    "sangiovese","nebbiolo","barbera","montepulciano","aglianico","primitivo","negroamaro","syrah",
    "cabernet","cabernet sauvignon","cabernet franc","merlot","pinot nero","corvina","corvinone",
    "rondinella","refosco","sagrantino","nero d avola","nero d‚Äôavola","teroldego","lagrein",
    "frappato","dolcetto","grignolino","pelaverga","uva di troia","magliocco"
  ]);
  const uv = String(w?.uvaggio||"").toLowerCase()
    .replace(/\b(docg?|ig[pt])\b/g," ")
    .replace(/\d+\s*%/g," ")
    .split(/[,;+\/&]|(?:\b(?:e|con|blend|uvaggio|c√©page|variet[a√†])\b)/g)
    .map(s=>s.trim()).filter(Boolean);

  const hasWhite = uv.some(t => WHITE.has(t));
  const hasRed   = uv.some(t => RED.has(t));

  if (hasWhite && !hasRed) return { label: "Bianco", hex: "#FFD24D" };
  if (hasRed   && !hasWhite) return { label: "Rosso",  hex: "#E04B4B" };

  // 3) Neutro (non riconosciuto)
  return { label: "Vino", hex: "#DDDDDD" };
}

let cardsHtml = rawBlocks.map(block => {
  const lines = block.split(/\n/).map(l => l.trim()).filter(Boolean);
  const titleLine = lines[0] || "";
  const uvRiga = lines[1] || "";
  const motRiga = lines.slice(2).join(" ");

  // ‚ú® estrai badge dal titolo e pulisci il nome
  const isBoosted   = /‚≠ê/.test(titleLine);
  const isTop       = /üëç/.test(titleLine);
  const isDiscovery = /‚ú®/.test(titleLine);
  // rimuove qualsiasi emoji (anche quelle ‚Äúdi stile‚Äù come üçã) dal titolo mostrato
  const nomeVino = titleLine
    .replace(/\p{Extended_Pictographic}/gu, "") // via tutte le emoji
    .replace(/^[-‚Ä¢]\s*/, "")
    .trim();

  const uvVal  = stripLabelPrefix(uvRiga, [
    "uvaggio","grape","grape variety","cepages","c√©pages","variedad de uva","rebsorte","uva","Ëë°ËêÑÂìÅÁßç"
  ]);
  const motVal = stripLabelPrefix(motRiga, [
    "motivazione","rationale","justification","begrundung","begr√ºndung","motivacion","motivaci√≥n","ÁêÜÁî±"
  ]);

  // prezzi + colore
  let wFound = wines.find(w => normalize(w.nome) === normalize(nomeVino))
         || wines.find(w => normalize(w.nome).includes(normalize(nomeVino)) || normalize(nomeVino).includes(normalize(w.nome)));
  let prezziHtml = "";
let colorInfo = {label:"Vino", hex:"#ddd"};
if (wFound) {
  prezziHtml = buildPriceHTML(wFound);
  colorInfo = colorInfoFromWine(wFound);   // ‚Üê usa la nuova funzione
} else {
    const prezzoGrezz = (titleLine.match(/‚Ç¨\s*\d[\d.,]*/) || [])[0];
    if (prezzoGrezz) {
      prezziHtml = `
        <div class="price-row">
          <span class="price-chip">
            <img class="icon" src="bottleico.png" onerror="this.onerror=null;this.src='bottleicon.png';" alt="bottiglia">
            ${prezzoGrezz}
          </span>
        </div>`;
    }
  }

  // cluster badge (in alto a sx)
  const badgeStack = `
    <div class="badge-stack">
      ${isBoosted   ? "‚≠ê" : ""}
      ${isTop       ? "üëç" : ""}
      ${isDiscovery ? "‚ú®" : ""}
    </div>`;

  return `
    <div class="sommelier-card" style="background:${responseBg}; border:1px solid ${vignetteColor}; border-radius:12px; padding:14px 12px; margin:8px 0; box-shadow:0 2px 6px rgba(0,0,0,0.06); color:${textColor};">
      ${badgeStack}
      <span class="color-pill" style="background:${colorInfo.hex}; color:${getContrastingTextColor(colorInfo.hex)};">${colorInfo.label}</span>
      <div class="vino-header">
        <div class="titolo">${nomeVino}</div>
      </div>
      ${prezziHtml}
      ${uvVal ? `<div class="meta">${translations[currentLang].grape}: ${uvVal}</div>` : ""}
      ${motVal ? `
  <div class="motive-wrap">
    <div class="motive-box">
      <span class="label">${translations[currentLang].motive}:</span> ${motVal}
    </div>
  </div>` : ""}

    </div>`;
}).join('');


    if (!cardsHtml || cardsHtml.trim() === "") {
      suggestion.innerHTML = `
        <div style="background:${responseBg}; padding:15px; border-radius:12px; border:1px solid ${vignetteColor}; color: ${textColor}; font-style:italic;">${translations[currentLang].noMatch}</div>`;
      await trackSommelier("sommelier_result_nomatch", { lang: currentLang });
        return;
    }

    aggiornaStorico(input);
    const storico = mostraStoricoNelSommelier();

suggestion.innerHTML = `
  <div class="sommelier-fadein" style="display:flex; align-items:flex-start; gap:12px; margin-bottom:20px;">
    <img id="sommelierAvatar"
         src="${ristoranteSommelierURL || 'sommelier.png'}"
         alt="Sommelier"
         style="width:64px; height:64px; border-radius:50%; object-fit:cover; box-shadow:0 0 6px rgba(0,0,0,0.1);">

    <div style="position: relative; background: ${responseBg}; border: 1px solid ${vignetteColor}; border-radius:16px; padding:16px 18px; max-width:80%; box-shadow: ${shadow}; color: ${textColor};">
      <div style="position: absolute; top: 20px; left: -10px; width: 0; height: 0; border-top: 10px solid transparent; border-bottom: 10px solid transparent; border-right: 10px solid ${vignetteColor};"></div>
      <strong style="color:${vignetteTextColor}; font-size: 1em;">${translations[currentLang].sommelierTitle}</strong>
      <div class="somm-list" style="margin-top:8px;">${cardsHtml}</div>
      ${storico}
      <div style="text-align:right; font-size:0.85em; color:${vignetteTextColor}; margin-top:8px;">${translations[currentLang].sommelierFooter}</div>
    </div>
  </div>
`;
await trackSommelier("sommelier_result_success", {
  lang: currentLang,
  results_count: rawBlocks.length
});

  } catch (err) {
    console.error(err);
    suggestion.innerHTML = "Errore nel generare il suggerimento.";
    await trackSommelier("sommelier_result_error", { lang: currentLang, msg: String(err?.message || err) });
  }
}

function stripLabelPrefix(line, labels) {
  if (!line) return "";
  const raw  = String(line).trim();
  const norm = raw.normalize("NFD").replace(/\p{Diacritic}/gu, "").toLowerCase();
  for (const lab of labels) {
    if (norm.startsWith(lab)) {
      return raw.replace(/^.*?[:Ôºö-]\s*/, ""); // rimuove "LABEL: "
    }
  }
  return raw;
}

window.addEventListener('click', (e) => {
  const overlay = document.getElementById('sommelierOverlay');
  if (!overlay) return;
  if (e.target === overlay) {
    trackSommelier("sommelier_popup_close_overlay", { lang: currentLang });
    closeSommelierPopup();
  }
});

window.addEventListener('popstate', (event) => {
  if (event.state?.sommelier || sommelierAperto) {
    closeSommelierPopup();
    sommelierAperto = false;
  }
});

async function loadRestaurantData() {
const res = await fetch(`${SUPABASE_URL}/rest/v1/ristoranti?select=subscription_plan,sommelier_attivo,nome,font,palette_color,logo_url,logo_size,sommelier_url,sommelier_range,sommelier_boost_multi,name_size,name_color,name_bold,name_font,ordine_vini,ordine_categorie,ordine_sottocategorie,sommelier_gender&id=eq.${RESTAURANT_ID}`, {
  headers: { 'apikey': SUPABASE_API_KEY, 'Accept': 'application/json' }
});
const data = await res.json();
if (!Array.isArray(data) || data.length === 0) {
  console.error("Ristorante non trovato");
  return;
}
ristorante = data[0];
  const gender = ristorante?.sommelier_gender || "uomo";
ristoranteSommelierURL = ristorante.sommelier_url || (gender === "donna" ? "sommelier_femmina.png" : "sommelier.png");
// aggiorna avatar nel bottone (se gi√† creato) e fallback
const btnImg = document.querySelector('#sommelierBtn img');
if (btnImg) {
  btnImg.src = ristoranteSommelierURL;
  btnImg.onerror = () => { btnImg.onerror = null; btnImg.src = (gender === "donna" ? "sommelier_femmina.png" : "sommelier.png"); };
}

if (ristorante.font) {
  document.body.style.fontFamily = ristorante.font;
  ensureFontLoaded(ristorante.font);
}

const avatar = document.getElementById('sommelierAvatar');
if (avatar) {
  avatar.src = ristoranteSommelierURL;
}

if (ristorante) {
  const nameElem = document.getElementById("restaurantName");
  if (!nameElem) return;

  while (nameElem.firstChild) nameElem.removeChild(nameElem.firstChild);

  if (ristorante.logo_url) {
    const img = document.createElement('img');
    img.src = ristorante.logo_url;
    img.alt = ristorante.nome;
    img.id = "restaurantLogo";
    img.style.setProperty("height", (ristorante.logo_size || 40) + "px", "important");
    nameElem.appendChild(img);
  } else {
    const span = document.createElement('span');
    span.textContent = ristorante.nome || 'Carta dei Vini';
    span.style.fontFamily = ristorante.name_font || 'sans-serif';
    span.style.fontSize = (ristorante.name_size || 24) + "px";
    span.style.color = ristorante.name_color || "#000000";
    span.style.fontWeight = ristorante.name_bold ? "bold" : "normal";
    ensureFontLoaded(ristorante.name_font);
    nameElem.appendChild(span);
  }
    // üîí Limita lingue se NON PRO
if (ristorante.subscription_plan !== "pro") {
  const langSelector = document.getElementById("langSelector");
  if (langSelector) {
    [...langSelector.options].forEach(opt => {
      if (!["it", "en"].includes(opt.value)) opt.remove(); // lascia solo üáÆüáπ e üá¨üáß
    });
  }
}
  setTimeout(() => aggiornaAltezzaNavbar(), 20);
}

window.ristorantePalette = ristorante.palette_color;

applyPalette(ristorante.palette_color);
}

window.goBack = function () {
  history.back();
}

function applyPalette(palette) {
  if (window.ristorantePalette === "custom") return;

  let primary = "#b00";
  let background = "#fff9f4";
  let cardBackground = "#ffffff";
  let borderColor = "#b00";
  let textColor = "#000000";
  let boxShadow = "0 2px 6px rgba(0, 0, 0, 0.15)"; // valore predefinito
  let navbarColor;
  
  switch (palette) {
    case "rosso":
      primary = "#b3001b";
      background = "#fff5f5";
      navbarColor = "#ffcccc";
      cardBackground = "#ffe5e5";
      borderColor = "#990014";
      textColor = "#330000";
      boxShadow = "0 2px 6px rgba(155, 28, 49, 0.2)";
      break;

    case "oro":
      primary = "#c29d2e";
      background = "#fffdf0";
      navbarColor = "#fdf2c0";
      cardBackground = "#fef6d8";
      borderColor = "#b38e2e";
      textColor = "#4a3b00";
      boxShadow = "0 2px 6px rgba(179, 142, 46, 0.25)";
      break;

    case "blu-elegante":
      primary = "#103d5e";
      background = "#f2f7fc";
      navbarColor = "#cce0f2";
      cardBackground = "#e4eff9";
      borderColor = "#0b2e4b";
      textColor = "#0b1c2d";
      boxShadow = "0 2px 6px rgba(16, 61, 94, 0.18)";
      break;

    case "verde-salvia":
      primary = "#4a715a";
      background = "#f4f9f5";
      navbarColor = "#e0f0e4";
      cardBackground = "#e5f1e8";
      borderColor = "#3a5948";
      textColor = "#273e32";
      boxShadow = "0 2px 6px rgba(74, 113, 90, 0.2)";
      break;

    case "grigio-minimal":
      primary = "#444";
      background = "#f7f7f7";
      navbarColor = "#eeeeee";
      cardBackground = "#ffffff";
      borderColor = "#cccccc";
      textColor = "#222222";
      boxShadow = "0 2px 5px rgba(100, 100, 100, 0.1)";
      break;

case "black-white":
  primary = "#1e1e1e";
  background = "#f7f7f7";
  navbarColor = "#1e1e1e";
  cardBackground = "#ffffff";
  borderColor = "#d0d0d0";
  textColor = "#111111";
  boxShadow = "0 2px 6px rgba(0,0,0,0.08)";
  break;

    case "crema-nero":
      primary = "#000000";
      background = "#fffaf0";
      navbarColor = "#fff3dd";
      cardBackground = "#ffffff";
      borderColor = "#000000";
      textColor = "#000000";
      boxShadow = "0 2px 6px rgba(0, 0, 0, 0.1)";
      break;

      case "tramonto":
      primary = "#e07b39";
      background = "#fff5ec";
      navbarColor = "#c65a1e";
      cardBackground = "#ffe3cc";
      borderColor = "#c65a1e";
      textColor = "#3e2c1b";
      boxShadow = "0 2px 6px rgba(224, 123, 57, 0.2)";
      break;

      case "notte-blu":
      primary = "#0b1c2d"; // blu scuro petrolio
      background = "#eff4f7";
      navbarColor = "#021639";        // Navbar leggermente pi√π chiara
      cardBackground = "#d8e3ec";
      borderColor = "#06131f";
      textColor = "#0a1a28";
      boxShadow = "0 2px 6px rgba(11, 28, 45, 0.25)";
      break;

      case "vino-rosso":
      primary = "#511627"; // vinaccia
      background = "#fcf6f8";
      navbarColor = "#6e003f";        // Navbar tono pi√π scuro
      cardBackground = "#f6e9ed";
      borderColor = "#3b101d";
      textColor = "#2c0d14";
      boxShadow = "0 2px 6px rgba(81, 22, 39, 0.25)";
      break;

      case "tortora":
      primary = "#7e7064";
      background = "#f8f5f2";
      navbarColor = "#d6ccc2";
      cardBackground = "#eeeae6";
      borderColor = "#6e6156";
      textColor = "#2e2b28";
      boxShadow = "0 2px 6px rgba(126, 112, 100, 0.15)";
      break;
  }

  // Applica colori dinamici
  document.body.style.backgroundColor = background;
  const cards = document.querySelectorAll('.category, .subcategory, .wine-card');
    cards.forEach(el => {
      el.classList.remove("glass", "glass-dark");
      el.style.backgroundColor = cardBackground;
      el.style.borderColor = borderColor;
      el.style.color = textColor;
      el.style.boxShadow = boxShadow;
    });
    
    const popup = document.getElementById("sommelierPopup");
    if (popup) {
      popup.style.backgroundColor = cardBackground;
      popup.style.borderColor = borderColor;
      popup.style.color = textColor;
      popup.style.boxShadow = boxShadow;
    }

    // Applica effetto vetro solo a palette selezionate
    if (["oro", "crema-nero"].includes(palette)) {
      cards.forEach(el => el.classList.add("glass"));
    }
    if (palette === "black-white") {
      cards.forEach(el => el.classList.add("glass-dark"));
    } 

  // Applica colore anche ai bottoni / elementi principali
  const backBtn = document.querySelector("nav button");
  if (backBtn) backBtn.style.color = primary;

const sommelierBtn = document.getElementById("sommelierBtn");
if (sommelierBtn && window.showSommelier === true) {
  // gradient ‚Äúacceso‚Äù ma in palette: dal colore primario a una versione pi√π chiara
  sommelierBtn.style.background = `linear-gradient(90deg, ${primary}, color-mix(in srgb, ${primary} 70%, white))`;
  sommelierBtn.style.borderColor = primary;

  // testo leggibile sopra qualunque palette
  const fg = getContrastingTextColor(primary);
  sommelierBtn.style.color = fg;
  // forza anche il testo interno
  const t = sommelierBtn.querySelector(".somm-text");
  if (t) t.style.color = fg;
}

const nav = document.querySelector("nav");
if (nav) {
  nav.style.backgroundColor = typeof navbarColor !== "undefined" ? navbarColor : background;
}
// espone i colori a CSS
document.documentElement.style.setProperty('--navbar-color', (typeof navbarColor!=="undefined" ? navbarColor : background));
// foreground chiaro/scuro in base allo sfondo
const bb = document.getElementById("bottomBar");
if (bb) {
  const fg = getContrastingTextColor(typeof navbarColor!=="undefined" ? navbarColor : background);
  bb.style.color = fg;
  document.documentElement.style.setProperty('--bottom-bar-foreground', fg);
}

const bottleBtn = document.getElementById("bottleBtn");
if (bottleBtn) {
  bottleBtn.style.backgroundColor = primary;
  bottleBtn.style.borderColor = primary;
}

const glassBtn = document.getElementById("glassBtn");
if (glassBtn) {
  glassBtn.style.backgroundColor = primary;
  glassBtn.style.borderColor = primary;
}

const searchBtn = document.getElementById("searchBtn");
if (searchBtn) {
  searchBtn.style.backgroundColor = primary;
  searchBtn.style.borderColor = primary;
}

const searchPop = document.getElementById("searchPopover");
if (searchPop) {
  // usa i colori della palette per card/contorni/testo/ombra
  searchPop.style.backgroundColor = window.paletteColors?.cardBackground || "#fff";
  searchPop.style.borderColor     = window.paletteColors?.borderColor   || "#ccc";
  searchPop.style.color           = window.paletteColors?.textColor     || "#000";
  searchPop.style.boxShadow       = window.paletteColors?.boxShadow     || "0 2px 6px rgba(0,0,0,.15)";
  // input interno coerente
  const input = searchPop.querySelector('input');
  if (input) {
    input.style.backgroundColor = "#fff";
    input.style.color = "#000";
    input.style.borderColor = "#ccc";
  }
  const btn = searchPop.querySelector('button.save-btn');
  if (btn) {
    btn.style.backgroundColor = (document.getElementById("searchBtn")?.style.backgroundColor) || "#b00";
    btn.style.color = "#fff";
  }
}

window.paletteColors = {
  background,
  cardBackground,
  borderColor,
  textColor,
  boxShadow
};
}

function normalize(str) {
  return str ? str.toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu, "").trim() : '';
}

function goToCategories() {
  // chiudi eventuali overlay/popover
  closeFilterMenu?.();
  closeSearch?.();

  // reset contesto
  currentCategory = null;
  window.currentSubcategory = null;
  currentView = 'categories';

  // helper in alto
  setHelperByKey('helperChooseCategory');

  // ricostruisci le categorie (rispetta i filtri attivi)
  showCategories();

  // visibilit√† liste
  const catList = document.getElementById("category-list");
  const subcatList = document.getElementById("subcategory-list");
  const wineList = document.getElementById("wine-list");
  if (catList)   catList.style.display   = "block";
  if (subcatList) subcatList.style.display = "none";
  if (wineList)   wineList.style.display   = "none";

  // sincronizza la history (evita doppio push se gi√† manualNavigation)
  if (!window._manualNavigation) {
    history.pushState({ view: "categories" }, "");
  }
}
window.goToCategories = goToCategories;

function buildPriceHTML(w){
  const chips = [];

  if (w.prezzo) {
    chips.push(
      `<span class="price-chip">
         <img class="icon" src="bottleico.png"
              onerror="this.onerror=null;this.src='bottleicon.png';"
              alt="bottiglia">
         ${w.prezzo}
       </span>`
    );
  }
  if (w.prezzo_bicchiere) {
    chips.push(
      `<span class="price-chip">
         <img class="icon" src="glassico.png" alt="calice">
         ${w.prezzo_bicchiere}
       </span>`
    );
  }

  const add = (label, val) => { if (val) chips.push(`<span class="price-chip"><strong>${label}</strong> ${val}</span>`); };
  add('1/4lt',   w.prezzo_025);
  add('0,375lt', w.prezzo_0375);
  add('1/2lt',   w.prezzo_05);
  add('1,5lt',   w.prezzo_15);
  add('3lt',     w.prezzo_3l);

  if (!chips.length) return '';
  return `<div class="price-row">${chips.join(' ')}</div>`;
}

function showWinesBySubcategory(subcat) {
  setHelperByKey('helperClickWine');
  currentView = 'wines';
  window.currentSubcategory = subcat;
  const wineList = document.getElementById('wine-list');
  if (wineList) wineList.style.display = 'block';
  wineList.innerHTML = '';
  const { ids, map } = getCheckedFormats();
const allInSub = wines.filter(w =>
  normalize(w.categoria) === normalize(currentCategory) &&
  normalize(w.sottocategoria) === normalize(subcat)
);
const filtered = winesMatchFormats(allInSub, ids, map);
  filtered.forEach(w => {
    const card = document.createElement('div');
card.className = 'wine-card';
const annata = w.annata ? ` (${w.annata})` : '';

const nomePulito = (w.nome || "").trim();
const t = translations[currentLang];
card.innerHTML = `
  <strong>${nomePulito}${annata}</strong>
  ${buildPriceHTML(w)}
  ${w.uvaggio ? `<small>${t.grape}: ${w.uvaggio}</small>` : ""}`;

    wineList.appendChild(card);
    card.onclick = () => {
  mostraPopupDescrizione(w); // w √® il vino cliccato
};
  });
applyPalette(window.ristorantePalette);
nudgeSommelier("entered_wine_list");

  const subcatList = document.getElementById('subcategory-list');
  if (subcatList) subcatList.style.display = 'none';
  wineList.style.display = 'block';
  if (!window._manualNavigation) {
  history.pushState({ view: "wines", subcategory: subcat, category: currentCategory }, "");
}
}

function showWinesForCategory(category) {
  setHelperByKey('helperClickWine');
  currentView = 'wines';
  currentCategory = category;
  window.currentSubcategory = null;     // ‚Üê importante: nessuna sottocategoria attiva

  const wineList = document.getElementById('wine-list');
  if (wineList) wineList.style.display = 'block';
  wineList.innerHTML = '';

  // rispetta i filtri formati (bottiglia, calice, ecc.)
  const { ids, map } = getCheckedFormats();
  const allInCat = wines.filter(w => normalize(w.categoria) === normalize(category));
  const filtered = winesMatchFormats(allInCat, ids, map);

  filtered.forEach(w => {
    const card = document.createElement('div');
    card.className = 'wine-card';
    const annata = w.annata ? ` (${w.annata})` : '';
    const nomePulito = (w.nome || '').trim();
    const t = translations[currentLang];
    card.innerHTML = `
      <strong>${nomePulito}${annata}</strong>
      ${buildPriceHTML(w)}
      ${w.uvaggio ? `<small>${t.grape}: ${w.uvaggio}</small>` : ""}`;
    wineList.appendChild(card);
    card.onclick = () => { mostraPopupDescrizione(w); };
  });

  // nascondi liste non pertinenti
  const subcatList = document.getElementById('subcategory-list');
  if (subcatList) subcatList.style.display = 'none';
  const catList = document.getElementById('category-list');
  if (catList) catList.style.display = 'none';

  // stato cronologia: ‚Äúwines‚Äù senza subcategory
  if (!window._manualNavigation) {
  history.pushState({ view: "wines", category, subcategory: null }, "");
}

  // riapplica palette
  applyPalette(window.ristorantePalette);
  nudgeSommelier("entered_wine_list");
}

async function loadWineData() {
  if (!RESTAURANT_ID) return;
  if (!ristorante) {
    console.error("Ristorante non caricato");
    return;
  }

  const res = await fetch(`${SUPABASE_URL}/rest/v1/wines?ristorante_id=eq.${RESTAURANT_ID}&visibile=is.true`, {
    headers: { 'apikey': SUPABASE_API_KEY, 'Accept': 'application/json' }
  });
  const json = await res.json();

wines = Array.isArray(json) ? json : [];

// Estrai categorie uniche dai vini
const categorieUniche = [];
wines.forEach(w => {
  const cat = w.categoria;
  if (cat && !categorieUniche.includes(cat)) {
    categorieUniche.push(cat);
  }
});

// Ordina alfabeticamente
if (Array.isArray(categoriaOrder) && categoriaOrder.length) {
  sortByOrder(categorieUniche, categoriaOrder);
}


switch ((ristorante.ordine_vini || 'prezzo')) {
  case 'prezzo':
    wines.sort((a, b) => {
      const priceA = parseFloat((a.prezzo || '').replace(/[^0-9,.]/g, '').replace(',', '.')) || 0;
      const priceB = parseFloat((b.prezzo || '').replace(/[^0-9,.]/g, '').replace(',', '.')) || 0;
      return priceA - priceB;
    });
    break;

  case 'annata':
    wines.sort((a, b) => (parseInt(a.annata) || 0) - (parseInt(b.annata) || 0));
    break;

  case 'nome':
    wines.sort((a, b) => (a.nome || '').localeCompare(b.nome || ''));
    break;

  case 'inserimento':
    // Nessun ordinamento, resta come arriva
    break;
}
}
async function setupSommelierUI() {
  // crea solo gli elementi una volta
  window.showSommelier = ristorante?.sommelier_attivo === true || ristorante?.sommelier_attivo === "true";
  if (!document.getElementById("sommelierBtn")) {
    creaUIBaseSommelier();
  }

  await aggiornaCategorieSommelier();
}
async function creaUIBaseSommelier() {
  const btn = document.createElement("button");
  btn.id = "sommelierBtn";
  btn.setAttribute("aria-label", translations[currentLang].sommelierBtn || "Sommelier");
btn.innerHTML = `
  <img src="${ristoranteSommelierURL || 'sommelier.png'}" alt="" aria-hidden="true">
  <div class="somm-text">
    <span class="somm-title translate-label" data-key="sommelierBtnTitle">${translations[currentLang].sommelierBtnTitle}</span>
    <span class="somm-sub translate-label" data-key="sommelierBtnSub">${getSommelierBtnSubText()}</span>
  </div>
`;
  document.body.appendChild(btn);
  refreshSommelierBtnCopy();

  trackSommelier("sommelier_btn_shown", {
  lang: currentLang,
  palette: window.ristorantePalette || null
}, "btn_shown");

  // Apri il popup al click
  btn.addEventListener("click", () => {
    trackSommelier("sommelier_btn_click", { lang: currentLang });
    localStorage.setItem("sommelier_seen", "1");
    btn.classList.remove("pulse");
    toggleSommelier();
  });

  // Effetti periodici: glow e wiggle (soft)
  setInterval(() => btn.classList.toggle("glow"), 3500);
setInterval(() => {
  if (localStorage.getItem("sommelier_seen")) return; // solo finch√© non l‚Äôhanno mai usato
  btn.classList.add("wiggle");
  setTimeout(() => btn.classList.remove("wiggle"), 950);
}, 22000);


  // Pulse solo se mai cliccato
  if (!localStorage.getItem("sommelier_seen")) {
    btn.classList.add("pulse");
  }


    const overlay = document.createElement("div");
    overlay.id = "sommelierOverlay";
    overlay.innerHTML = `
      <div id="sommelierPopup" class="popup">
        <button class="close-btn" onclick="closeSommelierPopup()">‚úñ</button>
        <h3 class="translate-label" data-key="sommelierTitleBox">Dimmi cosa mangerai e io ti consiglier√≤ il vino giusto! üç∑</h3>
        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;">
          <div style="flex: 1 1 48%;">
            <label for="priceFilter" class="translate-label" data-key="filterPrice" style="font-size: 0.85em; display: block; margin-bottom: 4px;">Filtra per prezzo</label>
            <select id="priceFilter" style="width: 100%; padding: 8px; font-size: 0.95em; border-radius: 8px; border: 1px solid #ccc;">
              <option value="" class="translate-label" data-key="anyPrice">Indifferente</option>
              <option value="25">Max ‚Ç¨25</option>
              <option value="35">Max ‚Ç¨35</option>
              <option value="45">Max ‚Ç¨45</option>
              <option value="60">Max ‚Ç¨60</option>
              <option value="100">Max ‚Ç¨100</option>
            </select>
          </div>
          <div style="flex: 1 1 48%; min-width: 0; position: relative;">
            <label style="font-size: 0.85em; display: block; margin-bottom: 4px;" class="translate-label" data-key="filterCategory">Filtra per categoria</label>
            <button type="button" onclick="toggleWineTypeDropdown()" id="categoryFilterBtn"
              style="width: 100%; max-width: 100%; overflow: hidden; padding: 8px; font-size: 0.95em; border-radius: 8px; border: 1px solid #ccc; background: #fff; appearance: none; text-align: left; position: relative; white-space: nowrap;">
              <span class="labelText"
                style="display:inline-block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: calc(100% - 24px); vertical-align: middle;">Tutti</span>
              <span style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-size: 0.8em;">‚ñº</span>
            </button>
          </div>
        </div>
        <div style="margin-top: 12px;">
          <label style="font-size: 0.85em; display: block; margin-bottom: 4px;" class="translate-label" data-key="searchLabel">Ricerca piatti per abbinamento</label>
          <div style="display: flex; background: white; border-radius: 999px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.08); width: 100%;">
            <input type="text" id="foodInput" placeholder="Separa piatti con le virgole." onkeydown="handleSommelierKey(event)" style="flex: 1; padding: 10px 14px; border: none; outline: none; font-size: 0.95em; background: transparent; line-height: 1.2; height: 40px; display: flex; align-items: center;" />
            <button id="sendFoodBtn" onclick="suggestWine()" style="padding: 0 16px; background: #999; color: white; border: none; font-size: 0.9em; font-weight: 500; cursor: pointer; display: none; transition: background 0.2s ease; border-radius: 999px;" class="translate-label" data-key="sendButton">INVIA</button>
          </div>
        </div>
        <div id="wineSuggestion" style="margin-top: 15px; font-size: 0.95em;"></div>
      </div>
    `;
    document.body.appendChild(overlay);

    const foodInput = document.getElementById("foodInput");
    const sendBtn = document.getElementById("sendFoodBtn");

    if (foodInput && sendBtn) {
      let _firstTypeTracked = false;

foodInput.addEventListener("input", () => {
  if (!_firstTypeTracked && foodInput.value.trim().length > 0) {
    _firstTypeTracked = true;
    trackSommelier("sommelier_input_started", {
      lang: currentLang
    }, "input_started");
  }

  if (foodInput.value.trim().length > 0) {
    sendBtn.style.display = "inline-block";
  } else {
    sendBtn.style.display = "none";
  }
});

    }

    const dropdown = document.createElement("div");
    dropdown.id = "wineTypeDropdown";
    dropdown.style.display = "none";
    document.body.appendChild(dropdown);

  aggiornaEtichettaCategorie();
}

window.closeSommelierPopup = closeSommelierPopup;

  async function aggiornaCategorieSommelier() {
  const dropdown = document.getElementById("wineTypeDropdown");
  if (!dropdown || !Array.isArray(wines)) return;

  const categorieUniche = [...new Set(wines.map(w => w.categoria).filter(Boolean))];
  dropdown.innerHTML = "";

  for (const cat of categorieUniche) {
    const label = document.createElement("label");
    label.style.cssText = "display: flex; align-items: center; gap: 8px; margin-bottom: 6px;";

    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.value = cat;
    checkbox.checked = true;
    checkbox.onchange = aggiornaEtichettaCategorie;

    const span = document.createElement("span");
    span.textContent = cat;

    if (currentLang !== "it") {
      try {
        const res = await fetch("https://ldunvbftxhbtuyabgxwh.functions.supabase.co/traduci-categoria", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text: cat, targetLang: currentLang })
        });
        const data = await res.json();
        const translated = data.text?.trim() || cat;
        span.textContent = translated;
        checkbox.setAttribute("data-translated-label", translated);
      } catch (err) {
        checkbox.setAttribute("data-translated-label", cat);
      }
    } else {
      checkbox.setAttribute("data-translated-label", cat);
    }

    label.appendChild(checkbox);
    label.appendChild(span);
    dropdown.appendChild(label);
  }

  aggiornaEtichettaCategorie();
}

let reorderMode = null;
let reorderType = null;
let categoriaOrder = [];
let sottocategoriaOrderMap = {};

function buildPrintWineBlock(w) {
  const t = translations[currentLang] || translations.it;

  const wrapper = document.createElement("div");
  wrapper.className = "print-wine-block";

  // riga nome + prezzi
  const row = document.createElement("div");
  row.className = "print-wine-row";

  const name = document.createElement("div");
  name.className = "print-wine-name";
  const annata = w.annata ? ` (${w.annata})` : "";
  name.textContent = `${(w.nome || "").trim()}${annata}`;

  const prices = document.createElement("div");
  prices.className = "print-wine-prices";
  prices.innerHTML = buildPriceHTML(w) || "";

  row.appendChild(name);
  row.appendChild(prices);
  wrapper.appendChild(row);

  // uvaggio sotto, se presente
  if (w.uvaggio) {
    const uv = document.createElement("div");
    uv.className = "print-wine-uvaggio";
    uv.textContent = `${t.grape}: ${w.uvaggio}`;
    wrapper.appendChild(uv);
  }

  return wrapper;
}

function buildPrintableCarta() {
  // rispetta i filtri formati (bottiglia / bicchiere / formati extra)
  const { ids, map } = getCheckedFormats();
  const filtered = winesMatchFormats(wines, ids, map);

  if (!filtered || !filtered.length) {
    alert("Non ci sono vini da stampare con i filtri attuali.");
    return null;
  }

  const root = document.createElement("div");
  root.id = "printCartaRoot";
  root.className = "print-carta-root";

  const t = translations[currentLang] || translations.it;

  // header con nome ristorante / titolo carta
  const header = document.createElement("div");
  header.className = "print-header";

  const h1 = document.createElement("h1");
  const nameSpan = document.querySelector("#restaurantName span");
  h1.textContent =
    (nameSpan?.textContent?.trim()) ||
    t.wineList ||
    "Carta dei Vini";

  header.appendChild(h1);
  root.appendChild(header);

  // se stai mostrando solo i vini al calice, lo indichiamo
  if (typeof isGlassOnly === "function" && isGlassOnly()) {
    const sub = document.createElement("div");
    sub.className = "print-subtitle";
    sub.textContent =
      t.helperGlassMode || "üç∑ Stai visualizzando solo i vini al calice";
    root.appendChild(sub);
  }

  // raggruppa per categoria / sottocategoria
  const catsMap = new Map();
  filtered.forEach((w) => {
    const catLabel = w.categoria || "Altro";
    const catKey = normalize(catLabel) || catLabel.toLowerCase();
    if (!catsMap.has(catKey)) {
      catsMap.set(catKey, {
        name: catLabel,
        subMap: new Map(), // key normalizzata -> { name, wines[] }
        noSub: [],        // vini senza sottocategoria
      });
    }
    const cat = catsMap.get(catKey);
    const subLabel = (w.sottocategoria || "").trim();
    if (subLabel) {
      const subKey = normalize(subLabel);
      if (!cat.subMap.has(subKey)) {
        cat.subMap.set(subKey, { name: subLabel, wines: [] });
      }
      cat.subMap.get(subKey).wines.push(w);
    } else {
      cat.noSub.push(w);
    }
  });

  // ordina le categorie con ordine personalizzato, se presente
  const catEntries = Array.from(catsMap.entries());
  if (Array.isArray(categoriaOrder) && categoriaOrder.length) {
    catEntries.sort((a, b) => {
      const i1 = categoriaOrder.indexOf(a[0]);
      const i2 = categoriaOrder.indexOf(b[0]);
      if (i1 === -1 && i2 === -1) {
        return a[1].name.localeCompare(b[1].name, "it");
      }
      if (i1 === -1) return 1;
      if (i2 === -1) return -1;
      return i1 - i2;
    });
  } else {
    catEntries.sort((a, b) => a[1].name.localeCompare(b[1].name, "it"));
  }

  catEntries.forEach(([catKey, catData]) => {
    const block = document.createElement("section");
    block.className = "print-category-block";

    const h2 = document.createElement("h2");
    h2.className = "print-category-title";
    h2.textContent = catData.name;
    block.appendChild(h2);

    // vini senza sottocategoria
    catData.noSub.forEach((w) => {
      block.appendChild(buildPrintWineBlock(w));
    });

    // sottocategorie ordinate
    const subEntries = Array.from(catData.subMap.entries());
    const subOrder =
      (sottocategoriaOrderMap && sottocategoriaOrderMap[catKey]) || [];

    if (subOrder.length) {
      subEntries.sort((a, b) => {
        const i1 = subOrder.indexOf(a[0]);
        const i2 = subOrder.indexOf(b[0]);
        if (i1 === -1 && i2 === -1) {
          return a[1].name.localeCompare(b[1].name, "it");
        }
        if (i1 === -1) return 1;
        if (i2 === -1) return -1;
        return i1 - i2;
      });
    } else {
      subEntries.sort((a, b) => a[1].name.localeCompare(b[1].name, "it"));
    }

    subEntries.forEach(([_, subData]) => {
      const h3 = document.createElement("h3");
      h3.className = "print-subcategory-title";
      h3.textContent = subData.name;
      block.appendChild(h3);

      subData.wines.forEach((w) => {
        block.appendChild(buildPrintWineBlock(w));
      });
    });

    root.appendChild(block);
  });

  return root;
}

async function startDownloadPDF() {
  // ‚úÖ carica html2pdf solo quando serve
  if (typeof html2pdf === "undefined") {
    await loadScriptOnce(
      "html2pdf-js",
      "https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"
    );
  }


  // Costruisce il layout completo (categorie + sottocategorie + vini)
  const printRoot = buildPrintableCarta();
  if (!printRoot) return;

  // Nascondi la UI interattiva, mostra solo il layout stampabile
  document.body.classList.add("pdf-export");

  const app = document.getElementById("app");
  const previousDisplay = app ? app.style.display : null;
  if (app) app.style.display = "none";

  document.body.appendChild(printRoot);

  const nameSpan = document.querySelector("#restaurantName span");
  const baseName = (nameSpan?.textContent || "carta-vini")
    .toLowerCase()
    .replace(/[^\w\-]+/g, "-");
  const t = translations[currentLang] || translations.it;

  const opt = {
    margin: [0.5, 0.7, 0.8, 0.7], // top,right,bottom,left in cm
    filename: `${baseName}.pdf`,
    image: { type: "jpeg", quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true },
    jsPDF: { unit: "cm", format: "a4", orientation: "portrait" },
    pagebreak: { mode: ["css", "legacy"] }
  };

  // Worker html2pdf con numeri di pagina
  const worker = html2pdf()
    .set(opt)
    .from(printRoot)
    .toPdf()
    .get("pdf")
    .then(function (pdf) {
      const totalPages = pdf.internal.getNumberOfPages();
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();

      pdf.setFont("helvetica", "normal");
      pdf.setFontSize(8);

      for (let i = 1; i <= totalPages; i++) {
  pdf.setPage(i);
  // uso un trattino semplice per evitare problemi di encoding
  const labelText = `${t.wineList || "Carta dei Vini"} - ${i}/${totalPages}`;
  pdf.text(labelText, pageWidth / 2, pageHeight - 0.5, { align: "center" });
}
    })
    .save();

  // cleanup UI una volta finito
  worker
    .then(() => {
      document.body.classList.remove("pdf-export");
      if (printRoot.parentNode) {
        printRoot.parentNode.removeChild(printRoot);
      }
      if (app) {
        app.style.display = previousDisplay ?? "";
      }
    })
    .catch(() => {
      document.body.classList.remove("pdf-export");
      if (printRoot.parentNode) {
        printRoot.parentNode.removeChild(printRoot);
      }
      if (app) {
        app.style.display = previousDisplay ?? "";
      }
    });
}


window.addEventListener("message", async (event) => {
  if (event.data?.action === "updateFontLive") {
  const font = event.data.font;
  if (font) {
    document.body.style.fontFamily = font;
    ensureFontLoaded(font);
  }
  window.paletteOverrideLive = true;
}

if (event.data?.action === "updatePaletteLive") {
  const { palette } = event.data;
  window.paletteOverrideLive = false;
  window.ristorantePalette = palette;
  applyPalette(palette);
}

  if (event.data?.action === "checkSubcategoryContext") {
    const allowed = currentView === "subcategory" && currentCategory;
    parent.postMessage({ action: "subcatReady", allowed }, "*");
  }

  if (event.data?.action === "updateLogoLive") {
  let logo = document.getElementById("restaurantLogo");
  const nav = document.querySelector("nav");

if (!logo && event.data.logoUrl) {
  logo = document.createElement("img");
  logo.id = "restaurantLogo";
  logo.style.display = "block";

  // ‚úÖ Ricrea il contenuto del nav con il bottone goBack incluso
  nav.innerHTML = `
    <button onclick="goBack()">‚¨Ö</button>
    <div style="flex: 1; display: flex; justify-content: center;">
      <div id="restaurantName"></div>
    </div>
  `;
  document.getElementById("restaurantName").appendChild(logo);
  setTimeout(() => aggiornaAltezzaNavbar(), 50);
}

  if (logo) {
    if (event.data.logoUrl) logo.src = event.data.logoUrl;
    if (event.data.size) {
      logo.style.height = event.data.size + "px";
      setTimeout(() => aggiornaAltezzaNavbar(), 30);
    }

    if (event.data.border) {
      logo.style.border = "2px solid " + event.data.borderColor;
      logo.style.borderRadius = "8px";
      logo.style.padding = "4px";
    } else {
      logo.style.border = "none";
            logo.style.padding = "0";
    }
  }
}

  if (event.data?.action === "updateNameLive") {
const nameSpan = document.querySelector("#restaurantName span");
if (nameSpan) {
  nameSpan.style.fontFamily = event.data.font || "sans-serif";
  nameSpan.style.fontSize = event.data.size + "px";
  nameSpan.style.color = event.data.color;
  nameSpan.style.fontWeight = event.data.bold ? "bold" : "normal";
  nameSpan.textContent = event.data.name || "Carta dei Vini";

  ensureFontLoaded(event.data.font);

  // Aspetta il prossimo repaint per avere le dimensioni corrette
  setTimeout(() => {
    aggiornaAltezzaNavbar();
  }, 50);
}}


  if (event.data?.action === "startReorder") {
    if (typeof Sortable === "undefined") {
  await loadScriptOnce(
    "sortable-js",
    "https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"
  );
}
    reorderMode = true;
    reorderType = event.data.type;

    if (reorderType === "categorie") {
      const container = document.getElementById("category-list");
      [...container.children].forEach(el => {
        el.style.cursor = "grab";
        el.innerHTML = `<span style='opacity:0.5;margin-right:0.5em;'>‚ò∞</span>${el.innerHTML}`;
      });

      new Sortable(container, {
        animation: 150,
        ghostClass: 'sortable-ghost'
      });
    } else if (reorderType === "sottocategorie") {
      const subContainer = document.getElementById("subcategory-list");
      [...subContainer.children].forEach(el => {
        el.style.cursor = "grab";
        el.innerHTML = `<span style='opacity:0.5;margin-right:0.5em;'>‚ò∞</span>${el.innerHTML}`;
      });

      new Sortable(subContainer, {
        animation: 150,
        ghostClass: 'sortable-ghost'
      });
    }
  }

  if (event.data?.action === "getReorder") {
    if (reorderType === "categorie") {
      const container = document.getElementById("category-list");
      const ordine = [...container.children].map(el =>
  el.textContent.replace(/^‚ò∞\s*/, '').trim()
);
      parent.postMessage({ action: "saveReorder", type: "categorie", ordine }, "*");
    } else if (reorderType === "sottocategorie") {
      const subContainer = document.getElementById("subcategory-list");
      const ordine = [...subContainer.children].map(el =>
  el.textContent.replace(/^‚ò∞\s*/, '').trim()
);
      const sottocategorieMap = { [currentCategory]: ordine };
      parent.postMessage({ action: "saveReorder", type: "sottocategorie", sottocategorieMap }, "*");
    }
  }

    if (event.data?.action === "downloadPDF") {
    startDownloadPDF();
  }
});

async function fetchCategoryOrder() {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/ristoranti?id=eq.${RESTAURANT_ID}`, {
    headers: { 'apikey': SUPABASE_API_KEY, 'Accept': 'application/json' }
  });
  const data = await res.json();
  const risto = data[0] || {};

  // --- categorie ---
  categoriaOrder = (risto.ordine_categorie || []).map(normalize);

  // --- sottocategorie ---
  let rawMap = risto.ordine_sottocategorie || {};

  // se arriva come stringa JSON, la parsiamo
  if (typeof rawMap === "string") {
    try {
      rawMap = JSON.parse(rawMap);
    } catch (e) {
      console.warn("ordine_sottocategorie non parsabile:", e);
      rawMap = {};
    }
  }

  sottocategoriaOrderMap = {};
  for (const [catName, value] of Object.entries(rawMap)) {
    const normCat = normalize(catName);              // chiave: categoria normalizzata
    const arr = Array.isArray(value) ? value : [];
    // salviamo i nomi delle sottocategorie normalizzati
    sottocategoriaOrderMap[normCat] = arr.map(normalize);
  }
}

function sortByOrder(array, orderArray) {
  return array.sort((a, b) => {
    const i1 = orderArray.indexOf(normalize(a));
    const i2 = orderArray.indexOf(normalize(b));
    if (i1 === -1) return 1;
    if (i2 === -1) return -1;
    return i1 - i2;
  });
}

// override showCategories and showSubcategories to apply order
const originalShowCategories = window.showCategories;
const originalShowSubcategories = window.showSubcategories;
let _catRenderToken = 0;

window.showCategories = async function () {
  setHelperByKey('helperChooseCategory');

  // üëâ 1) calcolo l‚Äôelenco categorie dai vini filtrati (come prima)
  const { ids, map } = getCheckedFormats();
  const filtered = winesMatchFormats(wines, ids, map);
  const seen = new Map();
  filtered.forEach(w => {
    const key = normalize(w.categoria);
    if (key && !seen.has(key)) seen.set(key, w.categoria);
  });

  let orderedKeys = Array.from(seen.keys());

  if (categoriaOrder.length) {
    const seenKeys = Array.from(seen.keys());
    const customOrder = categoriaOrder
      .map(name => {
        const normalized = normalize(name);
        return seenKeys.find(k => normalize(k) === normalized);
      })
      .filter(Boolean);
    if (customOrder.length > 0) orderedKeys = customOrder;
  }

  // üëâ 2) token di render per annullare render precedenti
  const myToken = ++_catRenderToken;

  const container = document.getElementById('category-list');
  if (!container) return;
  container.style.display = 'block';
  container.innerHTML = ''; // svuota SUBITO

  // üëâ 3) preparo TUTTI i testi (tradotti) prima, poi renderizzo una sola volta
  const items = await Promise.all(orderedKeys.map(async (key) => {
    let display = seen.get(key);
    if (currentLang !== "it") {
      try {
        const res = await fetch("https://ldunvbftxhbtuyabgxwh.functions.supabase.co/traduci-categoria", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text: display, targetLang: currentLang })
        });
        const data = await res.json();
        display = (data.text?.trim()) || display;
      } catch (_) {}
    }
    return { key, display };
  }));

  // üëâ 4) se nel frattempo √® partito un altro render, mi fermo
  if (myToken !== _catRenderToken) return;

  // üëâ 5) dedup per sicurezza (es. due categorie diverse -> stessa traduzione)
  const already = new Set();
  const frag = document.createDocumentFragment();
  for (const { key, display } of items) {
    const label = display;
    const dedupKey = normalize(label);
    if (already.has(dedupKey)) continue;
    already.add(dedupKey);

    const div = document.createElement('div');
    div.className = 'category';
    div.textContent = label;
    div.onclick = () => showSubcategories(key);
    frag.appendChild(div);
  }

  container.appendChild(frag);
  applyPalette(window.ristorantePalette);
};

window.showSubcategories = function (category) {
  currentCategory = category;
  setHelperCategoryName(category);
  currentView = 'subcategory';

  // ‚≠êÔ∏è Prendi i formati selezionati e filtra i vini della categoria
  const { ids, map } = getCheckedFormats();
  const inCategory = wines.filter(w => normalize(w.categoria) === normalize(category));
  const list = (ids && ids.length) ? winesMatchFormats(inCategory, ids, map) : inCategory;

  // Calcola solo le sottocategorie che hanno almeno un vino "list"
  const seen = new Map();
  list.forEach(w => {
    const key = normalize(w.sottocategoria);
    if (key && !seen.has(key)) seen.set(key, w.sottocategoria);
  });

  let orderedKeys = Array.from(seen.keys());
    // üëâ Nessuna sottocategoria? Vai direttamente alla lista dei vini della categoria
  if (orderedKeys.length === 0) {
    showWinesForCategory(category);
    return;
  }

const order = sottocategoriaOrderMap[normalize(category)] || [];

if (Array.isArray(order) && order.length) {
  const seenKeys = Array.from(seen.keys());
  const customOrder = order
    .map(name => {
      const normalized = normalize(name);
      return seenKeys.find(k => normalize(k) === normalized);
    })
    .filter(Boolean);

  // Aggiungi eventuali sottocategorie nuove non presenti nell'ordine salvato
  const extra = seenKeys.filter(k => !customOrder.includes(k));
  orderedKeys = [...customOrder, ...extra];
}

  const container = document.getElementById('subcategory-list');
  container.innerHTML = '';
  for (const key of orderedKeys) {
    const display = seen.get(key);
    const div = document.createElement('div');
    div.className = 'subcategory';
    div.textContent = display.charAt(0).toUpperCase() + display.slice(1).toLowerCase();
    div.onclick = () => showWinesBySubcategory(key);
    container.appendChild(div);
  }
applyPalette(window.ristorantePalette);

    const catList = document.getElementById('category-list');
    if (catList) catList.style.display = 'none';
  container.style.display = 'grid';
  const wineList = document.getElementById('wine-list');
  if (wineList) wineList.style.display = 'none';
if (window._manualNavigation !== true) {
  history.pushState({ view: "subcategory", category }, "");
}
};

(async () => {
  // 1) Prima risolviamo l‚ÄôID del ristorante (da query, slug o utente loggato)
  await ensureRestaurantId();

  if (!RESTAURANT_ID) {
    console.error("Nessun ristorante associato a questo URL");
    const helper = document.getElementById("helperBanner");
    if (helper) {
      helper.textContent = "Carta non trovata. Verifica il link o chiedi al ristorante.";
    }
    return;
  }

  // 2) Poi procediamo come prima
  await fetchCategoryOrder();
  await loadRestaurantData();

  if (ristorante && RESTAURANT_ID) {
    await loadWineData();
    setupFilterUI();
    showCategories();
  }

  const isSommelierOn =
    ristorante?.sommelier_attivo === true ||
    ristorante?.sommelier_attivo === "true";
  if (isSommelierOn) {
    setupSommelierUI();
  }

  // üîí Blocco la palette una volta per tutte
  const isCustom = ristorante.palette_color === "custom";
  window.paletteOverrideLive = isCustom;
  window.ristorantePalette = ristorante.palette_color;

  history.replaceState({ view: "categories" }, "");

applyPalette(window.ristorantePalette);
_afterDomGlassHook?.();

// ‚úÖ mostra la pagina solo quando √® pronta (niente flash/scatti)
requestAnimationFrame(() => {
  document.documentElement.classList.remove('boot-loading');
});
})();


let abbinamentiRecenti = JSON.parse(localStorage.getItem("abbinamenti_recenti") || "[]");
function aggiornaStorico(piatto) {
  if (!piatto) return;
  abbinamentiRecenti = abbinamentiRecenti.filter(p => p !== piatto);
  abbinamentiRecenti.unshift(piatto);
  if (abbinamentiRecenti.length > 5) abbinamentiRecenti.pop();
  localStorage.setItem("abbinamenti_recenti", JSON.stringify(abbinamentiRecenti));
}
function mostraStoricoNelSommelier() {
  if (!abbinamentiRecenti.length) return "";
  return `<div style='margin-top:20px; font-size:0.85em; color:#555;'>üîÅ Hai gi√† chiesto per: ` + abbinamentiRecenti.map(p => `<span onclick='ripetiAbbinamento("${p}")' style='cursor:pointer; color:#b00; margin-right:6px; text-decoration:underline;'>${p}</span>`).join(" ") + `</div>`;
}
function ripetiAbbinamento(piatto) {
  document.getElementById("foodInput").value = piatto;
  suggestWine();
}
  window.ripetiAbbinamento = ripetiAbbinamento;

function ensureFontLoaded(fontName) {
  if (!fontName || fontName === "custom") return;
  if (["sans-serif", "cursive", "monospace"].includes(fontName)) return;

  const fontId = "googleFont_" + fontName.replace(/\s+/g, "_");
  if (!document.getElementById(fontId)) {
    const link = document.createElement("link");
    link.id = fontId;
    link.rel = "stylesheet";
    const encoded = encodeURIComponent(fontName.trim()).replace(/%20/g, "+");
    link.href = `https://fonts.googleapis.com/css2?family=${encoded}&display=swap`;
    document.head.appendChild(link);
  }
}
function toggleWineTypeDropdown() {
  const dropdown = document.getElementById("wineTypeDropdown");
  const button = document.getElementById("categoryFilterBtn");

  if (!dropdown || !button) return;

  // Toggle display
  if (dropdown.style.display === "block") {
    dropdown.style.display = "none";
    return;
  }

  const rect = button.getBoundingClientRect();
  const popupRect = document.getElementById("sommelierPopup")?.getBoundingClientRect();
  const top = popupRect ? (rect.bottom + popupRect.top) : rect.bottom;

  dropdown.style.position = "fixed";
  dropdown.style.top = `${rect.bottom}px`;
  dropdown.style.left = `${rect.left}px`;
  dropdown.style.display = "block";
}
  window.toggleWineTypeDropdown = toggleWineTypeDropdown;

document.addEventListener("click", function (event) {
  const dropdown = document.getElementById("wineTypeDropdown");
  const button = document.getElementById("categoryFilterBtn");

  // Non chiudere se clicco sul bottone o dentro al menu
  if (
    dropdown.style.display === "block" &&
    !dropdown.contains(event.target) &&
    event.target !== button &&
    !button.contains(event.target)
  ) {
    dropdown.style.display = "none";
  }
});

function aggiornaEtichettaCategorie() {
  const allCheckboxes = document.querySelectorAll("#wineTypeDropdown input[type='checkbox']");
  const checked = Array.from(allCheckboxes).filter(cb => cb.checked).map(cb => cb.getAttribute("data-translated-label") || cb.value);
  const button = document.getElementById("categoryFilterBtn");

  const baseLabel = (checked.length === 0 || checked.length === allCheckboxes.length)
    ? translations[currentLang].allLabel
    : checked.slice(0, 3).join(', ') + (checked.length > 3 ? '‚Ä¶' : '');

  // ‚úÖ Non sostituire tutto l‚ÄôinnerHTML, modifica solo il contenuto testuale
  const textSpan = button.querySelector(".labelText");
  if (textSpan) textSpan.textContent = baseLabel;
}
window.addEventListener("popstate", (event) => {
 const overlay = document.getElementById('sommelierOverlay');
 if (overlay && overlay.style.display === 'flex') return;
  const state = event.state;

  window._manualNavigation = true; // ‚úÖ evita pushState

  if (!state || state.view === "categories") {
    goToCategories();
  } else if (state.view === "subcategory") {
    showSubcategories(state.category);
    } else if (state.view === "wines") {
    currentCategory = state.category;
    if (state.subcategory) {
      showWinesBySubcategory(state.subcategory);
    } else {
      showWinesForCategory(state.category);   // ‚úÖ categoria ‚Äúflat‚Äù
    }
  }

  setTimeout(() => window._manualNavigation = false, 100);
});
function renderSchedaInto(el, vinoNome, scheda, descrizione, lang){
  const clamp = v => Math.max(0, Math.min(100, Number(v||0)));

  const bars = `
    <div class="vino-bars">
      <div class="bar"><span>Leggero</span><div class="track"><i class="knob" style="left:${clamp(scheda?.profile?.body)}%"></i></div><span>Strutturato</span></div>
      <div class="bar"><span>Secco</span>  <div class="track"><i class="knob" style="left:${clamp(scheda?.profile?.sweetness)}%"></i></div><span>Dolce</span></div>
      <div class="bar"><span>Morbido</span><div class="track"><i class="knob" style="left:${clamp(scheda?.profile?.acidity)}%"></i></div><span>Acido</span></div>
    </div>`;

  const chips = (arr, icon="") =>
    (arr||[]).map(n => {
      const label = typeof n==="string" ? n : (n?.label || "");
      return `<span class="chip">${icon ? icon + " " : ""}${label}</span>`;
    }).join("");

  const summary = (scheda?.summary||"").toString();
  const pair = Array.isArray(scheda?.pairings) ? scheda.pairings : [];
  const notes = Array.isArray(scheda?.notes) ? scheda.notes : [];

  el.innerHTML = `
    <div class="vino-card">
      ${summary ? `<p class="summary">${summary}</p>` : ""}

      ${bars}

      ${notes.length ? `
        <div class="vino-section">
          <div class="vino-section-title">‚ú® Note</div>
          <div class="vino-chips">${chips(notes)}</div>
        </div>` : ""}

      ${pair.length ? `
        <div class="vino-section">
          <div class="vino-section-title">üçΩÔ∏è Abbinamenti</div>
          <div class="vino-chips">${chips(pair)}</div>
        </div>` : ""}

      <button class="vino-toggle" id="vToggleBtn">Mostra dettagli</button>
      <p id="vFullDesc" style="display:none; margin-top:6px;">${descrizione||""}</p>
    </div>
  `;

  const btn = el.querySelector('#vToggleBtn');
  const p   = el.querySelector('#vFullDesc');
  btn.onclick = () => {
    const show = p.style.display === 'none';
    p.style.display = show ? 'block' : 'none';
    btn.textContent = show ? 'Nascondi dettagli' : 'Mostra dettagli';
  };
}

function renderMiniCardInto(el, vinoNome, mini, lang){
  if (!el) return;
  const safe = (s)=> (s||"").toString();

  const noteChips = (mini?.notes||[]).map(n => {
    const emoji = mini?.emojis?.notes?.[n] || "";
    return `<span class="chip">${emoji ? (emoji + " ") : ""}${n}</span>`;
  }).join("");

  const pairChips = (mini?.pairings||[]).map(p => {
    const emoji = mini?.emojis?.pairings?.[p] || "";
    return `<span class="chip">${emoji ? (emoji + " ") : ""}${p}</span>`;
  }).join("");

  el.innerHTML = `
    <div class="vino-card">
      <p class="summary" style="margin-bottom:6px;"><strong>${safe(mini?.hook)}</strong></p>
      <p class="summary" style="margin-top:0;">${safe(mini?.palate)}</p>

      ${mini?.notes?.length ? `
        <div class="vino-section">
          <div class="vino-section-title">‚ú® Note</div>
          <div class="vino-chips">${noteChips}</div>
        </div>` : ""}

      ${mini?.pairings?.length ? `
        <div class="vino-section">
          <div class="vino-section-title">üçΩÔ∏è Abbinamenti</div>
          <div class="vino-chips">${pairChips}</div>
        </div>` : ""}
    </div>
  `;
}

function mostraPopupDescrizione(vino) {
  // Crea sempre l'overlay con gli elementi usati dopo
  const overlay = document.createElement("div");
  overlay.className = "popup-overlay";
  overlay.innerHTML = `
    <div class="popup-descrizione">
      <button class="close-btn" onclick="this.closest('.popup-overlay').remove()">‚úñ</button>
      <h3>${vino.nome}${vino.annata ? ` (${vino.annata})` : ""}</h3>
      <div id="schedaWrap" style="margin-top:8px;"></div>
      <div id="descrizioneTesto" style="margin-top:8px; font-size:.95em; opacity:.9;"></div>
    </div>`;
  document.body.appendChild(overlay);

  // Kill-switch: se disabilitata, messaggio e stop
  if (DESCRIZIONE_VINO_ABILITATA === false) {
    const desc = overlay.querySelector("#descrizioneTesto");
    if (desc) desc.textContent = "Descrizione momentaneamente non disponibile.";
    return;
  }

  // Altrimenti procedi col loader + fetch
  const descEl = overlay.querySelector("#descrizioneTesto");
  const wrapEl = overlay.querySelector("#schedaWrap");
  if (descEl) descEl.textContent = (translations[currentLang]?.loadingDescription) || "Sto caricando una descrizione...";

const DESCR_FN_URL = "https://ldunvbftxhbtuyabgxwh.functions.supabase.co/descrizione-vino";
const TRAD_FN_URL  = "https://ldunvbftxhbtuyabgxwh.functions.supabase.co/traduci-descrizione-vino";

const payload = {
  nome: vino.nome,
  annata: vino.annata,
  uvaggio: vino.uvaggio,
  categoria: vino.categoria,
  sottocategoria: vino.sottocategoria,
  ristorante_id: RESTAURANT_ID,
  lang: (currentLang === "gb" ? "en" : currentLang)
};

const isItalian = (currentLang === "it");

// se IT ‚Üí uso descrizione-vino
// se non IT ‚Üí uso traduci-descrizione-vino
const fnUrl = isItalian ? DESCR_FN_URL : TRAD_FN_URL;

fetch(fnUrl, {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
    "Authorization": `Bearer ${SUPABASE_API_KEY}`
  },
  body: JSON.stringify(payload)
})
  .then(async res => {
    const raw = await res.text();
    if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText} ‚Äî ${raw}`);
    return JSON.parse(raw);
  })
  .then(data => {
    const descr = data.descrizione || translations[currentLang].noDescription || "Nessuna descrizione trovata.";
    const card  = data.mini_card || data.scheda || null;

    if (wrapEl && card) {
      if (descEl) descEl.textContent = "";
      renderMiniCardInto(
        wrapEl,
        vino.nome + (vino.annata ? ` (${vino.annata})` : ""),
        card,
        currentLang
      );
    } else {
      if (descEl) descEl.textContent = descr;
    }

    // üîÅ se siamo in IT, dopo aver mostrato la descrizione
    // chiedo in background la preparazione delle traduzioni
    if (isItalian) {
      fetch(TRAD_FN_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${SUPABASE_API_KEY}`
        },
        body: JSON.stringify(payload),
        keepalive: true
      }).catch(() => {});
    }
  })
  .catch(err => {
    console.error("[descrizione-vino / traduci-descrizione-vino]", err);
    if (descEl) descEl.textContent = "Errore durante il recupero della descrizione.";
  });

}

function setupFilterUI() {
  const btn = document.getElementById("bottleBtn");
  const menu = document.getElementById("filterMenu");
  const optionsContainer = document.getElementById("filterOptions");
  const t = translations[currentLang] || translations.it;  // ‚Üê AGGIUNGI QUESTA RIGA

// Trova i formati disponibili nei vini
const formatsMapUI = {                    // ‚Üê solo formati "bottiglia"
  bottle:    { label: t.formatBottle || "Bottiglia", key: "prezzo" },
  quarter:   { label: "1/4 lt",       key: "prezzo_025" },
  threequart:{ label: "0,375 lt",     key: "prezzo_0375" },
  half:      { label: "1/2 lt",       key: "prezzo_05" },
  onehalf:   { label: "1,5 lt",       key: "prezzo_15" },
  three:     { label: "3 lt",         key: "prezzo_3l" }
};

const availableFormats = {};
wines.forEach(w => {
  for (const [id, f] of Object.entries(formatsMapUI)) {
    if (w[f.key]) availableFormats[id] = f;
  }
});

// Popola le checkbox (tutte NON spuntate di default)
optionsContainer.innerHTML = "";
for (const [id, f] of Object.entries(availableFormats)) {
  const label = document.createElement("label");
  label.style.display = "flex";
  label.style.alignItems = "center";
  label.style.gap = "6px";
  label.style.marginBottom = "6px";

  const cb = document.createElement("input");
  cb.type = "checkbox";
  cb.value = id;
  cb.checked = true;               // üëà default: nessun filtro
  cb.onchange = () => {
  // se l‚Äôutente tocca un formato ‚Äúbottiglia‚Äù, disattiva il bicchiere nascosto
  const hidden = document.getElementById("glassHiddenCb");
  if (hidden) hidden.checked = false;
  applyFilters();
};

  label.appendChild(cb);
  label.appendChild(document.createTextNode(f.label));
  optionsContainer.appendChild(label);
}

// ‚úÖ checkbox "glass" nascosta per il quick filter (non visibile nel menu)
let hidden = document.getElementById("glassHiddenCb");
if (!hidden) {
  hidden = document.createElement("input");
  hidden.type = "checkbox";
  hidden.value = "glass";
  hidden.id = "glassHiddenCb";
  hidden.style.display = "none";
  hidden.checked = false;
  optionsContainer.appendChild(hidden);
}

btn.onclick = () => {
  menu.style.display = (menu.style.display === "none") ? "block" : "none";
};

applyFilters();
}

// Quick-filter: mostra solo i vini al bicchiere
function quickFilterGlass() {
  const container = document.getElementById("filterOptions");
  if (!container) return;

  // deseleziona tutti i formati visibili
  container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    if (cb.id !== "glassHiddenCb") cb.checked = false;
  });

  // attiva SOLO la checkbox nascosta "glass"
  const hidden = document.getElementById("glassHiddenCb");
  if (hidden) hidden.checked = true;

  applyFilters();
  updateFormatActiveState();
  closeFilterMenu();

  // üîπ Mostra doppia riga nel banner
  const helper = document.getElementById("helperBanner");
  if (helper) {
    const mainLine = translations[currentLang].helperChooseCategory || "Scegli una categoria!";
    const subLine  = translations[currentLang].helperGlassMode || "üç∑ Stai visualizzando solo i vini al calice";
    helper.innerHTML = `${mainLine}<br><span style="color:#050505;font-weight:600;">${subLine}</span>`;
  }

  // üîπ Attiva effetto visivo sul bottone bicchiere
  const glassBtn = document.getElementById("glassBtn");
  const bottleBtn = document.getElementById("bottleBtn");
  if (glassBtn) {
    glassBtn.classList.add("active", "glass-mode");
  }
  if (bottleBtn) {
    bottleBtn.classList.remove("active", "glass-mode");
  }
}

// collega il bottone
const _afterDomGlassHook = () => {
  const glassBtn = document.getElementById("glassBtn");
  if (glassBtn) glassBtn.onclick = quickFilterGlass;
};

function refreshFilterOptionsPreservingState() {
  const optionsContainer = document.getElementById("filterOptions");
  if (!optionsContainer) return;

  // Ricorda cosa era selezionato PRIMA di ricostruire
  const prevChecked = new Set(
    Array.from(optionsContainer.querySelectorAll("input[type='checkbox']:checked"))
         .map(cb => cb.value)
  );
  const wasGlassOn = prevChecked.has('glass');

  // ---- Ricostruzione (SOLO formati bottiglia) ----
  const t = translations[currentLang] || translations.it;
  const formatsMap = {
    bottle:     { label: t.formatBottle || "Bottiglia", key: "prezzo" },
    quarter:    { label: "1/4 lt",      key: "prezzo_025" },
    threequart: { label: "0,375 lt",    key: "prezzo_0375" },
    half:       { label: "1/2 lt",      key: "prezzo_05" },
    onehalf:    { label: "1,5 lt",      key: "prezzo_15" },
    three:      { label: "3 lt",        key: "prezzo_3l" }
    // üëÜ NIENTE 'glass' qui dentro
  };

  // Limita ai formati effettivamente presenti nei vini
  const availableFormats = {};
  wines.forEach(w => {
    for (const [id, f] of Object.entries(formatsMap)) {
      if (w[f.key]) availableFormats[id] = f;
    }
  });

  optionsContainer.innerHTML = "";
  for (const [id, f] of Object.entries(availableFormats)) {
    const label = document.createElement("label");
    label.style.cssText = "display:flex;align-items:center;gap:6px;margin-bottom:6px;";

    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.value = id;
    // se avevo roba selezionata, ripristino; altrimenti default=spento
    cb.checked = prevChecked.size ? prevChecked.has(id) : false;
    cb.onchange = () => {
      // se tocco un formato bottiglia, spengo la nascosta 'glass'
      const hidden = document.getElementById("glassHiddenCb");
      if (hidden) hidden.checked = false;
      applyFilters();
    };

    label.appendChild(cb);
    label.appendChild(document.createTextNode(f.label));
    optionsContainer.appendChild(label);
  }

  // üîí ricreo SEMPRE la checkbox NASCOSTA 'glass' e ripristino lo stato precedente
  let hidden = document.createElement("input");
  hidden.type = "checkbox";
  hidden.value = "glass";
  hidden.id = "glassHiddenCb";
  hidden.style.display = "none";
  hidden.checked = wasGlassOn === true;   // se era attivo prima del cambio lingua, resta attivo
  optionsContainer.appendChild(hidden);

  updateFormatActiveState();
}

function getCheckedFormats() {
  const all = Array.from(document.querySelectorAll("#filterOptions input:checked")).map(cb => cb.value);
  // se c‚Äô√® almeno un formato bottiglia, escludi ‚Äòglass‚Äô
  const ids = all.includes('glass') && all.some(v => v !== 'glass')
    ? all.filter(v => v !== 'glass')
    : all;

  const map = {
    bottle: "prezzo",
    glass: "prezzo_bicchiere",
    quarter: "prezzo_025",
    threequart: "prezzo_0375",
    half: "prezzo_05",
    onehalf: "prezzo_15",
    three: "prezzo_3l"
  };
  return { ids, map };
}

function winesMatchFormats(list, ids, map) {
  if (!ids.length) return []; // nessun formato selezionato ‚Üí nessun vino
  return list.filter(w => ids.some(f => w[map[f]]));
}

function applyFilters() {
    // üëâ Se siamo sulla vista categorie, delega sempre a showCategories
  if (currentView === 'categories') {
    showCategories();
    updateFormatActiveState();
    return;
  }
  const { ids, map } = getCheckedFormats();
  // 1) ricava i vini che hanno almeno uno dei formati scelti
  const filteredWines = winesMatchFormats(wines, ids, map);

  // 2) capiamo dove siamo e rigeneriamo l‚ÄôUI di conseguenza
  if (currentView === 'categories') {
    // mostro solo le categorie che hanno almeno un vino valido
    const haveCats = Array.from(new Set(filteredWines.map(w => w.categoria).filter(Boolean)));
    const ordered = (categoriaOrder && categoriaOrder.length)
      ? haveCats.sort((a,b) => categoriaOrder.indexOf(normalize(a)) - categoriaOrder.indexOf(normalize(b)))
      : haveCats;
    const container = document.getElementById('category-list');
    container.innerHTML = '';
ordered.forEach(async (cat) => {
  const div = document.createElement('div');
  div.className = 'category';

  // traduzione dinamica se lingua != it
  let display = cat;
  if (currentLang !== 'it') {
    try {
      const res = await fetch("https://ldunvbftxhbtuyabgxwh.functions.supabase.co/traduci-categoria", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: cat, targetLang: currentLang })
      });
      const data = await res.json();
      display = (data.text || cat).trim();
    } catch (_) { /* fallback: cat */ }
  }
  div.textContent = display;

  div.onclick = () => showSubcategories(cat);
  container.appendChild(div);
});

  } else if (currentView === 'subcategory') {
    // solo le sottocategorie della categoria corrente che hanno un vino valido
    const list = filteredWines.filter(w => normalize(w.categoria) === normalize(currentCategory));
    const haveSub = Array.from(new Set(list.map(w => w.sottocategoria).filter(Boolean)));
    let ordered = haveSub;
    const order = Object.entries(sottocategoriaOrderMap).find(
      ([key]) => normalize(key) === normalize(currentCategory)
    )?.[1] || [];
    if (order.length) {
      ordered = haveSub.sort((a,b) => order.indexOf(normalize(a)) - order.indexOf(normalize(b)));
    }
    const container = document.getElementById('subcategory-list');
    container.innerHTML = '';
      // üëâ Se i filtri azzerano le sottocategorie visibili, mostra direttamente i vini della categoria
  if (ordered.length === 0) {
    showWinesForCategory(currentCategory);
    return;
  }
    ordered.forEach(sub => {
      const div = document.createElement('div');
      div.className = 'subcategory';
      div.textContent = sub.charAt(0).toUpperCase() + sub.slice(1).toLowerCase();
      div.onclick = () => showWinesBySubcategory(sub);
      container.appendChild(div);
    });
} else if (currentView === 'wines') {
  const wineList = document.getElementById("wine-list");
  if (!wineList) return;

  wineList.innerHTML = "";

  // Se ho una sottocategoria attiva ‚Üí comportamento attuale
  if (window.currentSubcategory) {
    const inSub = wines.filter(w =>
      normalize(w.categoria) === normalize(currentCategory) &&
      normalize(w.sottocategoria) === normalize(window.currentSubcategory)
    );
    const filtered = winesMatchFormats(inSub, ids, map);
    filtered.forEach(w => {
      const card = document.createElement("div");
      card.className = "wine-card";
      const annata = w.annata ? ` (${w.annata})` : "";
      const nomePulito = (w.nome || "").trim();
      const t = translations[currentLang];
      card.innerHTML = `
        <strong>${nomePulito}${annata}</strong>
        ${buildPriceHTML(w)}
        ${w.uvaggio ? `<small>${t.grape}: ${w.uvaggio}</small>` : ""}`;
      card.onclick = () => mostraPopupDescrizione(w);
      wineList.appendChild(card);
    });
  } else {
    // ‚úÖ Nessuna sottocategoria attiva ‚Üí filtra solo per categoria
    const inCat = wines.filter(w =>
      normalize(w.categoria) === normalize(currentCategory)
    );
    const filtered = winesMatchFormats(inCat, ids, map);
    filtered.forEach(w => {
      const card = document.createElement("div");
      card.className = "wine-card";
      const annata = w.annata ? ` (${w.annata})` : "";
      const nomePulito = (w.nome || "").trim();
      const t = translations[currentLang];
      card.innerHTML = `
        <strong>${nomePulito}${annata}</strong>
        ${buildPriceHTML(w)}
        ${w.uvaggio ? `<small>${t.grape}: ${w.uvaggio}</small>` : ""}`;
      card.onclick = () => mostraPopupDescrizione(w);
      wineList.appendChild(card);
    });
  }
}
updateFormatActiveState()
}

function updateFormatActiveState(){
  const bottleBtn = document.getElementById('bottleBtn');
  const glassBtn  = document.getElementById('glassBtn');
  bottleBtn?.classList.remove('active', 'glass-mode');
  glassBtn?.classList.remove('active', 'glass-mode');

  const checks = document.querySelectorAll('#filterOptions input[type="checkbox"]');
  const checked = Array.from(checks).filter(cb => cb.checked).map(cb => cb.value);

  if (checked.length === 1 && checked[0] === 'glass') {
    glassBtn?.classList.add('active', 'glass-mode');
  } else if (checked.length > 0) {
    bottleBtn?.classList.add('active');
  }

  // banner sempre coerente con la vista corrente,
  // ma aggiunge sotto la riga "al calice" se glass √® attivo
  setHelperByKey('helperChooseCategory');
}


function closeFilterMenu(){ 
  const m = document.getElementById('filterMenu');
  if (m) m.style.display = 'none';
}

document.addEventListener('click', (e) => {
  const menu = document.getElementById('filterMenu');
  const btn  = document.getElementById('bottleBtn');
  if (!menu || !btn) return;

  if (
    menu.style.display === 'block' &&
    !menu.contains(e.target) &&
    e.target !== btn &&
    !btn.contains(e.target)
  ) {
    menu.style.display = 'none';
  }
});

let lastSearchQuery = "";
let searchResults = [];

// apre/chiude il popover come fai per il filtro categorie
window.openSearch = function() {
  const pop = document.getElementById('searchPopover');
  const input = document.getElementById('searchInput');
  if (!pop || !input) return;

  const isOpen = pop.style.display === 'block';
  pop.style.display = isOpen ? 'none' : 'block';

  if (!isOpen) {
    // posiziona sopra al bottone (se serve ricalcolo dinamico)
    const wrapper = document.getElementById('searchBtnWrapper');
    if (wrapper) {
      const r = wrapper.getBoundingClientRect();
      pop.style.position = 'fixed';
      pop.style.left = '16px';            // ancorato a sinistra come il FAB
      pop.style.bottom = '78px';          // 52px bottone + ~10/12px gap
    }
    setTimeout(() => input.focus(), 40);
  }
};

window.closeSearch = function() {
  const pop = document.getElementById('searchPopover');
  if (pop) pop.style.display = 'none';
};

window.handleSearchKey = function(e){
  if (e.key === 'Enter') {
    e.preventDefault();
    runSearch();
  }
};

window.runSearch = function(){
  const el = document.getElementById('searchInput');
  const q = (el?.value || "").trim();
  lastSearchQuery = q;
  closeSearch();
  showSearchResults(q);
};

// chiudi se clicchi fuori dal popover e fuori dal bottone
document.addEventListener('click', function(ev){
  const pop = document.getElementById('searchPopover');
  const btn = document.getElementById('searchBtn');
  if (!pop || !btn) return;
  const clickInside = pop.contains(ev.target) || btn.contains(ev.target);
  if (pop.style.display === 'block' && !clickInside) pop.style.display = 'none';
});

window.showSearchResults = function(query){
  currentView = 'search';
  const t = translations[currentLang];
  const wineList = document.getElementById('wine-list');
  const sub = document.getElementById('subcategory-list');
  const cat = document.getElementById('category-list');
  if (cat) cat.style.display = 'none';
  if (sub) sub.style.display = 'none';
  if (wineList) wineList.style.display = 'block';

  const norm = s => (s||"").toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu,"").trim();
  const nq = norm(query);

  searchResults = wines.filter(w => nq && [
    w.nome, w.uvaggio, w.note, w.sottocategoria, w.categoria, w.denominazione
  ].some(f => norm(f).includes(nq)));

  wineList.innerHTML = "";
if (!searchResults.length){
  wineList.innerHTML = `
    <div class="wine-card" style="text-align:center; font-style:italic; opacity:0.8;">
      ${t?.noSearchResult || "Nessun vino per questa ricerca."}
    </div>`;
  return;
}

  searchResults.forEach(w => {
    const card = document.createElement('div');
    card.className = 'wine-card';
    const annata = w.annata ? ` (${w.annata})` : '';
    const nomePulito = (w.nome || "").trim();
    card.innerHTML = `
      <strong>${nomePulito}${annata}</strong>
      ${buildPriceHTML(w)}
      ${w.uvaggio ? `<small>${translations[currentLang].grape}: ${w.uvaggio}</small>` : ""}
      <div style="margin-top:6px; font-size:.85em; opacity:.8;">
        <em>${(w.categoria||"").trim()}${w.sottocategoria ? " ‚Ä¢ " + w.sottocategoria : ""}</em>
      </div>`;
    card.onclick = () => mostraPopupDescrizione(w);
    wineList.appendChild(card);
  });

  // re-applica palette alla UI appena generata
applyPalette(window.ristorantePalette);
nudgeSommelier("entered_wine_list");

  setHelper(`Risultati per: ‚Äú${query}‚Äù`);
  history.pushState({ view:"search", query }, "");
};

// se cambi lingua mentre sei in cerca, rigenera i risultati
const _origChangeLang = window.changeLanguage;
window.changeLanguage = function(){
  _origChangeLang();
  if (currentView === 'search' && lastSearchQuery) showSearchResults(lastSearchQuery);
};

// supporta back/forward del browser
window.addEventListener('popstate', (ev) => {
  if (ev.state?.view === 'search') showSearchResults(ev.state.query || "");
});

const rn = document.getElementById('restaurantName');
if (rn) {
  rn.addEventListener('click', () => {
    closeFilterMenu();
    // reset view ‚Üí categorie
    currentCategory = null;
    window.currentSubcategory = null;
    setHelper(translations[currentLang].helperChooseCategory);
    goToCategories(); // esiste gi√† e viene usata anche dal back (:contentReference[oaicite:6]{index=6})
    if (!window._manualNavigation) {
      history.pushState({ view: "categories" }, "");
    }
  });
}

</script>
<!-- Bottom bar -->
<div id="bottomBar">
  <button id="searchBtn" class="bottom-btn" aria-label="Cerca" onclick="openSearch()" style="justify-self:start">
    <img src="iconsearch.png" alt="" aria-hidden="true">
    <span class="translate-label" data-key="search">Cerca</span>
  </button>

  <button id="homeBtn" class="bottom-btn" aria-label="Home" onclick="goToCategories()" style="justify-self:center">
    <img src="iconmenu.png" alt="" aria-hidden="true">
    <span>Home</span>
  </button>

  <!-- GRUPPO FORMATI A DESTRA -->
  <div id="formatBtnGroup" style="justify-self:end; display:flex; gap:6px;">
    <button id="bottleBtn" class="bottom-btn" aria-label="Bottiglia">
      <img src="bottleiconwhite.png" alt="Bottiglia" aria-hidden="true">
    </button>
    <button id="glassBtn" class="bottom-btn" aria-label="Bicchiere">
      <img src="glassiconwhite.png" alt="Bicchiere" aria-hidden="true">
    </button>
  </div>
</div>

<!-- Popover di ricerca sopra al FAB (chiuso di default) -->
<div id="searchPopover" style="display:none; position:fixed; left:16px; bottom:78px; z-index:2000; border:1px solid #ccc; border-radius:12px; padding:10px; background:#fff; box-shadow:0 4px 12px rgba(0,0,0,.2); min-width:240px;">
  <div style="display:flex; gap:8px;">
    <input id="searchInput" type="text" placeholder="Cerca nome, uvaggio, note‚Ä¶" 
           onkeydown="handleSearchKey(event)"
           style="flex:1; padding:8px 10px; border:1px solid #ccc; border-radius:8px; font-size:0.95em;">
    <button class="save-btn translate-label" data-key="searchButton" onclick="runSearch()">Cerca</button>
  </div>
</div>

<div id="filterMenu" style="display:none; position:fixed; bottom:70px; right:16px; background:#fff; border:1px solid #ccc; border-radius:12px; padding:12px; box-shadow:0 4px 12px rgba(0,0,0,0.2); z-index:2000; min-width:200px;">
  <strong class="translate-text" data-key="filterBy">Filtra per:</strong>
  <div id="filterOptions"></div>
</div>
</body>
</html>
