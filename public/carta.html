<!DOCTYPE html>
<html lang="it">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display&family=Raleway&family=Dancing+Script&family=Montserrat&family=Roboto&family=Edu+NSW+ACT+Hand+Pre&family=Lavishly+Yours&family=Kolker+Brush&family=Pacifico&family=Indie+Flower&family=Cormorant+Garamond&family=Great+Vibes&family=Bebas+Neue&family=Merriweather&family=Abril+Fatface&family=Lobster&family=Oswald&family=Amatic+SC&family=Bitter&family=Quicksand&display=swap" rel="stylesheet">
<title>Carta dei Vini</title>
<style id="dynamic-style">
/* =========================
   VARIABILI BASE
========================= */
:root{
  --accent-color: #b00;
  --bg-default: #fff9f4;
  --bottom-bar-height: 56px;
  --sommelier-side-gap: 12px;         /* margine ai lati */
  --sommelier-height:   64px;         /* leggermente > della bottom bar (56px) */
  --safe-bottom-gap: 24px; /* margine extra per ombre/animazioni */
}

/* =========================
   ELEMENTI COMUNI
========================= */
body{
  font-family: sans-serif;
  background: var(--bg-default);
  color:#333;
  margin:0;
  padding-top:60px;
}

button, .save-btn{ background-color: var(--accent-color); }

#restaurantName{ cursor:pointer; margin:0 auto; display:flex; align-items:center; justify-content:center; gap:10px; font-size:1.2em; line-height:1.2; text-align:center; white-space:normal; }
#restaurantName span{ display:block; line-height:1.2; }
#restaurantLogo{ display:block; max-height:120px; object-fit:contain; border-radius:6px; }

/* Helper banner */
.helper-banner{ position:relative; z-index:900; margin:14px 16px; padding:0; font-weight:600; text-align:center; border:0; box-shadow:none; background:transparent; color:inherit; }
:root .helper-banner{ background: var(--bg-default); border-color:#ddd; color:#333; }
@media (max-width:480px){ .helper-banner{ margin:10px; font-size:.95em; } }

/* =========================
   NAVBAR
========================= */
nav{
  position:fixed; top:0; left:0; right:0;
  background:#fff; display:flex; justify-content:space-between; align-items:center;
  padding:.5em 1em; border-bottom:1px solid #ddd; z-index:1000; min-height:60px;
}
nav button{ background:none; border:none; font-size:1em; cursor:pointer; color:var(--accent-color); }

/* =========================
   LISTE / CARD
========================= */
.category-list, .subcategory-list, .wine-list{padding: .5em 1em;padding-bottom: calc(var(--bottom-bar-height) + var(--sommelier-height) + var(--safe-bottom-gap));}
.category, .subcategory, .wine-card{
  background:inherit; margin-bottom:.6em; padding:1em; border:1px solid; border-radius:12px;
  box-shadow:0 2px 4px rgba(0,0,0,.1);
  transition: background-color .3s ease, color .3s ease, box-shadow .3s ease, transform .2s ease;
  cursor:pointer;
}
.category:hover, .subcategory:hover, .wine-card:hover{ transform:scale(1.02); }

.category-list{ display:grid; grid-template-columns:1fr; gap:1em; }
.subcategory-list{ display:grid; grid-template-columns: repeat(auto-fit, minmax(120px,1fr)); gap:1em; }
.subcategory{ text-align:center; }

/* Prezzi nelle card vino */
.price-row{ display:flex; align-items:center; flex-wrap:wrap; gap:12px; margin:6px 0 4px; }
.price-chip{ display:inline-flex; align-items:center; gap:6px; font-size:.95em; }
.price-chip img.icon{ width:25px; height:25px; vertical-align:middle; object-fit:contain; }
.price-chip strong{ font-weight:600; }

/* =========================
   BOTTOM BAR FISSA
========================= */
#bottomBar{
  position:fixed; left:0; right:0; bottom:0;
  height:var(--bottom-bar-height);
  background: var(--navbar-color, #222);
  display:flex; align-items:center; justify-content:space-between;
  padding:0 12px; z-index:980; box-shadow:0 -2px 8px rgba(0,0,0,.15);
}
.bottom-btn{
  flex:0 0 auto; height:40px; min-width:72px; border:none; border-radius:10px; background:transparent;
  color: var(--bottom-bar-foreground, #fff); display:flex; align-items:center; justify-content:center; gap:8px;
  font-size:.9em; font-weight:700;
}
.bottom-btn img{ width:18px; height:18px; display:block; filter: brightness(100%) contrast(100%); }

/* =========================
   BOTTONE SOMMELIER (pulito)
========================= */
/* — Posizionamento e layout */
#sommelierBtn{
  position:fixed;
  bottom: calc(var(--bottom-bar-height) + 8px); /* sopra la banda */
  left: var(--sommelier-side-gap);
  right: var(--sommelier-side-gap);
  transform: none;                     /* niente translateX */
  width: auto;                         /* occupa tutto tra left e right */
  max-width: none;                     /* niente limite */
  height: var(--sommelier-height);
  min-height: var(--sommelier-height);
  padding: 8px 16px;                   /* più snello */
  gap: 10px;
  z-index:1000;

  /* aspetto “primo screen” */
  background: linear-gradient(90deg, var(--accent-color), #e05);
  color:#fff; border:none; border-radius:999px;
  display:flex; align-items:center; gap:12px; box-sizing:border-box;
  box-shadow:0 14px 28px rgba(0,0,0,.2), 0 0 0 6px rgba(255,255,255,.35) inset;
  font-size:1rem; font-weight:700; cursor:pointer;
  transition: transform .15s ease, filter .2s ease, box-shadow .2s ease;
  white-space:normal; /* consente al testo di andare a capo dentro al bottone */
}
#sommelierBtn:hover  { transform: scale(1.01); }
#sommelierBtn:active { transform: scale(.98);  }

/* — Avatar */
#sommelierBtn img{
  width:32px; height:32px; border-radius:50%; object-fit:cover; flex:0 0 auto;
  box-shadow:0 0 0 2px rgba(255,255,255,.6);
}

/* — Testo e badge */
#sommelierBtn .somm-text{ display:flex; flex-direction:column; line-height:1.05; max-width: none;white-space: normal;flex: 1 1 auto; }
#sommelierBtn .somm-title{ font-weight:800; letter-spacing:.2px;font-size: 0.95em; }
#sommelierBtn .somm-sub{ font-size: 0.82em; opacity: .95; font-weight:600; margin-top:2px; }
#sommelierBtn .somm-badge{
  flex:0 0 auto; margin-left: auto; font-size:.75em; font-weight:800; flex: 0 0 auto;
  background:rgba(255,255,255,.18); border:1px solid rgba(255,255,255,.45);
  padding:4px 8px; border-radius:999px; text-transform:uppercase;
}

/* — Effetti */
#sommelierBtn.glow{ box-shadow:0 14px 28px rgba(0,0,0,.2), 0 0 0 6px rgba(255,255,255,.35) inset, 0 0 24px rgba(255,60,120,.35); }
@keyframes sommWiggle{
  0%,100% { transform: rotate(0deg); }
  15%     { transform: rotate(-2deg); }
  30%     { transform: rotate( 2deg); }
  45%     { transform: rotate(-1.4deg); }
  60%     { transform: rotate( 1.4deg); }
  75%     { transform: rotate(-.6deg); }
  90%     { transform: rotate( .6deg); }
}
#sommelierBtn.wiggle { animation: sommWiggle .9s ease; }
#sommelierBtn.pulse{ animation:sommPulse 1.8s ease-out infinite; }
@keyframes sommPulse{
  0%{ box-shadow:0 0 0 0 rgba(0,0,0,.22), 0 10px 24px rgba(0,0,0,.18); }
  100%{ box-shadow:0 0 0 16px rgba(0,0,0,0), 0 10px 24px rgba(0,0,0,.18); }
}

/* Tooltip */
#tooltipSommelier{
  position:fixed; display:none; z-index:900; pointer-events:none;
  background:#fff; border:1px solid #ccc; border-radius:12px; padding:10px 14px;
  box-shadow:0 2px 8px rgba(0,0,0,.1); font-size:.9em; max-width:calc(100vw - 40px); text-align:center;
}
#tooltipSommelier .tip-content{ animation: tipFade 2.2s ease both; will-change: transform, opacity; }
@keyframes tipFade{ 0%{opacity:0; transform:translateY(10px);} 20%,80%{opacity:1; transform:translateY(0);} 100%{opacity:0; transform:translateY(-8px);} }

/* Popover posizionati sopra la bar */
#searchPopover{ bottom: calc(var(--bottom-bar-height) + 22px) !important; }
#filterMenu{    bottom: calc(var(--bottom-bar-height) + 14px) !important; }

/* =========================
   POPUP SOMMELIER
========================= */
#sommelierOverlay{ position:fixed; inset:0; background:rgba(0,0,0,.25); z-index:1000; display:none; justify-content:center; align-items:center; }
#sommelierPopup{
  background:#fff; border-radius:16px; padding:30px; width:90vw; max-width:500px;
  box-shadow:0 8px 24px rgba(0,0,0,.2); position:relative; animation: popupEnter .35s ease-out;
  max-height:90vh; overflow-y:auto; overscroll-behavior:contain; scrollbar-width:thin;
}
#sommelierPopup h3{ margin-top:0; }
#sommelierPopup input{
  width:100%; padding:12px; font-size:1em; border-radius:8px; border:1px solid #ccc; margin-top:10px;
}
#sommelierPopup .close-btn{ position:absolute; top:10px; left:10px; background:none; border:none; font-size:1.2em; cursor:pointer; }

/* =========================
   POPUP DESCRIZIONE VINO
========================= */
.popup-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:flex; justify-content:center; align-items:center; z-index:9999; }
.popup-descrizione{
  background:#fff; padding:20px; border-radius:16px; max-width:400px; width:90%;
  box-shadow:0 6px 16px rgba(0,0,0,.2); position:relative;
}
.popup-descrizione h3{ margin-top:0; font-size:1.2em; }
.popup-descrizione .close-btn{ position:absolute; top:10px; right:12px; font-size:1.2em; background:none; border:none; cursor:pointer; }

/* Dropdown categorie nel popup sommelier */
#wineTypeDropdown{
  position:fixed; background:#fff; border:1px solid #ccc; border-radius:8px; padding:8px 12px;
  box-shadow:0 4px 12px rgba(0,0,0,.1); z-index:3000; display:none; font-size:.95em; min-width:220px; animation: slideDown .2s ease-out;
}

/* =========================
   ANIMAZIONI GENERICHE
========================= */
.fade-in{ animation: fadeIn .4s ease forwards; opacity:0; }
.fade-out{ animation: fadeOut .3s ease forwards; opacity:1; }
.sommelier-fadein{ animation: fadeIn .5s ease both; }
.sommelier-card{ animation: fadeInUp .4s ease forwards; opacity:0; }

@keyframes slideDown{ from{opacity:0; transform:translateY(-5px);} to{opacity:1; transform:translateY(0);} }
@keyframes popupEnter{ from{opacity:0; transform:scale(.95) translateY(20px);} to{opacity:1; transform:scale(1) translateY(0);} }
@keyframes fadeIn{ to{opacity:1;} }
@keyframes fadeOut{ to{opacity:0; display:none;} }
@keyframes fadeInUp{ from{ transform:translateY(20px); opacity:0; } to{ transform:translateY(0); opacity:1; } }
@keyframes fadeSlideIn{ from{ opacity:0; transform:translateY(10px);} to{ opacity:1; transform:translateY(0);} }

/* =========================
   GLASS EFFECT (palette)
========================= */
.glass{ background:rgba(255,255,255,.3); backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px); border:1px solid rgba(255,255,255,.4); }
.glass-dark{ background:rgba(20,20,20,.3); backdrop-filter:blur(6px); border:1px solid rgba(255,255,255,.1); }

/* =========================
   SCHEDA VINO
========================= */
.vino-card{ border-radius:12px; padding:12px; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,.06); }
.vino-card h4{ margin:0 0 6px 0; font-size:1.05em; }
.vino-card p.summary{ margin:6px 0 10px; }
.vino-bars .bar{ display:grid; grid-template-columns:64px 1fr 84px; gap:8px; align-items:center; margin:6px 0; }
.vino-bars .track{ height:6px; background:#eee; border-radius:999px; position:relative; }
.vino-bars .knob{ position:absolute; top:-4px; width:14px; height:14px; border-radius:50%; background: var(--accent-color,#c41d1d); left:0; transform:translateX(-50%); }
.vino-chips{ display:flex; flex-wrap:wrap; gap:6px; margin:8px 0; }
.vino-chips span{ background:#f6f6f6; border-radius:999px; padding:6px 10px; font-size:.9em; }
.vino-chips.muted span{ background:#fafafa; color:#666; }
.vino-toggle{ margin-top:8px; font-size:.9em; border:none; background:transparent; color:var(--accent-color,#b00); cursor:pointer; }

/* — Sommelier card tweaks — */
.sommelier-card .vino-header{
  display:flex; align-items:baseline; justify-content:space-between; gap:12px; flex-wrap:wrap;
}
.sommelier-card .vino-title{ font-weight:600; font-size:1em; display:flex; align-items:center; gap:8px; }
.sommelier-card .header-right{ margin-left:auto; text-align:right; }
.sommelier-card .header-right .price-row{ margin:0; }

/* Badge colore accanto al titolo */
.badge-colore{
  font-size:.75em; font-weight:800; padding:2px 8px; border-radius:999px;
  border:1px solid var(--accent-color); color:var(--accent-color); background:transparent;
  text-transform:uppercase; letter-spacing:.3px;
}

/* Box motivazione con bordo laterale accent */
.motive-box{
  margin-top:10px; font-size:0.95em; padding:10px 12px;
  border-left:4px solid var(--accent-color);
  background:rgba(0,0,0,.03);
  border-radius:8px;
}
.motive-box strong{ margin-right:6px; }

/* =========================
   RESPONSIVE
========================= */
@media (max-width:768px){
  :root{ --sommelier-height: 68px; }
  .wine-card{ font-size:1em; padding:1em; }
  #restaurantName{ font-size:1.1em; }
}
@media (max-width:480px){
  #wineTypeDropdown{ min-width:160px; font-size:.85em; padding:6px; }
  #wineTypeDropdown label{ display:block; margin-bottom:6px; }
  #priceFilter{ font-size:.95em; }
  .wine-card{ font-size:.95em; padding:.8em; }
  #restaurantName{ font-size:1em; gap:6px; }
  #sommelierPopup{ padding:20px 16px; width:95vw; border-radius:12px; }
  .sommelier-card{ font-size:.95em; }
  .vino-header{ flex-direction:column; align-items:flex-start; }
  #sommelierPopup input{ font-size:1em; max-width:100%; box-sizing:border-box; }
  nav{ padding:.3em .6em; height:auto !important; }
  #restaurantLogo{ max-height:120px; }
  #restaurantName{ font-size:1em !important; gap:6px; flex-direction:column; }
  .category, .subcategory, .wine-card{ font-size:.95em; padding:.8em; }
}
@media (max-width: 420px){
  :root{ --sommelier-height: 60px; }
  #sommelierBtn{ padding: 8px 14px; }
  #sommelierBtn img{ width:28px; height:28px; }
  #sommelierBtn .somm-title{ font-size: 0.9em; }
  #sommelierBtn .somm-sub{   font-size: 0.78em; }
}
</style>
</head>
<body>
<nav>
  <button onclick="goBack()" style="background:none; border:none; padding:0; cursor:pointer;">
  <img src="arrowicon.png" alt="Indietro" style="width:50px; height:50px; display:block;">
</button>
  <div style="flex: 1; display: flex; justify-content: center;">
    <div id="restaurantName"><span>CARTA DEI VINI</span></div>
  </div>
    <select id="langSelector" onchange="changeLanguage()" style="margin-left: 10px; font-size: 1.5em;">
    <option value="it">🇮🇹</option>
    <option value="en">🇬🇧</option>
    <option value="fr">🇫🇷</option>
    <option value="de">🇩🇪</option>
    <option value="es">🇪🇸</option>
    <option value="zh">🇨🇳</option>
  </select>
</nav>

<div id="helperBanner" class="helper-banner" aria-live="polite">
  Scegli una categoria!
</div>

<div id="app" class="flipbook">
  <div class="category-list page" id="category-list"></div>
  <div class="subcategory-list page" id="subcategory-list"></div>
  <div class="wine-list page" id="wine-list"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script type="module">
const translations = {
  it: {
    wineList: "Carta dei Vini",
    grape: "Uvaggio",
    price: "Prezzo",
    sommelierTitle: "Il nostro sommelier ti consiglia:",
    noDescription: "Nessuna descrizione trovata.",
    filterPrice: "Filtra per prezzo",
    filterCategory: "Filtra per categoria",
    searchLabel: "Ricerca piatti per abbinamento",
    sendButton: "INVIA",
    allLabel: "Tutti",
    placeholder: "Separa piatti con le virgole.",
    loadingDescription: "Sto caricando una descrizione...",
    emptyInput: "Inserisci un piatto!",
    thinking: "Sto pensando...",
    noMatch: "Non ho trovato nessun abbinamento per questi piatti...",
    alreadyAsked: "Hai già chiesto per:",
    sommelierFooter: "Il tuo Sommelier Virtuale 🍷",
    sommelierTitleBox: "Dimmi cosa mangerai e ti suggerirò il vino perfetto!",
    sommelierTooltip: "Non sai che vino scegliere? Lascia fare al Sommelier 🍷",
    anyPrice: "Indifferente",   // it
    motive:   "Motivazione",
    sommelierBtn: "Sommelier",
    helperChooseCategory: "Scegli una categoria!",          // it
    helperClickWine: "Clicca sul vino per maggiori dettagli.", // it
    filterLabel: "Filtra",
    search:"Cerca",
    searchPlaceholder: "Cerca nome, uvaggio, note…",
    filterBy: "Filtra per:",
    searchButton: "Cerca",
    formatBottle: "Bottiglia",
    formatGlass: "Bicchiere",
    noSearchResult: "Nessun vino per questa ricerca.",
    sommelierBtnTitle: "Consiglio del Sommelier",
    sommelierBtnSub:   "Scrivi il piatto, troviamo il vino",
    sommelierBtnBadge: "Novità",
  },
  en: {
    wineList: "Wine List",
    grape: "Grape variety",
    price: "Price",
    sommelierTitle: "Our sommelier recommends:",
    noDescription: "No description available.",
    filterPrice: "Filter by price",
    filterCategory: "Filter by category",
    searchLabel: "Pairing dish search",
    sendButton: "SEND",
    allLabel: "All",
    placeholder: "Separate dishes with commas.",
    loadingDescription: "Loading a description...",
    emptyInput: "Please enter a dish!",
    thinking: "Thinking...",
    noMatch: "I couldn't find a match for these dishes...",
    alreadyAsked: "You already asked for:",
    sommelierFooter: "Your Virtual Sommelier 🍷",
    sommelierTitleBox: "Tell me what you'll eat and I'll suggest the perfect wine!",
    sommelierTooltip: "Don't know which wine to choose? Let the Sommelier decide 🍷",
    anyPrice: "Any",
    motive:   "Rationale",
    sommelierBtn: "Sommelier",
    helperChooseCategory: "Choose a category!",        
    helperClickWine: "Click a wine for details.",
    filterLabel: "Filter",
    search:"Search",
    searchPlaceholder: "Search name, grape, notes…",
    filterBy: "Filter by:",
    searchButton: "Search",
    formatBottle: "Bottle",
    formatGlass: "By the glass",
    noSearchResult: "No wines found for this search.",
    sommelierBtnTitle: "Sommelier’s Advice",
    sommelierBtnSub:   "Type the dish, we’ll find the wine",
    sommelierBtnBadge: "New",
  },
  fr: {
    wineList: "Carte des Vins",
    grape: "Cépage",
    price: "Prix",
    sommelierTitle: "Notre sommelier vous recommande :",
    noDescription: "Aucune description disponible.",
    filterPrice: "Filtrer par prix",
    filterCategory: "Filtrer par catégorie",
    searchLabel: "Recherche de plats à associer",
    sendButton: "ENVOYER",
    allLabel: "Tous",
    placeholder: "Séparez les plats avec des virgules.",
    loadingDescription: "Chargement de la description...",
    emptyInput: "Veuillez saisir un plat !",
    thinking: "Je réfléchis...",
    noMatch: "Aucun accord trouvé pour ces plats...",
    alreadyAsked: "Vous avez déjà demandé pour :",
    sommelierFooter: "Votre Sommelier Virtuel 🍷",
    sommelierTitleBox: "Dites-moi ce que vous mangez et je vous suggère le vin idéal !",
    sommelierTooltip: "Vous ne savez pas quel vin choisir ? Laissez faire le Sommelier 🍷",
    anyPrice: "Sans préférence",
    motive:   "Justification",
    sommelierBtn: "Sommelier",
    helperChooseCategory: "Choisissez une catégorie !",          // it
    helperClickWine: "Cliquez sur le vin pour plus de détails.",
    filterLabel: "Filtrer",
    search:"Chercher",
    searchPlaceholder: "Rechercher nom, cépage, notes…",
    filterBy: "Filtrer par :",
    searchButton: "Chercher",
    formatBottle: "Bouteille", formatGlass: "Au verre",
      noSearchResult: "Aucun vin trouvé pour cette recherche.",
      sommelierBtnTitle: "Conseil du Sommelier",
sommelierBtnSub:   "Écrivez le plat, nous trouvons le vin",
sommelierBtnBadge: "Nouveauté",
  },
  de: {
    wineList: "Weinkarte",
    grape: "Rebsorte",
    price: "Preis",
    sommelierTitle: "Unser Sommelier empfiehlt:",
    noDescription: "Keine Beschreibung verfügbar.",
    filterPrice: "Nach Preis filtern",
    filterCategory: "Nach Kategorie filtern",
    searchLabel: "Gerichte zum Kombinieren suchen",
    sendButton: "SENDEN",
    allLabel: "Alle",
    placeholder: "Trenne Gerichte mit Kommas.",
    loadingDescription: "Beschreibung wird geladen...",
    emptyInput: "Bitte ein Gericht eingeben!",
    thinking: "Ich denke nach...",
    noMatch: "Keine passende Empfehlung gefunden...",
    alreadyAsked: "Du hast bereits gefragt nach:",
    sommelierFooter: "Dein virtueller Sommelier 🍷",
    sommelierTitleBox: "Sag mir, was du isst, und ich empfehle dir den perfekten Wein!",
    sommelierTooltip: "Sie wissen nicht, welchen Wein Sie wählen sollen? Überlassen Sie es dem Sommelier 🍷",
    anyPrice: "Beliebig",
    motive:   "Begründung",
    sommelierBtn: "Sommelier",
    helperChooseCategory: "Wählen Sie eine Kategorie!",          // it
    helperClickWine: "Klicken Sie auf den Wein, um weitere Details zu erhalten.",
    filterLabel: "Filtern",
    search:"Suchen",
    searchPlaceholder: "Suche Name, Rebsorte, Notizen…",
    filterBy: "Filtern nach:",
    searchButton: "Suchen",
    formatBottle: "Flasche",   formatGlass: "Im Glas",
    noSearchResult: "Keine Weine für diese Suche gefunden.",
    sommelierBtnTitle: "Empfehlung des Sommeliers",
sommelierBtnSub:   "Schreibe das Gericht, wir finden den Wein",
sommelierBtnBadge: "Neu",
  },
  es: {
    wineList: "Carta de Vinos",
    grape: "Variedad de uva",
    price: "Precio",
    sommelierTitle: "Nuestro sumiller recomienda:",
    noDescription: "No hay descripción disponible.",
    filterPrice: "Filtrar por precio",
    filterCategory: "Filtrar por categoría",
    searchLabel: "Buscar platos para maridar",
    sendButton: "ENVIAR",
    allLabel: "Todos",
    placeholder: "Separe los platos con comas.",
    loadingDescription: "Cargando descripción...",
    emptyInput: "¡Introduce un plato!",
    thinking: "Pensando...",
    noMatch: "No encontré una combinación para esos platos...",
    alreadyAsked: "Ya preguntaste por:",
    sommelierFooter: "Tu Sumiller Virtual 🍷",
    sommelierTitleBox: "Dime qué comerás y te sugiero el vino perfecto",
    sommelierTooltip: "¿No sabes qué vino elegir? Déjaselo al Sumiller 🍷",
    anyPrice: "Cualquiera",
    motive:   "Motivación",
    sommelierBtn: "Sumiller",
    helperChooseCategory: "¡Elige una categoría!",          // it
    helperClickWine: "Haz clic en el vino para más detalles.",
    filterLabel: "Filtrar",
    search:"Buscar",
    searchPlaceholder: "Buscar nombre, uva, notas…",
    filterBy: "Filtrar por:",
    searchButton: "Buscar",
    formatBottle: "Botella",   formatGlass: "Copa",
    noSearchResult: "No se encontraron vinos para esta búsqueda.",
    sommelierBtnTitle: "Consejo del Sumiller",
sommelierBtnSub:   "Escribe el plato, encontramos el vino",
sommelierBtnBadge: "Novedad",
  },
  zh: {
    wineList: "酒单",
    grape: "葡萄品种",
    price: "价格",
    sommelierTitle: "我们的侍酒师推荐：",
    noDescription: "暂无描述。",
    filterPrice: "按价格筛选",
    filterCategory: "按类别筛选",
    searchLabel: "查找可搭配的菜品",
    sendButton: "发送",
    allLabel: "全部",
    placeholder: "用逗号分隔菜品。",
    loadingDescription: "正在加载描述...",
    emptyInput: "请输入一道菜！",
    thinking: "思考中...",
    noMatch: "未找到与这些菜品匹配的酒...",
    alreadyAsked: "你已经查询过：",
    sommelierFooter: "您的虚拟侍酒师 🍷",
    sommelierTitleBox: "告诉我你要吃什么，我会推荐最适合的酒！",
    sommelierTooltip: "不知道选哪款酒？交给侍酒师吧 🍷",
    anyPrice: "不限",
    motive:   "理由",
    sommelierBtn: "侍酒师",
    helperChooseCategory: "选择一个类别！",          
    helperClickWine: "点击葡萄酒了解更多详情。",
    filterLabel: "筛选",
    search:"搜索",
    searchPlaceholder: "搜索名称、葡萄品种、备注…",
    filterBy: "筛选条件：",
    searchButton: "搜索",
    formatBottle: "瓶",   formatGlass: "杯",
    noSearchResult: "未找到符合此搜索的葡萄酒。",
    sommelierBtnTitle: "侍酒师推荐",
sommelierBtnSub:   "输入菜品，我们来找酒",
sommelierBtnBadge: "新品",
  }
};

function setHelper(text){
  const el = document.getElementById('helperBanner');
  if (el) el.textContent = text;
}

function setHelperByKey(key){
  const t = translations[currentLang];
  if (!t || !t[key]) return;
  setHelper(t[key]);
}

async function setHelperCategoryName(category){
  let label = String(category || "");
  if (currentLang !== "it" && label) {
    try {
      const res = await fetch("https://ldunvbftxhbtuyabgxwh.functions.supabase.co/traduci-categoria", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: label, targetLang: currentLang })
      });
      const data = await res.json();
      label = (data.text || label).trim();
    } catch(e){ /* fallback: label originale */ }
  }
  setHelper(label.toUpperCase());
}

  function getContrastingTextColor(bgColor) {
  if (!bgColor) return "#000000";
  const hex = bgColor.replace("#", "");
  if (hex.length !== 6) return "#000000"; // fallback per codici non validi
  const r = parseInt(hex.substring(0, 2), 16);
  const g = parseInt(hex.substring(2, 4), 16);
  const b = parseInt(hex.substring(4, 6), 16);
  const brightness = (r * 299 + g * 587 + b * 114) / 1000;
  return brightness > 150 ? "#000000" : "#ffffff";
}

const SUPABASE_URL = "https://ldunvbftxhbtuyabgxwh.supabase.co";
const SUPABASE_API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkdW52YmZ0eGhidHV5YWJneHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0NTMyOTYsImV4cCI6MjA2MjAyOTI5Nn0.0hjJASFktfHZHjVQzX9bq8xGBrf7o1Fya6lqnA2tvPo";
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(SUPABASE_URL, SUPABASE_API_KEY);
// 🔴 Disattiva/attiva la descrizione vino dalla UI
const DESCRIZIONE_VINO_ABILITATA = false; // ← metti true per riattivare

// --- URL parsing: supporta sia ?slug=... sia /:slug e /:slug.cartadeivini ---
const urlParams = new URLSearchParams(window.location.search);
let RESTAURANT_ID = urlParams.get("ristorante_id");
let slug = urlParams.get("slug");

// Se la pagina è stata aperta come /mioslug o /mioslug.cartadeivini, estraggo lo slug dal path
if (!slug) {
  const path = location.pathname.replace(/^\//, ''); // toglie lo slash iniziale
  if (path && !/\.html$/i.test(path)) {
    // rimuove l'eventuale .cartadeivini
    slug = path.replace(/\.cartadeivini$/i, '');
  }
}

if (slug) {
  const { data: r, error } = await supabase
    .from('ristoranti')
    .select('id, slug')
    .eq('slug', slug)
    .single();

  if (r?.id) {
    RESTAURANT_ID = r.id;

    // Mantieni l'URL "bello" in barra (niente query string)
    const pretty = `/${r.slug}${/\.cartadeivini$/i.test(location.pathname) ? '.cartadeivini' : ''}`;
    if (location.pathname !== pretty) history.replaceState({}, '', pretty);
  } else {
    console.warn('Slug non trovato, uso eventuale query string o utente loggato.');
  }
}

// Fallback: se ancora non ho l'ID, provo con l'utente loggato (solo in area riservata)
if (!RESTAURANT_ID) {
  const { data: { user } } = await supabase.auth.getUser();
  if (user) RESTAURANT_ID = user.id;
}

// Disabilita sommelier nella demo
if (RESTAURANT_ID === "fc28c874-b195-4660-9c78-c58d8dc3c092") {
  window.suggestWine = () => {
    const suggestion = document.getElementById('wineSuggestion');
    if (suggestion) {
      suggestion.innerHTML = `
        <div style="background:#fff3f0; padding:15px; border-radius:12px; border:1px solid #ddd; color:#b00; font-weight:bold;">
          Funzione disabilitata per la demo.
        </div>`;
    }
  };
}

let wines = [];
let ristorante = null;
let ristoranteSommelierURL = null;
let currentCategory = '';
let currentView = 'categories';
let sommelierAperto = false;
let currentLang = "it"; // default

window.paletteColors = {
  background: null,
  cardBackground: null,
  borderColor: null,
  textColor: null,
  boxShadow: null
};

function changeLanguage() {
  const langSelector = document.getElementById("langSelector");
  currentLang = langSelector.value;

  // fallback sicuro
  if (!translations[currentLang]) {
    currentLang = "en";
    langSelector.value = "en";
  }

  applyTranslations();
  refreshFilterOptionsPreservingState();
// aggiorna solo la vista corrente
if (currentView === 'categories') {
  applyFilters();                       // ricostruisce categorie coi filtri attivi
} else if (currentView === 'subcategory') {
  showSubcategories(currentCategory);   // ricostruisce le sottocategorie correnti
} else if (currentView === 'wines') {
  showWinesBySubcategory(window.currentSubcategory); // ricostruisce i vini correnti
}

// sommelier UI come già fai
if (window.showSommelier === true) {
  setupSommelierUI();
} else {
  document.getElementById("sommelierBtn")?.remove();
  document.getElementById("tooltipSommelier")?.remove();
}
}
  window.changeLanguage = changeLanguage;

function applyTranslations() {
  const t = translations[currentLang];

  const foodInput = document.getElementById("foodInput");
if (foodInput && translations[currentLang].placeholder) {
  foodInput.placeholder = translations[currentLang].placeholder;
}

  // cambia titolo principale
  const titleEl = document.querySelector("#restaurantName span");
  if (titleEl) titleEl.textContent = t.wineList;

  // aggiorna descrizione popup (se presente)
  const descrEl = document.getElementById("descrizioneTesto");
  if (descrEl && descrEl.textContent.includes("Nessuna descrizione")) {
    descrEl.textContent = t.noDescription;
  }

  document.querySelectorAll('.wine-card').forEach(card => {
  const text = card.innerHTML;
  const match = text.match(/<small>.*?: (.*?)<\/small>/);
  const grapeValue = match?.[1] || "";

  const t = translations[currentLang];
  card.innerHTML = text.replace(/<small>.*?: .*?<\/small>/, `<small>${t.grape}: ${grapeValue}</small>`);
});
// Etichette translate-label
document.querySelectorAll(".translate-label").forEach(el => {
  const key = el.dataset.key;
  if (translations[currentLang][key]) {
    el.textContent = translations[currentLang][key];
  }
});

// Pulsante invia
const sendBtn = document.getElementById("sendFoodBtn");
if (sendBtn && translations[currentLang].sendButton) {
  sendBtn.textContent = translations[currentLang].sendButton;
}
const tooltip = document.getElementById("tooltipSommelier");
if (tooltip && translations[currentLang].sommelierTooltip) {
  const inner = tooltip.querySelector(".tip-content") || tooltip;
  inner.textContent = translations[currentLang].sommelierTooltip;
}

const priceAnyOpt = document.querySelector('#priceFilter option[value=""]');
if (priceAnyOpt) priceAnyOpt.textContent = t.anyPrice;

// aggiorna testo del bottone sommelier
const sBtn = document.getElementById("sommelierBtn");
if (sBtn) {
  const lbl = sBtn.querySelector(".label");
  if (lbl) lbl.textContent = translations[currentLang].sommelierBtn;
  sBtn.setAttribute("aria-label", translations[currentLang].sommelierBtn);
}

// 1) placeholder dell'input di ricerca (popover)
const si = document.getElementById("searchInput");
if (si && t.searchPlaceholder) {
  si.placeholder = t.searchPlaceholder;
}

// 2) titolo del menu filtro ("Filtra per:")
const filterTitle = document.querySelector('#filterMenu .translate-text[data-key="filterBy"]');
if (filterTitle && t.filterBy) {
  filterTitle.textContent = t.filterBy;
}

// 3) bottone "Cerca" dentro al popover
const searchBtnInside = document.querySelector('#searchPopover button.save-btn.translate-label[data-key="searchButton"]');
if (searchBtnInside && t.searchButton) {
  searchBtnInside.textContent = t.searchButton;
}
}

function aggiornaAltezzaNavbar() {
  const nav = document.querySelector("nav");
  const nameBlock = document.getElementById("restaurantName");
  if (!nav || !nameBlock) return;

  const rect = nameBlock.getBoundingClientRect();
  const height = rect.height + 20;      // altezza effettiva navbar

  nav.style.minHeight = height + "px";
  document.body.style.paddingTop = height + "px";  // sposta tutta la pagina sotto la navbar

  // ❌ rimuovi il codice che faceva paddingTop sulle liste
}
window.addEventListener('resize', aggiornaAltezzaNavbar);

window.addEventListener("message", (event) => {
  if (event.data?.action === "updateNameLive" || event.data?.action === "updateLogoLive") {
    setTimeout(() => aggiornaAltezzaNavbar(), 30);
  }
});
function toggleSommelier() {
  const overlay = document.getElementById('sommelierOverlay');
    overlay.classList.remove("fade-out");
    overlay.classList.add("fade-in");
    overlay.style.display = 'flex';

  const popup = document.getElementById("sommelierPopup");
  const palette = window.ristorantePalette;
    if (popup) {
popup.style.boxShadow = palette && window.paletteColors?.boxShadow || "0 2px 6px rgba(0,0,0,0.15)";
}

const input = document.getElementById("foodInput");
if (input) {
  input.style.backgroundColor = "#ffffff"; // sempre bianco
  input.style.color = "#000000"; // sempre nero
}

  const inputEl = document.getElementById('foodInput');
if (inputEl) inputEl.focus();
  history.pushState({ sommelier: true }, '', '#sommelier');
  sommelierAperto = true;
  document.getElementById('tooltipSommelier')?.style.setProperty('display','none','important');
}

function closeSommelierPopup() {
const overlay = document.getElementById('sommelierOverlay');
if (overlay) {
  overlay.classList.remove("fade-in");
  overlay.classList.add("fade-out");
  setTimeout(() => {
    overlay.style.display = "none";
  }, 300);
}
const foodInput = document.getElementById('foodInput');
if (foodInput) foodInput.value = '';
const wineSuggestion = document.getElementById('wineSuggestion');
if (wineSuggestion) wineSuggestion.innerHTML = '';

  // Puliamo l’URL (togliamo #sommelier) e azzeriamo lo stato
  if (location.hash === "#sommelier") {
    history.replaceState({}, '', location.pathname); // resetta l’URL
  }
}

window.handleSommelierKey = function (e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    suggestWine();
    const input = document.getElementById('foodInput');
if (input) input.blur();
  }
}

function flipToPage(fromId, toId) {
const from = document.getElementById(fromId);
const to = document.getElementById(toId);

if (from && to) {
  from.classList.remove("flip-out");
  from.classList.add("flip-in");
  to.classList.remove("flip-in");
  to.classList.add("flip-out");
  setTimeout(() => {
    from.style.display = 'none';
    to.style.display = 'block';
  }, 600);
}
}

function colorLabelFromWine(w){
  if (!w) return null;
  const s = (String(w.categoria||"") + " " + String(w.sottocategoria||"") + " " + String(w.uvaggio||"")).toLowerCase();
  if (/\brosat|ros[eè]|\bramato\b/.test(s)) return "Rosato";
  if (/\bbianc|white|blanc\b/.test(s))      return "Bianco";
  if (/\bross|red|rouge\b/.test(s))         return "Rosso";
  return null;
}

window.suggestWine = async function () {
    if (RESTAURANT_ID === "fc28c874-b195-4660-9c78-c58d8dc3c092") {
    const suggestion = document.getElementById('wineSuggestion');
    if (suggestion) {
      suggestion.innerHTML = `
        <div style="background:#fff3f0; padding:15px; border-radius:12px; border:1px solid #ddd; color:#b00; font-weight:bold;">
          Funzione disabilitata per la demo.
        </div>`;
    }
    return; // 🔒 blocca esecuzione
  }

  const paroleBloccate = [
    "come ti chiami", "come stai", "ciao", "chi sei", "sei reale", "sei umano",
    "parolacce", "cazzo", "merda", "stronzo", "scemo", "stupido", "ubriaco",
    "sposato", "fidanzato", "intelligenza", "chi ha vinto", "quanto costi", "gpt"
  ];
  const input = document.getElementById('foodInput').value.trim();
  const suggestion = document.getElementById('wineSuggestion');
  const inputLower = input.toLowerCase();
  const contieneOffensivo = paroleBloccate.some(p => inputLower.includes(p));

  if (contieneOffensivo) {
    suggestion.innerHTML = `
      <div style="background:#fff3f0; padding:15px; border-radius:12px; border:1px solid #ddd; color:#333; font-style:italic;">
        Per favore scrivimi il nome di un piatto, così posso consigliarti il vino perfetto! 🍷
      </div>`;
    return;
  }

  if (!input) {
    suggestion.innerHTML = translations[currentLang].emptyInput;
    return;
  }

  suggestion.innerHTML = translations[currentLang].thinking;

try {
  const priceLimit = document.getElementById("priceFilter").value;
  const wineColorChecks = document.querySelectorAll("#wineTypeDropdown input[type='checkbox']");
  const wineColors = Array.from(wineColorChecks).filter(cb => cb.checked).map(cb => cb.value);

  const response = await fetch("https://ldunvbftxhbtuyabgxwh.functions.supabase.co/consiglia-vino", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      vini: wines,
      piatto: input,
      ristorante_id: RESTAURANT_ID,
      prezzo_massimo: priceLimit ? parseInt(priceLimit) : null,
      colori: wineColors,
      lang: (currentLang === "gb" ? "en" : currentLang)  // << invia sempre en, non gb
    })
  });


    const data = await response.json();
    const reply = data.suggestion || "";
    const rawBlocks = reply.split(/^- /m).map(b => b.trim()).filter(Boolean);

const popupBg      = window.paletteColors?.background    || "#ffffff";
const responseBg   = window.paletteColors?.cardBackground || "#ffffff";
const vignetteColor= window.paletteColors?.borderColor    || "#cccccc";
const textColor    = window.paletteColors?.textColor      || "#000000";
const vignetteTextColor = textColor;
const shadow       = window.paletteColors?.boxShadow      || "0 2px 6px rgba(0,0,0,0.15)";
const prezzoColor = getContrastingTextColor(responseBg);

let cardsHtml = rawBlocks.map(block => {
  const lines = block.split(/\n/).map(l => l.trim()).filter(Boolean);
  const titleLine = lines[0] || "";
const uvRiga = lines[1] || "";
const motRiga = lines.slice(2).join(" ");

const uvVal = stripLabelPrefix(uvRiga, [
  "uvaggio","grape","grape variety","cepages","cépages","variedad de uva","rebsorte","uva","葡萄品种"
]);

const motVal = stripLabelPrefix(motRiga, [
  "motivazione","rationale","justification","begrundung","begründung","motivacion","motivación","理由"
]);

  // prendo SOLO il nome del vino dalla prima riga (ignoro eventuale €... scritto dall'AI)
  // 1) prendo solo la parte prima di eventuali prezzi
const rawTitle   = (titleLine.split(/€|EUR|CHF|\$|£|¥/)[0] || "");

// 2) tolgo eventuali "-"/"•" iniziali
const noBullet   = rawTitle.replace(/^[\s\-•]+/u, "");

// 3) 🔑 tolgo TUTTO ciò che non è lettera/numero all'inizio (emoji, pollici, pallini, ecc.)
const nomeVino   = noBullet.replace(/^[^\p{L}\p{N}]+/u, "").trim();
// Estrai le emoji iniziali per usarle, se vuoi, come badge separati (non nel titolo)
const prefixEmojis = (rawTitle.match(/^[^\p{L}\p{N}]+/u)?.[0] || "").trim();
  if (!nomeVino) return '';

  // cerco lo stesso vino nella carta per recuperare TUTTI i prezzi
  const norm = s => (s || "").toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu, "").trim();
  let wFound = wines.find(w => norm(w.nome) === norm(nomeVino));
  if (!wFound) {
    // fallback "soft": include/è incluso
    wFound = wines.find(w => norm(w.nome).includes(norm(nomeVino)) || norm(nomeVino).includes(norm(w.nome)));
  }

  // compongo la riga prezzi: se non trovo il vino, faccio almeno la bottiglia letta dalla riga
  let prezziHtml = "";
  if (wFound) {
    prezziHtml = buildPriceHTML(wFound);
  } else {
    const prezzoGrezz = (titleLine.match(/€\s*\d[\d.,]*/) || [])[0];
    if (prezzoGrezz) {
      prezziHtml = `
        <div class="price-row">
          <span class="price-chip">
            <img class="icon" src="bottleico.png" onerror="this.onerror=null;this.src='bottleicon.png';" alt="bottiglia">
            ${prezzoGrezz}
          </span>
        </div>`;
    }
  }

  return `
  <div class="sommelier-card" style="background:${responseBg}; border:1px solid ${vignetteColor}; border-radius:12px; padding:15px; margin-bottom:10px; box-shadow:0 2px 6px rgba(0,0,0,0.06); color:${textColor};">
    <div class="vino-header">
      <div class="vino-title">
        <div>${nomeVino}</div>
        ${
          (function(){
            const lbl = colorLabelFromWine(wFound);
            return lbl ? `<span class="badge-colore">${lbl}</span>` : "";
          })()
        }
      </div>
      <div class="header-right">
        ${prezziHtml || ""}
      </div>
    </div>

    ${uvVal ? `<div style="font-size:0.9em; color:#666; margin-top:6px;">${translations[currentLang].grape}: ${uvVal}</div>` : ""}

    ${
      motVal
        ? `<div class="motive-box"><strong>${translations[currentLang].motive}:</strong> ${motVal}</div>`
        : ""
    }
  </div>`;
}).join('');


    if (!cardsHtml || cardsHtml.trim() === "") {
      suggestion.innerHTML = `
        <div style="background:${responseBg}; padding:15px; border-radius:12px; border:1px solid ${vignetteColor}; color: ${textColor}; font-style:italic;">${translations[currentLang].noMatch}</div>`;
      return;
    }

    aggiornaStorico(input);
    const storico = mostraStoricoNelSommelier();

suggestion.innerHTML = `
  <div class="sommelier-fadein" style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 20px;">
    <img id="sommelierAvatar"
        src="${ristoranteSommelierURL || 'sommelier.png'}"
        alt="Sommelier"
        style="width:64px; height:64px; border-radius:50%; object-fit:cover; box-shadow:0 0 6px rgba(0,0,0,0.1);">

    <div style="position: relative; background: ${responseBg}; border: 1px solid ${vignetteColor}; border-radius:16px; padding:16px 18px; max-width:80%; box-shadow: ${shadow}; color: ${textColor};">
      <div style="position: absolute; top: 20px; left: -10px; width: 0; height: 0; border-top: 10px solid transparent; border-bottom: 10px solid transparent; border-right: 10px solid ${vignetteColor};"></div>
      <strong style="color:${vignetteTextColor}; font-size: 1em;">${translations[currentLang].sommelierTitle}</strong>
      <div style="margin-top: 8px;">${cardsHtml}</div>
      ${storico}
      <div style="text-align:right; font-size:0.85em; color:${vignetteTextColor}; margin-top:8px;">${translations[currentLang].sommelierFooter}</div>
    </div>
  </div>
`;

  } catch (err) {
    console.error(err);
    suggestion.innerHTML = "Errore nel generare il suggerimento.";
  }
}

function stripLabelPrefix(line, labels) {
  if (!line) return "";
  const raw  = String(line).trim();
  const norm = raw.normalize("NFD").replace(/\p{Diacritic}/gu, "").toLowerCase();
  for (const lab of labels) {
    if (norm.startsWith(lab)) {
      return raw.replace(/^.*?[:：-]\s*/, ""); // rimuove "LABEL: "
    }
  }
  return raw;
}

window.addEventListener('click', e => {
  const overlay = document.getElementById('sommelierOverlay');
  if (e.target === overlay) closeSommelierPopup();
});

window.addEventListener('popstate', (event) => {
  if (event.state?.sommelier || sommelierAperto) {
    closeSommelierPopup();
    sommelierAperto = false;
  }
});

async function loadRestaurantData() {
const res = await fetch(`${SUPABASE_URL}/rest/v1/ristoranti?select=subscription_plan,sommelier_attivo,nome,font,palette_color,logo_url,logo_size,sommelier_url,sommelier_range,sommelier_boost_multi,name_size,name_color,name_bold,name_font,ordine_vini,ordine_categorie,ordine_sottocategorie,sommelier_gender&id=eq.${RESTAURANT_ID}`, {
  headers: { 'apikey': SUPABASE_API_KEY, 'Accept': 'application/json' }
});
const data = await res.json();
if (!Array.isArray(data) || data.length === 0) {
  console.error("Ristorante non trovato");
  return;
}
ristorante = data[0];
  const gender = ristorante?.sommelier_gender || "uomo";
ristoranteSommelierURL = ristorante.sommelier_url || (gender === "donna" ? "sommelier_femmina.png" : "sommelier.png");
// aggiorna avatar nel bottone (se già creato) e fallback
const btnImg = document.querySelector('#sommelierBtn img');
if (btnImg) {
  btnImg.src = ristoranteSommelierURL;
  btnImg.onerror = () => { btnImg.onerror = null; btnImg.src = (gender === "donna" ? "sommelier_femmina.png" : "sommelier.png"); };
}

if (ristorante.font) {
  document.body.style.fontFamily = ristorante.font;
  ensureFontLoaded(ristorante.font);
}

const avatar = document.getElementById('sommelierAvatar');
if (avatar) {
  avatar.src = ristoranteSommelierURL;
}

if (ristorante) {
  const nameElem = document.getElementById("restaurantName");
  if (!nameElem) return;

  while (nameElem.firstChild) nameElem.removeChild(nameElem.firstChild);

  if (ristorante.logo_url) {
    const img = document.createElement('img');
    img.src = ristorante.logo_url + "?t=" + new Date().getTime();
    img.alt = ristorante.nome;
    img.id = "restaurantLogo";
    img.style.setProperty("height", (ristorante.logo_size || 40) + "px", "important");
    nameElem.appendChild(img);
  } else {
    const span = document.createElement('span');
    span.textContent = ristorante.nome || 'Carta dei Vini';
    span.style.fontFamily = ristorante.name_font || 'sans-serif';
    span.style.fontSize = (ristorante.name_size || 24) + "px";
    span.style.color = ristorante.name_color || "#000000";
    span.style.fontWeight = ristorante.name_bold ? "bold" : "normal";
    ensureFontLoaded(ristorante.name_font);
    nameElem.appendChild(span);
  }
    // 🔒 Limita lingue se NON PRO
if (ristorante.subscription_plan !== "pro") {
  const langSelector = document.getElementById("langSelector");
  if (langSelector) {
    [...langSelector.options].forEach(opt => {
      if (!["it", "en"].includes(opt.value)) opt.remove(); // lascia solo 🇮🇹 e 🇬🇧
    });
  }
}
  setTimeout(() => aggiornaAltezzaNavbar(), 20);
}

window.ristorantePalette = ristorante.palette_color;

applyPalette(ristorante.palette_color);
}

window.goBack = function () {
  history.back();
}

function applyPalette(palette) {
  if (window.ristorantePalette === "custom") return;

  let primary = "#b00";
  let background = "#fff9f4";
  let cardBackground = "#ffffff";
  let borderColor = "#b00";
  let textColor = "#000000";
  let boxShadow = "0 2px 6px rgba(0, 0, 0, 0.15)"; // valore predefinito
  let navbarColor;
  
  switch (palette) {
    case "rosso":
      primary = "#b3001b";
      background = "#fff5f5";
      navbarColor = "#ffcccc";
      cardBackground = "#ffe5e5";
      borderColor = "#990014";
      textColor = "#330000";
      boxShadow = "0 2px 6px rgba(155, 28, 49, 0.2)";
      break;

    case "oro":
      primary = "#c29d2e";
      background = "#fffdf0";
      navbarColor = "#fdf2c0";
      cardBackground = "#fef6d8";
      borderColor = "#b38e2e";
      textColor = "#4a3b00";
      boxShadow = "0 2px 6px rgba(179, 142, 46, 0.25)";
      break;

    case "blu-elegante":
      primary = "#103d5e";
      background = "#f2f7fc";
      navbarColor = "#cce0f2";
      cardBackground = "#e4eff9";
      borderColor = "#0b2e4b";
      textColor = "#0b1c2d";
      boxShadow = "0 2px 6px rgba(16, 61, 94, 0.18)";
      break;

    case "verde-salvia":
      primary = "#4a715a";
      background = "#f4f9f5";
      navbarColor = "#e0f0e4";
      cardBackground = "#e5f1e8";
      borderColor = "#3a5948";
      textColor = "#273e32";
      boxShadow = "0 2px 6px rgba(74, 113, 90, 0.2)";
      break;

    case "grigio-minimal":
      primary = "#444";
      background = "#f7f7f7";
      navbarColor = "#eeeeee";
      cardBackground = "#ffffff";
      borderColor = "#cccccc";
      textColor = "#222222";
      boxShadow = "0 2px 5px rgba(100, 100, 100, 0.1)";
      break;

case "black-white":
  primary = "#1e1e1e";
  background = "#f7f7f7";
  navbarColor = "#1e1e1e";
  cardBackground = "#ffffff";
  borderColor = "#d0d0d0";
  textColor = "#111111";
  boxShadow = "0 2px 6px rgba(0,0,0,0.08)";
  break;

    case "crema-nero":
      primary = "#000000";
      background = "#fffaf0";
      navbarColor = "#fff3dd";
      cardBackground = "#ffffff";
      borderColor = "#000000";
      textColor = "#000000";
      boxShadow = "0 2px 6px rgba(0, 0, 0, 0.1)";
      break;

      case "tramonto":
      primary = "#e07b39";
      background = "#fff5ec";
      navbarColor = "#c65a1e";
      cardBackground = "#ffe3cc";
      borderColor = "#c65a1e";
      textColor = "#3e2c1b";
      boxShadow = "0 2px 6px rgba(224, 123, 57, 0.2)";
      break;

      case "notte-blu":
      primary = "#0b1c2d"; // blu scuro petrolio
      background = "#eff4f7";
      navbarColor = "#021639";        // Navbar leggermente più chiara
      cardBackground = "#d8e3ec";
      borderColor = "#06131f";
      textColor = "#0a1a28";
      boxShadow = "0 2px 6px rgba(11, 28, 45, 0.25)";
      break;

      case "vino-rosso":
      primary = "#511627"; // vinaccia
      background = "#fcf6f8";
      navbarColor = "#6e003f";        // Navbar tono più scuro
      cardBackground = "#f6e9ed";
      borderColor = "#3b101d";
      textColor = "#2c0d14";
      boxShadow = "0 2px 6px rgba(81, 22, 39, 0.25)";
      break;

      case "tortora":
      primary = "#7e7064";
      background = "#f8f5f2";
      navbarColor = "#d6ccc2";
      cardBackground = "#eeeae6";
      borderColor = "#6e6156";
      textColor = "#2e2b28";
      boxShadow = "0 2px 6px rgba(126, 112, 100, 0.15)";
      break;
  }

  // Applica colori dinamici
  document.body.style.backgroundColor = background;
  const cards = document.querySelectorAll('.category, .subcategory, .wine-card');
    cards.forEach(el => {
      el.classList.remove("glass", "glass-dark");
      el.style.backgroundColor = cardBackground;
      el.style.borderColor = borderColor;
      el.style.color = textColor;
      el.style.boxShadow = boxShadow;
    });
    
    const popup = document.getElementById("sommelierPopup");
    if (popup) {
      popup.style.backgroundColor = cardBackground;
      popup.style.borderColor = borderColor;
      popup.style.color = textColor;
      popup.style.boxShadow = boxShadow;
    }

    // Applica effetto vetro solo a palette selezionate
    if (["oro", "crema-nero"].includes(palette)) {
      cards.forEach(el => el.classList.add("glass"));
    }
    if (palette === "black-white") {
      cards.forEach(el => el.classList.add("glass-dark"));
    } 

  // Applica colore anche ai bottoni / elementi principali
  const backBtn = document.querySelector("nav button");
  if (backBtn) backBtn.style.color = primary;

const sommelierBtn = document.getElementById("sommelierBtn");
if (sommelierBtn && window.showSommelier === true) {
  sommelierBtn.style.backgroundColor = primary;
  sommelierBtn.style.borderColor = primary;
}
const nav = document.querySelector("nav");
if (nav) {
  nav.style.backgroundColor = typeof navbarColor !== "undefined" ? navbarColor : background;
}
// espone i colori a CSS
document.documentElement.style.setProperty('--navbar-color', (typeof navbarColor!=="undefined" ? navbarColor : background));
// foreground chiaro/scuro in base allo sfondo
const bb = document.getElementById("bottomBar");
if (bb) {
  const fg = getContrastingTextColor(typeof navbarColor!=="undefined" ? navbarColor : background);
  bb.style.color = fg;
  document.documentElement.style.setProperty('--bottom-bar-foreground', fg);
}

const filterBtn = document.getElementById("filterBtn");
if (filterBtn) {
  filterBtn.style.backgroundColor = primary;
  filterBtn.style.borderColor = primary;
}

const searchBtn = document.getElementById("searchBtn");
if (searchBtn) {
  searchBtn.style.backgroundColor = primary;
  searchBtn.style.borderColor = primary;
}

const searchPop = document.getElementById("searchPopover");
if (searchPop) {
  // usa i colori della palette per card/contorni/testo/ombra
  searchPop.style.backgroundColor = window.paletteColors?.cardBackground || "#fff";
  searchPop.style.borderColor     = window.paletteColors?.borderColor   || "#ccc";
  searchPop.style.color           = window.paletteColors?.textColor     || "#000";
  searchPop.style.boxShadow       = window.paletteColors?.boxShadow     || "0 2px 6px rgba(0,0,0,.15)";
  // input interno coerente
  const input = searchPop.querySelector('input');
  if (input) {
    input.style.backgroundColor = "#fff";
    input.style.color = "#000";
    input.style.borderColor = "#ccc";
  }
  const btn = searchPop.querySelector('button.save-btn');
  if (btn) {
    btn.style.backgroundColor = (document.getElementById("searchBtn")?.style.backgroundColor) || "#b00";
    btn.style.color = "#fff";
  }
}

window.paletteColors = {
  background,
  cardBackground,
  borderColor,
  textColor,
  boxShadow
};
}

function normalize(str) {
  return str ? str.toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu, "").trim() : '';
}

function goToCategories() {
  // chiudi eventuali overlay/popover
  closeFilterMenu?.();
  closeSearch?.();

  // reset contesto
  currentCategory = null;
  window.currentSubcategory = null;
  currentView = 'categories';

  // helper in alto
  setHelperByKey('helperChooseCategory');

  // ricostruisci le categorie (rispetta i filtri attivi)
  showCategories();

  // visibilità liste
  const catList = document.getElementById("category-list");
  const subcatList = document.getElementById("subcategory-list");
  const wineList = document.getElementById("wine-list");
  if (catList)   catList.style.display   = "block";
  if (subcatList) subcatList.style.display = "none";
  if (wineList)   wineList.style.display   = "none";

  // sincronizza la history (evita doppio push se già manualNavigation)
  if (!window._manualNavigation) {
    history.pushState({ view: "categories" }, "");
  }
}
window.goToCategories = goToCategories;

function buildPriceHTML(w){
  const chips = [];

  if (w.prezzo) {
    chips.push(
      `<span class="price-chip">
         <img class="icon" src="bottleico.png"
              onerror="this.onerror=null;this.src='bottleicon.png';"
              alt="bottiglia">
         ${w.prezzo}
       </span>`
    );
  }
  if (w.prezzo_bicchiere) {
    chips.push(
      `<span class="price-chip">
         <img class="icon" src="glassico.png" alt="calice">
         ${w.prezzo_bicchiere}
       </span>`
    );
  }

  const add = (label, val) => { if (val) chips.push(`<span class="price-chip"><strong>${label}</strong> ${val}</span>`); };
  add('1/4lt',   w.prezzo_025);
  add('0,375lt', w.prezzo_0375);
  add('1/2lt',   w.prezzo_05);
  add('1,5lt',   w.prezzo_15);
  add('3lt',     w.prezzo_3l);

  if (!chips.length) return '';
  return `<div class="price-row">${chips.join(' ')}</div>`;
}

function showWinesBySubcategory(subcat) {
  setHelperByKey('helperClickWine');
  currentView = 'wines';
  window.currentSubcategory = subcat;
  const wineList = document.getElementById('wine-list');
  if (wineList) wineList.style.display = 'block';
  wineList.innerHTML = '';
  const { ids, map } = getCheckedFormats();
const allInSub = wines.filter(w =>
  normalize(w.categoria) === normalize(currentCategory) &&
  normalize(w.sottocategoria) === normalize(subcat)
);
const filtered = winesMatchFormats(allInSub, ids, map);
  filtered.forEach(w => {
    const card = document.createElement('div');
card.className = 'wine-card';
const annata = w.annata ? ` (${w.annata})` : '';

const nomePulito = (w.nome || "").trim();
const t = translations[currentLang];
card.innerHTML = `
  <strong>${nomePulito}${annata}</strong>
  ${buildPriceHTML(w)}
  ${w.uvaggio ? `<small>${t.grape}: ${w.uvaggio}</small>` : ""}`;

    wineList.appendChild(card);
    card.onclick = () => {
  mostraPopupDescrizione(w); // w è il vino cliccato
};
  });
applyPalette(window.ristorantePalette);

  const subcatList = document.getElementById('subcategory-list');
  if (subcatList) subcatList.style.display = 'none';
  wineList.style.display = 'block';
  history.pushState({ view: "wines", subcategory: subcat, category: currentCategory }, "");
}

async function loadWineData() {
  if (!RESTAURANT_ID) return;
  if (!ristorante) {
    console.error("Ristorante non caricato");
    return;
  }

  const res = await fetch(`${SUPABASE_URL}/rest/v1/wines?ristorante_id=eq.${RESTAURANT_ID}&visibile=is.true`, {
    headers: { 'apikey': SUPABASE_API_KEY, 'Accept': 'application/json' }
  });
  const json = await res.json();

wines = Array.isArray(json) ? json : [];

// Estrai categorie uniche dai vini
const categorieUniche = [];
wines.forEach(w => {
  const cat = w.categoria;
  if (cat && !categorieUniche.includes(cat)) {
    categorieUniche.push(cat);
  }
});

// Ordina alfabeticamente
if (Array.isArray(categoriaOrder) && categoriaOrder.length) {
  sortByOrder(categorieUniche, categoriaOrder);
}


switch ((ristorante.ordine_vini || 'prezzo')) {
  case 'prezzo':
    wines.sort((a, b) => {
      const priceA = parseFloat((a.prezzo || '').replace(/[^0-9,.]/g, '').replace(',', '.')) || 0;
      const priceB = parseFloat((b.prezzo || '').replace(/[^0-9,.]/g, '').replace(',', '.')) || 0;
      return priceA - priceB;
    });
    break;

  case 'annata':
    wines.sort((a, b) => (parseInt(a.annata) || 0) - (parseInt(b.annata) || 0));
    break;

  case 'nome':
    wines.sort((a, b) => (a.nome || '').localeCompare(b.nome || ''));
    break;

  case 'inserimento':
    // Nessun ordinamento, resta come arriva
    break;
}
}
async function setupSommelierUI() {
  // crea solo gli elementi una volta
  window.showSommelier = ristorante?.sommelier_attivo === true || ristorante?.sommelier_attivo === "true";
  if (!document.getElementById("sommelierBtn")) {
    creaUIBaseSommelier();
  }

  await aggiornaCategorieSommelier();
}
async function creaUIBaseSommelier() {
  const btn = document.createElement("button");
  btn.id = "sommelierBtn";
  btn.setAttribute("aria-label", translations[currentLang].sommelierBtn || "Sommelier");
btn.innerHTML = `
  <img src="${ristoranteSommelierURL || 'sommelier.png'}" alt=""
       onerror="this.onerror=null;this.src='${(ristorante?.sommelier_gender||'uomo')==='donna'?'sommelier_femmina.png':'sommelier.png'}'"/>
  <div class="somm-text">
    <span class="somm-title translate-label" data-key="sommelierBtnTitle">${translations[currentLang].sommelierBtnTitle}</span>
    <span class="somm-sub translate-label" data-key="sommelierBtnSub">${translations[currentLang].sommelierBtnSub}</span>
  </div>
  <span class="somm-badge translate-label" data-key="sommelierBtnBadge">${translations[currentLang].sommelierBtnBadge}</span>
`;
  document.body.appendChild(btn);

  // Apri il popup al click
  btn.addEventListener("click", () => {
    localStorage.setItem("sommelier_seen", "1");
    btn.classList.remove("pulse");
    toggleSommelier();
  });

  // Effetti periodici: glow e wiggle (soft)
  setInterval(() => btn.classList.toggle("glow"), 3500);
  setInterval(() => {
    btn.classList.add("wiggle");
    setTimeout(() => btn.classList.remove("wiggle"), 950);
  }, 10000);

  // Tooltip: creazione e ciclo
const tooltip = document.createElement("div");
tooltip.id = "tooltipSommelier";
tooltip.innerHTML = `<div class="tip-content">${translations[currentLang].sommelierTooltip}</div>`;
document.body.appendChild(tooltip);

  // Pulse solo se mai cliccato
  if (!localStorage.getItem("sommelier_seen")) {
    btn.classList.add("pulse");
  }

  // Avvio ciclo tooltip “rotante”
  startSommelierTooltipCycle();

    const overlay = document.createElement("div");
    overlay.id = "sommelierOverlay";
    overlay.innerHTML = `
      <div id="sommelierPopup" class="popup">
        <button class="close-btn" onclick="closeSommelierPopup()">✖</button>
        <h3 class="translate-label" data-key="sommelierTitleBox">Dimmi cosa mangerai e io ti consiglierò il vino giusto! 🍷</h3>
        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;">
          <div style="flex: 1 1 48%;">
            <label for="priceFilter" class="translate-label" data-key="filterPrice" style="font-size: 0.85em; display: block; margin-bottom: 4px;">Filtra per prezzo</label>
            <select id="priceFilter" style="width: 100%; padding: 8px; font-size: 0.95em; border-radius: 8px; border: 1px solid #ccc;">
              <option value="" class="translate-label" data-key="anyPrice">Indifferente</option>
              <option value="25">Max €25</option>
              <option value="35">Max €35</option>
              <option value="45">Max €45</option>
              <option value="60">Max €60</option>
              <option value="100">Max €100</option>
            </select>
          </div>
          <div style="flex: 1 1 48%; min-width: 0; position: relative;">
            <label style="font-size: 0.85em; display: block; margin-bottom: 4px;" class="translate-label" data-key="filterCategory">Filtra per categoria</label>
            <button type="button" onclick="toggleWineTypeDropdown()" id="categoryFilterBtn"
              style="width: 100%; max-width: 100%; overflow: hidden; padding: 8px; font-size: 0.95em; border-radius: 8px; border: 1px solid #ccc; background: #fff; appearance: none; text-align: left; position: relative; white-space: nowrap;">
              <span class="labelText"
                style="display:inline-block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: calc(100% - 24px); vertical-align: middle;">Tutti</span>
              <span style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-size: 0.8em;">▼</span>
            </button>
          </div>
        </div>
        <div style="margin-top: 12px;">
          <label style="font-size: 0.85em; display: block; margin-bottom: 4px;" class="translate-label" data-key="searchLabel">Ricerca piatti per abbinamento</label>
          <div style="display: flex; background: white; border-radius: 999px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.08); width: 100%;">
            <input type="text" id="foodInput" placeholder="Separa piatti con le virgole." onkeydown="handleSommelierKey(event)" style="flex: 1; padding: 10px 14px; border: none; outline: none; font-size: 0.95em; background: transparent; line-height: 1.2; height: 40px; display: flex; align-items: center;" />
            <button id="sendFoodBtn" onclick="suggestWine()" style="padding: 0 16px; background: #999; color: white; border: none; font-size: 0.9em; font-weight: 500; cursor: pointer; display: none; transition: background 0.2s ease; border-radius: 999px;" class="translate-label" data-key="sendButton">INVIA</button>
          </div>
        </div>
        <div id="wineSuggestion" style="margin-top: 15px; font-size: 0.95em;"></div>
      </div>
    `;
    document.body.appendChild(overlay);

    const foodInput = document.getElementById("foodInput");
    const sendBtn = document.getElementById("sendFoodBtn");

    if (foodInput && sendBtn) {
      foodInput.addEventListener("input", () => {
        if (foodInput.value.trim().length > 0) {
          sendBtn.style.display = "inline-block";
        } else {
          sendBtn.style.display = "none";
        }
      });
    }

    const dropdown = document.createElement("div");
    dropdown.id = "wineTypeDropdown";
    dropdown.style.display = "none";
    document.body.appendChild(dropdown);

  aggiornaEtichettaCategorie();
}

window.closeSommelierPopup = closeSommelierPopup;

    // ——— Tooltip Sommelier: frasi e ciclo ———
function getSommelierTips() {
  const t = translations[currentLang];
  // tutte prese dal dizionario (quindi già tradotte)
  return [
    t.sommelierTooltip,   // es: "Non sai che vino scegliere? ..."
    t.sommelierTitleBox,  // es: "Dimmi cosa mangerai ..."
    t.searchLabel         // es: "Ricerca piatti per abbinamento"
  ];
}

function showTooltipOnceAnimated() {
  const tip = document.getElementById("tooltipSommelier");
  const btn = document.getElementById("sommelierBtn");
  if (!tip || !btn) return;

  const inner = tip.querySelector(".tip-content") || tip;
  const tips = getSommelierTips();
  const idx = (window._sommTipIndex = ((window._sommTipIndex || 0) + 1) % tips.length);
  inner.textContent = tips[idx];

  // posiziona sopra il bottone (usa la tua se già esiste)
  if (typeof positionTooltipOverButton === "function") {
    // posiziona (e riposiziona dopo reflow/raf)
    positionTooltipOverButton();
    requestAnimationFrame(() => positionTooltipOverButton());
    setTimeout(() => positionTooltipOverButton(), 120);
  } else {
    // fallback leggero
    const r = btn.getBoundingClientRect();
    tip.style.left = (r.left + r.width/2) + "px";
    tip.style.top  = (r.top - 12) + "px";
    tip.style.transform = "translate(-50%, -100%)";
  }

  tip.style.display = "block";

  // anima e nascondi al termine
  inner.style.animation = "none"; void inner.offsetHeight;
  inner.style.animation = "tipFade 2.2s ease both";
  inner.addEventListener("animationend", () => { tip.style.display = "none"; }, { once: true });
}

function startSommelierTooltipCycle() {
  stopSommelierTooltipCycle();
  showTooltipOnceAnimated();                       // mostra subito
  window._sommTipTimer = setInterval(showTooltipOnceAnimated, 9000); // poi ogni 9s
}

function stopSommelierTooltipCycle() {
  clearInterval(window._sommTipTimer);
  const tip = document.getElementById("tooltipSommelier");
  if (tip) tip.style.display = "none";
}

  async function aggiornaCategorieSommelier() {
  const dropdown = document.getElementById("wineTypeDropdown");
  if (!dropdown || !Array.isArray(wines)) return;

  const categorieUniche = [...new Set(wines.map(w => w.categoria).filter(Boolean))];
  dropdown.innerHTML = "";

  for (const cat of categorieUniche) {
    const label = document.createElement("label");
    label.style.cssText = "display: flex; align-items: center; gap: 8px; margin-bottom: 6px;";

    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.value = cat;
    checkbox.checked = true;
    checkbox.onchange = aggiornaEtichettaCategorie;

    const span = document.createElement("span");
    span.textContent = cat;

    if (currentLang !== "it") {
      try {
        const res = await fetch("https://ldunvbftxhbtuyabgxwh.functions.supabase.co/traduci-categoria", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text: cat, targetLang: currentLang })
        });
        const data = await res.json();
        const translated = data.text?.trim() || cat;
        span.textContent = translated;
        checkbox.setAttribute("data-translated-label", translated);
      } catch (err) {
        checkbox.setAttribute("data-translated-label", cat);
      }
    } else {
      checkbox.setAttribute("data-translated-label", cat);
    }

    label.appendChild(checkbox);
    label.appendChild(span);
    dropdown.appendChild(label);
  }

  aggiornaEtichettaCategorie();
}

let reorderMode = null;
let reorderType = null;
let categoriaOrder = [];
let sottocategoriaOrderMap = {};

window.addEventListener("message", (event) => {
  if (event.data?.action === "updateFontLive") {
  const font = event.data.font;
  if (font) {
    document.body.style.fontFamily = font;
    ensureFontLoaded(font);
  }
  window.paletteOverrideLive = true;
}

if (event.data?.action === "updatePaletteLive") {
  const { palette } = event.data;
  window.paletteOverrideLive = false;
  window.ristorantePalette = palette;
  applyPalette(palette);
}

  if (event.data?.action === "checkSubcategoryContext") {
    const allowed = currentView === "subcategory" && currentCategory;
    parent.postMessage({ action: "subcatReady", allowed }, "*");
  }

  if (event.data?.action === "updateLogoLive") {
  let logo = document.getElementById("restaurantLogo");
  const nav = document.querySelector("nav");

if (!logo && event.data.logoUrl) {
  logo = document.createElement("img");
  logo.id = "restaurantLogo";
  logo.style.display = "block";

  // ✅ Ricrea il contenuto del nav con il bottone goBack incluso
  nav.innerHTML = `
    <button onclick="goBack()">⬅</button>
    <div style="flex: 1; display: flex; justify-content: center;">
      <div id="restaurantName"></div>
    </div>
  `;
  document.getElementById("restaurantName").appendChild(logo);
  setTimeout(() => aggiornaAltezzaNavbar(), 50);
}

  if (logo) {
    if (event.data.logoUrl) logo.src = event.data.logoUrl;
    if (event.data.size) {
      logo.style.height = event.data.size + "px";
      setTimeout(() => aggiornaAltezzaNavbar(), 30);
    }

    if (event.data.border) {
      logo.style.border = "2px solid " + event.data.borderColor;
      logo.style.borderRadius = "8px";
      logo.style.padding = "4px";
    } else {
      logo.style.border = "none";
            logo.style.padding = "0";
    }
  }
}

  if (event.data?.action === "updateNameLive") {
const nameSpan = document.querySelector("#restaurantName span");
if (nameSpan) {
  nameSpan.style.fontFamily = event.data.font || "sans-serif";
  nameSpan.style.fontSize = event.data.size + "px";
  nameSpan.style.color = event.data.color;
  nameSpan.style.fontWeight = event.data.bold ? "bold" : "normal";
  nameSpan.textContent = event.data.name || "Carta dei Vini";

  ensureFontLoaded(event.data.font);

  // Aspetta il prossimo repaint per avere le dimensioni corrette
  setTimeout(() => {
    aggiornaAltezzaNavbar();
  }, 50);
}}


  if (event.data?.action === "startReorder") {
    reorderMode = true;
    reorderType = event.data.type;

    if (reorderType === "categorie") {
      const container = document.getElementById("category-list");
      [...container.children].forEach(el => {
        el.style.cursor = "grab";
        el.innerHTML = `<span style='opacity:0.5;margin-right:0.5em;'>☰</span>${el.innerHTML}`;
      });

      new Sortable(container, {
        animation: 150,
        ghostClass: 'sortable-ghost'
      });
    } else if (reorderType === "sottocategorie") {
      const subContainer = document.getElementById("subcategory-list");
      [...subContainer.children].forEach(el => {
        el.style.cursor = "grab";
        el.innerHTML = `<span style='opacity:0.5;margin-right:0.5em;'>☰</span>${el.innerHTML}`;
      });

      new Sortable(subContainer, {
        animation: 150,
        ghostClass: 'sortable-ghost'
      });
    }
  }

  if (event.data?.action === "getReorder") {
    if (reorderType === "categorie") {
      const container = document.getElementById("category-list");
      const ordine = [...container.children].map(el =>
  el.textContent.replace(/^☰\s*/, '').trim()
);
      parent.postMessage({ action: "saveReorder", type: "categorie", ordine }, "*");
    } else if (reorderType === "sottocategorie") {
      const subContainer = document.getElementById("subcategory-list");
      const ordine = [...subContainer.children].map(el =>
  el.textContent.replace(/^☰\s*/, '').trim()
);
      const sottocategorieMap = { [currentCategory]: ordine };
      parent.postMessage({ action: "saveReorder", type: "sottocategorie", sottocategorieMap }, "*");
    }
  }
});

async function fetchCategoryOrder() {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/ristoranti?id=eq.${RESTAURANT_ID}`, {
    headers: { 'apikey': SUPABASE_API_KEY, 'Accept': 'application/json' }
  });
  const data = await res.json();
  const ristorante = data[0];

  // Normalizza le categorie
  categoriaOrder = (ristorante.ordine_categorie || []).map(normalize);

  // Normalizza le sottocategorie
  const rawMap = ristorante.ordine_sottocategorie || {};
  sottocategoriaOrderMap = {};
  for (const [key, value] of Object.entries(rawMap)) {
    const normalizedKey = normalize(key);
    sottocategoriaOrderMap[normalizedKey] = Array.isArray(value)
      ? value.map(normalize)
      : [];
  }
}

function sortByOrder(array, orderArray) {
  return array.sort((a, b) => {
    const i1 = orderArray.indexOf(normalize(a));
    const i2 = orderArray.indexOf(normalize(b));
    if (i1 === -1) return 1;
    if (i2 === -1) return -1;
    return i1 - i2;
  });
}

// override showCategories and showSubcategories to apply order
const originalShowCategories = window.showCategories;
const originalShowSubcategories = window.showSubcategories;

window.showCategories = async function (categories) {
  setHelperByKey('helperChooseCategory');

    // ⭐️ prendi i formati selezionati e filtra i vini
  const { ids, map } = getCheckedFormats();
  const filtered = winesMatchFormats(wines, ids, map); // ⭐️
  const seen = new Map();
  filtered.forEach(w => {
    const key = normalize(w.categoria);
    if (key && !seen.has(key)) {
      seen.set(key, w.categoria);
    }
  });

  let orderedKeys = Array.from(seen.keys());

  if (categoriaOrder.length) {
    const seenKeys = Array.from(seen.keys());
    const customOrder = categoriaOrder
      .map(name => {
        const normalized = normalize(name);
        return seenKeys.find(k => normalize(k) === normalized);
      })
      .filter(Boolean);

    if (customOrder.length > 0) {
      orderedKeys = customOrder;
    }
  }

const container = document.getElementById('category-list');
if (!container) return; // 🔒 Se non esiste, esci subito

container.style.display = 'block';
container.innerHTML = '';

  for (const key of orderedKeys) {
    const display = seen.get(key);
    const div = document.createElement('div');
    div.className = 'category';
div.textContent = display;

try {
if (currentLang !== "it") {
  try {
    const res = await fetch("https://ldunvbftxhbtuyabgxwh.functions.supabase.co/traduci-categoria", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text: display, targetLang: currentLang })
    });
    const data = await res.json();
    const translated = data.text?.trim() || display;
    div.textContent = translated;
  } catch (e) {
    console.error("Errore GPT categorie:", e);
    div.textContent = display;
  }
}
} catch (e) {
  console.error("Errore GPT categorie:", e);
}

div.onclick = () => showSubcategories(key); // ✅ SEMPRE fuori
container.appendChild(div);                 // ✅ SEMPRE fuori

  }
applyPalette(window.ristorantePalette);
};

window.showSubcategories = function (category) {
  currentCategory = category;
  setHelperCategoryName(category);
  currentView = 'subcategory';

  // ⭐️ Prendi i formati selezionati e filtra i vini della categoria
  const { ids, map } = getCheckedFormats();
  const inCategory = wines.filter(w => normalize(w.categoria) === normalize(category));
  const list = (ids && ids.length) ? winesMatchFormats(inCategory, ids, map) : inCategory;

  // Calcola solo le sottocategorie che hanno almeno un vino "list"
  const seen = new Map();
  list.forEach(w => {
    const key = normalize(w.sottocategoria);
    if (key && !seen.has(key)) seen.set(key, w.sottocategoria);
  });

  let orderedKeys = Array.from(seen.keys());

  const order = Object.entries(sottocategoriaOrderMap).find(
    ([key]) => normalize(key) === normalize(category)
  )?.[1] || [];

if (Array.isArray(order) && order.length) {
  const seenKeys = Array.from(seen.keys());
  const customOrder = order
    .map(name => {
      const normalized = normalize(name);
      return seenKeys.find(k => normalize(k) === normalized);
    })
    .filter(Boolean);

  // Aggiungi eventuali sottocategorie nuove non presenti nell'ordine salvato
  const extra = seenKeys.filter(k => !customOrder.includes(k));
  orderedKeys = [...customOrder, ...extra];
}

  const container = document.getElementById('subcategory-list');
  container.innerHTML = '';
  for (const key of orderedKeys) {
    const display = seen.get(key);
    const div = document.createElement('div');
    div.className = 'subcategory';
    div.textContent = display.charAt(0).toUpperCase() + display.slice(1).toLowerCase();
    div.onclick = () => showWinesBySubcategory(key);
    container.appendChild(div);
  }
applyPalette(window.ristorantePalette);

    const catList = document.getElementById('category-list');
    if (catList) catList.style.display = 'none';
  container.style.display = 'grid';
  const wineList = document.getElementById('wine-list');
  if (wineList) wineList.style.display = 'none';
if (window._manualNavigation !== true) {
  history.pushState({ view: "subcategory", category }, "");
}
};

(async () => {
await fetchCategoryOrder();
await loadRestaurantData();
if (ristorante && RESTAURANT_ID) {
  await loadWineData();
  setupFilterUI();
  showCategories();
}

const isSommelierOn = ristorante?.sommelier_attivo === true || ristorante?.sommelier_attivo === "true";
if (isSommelierOn) {
  setupSommelierUI(); // crea UI del sommelier
}

  // 🔒 Blocco la palette una volta per tutte
  const isCustom = ristorante.palette_color === "custom";
  window.paletteOverrideLive = isCustom;
  window.ristorantePalette = ristorante.palette_color;

  showCategories();
  history.replaceState({ view: "categories" }, "");

applyPalette(window.ristorantePalette);
})();


let abbinamentiRecenti = JSON.parse(localStorage.getItem("abbinamenti_recenti") || "[]");
function aggiornaStorico(piatto) {
  if (!piatto) return;
  abbinamentiRecenti = abbinamentiRecenti.filter(p => p !== piatto);
  abbinamentiRecenti.unshift(piatto);
  if (abbinamentiRecenti.length > 5) abbinamentiRecenti.pop();
  localStorage.setItem("abbinamenti_recenti", JSON.stringify(abbinamentiRecenti));
}
function mostraStoricoNelSommelier() {
  if (!abbinamentiRecenti.length) return "";
  return `<div style='margin-top:20px; font-size:0.85em; color:#555;'>🔁 Hai già chiesto per: ` + abbinamentiRecenti.map(p => `<span onclick='ripetiAbbinamento("${p}")' style='cursor:pointer; color:#b00; margin-right:6px; text-decoration:underline;'>${p}</span>`).join(" ") + `</div>`;
}
function ripetiAbbinamento(piatto) {
  document.getElementById("foodInput").value = piatto;
  suggestWine();
}
  window.ripetiAbbinamento = ripetiAbbinamento;

function ensureFontLoaded(fontName) {
  if (!fontName || fontName === "custom") return;
  if (["sans-serif", "cursive", "monospace"].includes(fontName)) return;

  const fontId = "googleFont_" + fontName.replace(/\s+/g, "_");
  if (!document.getElementById(fontId)) {
    const link = document.createElement("link");
    link.id = fontId;
    link.rel = "stylesheet";
    const encoded = encodeURIComponent(fontName.trim()).replace(/%20/g, "+");
    link.href = `https://fonts.googleapis.com/css2?family=${encoded}&display=swap`;
    document.head.appendChild(link);
  }
}
function toggleWineTypeDropdown() {
  const dropdown = document.getElementById("wineTypeDropdown");
  const button = document.getElementById("categoryFilterBtn");

  if (!dropdown || !button) return;

  // Toggle display
  if (dropdown.style.display === "block") {
    dropdown.style.display = "none";
    return;
  }

  const rect = button.getBoundingClientRect();
  const popupRect = document.getElementById("sommelierPopup")?.getBoundingClientRect();
  const top = popupRect ? (rect.bottom + popupRect.top) : rect.bottom;

  dropdown.style.position = "fixed";
  dropdown.style.top = `${rect.bottom}px`;
  dropdown.style.left = `${rect.left}px`;
  dropdown.style.display = "block";
}
  window.toggleWineTypeDropdown = toggleWineTypeDropdown;

document.addEventListener("click", function (event) {
  const dropdown = document.getElementById("wineTypeDropdown");
  const button = document.getElementById("categoryFilterBtn");

  // Non chiudere se clicco sul bottone o dentro al menu
  if (
    dropdown.style.display === "block" &&
    !dropdown.contains(event.target) &&
    event.target !== button &&
    !button.contains(event.target)
  ) {
    dropdown.style.display = "none";
  }
});

function aggiornaEtichettaCategorie() {
  const allCheckboxes = document.querySelectorAll("#wineTypeDropdown input[type='checkbox']");
  const checked = Array.from(allCheckboxes).filter(cb => cb.checked).map(cb => cb.getAttribute("data-translated-label") || cb.value);
  const button = document.getElementById("categoryFilterBtn");

  const baseLabel = (checked.length === 0 || checked.length === allCheckboxes.length)
    ? translations[currentLang].allLabel
    : checked.slice(0, 3).join(', ') + (checked.length > 3 ? '…' : '');

  // ✅ Non sostituire tutto l’innerHTML, modifica solo il contenuto testuale
  const textSpan = button.querySelector(".labelText");
  if (textSpan) textSpan.textContent = baseLabel;
}
window.addEventListener("popstate", (event) => {
 const overlay = document.getElementById('sommelierOverlay');
 if (overlay && overlay.style.display === 'flex') return;
  const state = event.state;

  window._manualNavigation = true; // ✅ evita pushState

  if (!state || state.view === "categories") {
    goToCategories();
  } else if (state.view === "subcategory") {
    showSubcategories(state.category);
  } else if (state.view === "wines") {
    currentCategory = state.category;
    showWinesBySubcategory(state.subcategory);
  }

  setTimeout(() => window._manualNavigation = false, 100);
});
function renderSchedaInto(el, vinoNome, scheda, descrizione, lang){
  const clamp = v => Math.max(0, Math.min(100, Number(v||0)));

  const bars = `
    <div class="vino-bars">
      <div class="bar"><span>Leggero</span><div class="track"><i class="knob" style="left:${clamp(scheda?.profile?.body)}%"></i></div><span>Strutturato</span></div>
      <div class="bar"><span>Secco</span>  <div class="track"><i class="knob" style="left:${clamp(scheda?.profile?.sweetness)}%"></i></div><span>Dolce</span></div>
      <div class="bar"><span>Morbido</span><div class="track"><i class="knob" style="left:${clamp(scheda?.profile?.acidity)}%"></i></div><span>Acido</span></div>
    </div>`;

  const chips = (arr, muted=false) =>
    `<div class="vino-chips ${muted?'muted':''}">` +
    (arr||[]).map(n => `<span>${typeof n==="string"? n : (n?.label||"")}</span>`).join("") +
    `</div>`;

  const summary = (scheda?.summary||"").toString();
  const pair = Array.isArray(scheda?.pairings) ? scheda.pairings : [];
  const notes = Array.isArray(scheda?.notes) ? scheda.notes : [];

el.innerHTML = `
  <div class="vino-card">
    ${summary ? `<p class="summary">${summary}</p>` : ""}
    ${bars}
    ${notes.length ? chips(notes,false) : ""}
    ${pair.length ? chips(pair,true) : ""}
    <button class="vino-toggle" id="vToggleBtn">Mostra dettagli</button>
    <p id="vFullDesc" style="display:none; margin-top:6px;">${descrizione||""}</p>
  </div>
`;

  // toggle descrizione
  const btn = el.querySelector('#vToggleBtn');
  const p   = el.querySelector('#vFullDesc');
  btn.onclick = () => {
    const show = p.style.display === 'none';
    p.style.display = show ? 'block' : 'none';
    btn.textContent = show ? 'Nascondi dettagli' : 'Mostra dettagli';
  };
}
function mostraPopupDescrizione(vino) {
  // Crea sempre l'overlay con gli elementi usati dopo
  const overlay = document.createElement("div");
  overlay.className = "popup-overlay";
  overlay.innerHTML = `
    <div class="popup-descrizione">
      <button class="close-btn" onclick="this.closest('.popup-overlay').remove()">✖</button>
      <h3>${vino.nome}${vino.annata ? ` (${vino.annata})` : ""}</h3>
      <div id="schedaWrap" style="margin-top:8px;"></div>
      <div id="descrizioneTesto" style="margin-top:8px; font-size:.95em; opacity:.9;"></div>
    </div>`;
  document.body.appendChild(overlay);

  // Kill-switch: se disabilitata, messaggio e stop
  if (DESCRIZIONE_VINO_ABILITATA === false) {
    const desc = overlay.querySelector("#descrizioneTesto");
    if (desc) desc.textContent = "Descrizione momentaneamente non disponibile.";
    return;
  }

  // Altrimenti procedi col loader + fetch
  const descEl = overlay.querySelector("#descrizioneTesto");
  const wrapEl = overlay.querySelector("#schedaWrap");
  if (descEl) descEl.textContent = (translations[currentLang]?.loadingDescription) || "Sto caricando una descrizione...";

  const FN_URL = "https://ldunvbftxhbtuyabgxwh.functions.supabase.co/descrizione-vino";
  fetch(FN_URL, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${SUPABASE_API_KEY}`
    },
    body: JSON.stringify({
      nome: vino.nome,
      annata: vino.annata,
      uvaggio: vino.uvaggio,
      categoria: vino.categoria,
      sottocategoria: vino.sottocategoria,
      ristorante_id: RESTAURANT_ID
    })
  })
  .then(async res => {
    const raw = await res.text();
    if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText} — ${raw}`);
    return JSON.parse(raw);
  })
  .then(async data => {
    let descr = data.descrizione || translations[currentLang].noDescription || "Nessuna descrizione trovata.";
    const scheda = data.scheda || null;

    if (currentLang !== "it" && descr && descr !== "Nessuna descrizione trovata.") {
      try {
        const r = await fetch("https://ldunvbftxhbtuyabgxwh.functions.supabase.co/traduci-descrizione", {
          method: "POST",
          headers: { "Content-Type": "application/json", "Authorization": `Bearer ${SUPABASE_API_KEY}` },
          body: JSON.stringify({ text: descr, targetLang: currentLang })
        });
        const t = await r.json();
        descr = t.text || descr;
      } catch(e){}
    }

    if (wrapEl && scheda) {
      if (descEl) descEl.textContent = "";
      renderSchedaInto(wrapEl, vino.nome + (vino.annata ? ` (${vino.annata})`:""), scheda, descr, currentLang);
    } else {
      if (descEl) descEl.textContent = descr;
    }
  })
  .catch(err => {
    console.error("[descrizione-vino]", err);
    if (descEl) descEl.textContent = "Errore durante il recupero della descrizione.";
  });
}

function positionTooltipOverButton() {
  const tip = document.getElementById("tooltipSommelier");
  const btn = document.getElementById("sommelierBtn");
  if (!tip || !btn) return;

  // renderizza offscreen per calcolare dimensioni
  tip.style.visibility = "hidden";
  tip.style.display = "block";
  const tipRect = tip.getBoundingClientRect();

  const b = btn.getBoundingClientRect();
  const margin = 10; // distanza dal bottone
  let left = b.left + (b.width / 2) - (tipRect.width / 2);
  let top  = b.top - margin - tipRect.height;

  // clamp entro viewport
  const minX = 8;
  const maxX = window.innerWidth - tipRect.width - 8;
  left = Math.max(minX, Math.min(maxX, left));
  top  = Math.max(8, top);

  tip.style.left = `${left}px`;
  tip.style.top  = `${top}px`;
  tip.style.visibility = "visible";
}

// se l’utente ridimensiona / ruota, riposiziona SOLO se visibile
window.addEventListener("resize", () => {
  const tip = document.getElementById("tooltipSommelier");
  if (tip && tip.style.display === "block") positionTooltipOverButton();
});
window.addEventListener("scroll", () => {
  const tip = document.getElementById("tooltipSommelier");
  if (tip && tip.style.display === "block") positionTooltipOverButton();
});

function setupFilterUI() {
  const btn = document.getElementById("filterBtn");
  const menu = document.getElementById("filterMenu");
  const optionsContainer = document.getElementById("filterOptions");
  const t = translations[currentLang] || translations.it;  // ← AGGIUNGI QUESTA RIGA

  // Trova i formati disponibili nei vini
  const formatsMap = {
    bottle: { label: t.formatBottle || "Bottiglia", key: "prezzo" },
    glass:  { label: t.formatGlass  || "Bicchiere", key: "prezzo_bicchiere" },
    quarter: { label: "1/4 lt", key: "prezzo_025" },
    half: { label: "1/2 lt", key: "prezzo_05" },
    threequart: { label: "0,375 lt", key: "prezzo_0375" },
    onehalf: { label: "1,5 lt", key: "prezzo_15" },
    three: { label: "3 lt", key: "prezzo_3l" }
  };

  const availableFormats = {};
  wines.forEach(w => {
    for (const [id, f] of Object.entries(formatsMap)) {
      if (w[f.key]) availableFormats[id] = f;
    }
  });

  // Popola le checkbox
  optionsContainer.innerHTML = "";
  for (const [id, f] of Object.entries(availableFormats)) {
    const label = document.createElement("label");
    label.style.display = "flex";
    label.style.alignItems = "center";
    label.style.gap = "6px";
    label.style.marginBottom = "6px";

    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.value = id;
    cb.checked = true;
    cb.onchange = applyFilters;

    label.appendChild(cb);
    label.appendChild(document.createTextNode(f.label));
    optionsContainer.appendChild(label);
  }

  btn.onclick = () => {
    menu.style.display = (menu.style.display === "none") ? "block" : "none";
  };

  applyFilters();
}
function refreshFilterOptionsPreservingState() {
  const optionsContainer = document.getElementById("filterOptions");
  if (!optionsContainer) return;

  // Ricorda quali erano spuntate
  const checked = new Set(
    Array.from(optionsContainer.querySelectorAll("input[type='checkbox']:checked"))
         .map(cb => cb.value)
  );

  // Ricostruisci con le label tradotte (copiando la logica di setupFilterUI)
  const t = translations[currentLang];
  const formatsMap = {
    bottle: { label: t.formatBottle || "Bottiglia", key: "prezzo" },
    glass:  { label: t.formatGlass  || "Bicchiere", key: "prezzo_bicchiere" },
    quarter:    { label: "1/4 lt",   key: "prezzo_025" },
    half:       { label: "1/2 lt",   key: "prezzo_05" },
    threequart: { label: "0,375 lt", key: "prezzo_0375" },
    onehalf:    { label: "1,5 lt",   key: "prezzo_15" },
    three:      { label: "3 lt",     key: "prezzo_3l" }
  };

  // Limita ai formati effettivamente presenti nei vini (stessa logica di setup)
  const availableFormats = {};
  wines.forEach(w => {
    for (const [id, f] of Object.entries(formatsMap)) {
      if (w[f.key]) availableFormats[id] = f;
    }
  });

  optionsContainer.innerHTML = "";
  for (const [id, f] of Object.entries(availableFormats)) {
    const label = document.createElement("label");
    label.style.display = "flex";
    label.style.alignItems = "center";
    label.style.gap = "6px";
    label.style.marginBottom = "6px";

    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.value = id;
    cb.checked = checked.size ? checked.has(id) : true;
    cb.onchange = applyFilters;

    label.appendChild(cb);
    label.appendChild(document.createTextNode(f.label));
    optionsContainer.appendChild(label);
  }
}

function getCheckedFormats() {
  const ids = Array.from(document.querySelectorAll("#filterOptions input:checked")).map(cb => cb.value);
  const map = {
    bottle: "prezzo",
    glass: "prezzo_bicchiere",
    quarter: "prezzo_025",
    threequart: "prezzo_0375",
    half: "prezzo_05",
    onehalf: "prezzo_15",
    three: "prezzo_3l"
  };
  return { ids, map };
}

function winesMatchFormats(list, ids, map) {
  if (!ids.length) return []; // nessun formato selezionato → nessun vino
  return list.filter(w => ids.some(f => w[map[f]]));
}

function applyFilters() {
  const { ids, map } = getCheckedFormats();
  // 1) ricava i vini che hanno almeno uno dei formati scelti
  const filteredWines = winesMatchFormats(wines, ids, map);

  // 2) capiamo dove siamo e rigeneriamo l’UI di conseguenza
  if (currentView === 'categories') {
    // mostro solo le categorie che hanno almeno un vino valido
    const haveCats = Array.from(new Set(filteredWines.map(w => w.categoria).filter(Boolean)));
    const ordered = (categoriaOrder && categoriaOrder.length)
      ? haveCats.sort((a,b) => categoriaOrder.indexOf(normalize(a)) - categoriaOrder.indexOf(normalize(b)))
      : haveCats;
    const container = document.getElementById('category-list');
    container.innerHTML = '';
ordered.forEach(async (cat) => {
  const div = document.createElement('div');
  div.className = 'category';

  // traduzione dinamica se lingua != it
  let display = cat;
  if (currentLang !== 'it') {
    try {
      const res = await fetch("https://ldunvbftxhbtuyabgxwh.functions.supabase.co/traduci-categoria", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: cat, targetLang: currentLang })
      });
      const data = await res.json();
      display = (data.text || cat).trim();
    } catch (_) { /* fallback: cat */ }
  }
  div.textContent = display;

  div.onclick = () => showSubcategories(cat);
  container.appendChild(div);
});

  } else if (currentView === 'subcategory') {
    // solo le sottocategorie della categoria corrente che hanno un vino valido
    const list = filteredWines.filter(w => normalize(w.categoria) === normalize(currentCategory));
    const haveSub = Array.from(new Set(list.map(w => w.sottocategoria).filter(Boolean)));
    let ordered = haveSub;
    const order = Object.entries(sottocategoriaOrderMap).find(
      ([key]) => normalize(key) === normalize(currentCategory)
    )?.[1] || [];
    if (order.length) {
      ordered = haveSub.sort((a,b) => order.indexOf(normalize(a)) - order.indexOf(normalize(b)));
    }
    const container = document.getElementById('subcategory-list');
    container.innerHTML = '';
    ordered.forEach(sub => {
      const div = document.createElement('div');
      div.className = 'subcategory';
      div.textContent = sub.charAt(0).toUpperCase() + sub.slice(1).toLowerCase();
      div.onclick = () => showWinesBySubcategory(sub);
      container.appendChild(div);
    });
} else if (currentView === 'wines') {
  const wineList = document.getElementById("wine-list");
  if (!wineList || !window.currentSubcategory) return;

  wineList.innerHTML = "";
  const inSub = wines.filter(w =>
    normalize(w.categoria) === normalize(currentCategory) &&
    normalize(w.sottocategoria) === normalize(window.currentSubcategory)
  );
  const filtered = winesMatchFormats(inSub, ids, map);
  filtered.forEach(w => {
    const card = document.createElement("div");
    card.className = "wine-card";
    const annata = w.annata ? ` (${w.annata})` : "";
    const nomePulito = (w.nome || "").trim();
    const t = translations[currentLang];
    card.innerHTML = `
      <strong>${nomePulito}${annata}</strong>
      ${buildPriceHTML(w)}
      ${w.uvaggio ? `<small>${t.grape}: ${w.uvaggio}</small>` : ""}`;
    card.onclick = () => mostraPopupDescrizione(w);
    wineList.appendChild(card);
  });
}

}
function closeFilterMenu(){ 
  const m = document.getElementById('filterMenu');
  if (m) m.style.display = 'none';
}

document.addEventListener('click', (e) => {
  const menu = document.getElementById('filterMenu');
  const btn  = document.getElementById('filterBtn');
  if (!menu || !btn) return;

  if (
    menu.style.display === 'block' &&
    !menu.contains(e.target) &&
    e.target !== btn &&
    !btn.contains(e.target)
  ) {
    menu.style.display = 'none';
  }
});

let lastSearchQuery = "";
let searchResults = [];

// apre/chiude il popover come fai per il filtro categorie
window.openSearch = function() {
  const pop = document.getElementById('searchPopover');
  const input = document.getElementById('searchInput');
  if (!pop || !input) return;

  const isOpen = pop.style.display === 'block';
  pop.style.display = isOpen ? 'none' : 'block';

  if (!isOpen) {
    // posiziona sopra al bottone (se serve ricalcolo dinamico)
    const wrapper = document.getElementById('searchBtnWrapper');
    if (wrapper) {
      const r = wrapper.getBoundingClientRect();
      pop.style.position = 'fixed';
      pop.style.left = '16px';            // ancorato a sinistra come il FAB
      pop.style.bottom = '78px';          // 52px bottone + ~10/12px gap
    }
    setTimeout(() => input.focus(), 40);
  }
};

window.closeSearch = function() {
  const pop = document.getElementById('searchPopover');
  if (pop) pop.style.display = 'none';
};

window.handleSearchKey = function(e){
  if (e.key === 'Enter') {
    e.preventDefault();
    runSearch();
  }
};

window.runSearch = function(){
  const el = document.getElementById('searchInput');
  const q = (el?.value || "").trim();
  lastSearchQuery = q;
  closeSearch();
  showSearchResults(q);
};

// chiudi se clicchi fuori dal popover e fuori dal bottone
document.addEventListener('click', function(ev){
  const pop = document.getElementById('searchPopover');
  const btn = document.getElementById('searchBtn');
  if (!pop || !btn) return;
  const clickInside = pop.contains(ev.target) || btn.contains(ev.target);
  if (pop.style.display === 'block' && !clickInside) pop.style.display = 'none';
});

window.showSearchResults = function(query){
  currentView = 'search';
  const t = translations[currentLang];
  const wineList = document.getElementById('wine-list');
  const sub = document.getElementById('subcategory-list');
  const cat = document.getElementById('category-list');
  if (cat) cat.style.display = 'none';
  if (sub) sub.style.display = 'none';
  if (wineList) wineList.style.display = 'block';

  const norm = s => (s||"").toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu,"").trim();
  const nq = norm(query);

  searchResults = wines.filter(w => nq && [
    w.nome, w.uvaggio, w.note, w.sottocategoria, w.categoria, w.denominazione
  ].some(f => norm(f).includes(nq)));

  wineList.innerHTML = "";
if (!searchResults.length){
  wineList.innerHTML = `
    <div class="wine-card" style="text-align:center; font-style:italic; opacity:0.8;">
      ${t?.noSearchResult || "Nessun vino per questa ricerca."}
    </div>`;
  return;
}

  searchResults.forEach(w => {
    const card = document.createElement('div');
    card.className = 'wine-card';
    const annata = w.annata ? ` (${w.annata})` : '';
    const nomePulito = (w.nome || "").trim();
    card.innerHTML = `
      <strong>${nomePulito}${annata}</strong>
      ${buildPriceHTML(w)}
      ${w.uvaggio ? `<small>${translations[currentLang].grape}: ${w.uvaggio}</small>` : ""}
      <div style="margin-top:6px; font-size:.85em; opacity:.8;">
        <em>${(w.categoria||"").trim()}${w.sottocategoria ? " • " + w.sottocategoria : ""}</em>
      </div>`;
    card.onclick = () => mostraPopupDescrizione(w);
    wineList.appendChild(card);
  });

  // re-applica palette alla UI appena generata
applyPalette(window.ristorantePalette);

  setHelper(`Risultati per: “${query}”`);
  history.pushState({ view:"search", query }, "");
};

// se cambi lingua mentre sei in cerca, rigenera i risultati
const _origChangeLang = window.changeLanguage;
window.changeLanguage = function(){
  _origChangeLang();
  if (currentView === 'search' && lastSearchQuery) showSearchResults(lastSearchQuery);
};

// supporta back/forward del browser
window.addEventListener('popstate', (ev) => {
  if (ev.state?.view === 'search') showSearchResults(ev.state.query || "");
});

const rn = document.getElementById('restaurantName');
if (rn) {
  rn.addEventListener('click', () => {
    closeFilterMenu();
    // reset view → categorie
    currentCategory = null;
    window.currentSubcategory = null;
    setHelper(translations[currentLang].helperChooseCategory);
    goToCategories(); // esiste già e viene usata anche dal back (:contentReference[oaicite:6]{index=6})
    if (!window._manualNavigation) {
      history.pushState({ view: "categories" }, "");
    }
  });
}

</script>
<!-- Bottom bar -->
<div id="bottomBar">
  <button id="searchBtn" class="bottom-btn" aria-label="Cerca" onclick="openSearch()">
    <img src="iconsearch.png" alt="" aria-hidden="true">
    <span class="translate-label" data-key="search">Cerca</span>
  </button>

  <button id="homeBtn" class="bottom-btn" aria-label="Home" onclick="goToCategories()">
    <img src="iconmenu.png" alt="" aria-hidden="true">
    <span>Home</span>
  </button>

  <button id="filterBtn" class="bottom-btn" aria-label="Filtra">
    <img src="iconfilter.png" alt="" aria-hidden="true">
    <span class="translate-label" data-key="filterLabel">Filtra</span>
  </button>
</div>

<!-- Popover di ricerca sopra al FAB (chiuso di default) -->
<div id="searchPopover" style="display:none; position:fixed; left:16px; bottom:78px; z-index:2000; border:1px solid #ccc; border-radius:12px; padding:10px; background:#fff; box-shadow:0 4px 12px rgba(0,0,0,.2); min-width:240px;">
  <div style="display:flex; gap:8px;">
    <input id="searchInput" type="text" placeholder="Cerca nome, uvaggio, note…" 
           onkeydown="handleSearchKey(event)"
           style="flex:1; padding:8px 10px; border:1px solid #ccc; border-radius:8px; font-size:0.95em;">
    <button class="save-btn translate-label" data-key="searchButton" onclick="runSearch()">Cerca</button>
  </div>
</div>

<div id="filterMenu" style="display:none; position:fixed; bottom:70px; right:16px; background:#fff; border:1px solid #ccc; border-radius:12px; padding:12px; box-shadow:0 4px 12px rgba(0,0,0,0.2); z-index:2000; min-width:200px;">
  <strong class="translate-text" data-key="filterBy">Filtra per:</strong>
  <div id="filterOptions"></div>
</div>
</body>
</html>
