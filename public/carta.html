<!DOCTYPE html>
<html lang="it">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display&family=Raleway&family=Dancing+Script&family=Montserrat&family=Roboto&family=Edu+NSW+ACT+Hand+Pre&family=Lavishly+Yours&family=Kolker+Brush&family=Pacifico&family=Indie+Flower&family=Cormorant+Garamond&family=Great+Vibes&family=Bebas+Neue&family=Merriweather&family=Abril+Fatface&family=Lobster&family=Oswald&family=Amatic+SC&family=Bitter&family=Quicksand&display=swap" rel="stylesheet">
<title>Carta dei Vini</title>
<style id="dynamic-style">
:root {
  --accent-color: #b00;
  --bg-default: #fff9f4;
}
.popup-overlay {
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}
.popup-descrizione {
  background: #fff;
  padding: 20px;
  border-radius: 16px;
  max-width: 400px;
  width: 90%;
  box-shadow: 0 6px 16px rgba(0,0,0,0.2);
  position: relative;
}
.popup-descrizione h3 {
  margin-top: 0;
  font-size: 1.2em;
}
.popup-descrizione .close-btn {
  position: absolute;
  top: 10px; right: 12px;
  font-size: 1.2em;
  background: none;
  border: none;
  cursor: pointer;
}
#wineTypeDropdown {
  position: fixed;
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 8px;
  padding: 8px 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  z-index: 3000;
  display: none;
  font-size: 0.95em;
  min-width: 220px;
  animation: slideDown 0.2s ease-out;
}

body {
  font-family: sans-serif;
  background: var(--bg-default);
  color: #333;
  margin: 0;
  padding-top: 60px;
}

#restaurantName {
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  font-size: 1.2em;
  line-height: 1.2;
  text-align: center;
  white-space: normal;
}

#restaurantName span {
  display: block;
  text-align: center;
  white-space: normal;
  line-height: 1.2;
}
#restaurantLogo {
  display: block;
  max-height: 120px;
  object-fit: contain;
  border-radius: 6px;
}

/* NAV HEADER */
nav {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background: #fff;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.5em 1em;
  border-bottom: 1px solid #ddd;
  z-index: 1000;
  min-height: 60px; /* altezza minima, ma si adatta */
}

nav button {
  background: none;
  border: none;
  font-size: 1em;
  cursor: pointer;
  color: var(--accent-color);
}

button, .save-btn {
  background-color: var(--accent-color);
}

/* CONTENUTO */
.category-list, .subcategory-list, .wine-list {
  padding: 0.5em 1em;
  padding: 80px 1em 0; /* fallback se JS non parte subito */
}

.category, .subcategory, .wine-card {
  background: inherit;
  margin-bottom: 0.6em;
  padding: 1em;
  border: 1px solid;
  border-radius: 12px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
  cursor: pointer;
}
.category:hover, .subcategory:hover, .wine-card:hover {
  transform: scale(1.02);
  transition: transform 0.2s ease;
}

.subcategory-list {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 1em;
}
.category-list {
  display: grid;
  grid-template-columns: 1fr;
  gap: 1em;
}
.subcategory {
  text-align: center;
}

/* BOTTONE SOMMELIER */
#sommelierBtn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: var(--accent-color);
  color: white;
  border: none;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  font-size: 1.5em;
  cursor: pointer;
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* TOOLTIP */
#tooltipSommelier {
  position: fixed;
  bottom: 90px;
  right: 20px;
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 12px;
  padding: 10px 15px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  font-size: 0.9em;
  animation: tooltipSlide 3s ease-in-out;
  z-index: 999;
  display: none;
}

/* POPUP SOMMELIER */
#sommelierOverlay {
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.25);
  z-index: 1000;
  display: none;
  justify-content: center;
  align-items: center;
}

#sommelierPopup {
  background: #fff;
  border-radius: 16px;
  padding: 30px;
  width: 90vw;
  max-width: 500px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.2);
  position: relative;
  animation: popupEnter 0.35s ease-out;
  max-height: 90vh;
  overflow-y: auto;
  overscroll-behavior: contain;
  scrollbar-width: thin;
}
#sommelierPopup h3 {
  margin-top: 0;
}
#sommelierPopup input {
  width: 100%;
  padding: 12px;
  font-size: 1em;
  border-radius: 8px;
  border: 1px solid #ccc;
  margin-top: 10px;
}
#sommelierPopup .close-btn {
  position: absolute;
  top: 10px;
  left: 10px;
  background: none;
  border: none;
  font-size: 1.2em;
  cursor: pointer;
}

/* ANIMAZIONI */
.fade-in {
  animation: fadeIn 0.4s ease forwards;
  opacity: 0;
}
.fade-out {
  animation: fadeOut 0.3s ease forwards;
  opacity: 1;
}
.sommelier-fadein {
  animation: fadeIn 0.5s ease both;
}
.sommelier-card {
  animation: fadeInUp 0.4s ease forwards;
  opacity: 0;
}
@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-5px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
@keyframes popupEnter {
  from {
    opacity: 0;
    transform: scale(0.95) translateY(20px);
  }
  to {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
}

@keyframes fadeIn {
  to { opacity: 1; }
}
@keyframes fadeOut {
  to { opacity: 0; display: none; }
}
@keyframes fadeInUp {
  from { transform: translateY(20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}
@keyframes fadeSlideIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes tooltipSlide {
  0% { opacity: 0; transform: translateY(10px); }
  50% { opacity: 1; transform: translateY(0); }
  100% { opacity: 0; transform: translateY(-10px); }
}

/* GLASS EFFECT */
.glass {
  background: rgba(255, 255, 255, 0.3);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  border: 1px solid rgba(255, 255, 255, 0.4);
}
.glass-dark {
  background: rgba(20, 20, 20, 0.3);
  backdrop-filter: blur(6px);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

/* RESPONSIVE */
@media (max-width: 768px) {
  .wine-card {
    font-size: 1em;
    padding: 1em;
  }
  #restaurantName {
    font-size: 1.1em;
  }
}

@media (max-width: 480px) {
  #wineTypeDropdown {
    min-width: 160px;
    font-size: 0.85em;
    padding: 6px;
  }

  #wineTypeDropdown label {
    display: block;
    margin-bottom: 6px;
  }

  #priceFilter {
    font-size: 0.95em;
  }
  .wine-card {
    font-size: 0.95em;
    padding: 0.8em;
  }
  #restaurantName {
    font-size: 1em;
    gap: 6px;
  }
  #sommelierPopup {
    padding: 20px 16px;
    width: 95vw;
    border-radius: 12px;
  }
  .sommelier-card {
    font-size: 0.95em;
  }
  .vino-header {
    flex-direction: column;
    align-items: flex-start;
  }
#sommelierPopup input {
  font-size: 1em;
  max-width: 100%;
  box-sizing: border-box;
}
    nav {
    padding: 0.3em 0.6em;
    height: auto !important;
  }

  #restaurantLogo {
    max-height: 120px;
  }

  #restaurantName {
    font-size: 1em !important;
    gap: 6px;
    flex-direction: column;
  }

  .category, .subcategory, .wine-card {
    font-size: 0.95em;
    padding: 0.8em;
  }
}
</style>
</head>
<body>
<nav>
  <button onclick="goBack()">‚¨Ö</button>
  <div style="flex: 1; display: flex; justify-content: center;">
    <div id="restaurantName"><span>CARTA DEI VINI</span></div>
  </div>
    <select id="langSelector" onchange="changeLanguage()" style="margin-left: 10px; font-size: 0.9em;">
    <option value="it">üáÆüáπ</option>
    <option value="en">üá¨üáß</option>
    <option value="fr">üá´üá∑</option>
    <option value="de">üá©üá™</option>
    <option value="es">üá™üá∏</option>
    <option value="zh">üá®üá≥</option>
  </select>
</nav>

<div id="app" class="flipbook">
  <div class="category-list page" id="category-list"></div>
  <div class="subcategory-list page" id="subcategory-list"></div>
  <div class="wine-list page" id="wine-list"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script type="module">
const translations = {
  it: {
    wineList: "Carta dei Vini",
    grape: "Uvaggio",
    price: "Prezzo",
    sommelierTitle: "Il nostro sommelier ti consiglia:",
    noDescription: "Nessuna descrizione trovata.",
    filterPrice: "Filtra per prezzo",
    filterCategory: "Filtra per categoria",
    searchLabel: "Ricerca piatti per abbinamento",
    sendButton: "INVIA",
    allLabel: "Tutti",
    placeholder: "Separa piatti con le virgole.",
    loadingDescription: "Sto caricando una descrizione...",
    emptyInput: "Inserisci un piatto!",
    thinking: "Sto pensando...",
    noMatch: "Non ho trovato nessun abbinamento per questi piatti...",
    alreadyAsked: "Hai gi√† chiesto per:",
    sommelierFooter: "Il tuo Sommelier Virtuale üç∑",
    sommelierTitleBox: "Dimmi cosa mangerai e ti suggerir√≤ il vino perfetto!",
    sommelierTooltip: "Fatti dare una mano con l‚Äôabbinamento vino-cibo",
  },
  en: {
    wineList: "Wine List",
    grape: "Grape variety",
    price: "Price",
    sommelierTitle: "Our sommelier recommends:",
    noDescription: "No description available.",
    filterPrice: "Filter by price",
    filterCategory: "Filter by category",
    searchLabel: "Pairing dish search",
    sendButton: "SEND",
    allLabel: "All",
    placeholder: "Separate dishes with commas.",
    loadingDescription: "Loading a description...",
    emptyInput: "Please enter a dish!",
    thinking: "Thinking...",
    noMatch: "I couldn't find a match for these dishes...",
    alreadyAsked: "You already asked for:",
    sommelierFooter: "Your Virtual Sommelier üç∑",
    sommelierTitleBox: "Tell me what you'll eat and I'll suggest the perfect wine!",
    sommelierTooltip: "Let me help with wine & food pairing",
  },
  fr: {
    wineList: "Carte des Vins",
    grape: "C√©page",
    price: "Prix",
    sommelierTitle: "Notre sommelier vous recommande :",
    noDescription: "Aucune description disponible.",
    filterPrice: "Filtrer par prix",
    filterCategory: "Filtrer par cat√©gorie",
    searchLabel: "Recherche de plats √† associer",
    sendButton: "ENVOYER",
    allLabel: "Tous",
    placeholder: "S√©parez les plats avec des virgules.",
    loadingDescription: "Chargement de la description...",
    emptyInput: "Veuillez saisir un plat !",
    thinking: "Je r√©fl√©chis...",
    noMatch: "Aucun accord trouv√© pour ces plats...",
    alreadyAsked: "Vous avez d√©j√† demand√© pour :",
    sommelierFooter: "Votre Sommelier Virtuel üç∑",
    sommelierTitleBox: "Dites-moi ce que vous mangez et je vous sugg√®re le vin id√©al !",
    sommelierTooltip: "Laissez-moi vous aider √† associer vins et mets",
  },
  de: {
    wineList: "Weinkarte",
    grape: "Rebsorte",
    price: "Preis",
    sommelierTitle: "Unser Sommelier empfiehlt:",
    noDescription: "Keine Beschreibung verf√ºgbar.",
    filterPrice: "Nach Preis filtern",
    filterCategory: "Nach Kategorie filtern",
    searchLabel: "Gerichte zum Kombinieren suchen",
    sendButton: "SENDEN",
    allLabel: "Alle",
    placeholder: "Trenne Gerichte mit Kommas.",
    loadingDescription: "Beschreibung wird geladen...",
    emptyInput: "Bitte ein Gericht eingeben!",
    thinking: "Ich denke nach...",
    noMatch: "Keine passende Empfehlung gefunden...",
    alreadyAsked: "Du hast bereits gefragt nach:",
    sommelierFooter: "Dein virtueller Sommelier üç∑",
    sommelierTitleBox: "Sag mir, was du isst, und ich empfehle dir den perfekten Wein!",
    sommelierTooltip: "Ich helfe dir bei der Weinauswahl zum Essen",
  },
  es: {
    wineList: "Carta de Vinos",
    grape: "Variedad de uva",
    price: "Precio",
    sommelierTitle: "Nuestro sumiller recomienda:",
    noDescription: "No hay descripci√≥n disponible.",
    filterPrice: "Filtrar por precio",
    filterCategory: "Filtrar por categor√≠a",
    searchLabel: "Buscar platos para maridar",
    sendButton: "ENVIAR",
    allLabel: "Todos",
    placeholder: "Separe los platos con comas.",
    loadingDescription: "Cargando descripci√≥n...",
    emptyInput: "¬°Introduce un plato!",
    thinking: "Pensando...",
    noMatch: "No encontr√© una combinaci√≥n para esos platos...",
    alreadyAsked: "Ya preguntaste por:",
    sommelierFooter: "Tu Sumiller Virtual üç∑",
    sommelierTitleBox: "Dime qu√© comer√°s y te sugiero el vino perfecto",
    sommelierTooltip: "Te ayudo con el maridaje vino-comida",
  },
  zh: {
    wineList: "ÈÖíÂçï",
    grape: "Ëë°ËêÑÂìÅÁßç",
    price: "‰ª∑Ê†º",
    sommelierTitle: "Êàë‰ª¨ÁöÑ‰æçÈÖíÂ∏àÊé®ËçêÔºö",
    noDescription: "ÊöÇÊó†ÊèèËø∞„ÄÇ",
    filterPrice: "Êåâ‰ª∑Ê†ºÁ≠õÈÄâ",
    filterCategory: "ÊåâÁ±ªÂà´Á≠õÈÄâ",
    searchLabel: "Êü•ÊâæÂèØÊê≠ÈÖçÁöÑËèúÂìÅ",
    sendButton: "ÂèëÈÄÅ",
    allLabel: "ÂÖ®ÈÉ®",
    placeholder: "Áî®ÈÄóÂè∑ÂàÜÈöîËèúÂìÅ„ÄÇ",
    loadingDescription: "Ê≠£Âú®Âä†ËΩΩÊèèËø∞...",
    emptyInput: "ËØ∑ËæìÂÖ•‰∏ÄÈÅìËèúÔºÅ",
    thinking: "ÊÄùËÄÉ‰∏≠...",
    noMatch: "Êú™ÊâæÂà∞‰∏éËøô‰∫õËèúÂìÅÂåπÈÖçÁöÑÈÖí...",
    alreadyAsked: "‰Ω†Â∑≤ÁªèÊü•ËØ¢ËøáÔºö",
    sommelierFooter: "ÊÇ®ÁöÑËôöÊãü‰æçÈÖíÂ∏à üç∑",
    sommelierTitleBox: "ÂëäËØâÊàë‰Ω†Ë¶ÅÂêÉ‰ªÄ‰πàÔºåÊàë‰ºöÊé®ËçêÊúÄÈÄÇÂêàÁöÑÈÖíÔºÅ",
    sommelierTooltip: "ÊàëÂèØ‰ª•Â∏Æ‰Ω†ÈÄâÊã©Êê≠ÈÖçÁöÑËë°ËêÑÈÖí",
  }
};

  function getContrastingTextColor(bgColor) {
  if (!bgColor) return "#000000";
  const hex = bgColor.replace("#", "");
  if (hex.length !== 6) return "#000000"; // fallback per codici non validi
  const r = parseInt(hex.substring(0, 2), 16);
  const g = parseInt(hex.substring(2, 4), 16);
  const b = parseInt(hex.substring(4, 6), 16);
  const brightness = (r * 299 + g * 587 + b * 114) / 1000;
  return brightness > 150 ? "#000000" : "#ffffff";
}

const SUPABASE_URL = "https://ldunvbftxhbtuyabgxwh.supabase.co";
const SUPABASE_API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkdW52YmZ0eGhidHV5YWJneHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0NTMyOTYsImV4cCI6MjA2MjAyOTI5Nn0.0hjJASFktfHZHjVQzX9bq8xGBrf7o1Fya6lqnA2tvPo";
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(SUPABASE_URL, SUPABASE_API_KEY);

const urlParams = new URLSearchParams(window.location.search);
let RESTAURANT_ID = urlParams.get("ristorante_id");

if (!RESTAURANT_ID) {
  const { data: { user }, error } = await supabase.auth.getUser();
  if (error || !user) {
    console.error("Utente non loggato, impossibile caricare la carta.");
  } else {
    RESTAURANT_ID = user.id;
  }
}

let wines = [];
let ristorante = null;
let ristoranteSommelierURL = null;
let currentCategory = '';
let currentView = 'categories';
let sommelierAperto = false;
let currentLang = "it"; // default

window.paletteColors = {
  background: null,
  cardBackground: null,
  borderColor: null,
  textColor: null,
  boxShadow: null
};

function changeLanguage() {
  currentLang = document.getElementById("langSelector").value;
  applyTranslations();
  showCategories();
  if (window.showSommelier === true) {
    setupSommelierUI();
  } else {
    const sommelierBtn = document.getElementById("sommelierBtn");
if (sommelierBtn && window.showSommelier === true) {
  sommelierBtn.style.display = "block";
}
    if (sommelierBtn) sommelierBtn.remove();
    const tooltip = document.getElementById("tooltipSommelier");
    if (tooltip) tooltip.remove();
  }
}
  window.changeLanguage = changeLanguage;

function applyTranslations() {
  const t = translations[currentLang];

  const foodInput = document.getElementById("foodInput");
if (foodInput && translations[currentLang].placeholder) {
  foodInput.placeholder = translations[currentLang].placeholder;
}

  // cambia titolo principale
  const titleEl = document.querySelector("#restaurantName span");
  if (titleEl) titleEl.textContent = t.wineList;

  // aggiorna descrizione popup (se presente)
  const descrEl = document.getElementById("descrizioneTesto");
  if (descrEl && descrEl.textContent.includes("Nessuna descrizione")) {
    descrEl.textContent = t.noDescription;
  }

  document.querySelectorAll('.wine-card').forEach(card => {
  const text = card.innerHTML;
  const match = text.match(/<small>.*?: (.*?)<\/small>/);
  const grapeValue = match?.[1] || "";

  const t = translations[currentLang];
  card.innerHTML = text.replace(/<small>.*?: .*?<\/small>/, `<small>${t.grape}: ${grapeValue}</small>`);
});
// Etichette translate-label
document.querySelectorAll(".translate-label").forEach(el => {
  const key = el.dataset.key;
  if (translations[currentLang][key]) {
    el.textContent = translations[currentLang][key];
  }
});

// Pulsante invia
const sendBtn = document.getElementById("sendFoodBtn");
if (sendBtn && translations[currentLang].sendButton) {
  sendBtn.textContent = translations[currentLang].sendButton;
}
const tooltip = document.getElementById("tooltipSommelier");
if (tooltip && translations[currentLang].sommelierTooltip) {
  tooltip.innerText = translations[currentLang].sommelierTooltip;
}

}

function aggiornaAltezzaNavbar() {
  const nav = document.querySelector("nav");
  const nameBlock = document.getElementById("restaurantName");

  if (!nav || !nameBlock) return;

  const rect = nameBlock.getBoundingClientRect();
  const height = rect.height + 20;

  nav.style.minHeight = height + "px";

  document.querySelectorAll(".category-list, .subcategory-list, .wine-list").forEach(el => {
    el.style.paddingTop = height + "px";
  });
  // Forza aggiornamento navbar anche da iframe dopo postMessage
window.addEventListener("message", (event) => {
  if (event.data?.action === "updateNameLive" || event.data?.action === "updateLogoLive") {
    setTimeout(() => aggiornaAltezzaNavbar(), 30);
  }
});
}

function toggleSommelier() {
  const useCustom = window.paletteOverrideLive || ristorante?.palette_color === "custom";
  const overlay = document.getElementById('sommelierOverlay');
    overlay.classList.remove("fade-out");
    overlay.classList.add("fade-in");
    overlay.style.display = 'flex';

  const popup = document.getElementById("sommelierPopup");
  const palette = window.ristorantePalette;
    if (popup) {

popup.style.backgroundColor = useCustom
  ? (ristorante.bg_color || "#ffffff")
  : (palette && window.paletteColors?.background) || "#ffffff";

popup.style.borderColor = useCustom
  ? (ristorante.border_color || "#cccccc")
  : (palette && window.paletteColors?.borderColor) || "#cccccc";

popup.style.color = useCustom
  ? getContrastingTextColor(ristorante.bg_color || "#ffffff")
  : (palette && window.paletteColors?.textColor) || "#000000";

popup.style.boxShadow = palette && window.paletteColors?.boxShadow || "0 2px 6px rgba(0,0,0,0.15)";
}

const input = document.getElementById("foodInput");
if (input) {
  input.style.backgroundColor = "#ffffff"; // sempre bianco
  input.style.color = "#000000"; // sempre nero
}

  const inputEl = document.getElementById('foodInput');
if (inputEl) inputEl.focus();
  history.pushState({ sommelier: true }, '', '#sommelier');
  sommelierAperto = true;
}

function closeSommelierPopup() {
const overlay = document.getElementById('sommelierOverlay');
if (overlay) {
  overlay.classList.remove("fade-in");
  overlay.classList.add("fade-out");
  setTimeout(() => {
    overlay.style.display = "none";
  }, 300);
}
const foodInput = document.getElementById('foodInput');
if (foodInput) foodInput.value = '';
const wineSuggestion = document.getElementById('wineSuggestion');
if (wineSuggestion) wineSuggestion.innerHTML = '';

  // Puliamo l‚ÄôURL (togliamo #sommelier) e azzeriamo lo stato
  if (location.hash === "#sommelier") {
    history.replaceState({}, '', location.pathname); // resetta l‚ÄôURL
  }
}

window.handleSommelierKey = function (e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    suggestWine();
    const input = document.getElementById('foodInput');
if (input) input.blur();
  }
}

function flipToPage(fromId, toId) {
const from = document.getElementById(fromId);
const to = document.getElementById(toId);

if (from && to) {
  from.classList.remove("flip-out");
  from.classList.add("flip-in");
  to.classList.remove("flip-in");
  to.classList.add("flip-out");
  setTimeout(() => {
    from.style.display = 'none';
    to.style.display = 'block';
  }, 600);
}
}

window.suggestWine = async function () {
  const paroleBloccate = [
    "come ti chiami", "come stai", "ciao", "chi sei", "sei reale", "sei umano",
    "parolacce", "cazzo", "merda", "stronzo", "scemo", "stupido", "ubriaco",
    "sposato", "fidanzato", "intelligenza", "chi ha vinto", "quanto costi", "gpt"
  ];
  const input = document.getElementById('foodInput').value.trim();
  const suggestion = document.getElementById('wineSuggestion');
  const inputLower = input.toLowerCase();
  const contieneOffensivo = paroleBloccate.some(p => inputLower.includes(p));

  if (contieneOffensivo) {
    suggestion.innerHTML = `
      <div style="background:#fff3f0; padding:15px; border-radius:12px; border:1px solid #ddd; color:#333; font-style:italic;">
        Per favore scrivimi il nome di un piatto, cos√¨ posso consigliarti il vino perfetto! üç∑
      </div>`;
    return;
  }

  if (!input) {
    suggestion.innerHTML = translations[currentLang].emptyInput;
    return;
  }

  suggestion.innerHTML = translations[currentLang].thinking;

try {
  const priceLimit = document.getElementById("priceFilter").value;
  const wineColorChecks = document.querySelectorAll("#wineTypeDropdown input[type='checkbox']");
  const wineColors = Array.from(wineColorChecks).filter(cb => cb.checked).map(cb => cb.value);

  const response = await fetch("https://ldunvbftxhbtuyabgxwh.functions.supabase.co/consiglia-vino", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      vini: wines,
      piatto: input,
      ristorante_id: RESTAURANT_ID,
      prezzo_massimo: priceLimit ? parseInt(priceLimit) : null,
      colori: wineColors
    })
  });


    const data = await response.json();
    const reply = data.suggestion || "";
    const rawBlocks = reply.split(/^- /m).map(b => b.trim()).filter(Boolean);

    const useCustom = window.paletteOverrideLive || ristorante?.palette_color === "custom";
const palette = window.ristorantePalette;

const popupBg = useCustom
  ? (ristorante.bg_color || "#ffffff")
  : (palette && window.paletteColors?.background) || "#ffffff";

const responseBg = useCustom
  ? (ristorante.card_color || "#ffffff")
  : (palette && window.paletteColors?.cardBackground) || "#ffffff";

const vignetteColor = useCustom
  ? (ristorante.border_color || "#cccccc")
  : (palette && window.paletteColors?.borderColor) || "#cccccc";

  const prezzoColor = getContrastingTextColor(responseBg);

  const vignetteTextColor = useCustom
  ? getContrastingTextColor(vignetteColor)
  : (palette && window.paletteColors?.textColor) || "#000000";

const textColor = useCustom
  ? getContrastingTextColor(responseBg)
  : (palette && window.paletteColors?.textColor) || "#000000";

const shadow = palette && window.paletteColors?.boxShadow || "0 2px 6px rgba(0,0,0,0.15)";

let cardsHtml = rawBlocks.map(block => {
  const lines = block.split(/\n/).map(l => l.trim()).filter(Boolean);
  const titleLine = lines[0] || "";
  const uvaggio = lines[1] || "";
  const motivazione = lines.slice(2).join(" ");

  const match = titleLine.match(/^(.*)\s+‚Ç¨?(\d+.*)$/);
  const nomeVino = match?.[1] || "";
  const prezzo = match?.[2] ? `‚Ç¨${match[2]}` : "";

  if (!nomeVino || !prezzo || !motivazione) return '';

return `
  <div class="sommelier-card" style="background:${responseBg}; border:1px solid ${vignetteColor}; border-radius:12px; padding:15px; margin-bottom:10px; box-shadow:0 2px 6px rgba(0,0,0,0.06); color: ${textColor};">
    <div class="vino-header" style="display:flex; justify-content:space-between; align-items:baseline; flex-wrap:wrap;">
      <div style="font-weight:600; font-size:1em; flex:1;">${nomeVino}</div>
      <div style="font-size:0.95em; color:${prezzoColor}; white-space:nowrap;">${prezzo}</div>
    </div>
    ${uvaggio ? `<div style="font-size:0.9em; color:#666; margin-top:4px;">Uvaggio: ${uvaggio}</div>` : ""}
    <div style="margin-top:10px; font-style:italic; font-size:0.95em;">${motivazione}</div>
  </div>`;
}).join('');

    if (!cardsHtml || cardsHtml.trim() === "") {
      suggestion.innerHTML = `
        <div style="background:${responseBg}; padding:15px; border-radius:12px; border:1px solid ${vignetteColor}; color: ${textColor}; font-style:italic;">${translations[currentLang].noMatch}</div>`;
      return;
    }

    aggiornaStorico(input);
    const storico = mostraStoricoNelSommelier();

suggestion.innerHTML = `
  <div class="sommelier-fadein" style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 20px;">
    <img id="sommelierAvatar"
        src="${ristoranteSommelierURL || 'sommelier.png'}"
        alt="Sommelier"
        style="width:64px; height:64px; border-radius:50%; object-fit:cover; box-shadow:0 0 6px rgba(0,0,0,0.1);">

    <div style="position: relative; background: ${responseBg}; border: 1px solid ${vignetteColor}; border-radius:16px; padding:16px 18px; max-width:80%; box-shadow: ${shadow}; color: ${textColor};">
      <div style="position: absolute; top: 20px; left: -10px; width: 0; height: 0; border-top: 10px solid transparent; border-bottom: 10px solid transparent; border-right: 10px solid ${vignetteColor};"></div>
      <strong style="color:${vignetteTextColor}; font-size: 1em;">${translations[currentLang].sommelierTitle}</strong>
      <div style="margin-top: 8px;">${cardsHtml}</div>
      ${storico}
      <div style="text-align:right; font-size:0.85em; color:${vignetteTextColor}; margin-top:8px;">${translations[currentLang].sommelierFooter}</div>
    </div>
  </div>
`;

  } catch (err) {
    console.error(err);
    suggestion.innerHTML = "Errore nel generare il suggerimento.";
  }
}

window.addEventListener('click', e => {
  const overlay = document.getElementById('sommelierOverlay');
  if (e.target === overlay) closeSommelierPopup();
});

window.addEventListener('popstate', (event) => {
  console.log("popstate event:", event.state);
  if (event.state?.sommelier || sommelierAperto) {
    closeSommelierPopup();
    sommelierAperto = false;
  }
});

async function loadRestaurantData() {
const res = await fetch(`${SUPABASE_URL}/rest/v1/ristoranti?select=sommelier_attivo,nome,font,palette_color,bg_color,card_color,border_color,text_color,logo_url,logo_size,sommelier_url,sommelier_range,sommelier_boost_multi,name_size,name_color,name_bold,name_font,navbar_color,ordine_vini,ordine_categorie,ordine_sottocategorie&id=eq.${RESTAURANT_ID}`, {
    headers: { 'apikey': SUPABASE_API_KEY, 'Accept': 'application/json' }
  });
  const data = await res.json();
  ristorante = data[0]; // senza const
  console.log("Dati ricevuti da Supabase:", data);
console.log("Campo sommelier_attivo:", ristorante?.sommelier_attivo);
  ristoranteSommelierURL = ristorante.sommelier_url || "sommelier.png";

if (ristorante.font) {
  document.body.style.fontFamily = ristorante.font;
  ensureFontLoaded(ristorante.font);
}

  if (ristorante.bg_color) {
  document.body.style.backgroundColor = ristorante.bg_color;
}

  if (ristorante.card_color) {
    document.querySelectorAll('.category, .subcategory, .wine-card').forEach(el => {
      el.style.backgroundColor = ristorante.card_color;
    });
  }

  if (ristorante.border_color) {
    document.querySelectorAll('.category, .subcategory, .wine-card').forEach(el => {
      el.style.borderColor = ristorante.border_color;
    });
}

const avatar = document.getElementById('sommelierAvatar');
if (avatar) {
  avatar.src = ristoranteSommelierURL;
}

if (ristorante) {
  const nameElem = document.getElementById("restaurantName");
  if (!nameElem) return;

  while (nameElem.firstChild) nameElem.removeChild(nameElem.firstChild);

  if (ristorante.logo_url) {
    const img = document.createElement('img');
    img.src = ristorante.logo_url + "?t=" + new Date().getTime();
    img.alt = ristorante.nome;
    img.id = "restaurantLogo";
    img.style.setProperty("height", (ristorante.logo_size || 40) + "px", "important");
    nameElem.appendChild(img);
  } else {
    const span = document.createElement('span');
    span.textContent = ristorante.nome || 'Carta dei Vini';
    span.style.fontFamily = ristorante.name_font || 'sans-serif';
    span.style.fontSize = (ristorante.name_size || 24) + "px";
    span.style.color = ristorante.name_color || "#000000";
    span.style.fontWeight = ristorante.name_bold ? "bold" : "normal";
    ensureFontLoaded(ristorante.name_font);
    nameElem.appendChild(span);
  }
  setTimeout(() => aggiornaAltezzaNavbar(), 20);
}

window.ristorantePalette = ristorante.palette_color;

if (ristorante.palette_color === "custom") {
  window.paletteOverrideLive = true;
  applyCustomBoxStyles();
} else {
  applyPalette(ristorante.palette_color);

  // Applica anche colori salvati (per palette predefinite)
  if (ristorante.bg_color) document.body.style.backgroundColor = ristorante.bg_color;
  if (ristorante.navbar_color) {
    const nav = document.querySelector("nav");
    if (nav) nav.style.backgroundColor = ristorante.navbar_color;
  }
}
}

window.goBack = function () {
  history.back();
}

function applyPalette(palette) {
  if (window.ristorantePalette === "custom") return;

  let primary = "#b00";
  let background = "#fff9f4";
  let cardBackground = "#ffffff";
  let borderColor = "#b00";
  let textColor = "#000000";
  let boxShadow = "0 2px 6px rgba(0, 0, 0, 0.15)"; // valore predefinito
  let navbarColor;
  
  switch (palette) {
    case "rosso":
      primary = "#b3001b";
      background = "#fff5f5";
      navbarColor = "#ffcccc";
      cardBackground = "#ffe5e5";
      borderColor = "#990014";
      textColor = "#330000";
      boxShadow = "0 2px 6px rgba(155, 28, 49, 0.2)";
      break;

    case "oro":
      primary = "#c29d2e";
      background = "#fffdf0";
      navbarColor = "#fdf2c0";
      cardBackground = "#fef6d8";
      borderColor = "#b38e2e";
      textColor = "#4a3b00";
      boxShadow = "0 2px 6px rgba(179, 142, 46, 0.25)";
      break;

    case "blu-elegante":
      primary = "#103d5e";
      background = "#f2f7fc";
      navbarColor = "#cce0f2";
      cardBackground = "#e4eff9";
      borderColor = "#0b2e4b";
      textColor = "#0b1c2d";
      boxShadow = "0 2px 6px rgba(16, 61, 94, 0.18)";
      break;

    case "verde-salvia":
      primary = "#4a715a";
      background = "#f4f9f5";
      navbarColor = "#e0f0e4";
      cardBackground = "#e5f1e8";
      borderColor = "#3a5948";
      textColor = "#273e32";
      boxShadow = "0 2px 6px rgba(74, 113, 90, 0.2)";
      break;

    case "grigio-minimal":
      primary = "#444";
      background = "#f7f7f7";
      navbarColor = "#eeeeee";
      cardBackground = "#ffffff";
      borderColor = "#cccccc";
      textColor = "#222222";
      boxShadow = "0 2px 5px rgba(100, 100, 100, 0.1)";
      break;

case "black-white":
  primary = "#1e1e1e";
  background = "#f7f7f7";
  navbarColor = "#1e1e1e";
  cardBackground = "#ffffff";
  borderColor = "#d0d0d0";
  textColor = "#111111";
  boxShadow = "0 2px 6px rgba(0,0,0,0.08)";
  break;

    case "crema-nero":
      primary = "#000000";
      background = "#fffaf0";
      navbarColor = "#fff3dd";
      cardBackground = "#ffffff";
      borderColor = "#000000";
      textColor = "#000000";
      boxShadow = "0 2px 6px rgba(0, 0, 0, 0.1)";
      break;

      case "tramonto":
      primary = "#e07b39";
      background = "#fff5ec";
      navbarColor = "#c65a1e";
      cardBackground = "#ffe3cc";
      borderColor = "#c65a1e";
      textColor = "#3e2c1b";
      boxShadow = "0 2px 6px rgba(224, 123, 57, 0.2)";
      break;

      case "notte-blu":
      primary = "#0b1c2d"; // blu scuro petrolio
      background = "#eff4f7";
      navbarColor = "#021639";        // Navbar leggermente pi√π chiara
      cardBackground = "#d8e3ec";
      borderColor = "#06131f";
      textColor = "#0a1a28";
      boxShadow = "0 2px 6px rgba(11, 28, 45, 0.25)";
      break;

      case "vino-rosso":
      primary = "#511627"; // vinaccia
      background = "#fcf6f8";
      navbarColor = "#6e003f";        // Navbar tono pi√π scuro
      cardBackground = "#f6e9ed";
      borderColor = "#3b101d";
      textColor = "#2c0d14";
      boxShadow = "0 2px 6px rgba(81, 22, 39, 0.25)";
      break;

      case "tortora":
      primary = "#7e7064";
      background = "#f8f5f2";
      navbarColor = "#d6ccc2";
      cardBackground = "#eeeae6";
      borderColor = "#6e6156";
      textColor = "#2e2b28";
      boxShadow = "0 2px 6px rgba(126, 112, 100, 0.15)";
      break;
  }

  // Applica colori dinamici
  document.body.style.backgroundColor = background;
  const cards = document.querySelectorAll('.category, .subcategory, .wine-card');
    cards.forEach(el => {
      el.classList.remove("glass", "glass-dark");
      el.style.backgroundColor = cardBackground;
      el.style.borderColor = borderColor;
      el.style.color = textColor;
      el.style.boxShadow = boxShadow;
    });
    
    const popup = document.getElementById("sommelierPopup");
    if (popup) {
      popup.style.backgroundColor = cardBackground;
      popup.style.borderColor = borderColor;
      popup.style.color = textColor;
      popup.style.boxShadow = boxShadow;
    }

    // Applica effetto vetro solo a palette selezionate
    if (["oro", "crema-nero"].includes(palette)) {
      cards.forEach(el => el.classList.add("glass"));
    }
    if (palette === "black-white") {
      cards.forEach(el => el.classList.add("glass-dark"));
    } 

  // Applica colore anche ai bottoni / elementi principali
  const backBtn = document.querySelector("nav button");
  if (backBtn) backBtn.style.color = primary;

const sommelierBtn = document.getElementById("sommelierBtn");
if (sommelierBtn && window.showSommelier === true) {
  sommelierBtn.style.backgroundColor = primary;
  sommelierBtn.style.borderColor = primary;
}
const nav = document.querySelector("nav");
if (nav) {
  nav.style.backgroundColor = typeof navbarColor !== "undefined" ? navbarColor : background;
}

window.paletteColors = {
  background,
  cardBackground,
  borderColor,
  textColor,
  boxShadow
};
}

function applyCustomBoxStyles() {
if (!ristorante) return;
if (ristorante.bg_color) document.body.style.backgroundColor = ristorante.bg_color;
  const bg = ristorante.card_color;
  const border = ristorante.border_color;
  const text = ristorante.text_color;

  document.querySelectorAll('.category, .subcategory, .wine-card').forEach(el => {
    if (bg) el.style.backgroundColor = bg;
    if (border) el.style.borderColor = border;
    if (text) el.style.color = text;
  });

  const popup = document.getElementById("sommelierPopup");
if (popup && ristorante) {
  if (ristorante.card_color) popup.style.backgroundColor = ristorante.card_color;
  if (ristorante.border_color) popup.style.borderColor = ristorante.border_color;
  if (ristorante.text_color) popup.style.color = ristorante.text_color;
}
const backBtn = document.querySelector("nav button");
if (backBtn && ristorante.border_color) {
  backBtn.style.color = ristorante.border_color;
}

const sommelierBtn = document.getElementById("sommelierBtn");
if (sommelierBtn) {
  if (ristorante.border_color) sommelierBtn.style.backgroundColor = ristorante.border_color;
  if (ristorante.border_color) sommelierBtn.style.borderColor = ristorante.border_color;
  if (ristorante.text_color) sommelierBtn.style.color = ristorante.text_color;
}
if (ristorante.navbar_color) {
  const nav = document.querySelector("nav");
  if (nav) nav.style.backgroundColor = ristorante.navbar_color;
}
}

function normalize(str) {
  return str ? str.toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu, "").trim() : '';
}

function goToCategories() {
  if (currentView !== 'categories') {
    history.pushState({ view: "categories" }, "");
  }
  currentView = 'categories';

  const catList = document.getElementById("category-list");
  const subcatList = document.getElementById("subcategory-list");
  const wineList = document.getElementById("wine-list");

  if (catList) catList.style.display = "block";
  if (subcatList) subcatList.style.display = "none";
  if (wineList) wineList.style.display = "none";
}

function showWinesBySubcategory(subcat) {
  currentView = 'wines';
  const wineList = document.getElementById('wine-list');
  if (wineList) wineList.style.display = 'block';
  wineList.innerHTML = '';
  const filtered = wines.filter(w => normalize(w.categoria) === normalize(currentCategory) && normalize(w.sottocategoria) === normalize(subcat));
  filtered.forEach(w => {
    const card = document.createElement('div');
card.className = 'wine-card';
const annata = w.annata ? ` (${w.annata})` : '';

const [produttore, denominazione] = (w.nome || "").split(" | ");
const produttoreUpper = (produttore || "").toUpperCase();
const t = translations[currentLang];
card.innerHTML = `<strong>${produttoreUpper} ${denominazione}${annata}</strong><br>
<em>${w.prezzo}</em><br>
<small>${t.grape}: ${w.uvaggio}</small>`;
    wineList.appendChild(card);
    card.onclick = () => {
  mostraPopupDescrizione(w); // w √® il vino cliccato
};
  });
    if (window.paletteOverrideLive && window.ristorantePalette === "custom") {
  applyCustomBoxStyles();
} else {
  applyPalette(window.ristorantePalette);
}

  const subcatList = document.getElementById('subcategory-list');
  if (subcatList) subcatList.style.display = 'none';
  wineList.style.display = 'block';
  history.pushState({ view: "wines", subcategory: subcat, category: currentCategory }, "");
}

async function loadWineData() {
  if (!RESTAURANT_ID) return;
  if (!ristorante) {
    console.error("Ristorante non caricato");
    return;
  }

  const res = await fetch(`${SUPABASE_URL}/rest/v1/wines?ristorante_id=eq.${RESTAURANT_ID}&visibile=is.true`, {
    headers: { 'apikey': SUPABASE_API_KEY, 'Accept': 'application/json' }
  });
  const json = await res.json();

wines = Array.isArray(json) ? json : [];

// Estrai categorie uniche dai vini
const categorieUniche = [];
wines.forEach(w => {
  const cat = w.categoria;
  if (cat && !categorieUniche.includes(cat)) {
    categorieUniche.push(cat);
  }
});

// Ordina alfabeticamente
if (Array.isArray(categoriaOrder) && categoriaOrder.length) {
  sortByOrder(categorieUniche, categoriaOrder);
}

console.log("Categorie disponibili per filtro:", categorieUniche);

switch ((ristorante.ordine_vini || 'prezzo')) {
  case 'prezzo':
    wines.sort((a, b) => {
      const priceA = parseFloat((a.prezzo || '').replace(/[^0-9,.]/g, '').replace(',', '.')) || 0;
      const priceB = parseFloat((b.prezzo || '').replace(/[^0-9,.]/g, '').replace(',', '.')) || 0;
      return priceA - priceB;
    });
    break;

  case 'annata':
    wines.sort((a, b) => (parseInt(a.annata) || 0) - (parseInt(b.annata) || 0));
    break;

  case 'nome':
    wines.sort((a, b) => (a.nome || '').localeCompare(b.nome || ''));
    break;

  case 'inserimento':
    // Nessun ordinamento, resta come arriva
    break;
}
}
async function setupSommelierUI() {
  // crea solo gli elementi una volta
  window.showSommelier = ristorante?.sommelier_attivo === true || ristorante?.sommelier_attivo === "true";
  if (!document.getElementById("sommelierBtn")) {
    creaUIBaseSommelier();
  }

  await aggiornaCategorieSommelier();
}
async function creaUIBaseSommelier() {
  const btn = document.createElement("button");
  btn.id = "sommelierBtn";
  btn.innerText = "üç∑";
  document.body.appendChild(btn);

    const tooltip = document.createElement("div");
    tooltip.id = "tooltipSommelier";
    tooltip.innerText = "Fatti dare una mano dal nostro sommelier artificiale";
    document.body.appendChild(tooltip);

    const overlay = document.createElement("div");
    overlay.id = "sommelierOverlay";
    overlay.innerHTML = `
      <div id="sommelierPopup" class="popup">
        <button class="close-btn" onclick="closeSommelierPopup()">‚úñ</button>
        <h3 class="translate-label" data-key="sommelierTitleBox">Dimmi cosa mangerai e io ti consiglier√≤ il vino giusto! üç∑</h3>
        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;">
          <div style="flex: 1 1 48%;">
            <label for="priceFilter" class="translate-label" data-key="filterPrice" style="font-size: 0.85em; display: block; margin-bottom: 4px;">Filtra per prezzo</label>
            <select id="priceFilter" style="width: 100%; padding: 8px; font-size: 0.95em; border-radius: 8px; border: 1px solid #ccc;">
              <option value="">Indifferente</option>
              <option value="25">Max ‚Ç¨25</option>
              <option value="35">Max ‚Ç¨35</option>
              <option value="45">Max ‚Ç¨45</option>
              <option value="60">Max ‚Ç¨60</option>
              <option value="100">Max ‚Ç¨100</option>
            </select>
          </div>
          <div style="flex: 1 1 48%; min-width: 0; position: relative;">
            <label style="font-size: 0.85em; display: block; margin-bottom: 4px;" class="translate-label" data-key="filterCategory">Filtra per categoria</label>
            <button type="button" onclick="toggleWineTypeDropdown()" id="categoryFilterBtn"
              style="width: 100%; max-width: 100%; overflow: hidden; padding: 8px; font-size: 0.95em; border-radius: 8px; border: 1px solid #ccc; background: #fff; appearance: none; text-align: left; position: relative; white-space: nowrap;">
              <span class="labelText"
                style="display:inline-block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: calc(100% - 24px); vertical-align: middle;">Tutti</span>
              <span style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-size: 0.8em;">‚ñº</span>
            </button>
          </div>
        </div>
        <div style="margin-top: 12px;">
          <label style="font-size: 0.85em; display: block; margin-bottom: 4px;" class="translate-label" data-key="searchLabel">Ricerca piatti per abbinamento</label>
          <div style="display: flex; background: white; border-radius: 999px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.08); width: 100%;">
            <input type="text" id="foodInput" placeholder="Separa piatti con le virgole." onkeydown="handleSommelierKey(event)" style="flex: 1; padding: 10px 14px; border: none; outline: none; font-size: 0.95em; background: transparent; line-height: 1.2; height: 40px; display: flex; align-items: center;" />
            <button id="sendFoodBtn" onclick="suggestWine()" style="padding: 0 16px; background: #999; color: white; border: none; font-size: 0.9em; font-weight: 500; cursor: pointer; display: none; transition: background 0.2s ease; border-radius: 999px;" class="translate-label" data-key="sendButton">INVIA</button>
          </div>
        </div>
        <div id="wineSuggestion" style="margin-top: 15px; font-size: 0.95em;"></div>
      </div>
    `;
    document.body.appendChild(overlay);

    const foodInput = document.getElementById("foodInput");
    const sendBtn = document.getElementById("sendFoodBtn");

    if (foodInput && sendBtn) {
      foodInput.addEventListener("input", () => {
        if (foodInput.value.trim().length > 0) {
          sendBtn.style.display = "inline-block";
        } else {
          sendBtn.style.display = "none";
        }
      });
    }

    const dropdown = document.createElement("div");
    dropdown.id = "wineTypeDropdown";
    dropdown.style.display = "none";
    document.body.appendChild(dropdown);

btn.addEventListener("click", () => {
  const overlay = document.getElementById("sommelierOverlay");
  if (overlay) {
    overlay.classList.remove("fade-out");     // ‚úÖ rimuove la vecchia animazione
    overlay.classList.add("fade-in");         // ‚úÖ forza animazione entrata
    overlay.style.display = "flex";
  }
});

  aggiornaEtichettaCategorie();
}

    window.closeSommelierPopup = function () {
      const overlay = document.getElementById("sommelierOverlay");
if (overlay) overlay.style.display = "none";
    };

  async function aggiornaCategorieSommelier() {
  const dropdown = document.getElementById("wineTypeDropdown");
  if (!dropdown || !Array.isArray(wines)) return;

  const categorieUniche = [...new Set(wines.map(w => w.categoria).filter(Boolean))];
  dropdown.innerHTML = "";

  for (const cat of categorieUniche) {
    const label = document.createElement("label");
    label.style.cssText = "display: flex; align-items: center; gap: 8px; margin-bottom: 6px;";

    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.value = cat;
    checkbox.checked = true;
    checkbox.onchange = aggiornaEtichettaCategorie;

    const span = document.createElement("span");
    span.textContent = cat;

    if (currentLang !== "it") {
      try {
        const res = await fetch("https://ldunvbftxhbtuyabgxwh.functions.supabase.co/traduci-categoria", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text: cat, targetLang: currentLang })
        });
        const data = await res.json();
        const translated = data.text?.trim() || cat;
        span.textContent = translated;
        checkbox.setAttribute("data-translated-label", translated);
      } catch (err) {
        checkbox.setAttribute("data-translated-label", cat);
      }
    } else {
      checkbox.setAttribute("data-translated-label", cat);
    }

    label.appendChild(checkbox);
    label.appendChild(span);
    dropdown.appendChild(label);
  }

  aggiornaEtichettaCategorie();
}

let reorderMode = null;
let reorderType = null;
let categoriaOrder = [];
let sottocategoriaOrderMap = {};

window.addEventListener("message", (event) => {
  if (event.data?.action === "updateFontLive") {
  const font = event.data.font;
  if (font) {
    document.body.style.fontFamily = font;
    ensureFontLoaded(font);
  }
  window.paletteOverrideLive = true;
}

if (event.data?.action === "updatePaletteLive") {
  const { palette, bgColor, cardColor, borderColor, textColor, navbarColor } = event.data;
  window.paletteOverrideLive = true;

  const nav = document.querySelector("nav");
  if (nav && navbarColor) {
    nav.style.backgroundColor = navbarColor;
  }

  if (palette === "custom") {
    if (!ristorante) ristorante = {};

    ristorante.bg_color = bgColor;
    ristorante.card_color = cardColor;
    ristorante.border_color = borderColor;
    ristorante.text_color = textColor;
    ristorante.navbar_color = navbarColor;

    if (bgColor) document.body.style.backgroundColor = bgColor;

    document.querySelectorAll('.category, .subcategory, .wine-card').forEach(el => {
      if (cardColor) el.style.backgroundColor = cardColor;
      if (borderColor) el.style.borderColor = borderColor;
      if (textColor) el.style.color = textColor;
    });

    const popup = document.getElementById("sommelierPopup");
    if (popup) {
      if (cardColor) popup.style.backgroundColor = cardColor;
      if (borderColor) popup.style.borderColor = borderColor;
      if (textColor) popup.style.color = textColor;
    }

    const backBtn = document.querySelector("nav button");
    if (backBtn && borderColor) {
      backBtn.style.color = borderColor;
    }

    const sommelierBtn = document.getElementById("sommelierBtn");
    if (sommelierBtn) {
      if (borderColor) sommelierBtn.style.backgroundColor = borderColor;
      if (borderColor) sommelierBtn.style.borderColor = borderColor;
      if (textColor) sommelierBtn.style.color = textColor;
    }

  } else {
    window.paletteOverrideLive = false;
    window.ristorantePalette = palette;
    applyPalette(palette);
  }
if (palette !== "custom" && nav) {
  let fallbackColor;

  switch (palette) {
    case "rosso": fallbackColor = "#ffcccc"; break;
    case "oro": fallbackColor = "#fdf2c0"; break;
    case "blu-elegante": fallbackColor = "#cce0f2"; break;
    case "verde-salvia": fallbackColor = "#e0f0e4"; break;
    case "grigio-minimal": fallbackColor = "#eeeeee"; break;
    case "black-white": fallbackColor = "#1a1a1a"; break;
    case "crema-nero": fallbackColor = "#fff3dd"; break;
    case "tramonto": fallbackColor = "#c65a1e"; break;
    case "notte-blu": fallbackColor = "#021639"; break;
    case "vino-rosso": fallbackColor = "#6e003f"; break;
    case "tortora": fallbackColor = "#d6ccc2"; break;
    default: fallbackColor = "#ffffff"; // Fallback finale
  }

  nav.style.backgroundColor = fallbackColor;
}

}

  if (event.data?.action === "checkSubcategoryContext") {
    const allowed = currentView === "subcategory" && currentCategory;
    parent.postMessage({ action: "subcatReady", allowed }, "*");
  }

  if (event.data?.action === "updateLogoLive") {
  let logo = document.getElementById("restaurantLogo");
  const nav = document.querySelector("nav");

if (!logo && event.data.logoUrl) {
  logo = document.createElement("img");
  logo.id = "restaurantLogo";
  logo.style.display = "block";

  // ‚úÖ Ricrea il contenuto del nav con il bottone goBack incluso
  nav.innerHTML = `
    <button onclick="goBack()">‚¨Ö</button>
    <div style="flex: 1; display: flex; justify-content: center;">
      <div id="restaurantName"></div>
    </div>
  `;
  document.getElementById("restaurantName").appendChild(logo);
  setTimeout(() => aggiornaAltezzaNavbar(), 50);
}

  if (logo) {
    if (event.data.logoUrl) logo.src = event.data.logoUrl;
    if (event.data.size) {
      logo.style.height = event.data.size + "px";
      setTimeout(() => aggiornaAltezzaNavbar(), 30);
    }

    if (event.data.border) {
      logo.style.border = "2px solid " + event.data.borderColor;
      logo.style.borderRadius = "8px";
      logo.style.padding = "4px";
    } else {
      logo.style.border = "none";
            logo.style.padding = "0";
    }
  }
}

  if (event.data?.action === "updateNameLive") {
const nameSpan = document.querySelector("#restaurantName span");
if (nameSpan) {
  nameSpan.style.fontFamily = event.data.font || "sans-serif";
  nameSpan.style.fontSize = event.data.size + "px";
  nameSpan.style.color = event.data.color;
  nameSpan.style.fontWeight = event.data.bold ? "bold" : "normal";
  nameSpan.textContent = event.data.name || "Carta dei Vini";

  ensureFontLoaded(event.data.font);

  // Aspetta il prossimo repaint per avere le dimensioni corrette
  setTimeout(() => {
    aggiornaAltezzaNavbar();
  }, 50);
}}


  if (event.data?.action === "startReorder") {
    reorderMode = true;
    reorderType = event.data.type;

    if (reorderType === "categorie") {
      const container = document.getElementById("category-list");
      [...container.children].forEach(el => {
        el.style.cursor = "grab";
        el.innerHTML = `<span style='opacity:0.5;margin-right:0.5em;'>‚ò∞</span>${el.innerHTML}`;
      });

      new Sortable(container, {
        animation: 150,
        ghostClass: 'sortable-ghost'
      });
    } else if (reorderType === "sottocategorie") {
      const subContainer = document.getElementById("subcategory-list");
      [...subContainer.children].forEach(el => {
        el.style.cursor = "grab";
        el.innerHTML = `<span style='opacity:0.5;margin-right:0.5em;'>‚ò∞</span>${el.innerHTML}`;
      });

      new Sortable(subContainer, {
        animation: 150,
        ghostClass: 'sortable-ghost'
      });
    }
  }

  if (event.data?.action === "getReorder") {
    if (reorderType === "categorie") {
      const container = document.getElementById("category-list");
      const ordine = [...container.children].map(el =>
  el.textContent.replace(/^‚ò∞\s*/, '').trim()
);
      parent.postMessage({ action: "saveReorder", type: "categorie", ordine }, "*");
    } else if (reorderType === "sottocategorie") {
      const subContainer = document.getElementById("subcategory-list");
      const ordine = [...subContainer.children].map(el =>
  el.textContent.replace(/^‚ò∞\s*/, '').trim()
);
      const sottocategorieMap = { [currentCategory]: ordine };
      parent.postMessage({ action: "saveReorder", type: "sottocategorie", sottocategorieMap }, "*");
    }
  }
});

async function fetchCategoryOrder() {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/ristoranti?id=eq.${RESTAURANT_ID}`, {
    headers: { 'apikey': SUPABASE_API_KEY, 'Accept': 'application/json' }
  });
  const data = await res.json();
  const ristorante = data[0];

  // Normalizza le categorie
  categoriaOrder = (ristorante.ordine_categorie || []).map(normalize);

  // Normalizza le sottocategorie
  const rawMap = ristorante.ordine_sottocategorie || {};
  sottocategoriaOrderMap = {};
  for (const [key, value] of Object.entries(rawMap)) {
    const normalizedKey = normalize(key);
    sottocategoriaOrderMap[normalizedKey] = Array.isArray(value)
      ? value.map(normalize)
      : [];
  }

  console.log("Ordine categorie:", categoriaOrder);
  console.log("Mappa sottocategorie:", sottocategoriaOrderMap);
}

function sortByOrder(array, orderArray) {
  return array.sort((a, b) => {
    const i1 = orderArray.indexOf(normalize(a));
    const i2 = orderArray.indexOf(normalize(b));
    if (i1 === -1) return 1;
    if (i2 === -1) return -1;
    return i1 - i2;
  });
}

// override showCategories and showSubcategories to apply order
const originalShowCategories = window.showCategories;
const originalShowSubcategories = window.showSubcategories;

window.showCategories = async function (categories) {
  const seen = new Map();
  wines.forEach(w => {
    const key = normalize(w.categoria);
    if (key && !seen.has(key)) {
      seen.set(key, w.categoria);
    }
  });

  let orderedKeys = Array.from(seen.keys());

  if (categoriaOrder.length) {
    const seenKeys = Array.from(seen.keys());
    const customOrder = categoriaOrder
      .map(name => {
        const normalized = normalize(name);
        return seenKeys.find(k => normalize(k) === normalized);
      })
      .filter(Boolean);

    if (customOrder.length > 0) {
      orderedKeys = customOrder;
    }
  }

  const catList = document.getElementById('category-list');
  if (catList) catList.style.display = 'none';
  container.innerHTML = '';
  for (const key of orderedKeys) {
    const display = seen.get(key);
    const div = document.createElement('div');
    div.className = 'category';
div.textContent = display;

try {
if (currentLang !== "it") {
  try {
    const res = await fetch("https://ldunvbftxhbtuyabgxwh.functions.supabase.co/traduci-categoria", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text: display, targetLang: currentLang })
    });
    const data = await res.json();
    const translated = data.text?.trim() || display;
    div.textContent = translated;
  } catch (e) {
    console.error("Errore GPT categorie:", e);
    div.textContent = display;
  }
}
} catch (e) {
  console.error("Errore GPT categorie:", e);
}

div.onclick = () => showSubcategories(key); // ‚úÖ SEMPRE fuori
container.appendChild(div);                 // ‚úÖ SEMPRE fuori

  }
  if (window.paletteOverrideLive && window.ristorantePalette === "custom") {
  applyCustomBoxStyles();
} else {
  applyPalette(window.ristorantePalette);
}
};

window.showSubcategories = function (category) {
  currentCategory = category;
  currentView = 'subcategory';
  const seen = new Map();
  wines.forEach(w => {
    if (normalize(w.categoria) === normalize(category)) {
      const key = normalize(w.sottocategoria);
      if (key && !seen.has(key)) {
        seen.set(key, w.sottocategoria);
      }
    }
  });

  let orderedKeys = Array.from(seen.keys());

  const order = Object.entries(sottocategoriaOrderMap).find(
    ([key]) => normalize(key) === normalize(category)
  )?.[1] || [];

if (Array.isArray(order) && order.length) {
  const seenKeys = Array.from(seen.keys());
  const customOrder = order
    .map(name => {
      const normalized = normalize(name);
      return seenKeys.find(k => normalize(k) === normalized);
    })
    .filter(Boolean);

  // Aggiungi eventuali sottocategorie nuove non presenti nell'ordine salvato
  const extra = seenKeys.filter(k => !customOrder.includes(k));
  orderedKeys = [...customOrder, ...extra];
}

  const container = document.getElementById('subcategory-list');
  container.innerHTML = '';
  for (const key of orderedKeys) {
    const display = seen.get(key);
    const div = document.createElement('div');
    div.className = 'subcategory';
    div.textContent = display.charAt(0).toUpperCase() + display.slice(1).toLowerCase();
    div.onclick = () => showWinesBySubcategory(key);
    container.appendChild(div);
  }
  if (window.paletteOverrideLive && window.ristorantePalette === "custom") {
  applyCustomBoxStyles();
} else {
  applyPalette(window.ristorantePalette);
}

    const catList = document.getElementById('category-list');
    if (catList) catList.style.display = 'none';
  container.style.display = 'grid';
  const wineList = document.getElementById('wine-list');
  if (wineList) wineList.style.display = 'none';
if (window._manualNavigation !== true) {
  history.pushState({ view: "subcategory", category }, "");
}
};

(async () => {
  await fetchCategoryOrder();
  await loadRestaurantData();
  await loadWineData(); // carica sempre i vini

const isSommelierOn = ristorante?.sommelier_attivo === true || ristorante?.sommelier_attivo === "true";
if (isSommelierOn) {
  setupSommelierUI(); // crea UI del sommelier
}

  // üîí Blocco la palette una volta per tutte
  const isCustom = ristorante.palette_color === "custom";
  window.paletteOverrideLive = isCustom;
  window.ristorantePalette = ristorante.palette_color;

  showCategories();
  history.replaceState({ view: "categories" }, "");

  if (isCustom) {
    applyCustomBoxStyles();
  } else {
    applyPalette(window.ristorantePalette);
  }
})();


let abbinamentiRecenti = JSON.parse(localStorage.getItem("abbinamenti_recenti") || "[]");
function aggiornaStorico(piatto) {
  if (!piatto) return;
  abbinamentiRecenti = abbinamentiRecenti.filter(p => p !== piatto);
  abbinamentiRecenti.unshift(piatto);
  if (abbinamentiRecenti.length > 5) abbinamentiRecenti.pop();
  localStorage.setItem("abbinamenti_recenti", JSON.stringify(abbinamentiRecenti));
}
function mostraStoricoNelSommelier() {
  if (!abbinamentiRecenti.length) return "";
  return `<div style='margin-top:20px; font-size:0.85em; color:#555;'>üîÅ Hai gi√† chiesto per: ` + abbinamentiRecenti.map(p => `<span onclick='ripetiAbbinamento("${p}")' style='cursor:pointer; color:#b00; margin-right:6px; text-decoration:underline;'>${p}</span>`).join(" ") + `</div>`;
}
function ripetiAbbinamento(piatto) {
  document.getElementById("foodInput").value = piatto;
  suggestWine();
}
  window.ripetiAbbinamento = ripetiAbbinamento;

function ensureFontLoaded(fontName) {
  if (!fontName || fontName === "custom") return;
  if (["sans-serif", "cursive", "monospace"].includes(fontName)) return;

  const fontId = "googleFont_" + fontName.replace(/\s+/g, "_");
  if (!document.getElementById(fontId)) {
    const link = document.createElement("link");
    link.id = fontId;
    link.rel = "stylesheet";
    const encoded = encodeURIComponent(fontName.trim()).replace(/%20/g, "+");
    link.href = `https://fonts.googleapis.com/css2?family=${encoded}&display=swap`;
    document.head.appendChild(link);
  }
}
function toggleWineTypeDropdown() {
  const dropdown = document.getElementById("wineTypeDropdown");
  const button = document.getElementById("categoryFilterBtn");

  if (!dropdown || !button) return;

  // Toggle display
  if (dropdown.style.display === "block") {
    dropdown.style.display = "none";
    return;
  }

  const rect = button.getBoundingClientRect();

  // ‚úÖ Scroll del documento + compensazione del popup scrollabile
  const popupScroll = document.getElementById("sommelierPopup")?.scrollTop || 0;
  const offsetTop = rect.bottom + window.scrollY;

  dropdown.style.position = "fixed";
  dropdown.style.top = `${offsetTop}px`;
  dropdown.style.left = `${rect.left}px`;
  dropdown.style.display = "block";
}
  window.toggleWineTypeDropdown = toggleWineTypeDropdown;

document.addEventListener("click", function (event) {
  const dropdown = document.getElementById("wineTypeDropdown");
  const button = document.getElementById("categoryFilterBtn");

  // Non chiudere se clicco sul bottone o dentro al menu
  if (
    dropdown.style.display === "block" &&
    !dropdown.contains(event.target) &&
    event.target !== button &&
    !button.contains(event.target)
  ) {
    dropdown.style.display = "none";
  }
});

function aggiornaEtichettaCategorie() {
  const allCheckboxes = document.querySelectorAll("#wineTypeDropdown input[type='checkbox']");
  const checked = Array.from(allCheckboxes).filter(cb => cb.checked).map(cb => cb.getAttribute("data-translated-label") || cb.value);
  const button = document.getElementById("categoryFilterBtn");

  const baseLabel = (checked.length === 0 || checked.length === allCheckboxes.length)
    ? translations[currentLang].allLabel
    : checked.slice(0, 3).join(', ') + (checked.length > 3 ? '‚Ä¶' : '');

  // ‚úÖ Non sostituire tutto l‚ÄôinnerHTML, modifica solo il contenuto testuale
  const textSpan = button.querySelector(".labelText");
  if (textSpan) textSpan.textContent = baseLabel;
}
window.addEventListener("popstate", (event) => {
  const state = event.state;

  window._manualNavigation = true; // ‚úÖ evita pushState

  if (!state || state.view === "categories") {
    goToCategories();
  } else if (state.view === "subcategory") {
    showSubcategories(state.category);
  } else if (state.view === "wines") {
    currentCategory = state.category;
    showWinesBySubcategory(state.subcategory);
  }

  setTimeout(() => window._manualNavigation = false, 100);
});
function mostraPopupDescrizione(vino) {
  const overlay = document.createElement("div");
  overlay.className = "popup-overlay";
  overlay.innerHTML = `
    <div class="popup-descrizione">
      <button class="close-btn" onclick="this.closest('.popup-overlay').remove()">‚úñ</button>
      <h3>${vino.nome}${vino.annata ? ` (${vino.annata})` : ""}</h3>
      <div id="descrizioneTesto">Sto caricando una descrizione...</div>
    </div>
  `;
  document.body.appendChild(overlay);

  fetch("https://ldunvbftxhbtuyabgxwh.functions.supabase.co/descrizione-vino", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
    nome: vino.nome,
    annata: vino.annata,
    uvaggio: vino.uvaggio,
    prezzo: vino.prezzo,
    ristorante_id: RESTAURANT_ID  // <-- questo era mancante!
  })
  })
  .then(res => res.json())
.then(async data => {
  const testoOriginale = data.descrizione || "Nessuna descrizione trovata.";

  if (currentLang === "it") {
    overlay.querySelector("#descrizioneTesto").innerText = testoOriginale;
  } else {
    // chiamata a OpenAI, DeepL o traduzione locale (esempio fittizio)
    try {
      const res = await fetch("https://ldunvbftxhbtuyabgxwh.functions.supabase.co/traduci-descrizione", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          text: testoOriginale,
          targetLang: currentLang
        })
      });
      const translated = await res.json();
      overlay.querySelector("#descrizioneTesto").innerText = `${translated.text || testoOriginale} [${currentLang}]`;
    } catch (err) {
      overlay.querySelector("#descrizioneTesto").innerText = testoOriginale + " ‚ö†Ô∏è (non tradotto)";
    }
  }
})
  .catch(() => {
    overlay.querySelector("#descrizioneTesto").innerText = "Errore durante il recupero della descrizione.";
  });
}

</script>
</body>
</html>
