<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestione Abbonamento</title>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.42.3/dist/umd/supabase.min.js"></script>
  <style>
    body {
      background-color: #fff9f4;
      font-family: 'Segoe UI', Tahoma, sans-serif;
      color: #333;
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }
    .container {
      background: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 600px;
      text-align: center;
    }
    h1 {
      color: #b00;
      margin-bottom: 20px;
      font-size: 1.8em;
    }
    .piani { display: flex; flex-direction: column; gap: 1.5rem; }
    .piano { border: 1px solid #ccc; border-radius: 12px; padding: 1.5rem; background-color: #fdfdfd; text-align: left; }
    .piano.attivo { border: 2px solid #b00; }
    .piano h2 { color: #b00; margin-bottom: 0.5em; }
    .piano ul { padding-left: 1.2em; margin: 0; }
    .piano ul li { margin-bottom: 8px; }
    .btn { padding: 10px 20px; margin-top: 15px; background-color: #b00; color: white; border: none; border-radius: 8px; font-size: 1em; cursor: pointer; }
    .btn.cancel { background-color: transparent; color: #999; font-size: 0.9em; border: none; margin-top: 2rem; }

    /* â€”â€”â€” MODAL â€”â€”â€” */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.4); display: none; align-items: center; justify-content: center; padding: 16px; z-index: 50; }
    .modal-backdrop.show { display: flex; }
    .modal { width: 100%; max-width: 560px; background: #fff; border-radius: 14px; box-shadow: 0 10px 30px rgba(0,0,0,.25); overflow: hidden; }
    .modal header { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; background: #faf6f3; border-bottom: 1px solid #eee; }
    .modal header h3 { margin: 0; font-size: 1.1rem; color: #b00; }
    .modal header button { background: transparent; border: 0; font-size: 1.4rem; line-height: 1; cursor: pointer; color: #777; }
    .modal .content { padding: 18px 20px; }
    .modal .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .modal label { display: block; margin: 8px 0 4px; font-weight: 600; }
    .modal input { width: 100%; padding: .7em; border-radius: 10px; border: 1px solid #ccc; }
    .modal .hint { font-size: .9em; opacity: .8; margin-top: .6em; }
    .modal footer { display: flex; gap: 10px; justify-content: flex-end; padding: 14px 20px 20px; }
    .btn.secondary { background: #eee; color: #333; }
    .field-error { color: #b00; font-size: .85em; margin-top: 4px; display:none; }
    .invalid input { border-color: #b00; }
    .invalid .field-error { display:block; }
    .topbar{  display:flex;  justify-content:space-between;  align-items:center;  gap:12px;  margin-bottom: 10px;}
    #backToDashboard{  font-size: 0.85em;  color: #b00;  text-decoration: none;}
    #backToDashboard:hover{ text-decoration: underline; }
    .lang-wrap{  display:flex;  align-items:center;  gap:8px;}
    .lang-wrap label{  margin:0;  font-size: 0.9em;  color:#555;}
    .lang-wrap select{  padding:6px 10px;  border-radius:10px;  border:1px solid #ccc;  background:#fff;}
  </style>
</head>
<body>
<div class="container">

  <div class="topbar">
    <a href="dashboard.html" id="backToDashboard">â† Torna alla Dashboard</a>

    <div class="lang-wrap">
      <label id="langLabel" for="langSelect">Lingua</label>
      <select id="langSelect">
        <option value="it">Italiano</option>
        <option value="en">English</option>
        <option value="fr">FranÃ§ais</option>
        <option value="es">EspaÃ±ol</option>
      </select>
    </div>
  </div>

  <h1 id="pageTitle">Gestione Abbonamento</h1>

    <div id="statusTrial" style="margin-bottom: 1rem; color: #555;"></div>

    <!-- â–¼ Piano cards -->
    <div class="piani">
      <div id="pianoBase" class="piano">
        <h2 data-i18n="base_title">Piano Base - 14,99â‚¬/mese</h2>
          <ul>
            <li data-i18n="base_li1">Accesso completo alla carta dei vini digitale</li>
            <li data-i18n="base_li2">Sommelier artificiale attivo (consigli illimitati)</li>
            <li data-i18n="base_li3">Personalizzazione base di colori e font</li>
            <li data-i18n="base_li4">Logo o nome del ristorante visibile</li>
            <li data-i18n="base_li5">Lingue supportate: ğŸ‡®ğŸ‡¹ Italiano, ğŸ‡¬ğŸ‡§ Inglese</li>
          </ul>
          <p data-i18n="base_note" style="margin-top: 1em; font-size: 0.9em; color: #999;">
            FunzionalitÃ  avanzate disponibili nel piano PRO
          </p>
          <button id="passaBase" class="btn" style="display:none" data-i18n="activate_base">Attiva Piano Base</button>

      </div>

      <div id="pianoPro" class="piano">
        <h2 data-i18n="pro_title">Piano PRO - 29,99â‚¬/mese</h2>
          <ul>
            <li data-i18n="pro_li1">Tutte le funzionalitÃ  del piano base</li>
            <li data-i18n="pro_li2">Logo personalizzato del sommelier</li>
            <li data-i18n="pro_li3">Selezione del numero di vini da consigliare</li>
            <li data-i18n="pro_li4">PossibilitÃ  di spingere vini in evidenza</li>
            <li data-i18n="pro_li5">Caricamento carta dei vini tramite OCR (PDF o immagine)</li>
            <li data-i18n="pro_li6">Supporto multilingua completo: ğŸ‡«ğŸ‡· ğŸ‡©ğŸ‡ª ğŸ‡ªğŸ‡¸ ğŸ‡¨ğŸ‡³</li>
            <li data-i18n="pro_li7">Branding avanzato e stile personalizzato</li>
          </ul>
          <button id="passaPro" class="btn" style="display:none" data-i18n="switch_to_pro">Passa al Piano PRO</button>

      </div>
    </div>

    <button id="annullaAbbonamento" class="btn cancel" data-i18n="cancel_subscription">Annulla abbonamento</button>
  </div>

  <!-- â–¼ MODAL: Dati fatturazione -->
  <div id="b2bModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal" role="document">
      <header>
        <h3 id="modalTitle" data-i18n="modal_title">Dati fatturazione (solo aziende)</h3>
          <button id="closeModal" aria-label="Chiudi" data-i18n-aria="close">Ã—</button>

      </header>
      <div class="content">
        <div class="field" id="fBusinessName">
          <label for="businessName" data-i18n="business_name">Ragione sociale*</label>
          <input id="businessName" placeholder="OSTERIA SRL" autocomplete="organization" data-i18n-placeholder="business_name_ph" />
          <div class="field-error" data-i18n="required">Obbligatorio.</div>
        </div>

        <div class="field" id="fVat">
          <label for="vat" data-i18n="vat_label">Partita IVA* <small>(IT###########)</small></label>
          <input id="vat" placeholder="IT12345678901" autocomplete="off" />
          <div class="field-error" data-i18n="vat_err">Formato atteso: IT + 11 cifre.</div>
        </div>

        <div class="grid">
          <div class="field" id="fSdi">
            <label for="sdi" data-i18n="sdi_label">Codice SDI <small>(oppure PEC)</small></label>
            <input id="sdi" maxlength="7" placeholder="ABCDEF1" autocomplete="off" />
            <div class="field-error" data-i18n="sdi_err">Deve avere 7 caratteri.</div>
          </div>
          <div class="field" id="fPec">
            <label for="pec" data-i18n="pec_label">PEC <small>(oppure SDI)</small></label>
            <input id="pec" type="email" placeholder="amministrazione@pec.azienda.it" />
            <div class="field-error" data-i18n="pec_err">Inserisci una PEC valida.</div>
          </div>
        </div>
        <p class="hint" data-i18n="modal_hint">* Campi obbligatori. Inserisci <b>SDI</b> <em>oppure</em> <b>PEC</b>.</p>
      </div>
      <footer>
        <button class="btn secondary" id="cancelModal" data-i18n="modal_cancel">Annulla</button>
        <button class="btn" id="continueModal" data-i18n="modal_continue">Continua</button>
      </footer>
    </div>
  </div>

  <script>
    const sb = window.supabase.createClient(
      "https://ldunvbftxhbtuyabgxwh.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkdW52YmZ0eGhidHV5YWJneHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0NTMyOTYsImV4cCI6MjA2MjAyOTI5Nn0.0hjJASFktfHZHjVQzX9bq8xGBrf7o1Fya6lqnA2tvPo"
    );

    if (window.location.hash === "#") { history.replaceState(null, "", window.location.pathname); }

    let RESTAURANT_ID;
    let SELECTED_PLAN = null;

    // ==========================
// i18n (Abbonamento)
// ==========================
const SUPPORTED_LANGS = ["it","en","fr","es"];
let currentLang = "it";

const TRANSLATIONS = {
  it: {
    language: "Lingua",
    back_dashboard: "â† Torna alla Dashboard",
    page_title: "Gestione Abbonamento",

    base_title: "Piano Base - 14,99â‚¬/mese",
    base_li1: "Accesso completo alla carta dei vini digitale",
    base_li2: "Sommelier artificiale attivo (consigli illimitati)",
    base_li3: "Personalizzazione base di colori e font",
    base_li4: "Logo o nome del ristorante visibile",
    base_li5: "Lingue supportate: ğŸ‡®ğŸ‡¹ Italiano, ğŸ‡¬ğŸ‡§ Inglese",
    base_note: "FunzionalitÃ  avanzate disponibili nel piano PRO",
    activate_base: "Attiva Piano Base",

    pro_title: "Piano PRO - 29,99â‚¬/mese",
    pro_li1: "Tutte le funzionalitÃ  del piano base",
    pro_li2: "Logo personalizzato del sommelier",
    pro_li3: "Selezione del numero di vini da consigliare",
    pro_li4: "PossibilitÃ  di spingere vini in evidenza",
    pro_li5: "Caricamento carta dei vini tramite OCR (PDF o immagine)",
    pro_li6: "Supporto multilingua completo: ğŸ‡«ğŸ‡· ğŸ‡©ğŸ‡ª ğŸ‡ªğŸ‡¸ ğŸ‡¨ğŸ‡³",
    pro_li7: "Branding avanzato e stile personalizzato",
    switch_to_pro: "Passa al Piano PRO",

    cancel_subscription: "Annulla abbonamento",

    // Stati
    choose_plan_title: "Scegli il tuo piano per continuare",
    no_active: "âš ï¸ Nessun abbonamento attivo.",
    active_sub: "âœ… Hai un abbonamento attivo.",

    // Modal
    modal_title: "Dati fatturazione (solo aziende)",
    close: "Chiudi",
    business_name: "Ragione sociale*",
    business_name_ph: "OSTERIA SRL",
    vat_label: "Partita IVA* <small>(IT###########)</small>",
    sdi_label: "Codice SDI <small>(oppure PEC)</small>",
    pec_label: "PEC <small>(oppure SDI)</small>",
    required: "Obbligatorio.",
    vat_err: "Formato atteso: IT + 11 cifre.",
    sdi_err: "Deve avere 7 caratteri.",
    pec_err: "Inserisci una PEC valida.",
    modal_hint: "* Campi obbligatori. Inserisci <b>SDI</b> <em>oppure</em> <b>PEC</b>.",
    modal_cancel: "Annulla",
    modal_continue: "Continua",

    // JS alerts / confirm / btn
    err_user_email: "Errore nel recupero dell'email dell'utente.",
    wait: "Attendiâ€¦",
    err_checkout: "Errore nella creazione del checkout.",
    network_err: "Errore di rete. Riprova.",
    confirm_cancel: "Sei sicuro di voler annullare l'abbonamento?",
    cancel_ok: "Abbonamento annullato correttamente.",
    err_generic: "Errore generico"
  },

  en: {
    language: "Language",
    back_dashboard: "â† Back to Dashboard",
    page_title: "Subscription",

    base_title: "Base Plan - â‚¬14.99/month",
    base_li1: "Full access to the digital wine list",
    base_li2: "AI sommelier enabled (unlimited suggestions)",
    base_li3: "Basic customization (colors & fonts)",
    base_li4: "Restaurant logo or name visible",
    base_li5: "Supported languages: ğŸ‡®ğŸ‡¹ Italian, ğŸ‡¬ğŸ‡§ English",
    base_note: "Advanced features are available in the PRO plan",
    activate_base: "Activate Base Plan",

    pro_title: "PRO Plan - â‚¬29.99/month",
    pro_li1: "All Base plan features",
    pro_li2: "Custom sommelier logo",
    pro_li3: "Choose how many wines to recommend",
    pro_li4: "Ability to push featured wines",
    pro_li5: "Upload wine list via OCR (PDF or image)",
    pro_li6: "Full multilingual support: ğŸ‡«ğŸ‡· ğŸ‡©ğŸ‡ª ğŸ‡ªğŸ‡¸ ğŸ‡¨ğŸ‡³",
    pro_li7: "Advanced branding and custom styling",
    switch_to_pro: "Switch to PRO Plan",

    cancel_subscription: "Cancel subscription",

    choose_plan_title: "Choose your plan to continue",
    no_active: "âš ï¸ No active subscription.",
    active_sub: "âœ… You have an active subscription.",

    modal_title: "Billing details (businesses only)",
    close: "Close",
    business_name: "Business name*",
    business_name_ph: "OSTERIA SRL",
    vat_label: "VAT number* <small>(IT###########)</small>",
    sdi_label: "SDI code <small>(or PEC)</small>",
    pec_label: "PEC email <small>(or SDI)</small>",
    required: "Required.",
    vat_err: "Expected format: IT + 11 digits.",
    sdi_err: "Must be 7 characters.",
    pec_err: "Enter a valid PEC email.",
    modal_hint: "* Required fields. Enter <b>SDI</b> <em>or</em> <b>PEC</b>.",
    modal_cancel: "Cancel",
    modal_continue: "Continue",

    err_user_email: "Error retrieving the user's email.",
    wait: "Please waitâ€¦",
    err_checkout: "Error creating checkout.",
    network_err: "Network error. Please try again.",
    confirm_cancel: "Are you sure you want to cancel the subscription?",
    cancel_ok: "Subscription canceled successfully.",
    err_generic: "Generic error"
  },

  fr: {
    language: "Langue",
    back_dashboard: "â† Retour au tableau de bord",
    page_title: "Abonnement",

    base_title: "Forfait Base - 14,99â‚¬/mois",
    base_li1: "AccÃ¨s complet Ã  la carte des vins digitale",
    base_li2: "Sommelier IA actif (conseils illimitÃ©s)",
    base_li3: "Personnalisation de base (couleurs et polices)",
    base_li4: "Logo ou nom du restaurant visible",
    base_li5: "Langues prises en charge : ğŸ‡®ğŸ‡¹ Italien, ğŸ‡¬ğŸ‡§ Anglais",
    base_note: "Les fonctionnalitÃ©s avancÃ©es sont disponibles dans le forfait PRO",
    activate_base: "Activer le forfait Base",

    pro_title: "Forfait PRO - 29,99â‚¬/mois",
    pro_li1: "Toutes les fonctionnalitÃ©s du forfait Base",
    pro_li2: "Logo du sommelier personnalisÃ©",
    pro_li3: "Choix du nombre de vins Ã  recommander",
    pro_li4: "PossibilitÃ© de mettre en avant des vins",
    pro_li5: "Import de la carte via OCR (PDF ou image)",
    pro_li6: "Support multilingue complet : ğŸ‡«ğŸ‡· ğŸ‡©ğŸ‡ª ğŸ‡ªğŸ‡¸ ğŸ‡¨ğŸ‡³",
    pro_li7: "Branding avancÃ© et style personnalisÃ©",
    switch_to_pro: "Passer au forfait PRO",

    cancel_subscription: "Annuler lâ€™abonnement",

    choose_plan_title: "Choisissez votre forfait pour continuer",
    no_active: "âš ï¸ Aucun abonnement actif.",
    active_sub: "âœ… Vous avez un abonnement actif.",

    modal_title: "DÃ©tails de facturation (entreprises uniquement)",
    close: "Fermer",
    business_name: "Raison sociale*",
    business_name_ph: "OSTERIA SRL",
    vat_label: "NÂ° TVA* <small>(IT###########)</small>",
    sdi_label: "Code SDI <small>(ou PEC)</small>",
    pec_label: "E-mail PEC <small>(ou SDI)</small>",
    required: "Obligatoire.",
    vat_err: "Format attendu : IT + 11 chiffres.",
    sdi_err: "Doit contenir 7 caractÃ¨res.",
    pec_err: "Saisissez un e-mail PEC valide.",
    modal_hint: "* Champs obligatoires. Saisissez <b>SDI</b> <em>ou</em> <b>PEC</b>.",
    modal_cancel: "Annuler",
    modal_continue: "Continuer",

    err_user_email: "Erreur lors de la rÃ©cupÃ©ration de lâ€™e-mail de lâ€™utilisateur.",
    wait: "Patientezâ€¦",
    err_checkout: "Erreur lors de la crÃ©ation du paiement.",
    network_err: "Erreur rÃ©seau. RÃ©essayez.",
    confirm_cancel: "ÃŠtes-vous sÃ»r de vouloir annuler lâ€™abonnement ?",
    cancel_ok: "Abonnement annulÃ© avec succÃ¨s.",
    err_generic: "Erreur gÃ©nÃ©rique"
  },

  es: {
    language: "Idioma",
    back_dashboard: "â† Volver al panel",
    page_title: "SuscripciÃ³n",

    base_title: "Plan Base - 14,99â‚¬/mes",
    base_li1: "Acceso completo a la carta de vinos digital",
    base_li2: "Sumiller IA activo (recomendaciones ilimitadas)",
    base_li3: "PersonalizaciÃ³n bÃ¡sica (colores y fuentes)",
    base_li4: "Logo o nombre del restaurante visible",
    base_li5: "Idiomas compatibles: ğŸ‡®ğŸ‡¹ Italiano, ğŸ‡¬ğŸ‡§ InglÃ©s",
    base_note: "Las funciones avanzadas estÃ¡n disponibles en el plan PRO",
    activate_base: "Activar Plan Base",

    pro_title: "Plan PRO - 29,99â‚¬/mes",
    pro_li1: "Todas las funciones del plan Base",
    pro_li2: "Logo del sumiller personalizado",
    pro_li3: "Elige cuÃ¡ntos vinos recomendar",
    pro_li4: "Posibilidad de destacar vinos",
    pro_li5: "Subida de carta mediante OCR (PDF o imagen)",
    pro_li6: "Soporte multilingÃ¼e completo: ğŸ‡«ğŸ‡· ğŸ‡©ğŸ‡ª ğŸ‡ªğŸ‡¸ ğŸ‡¨ğŸ‡³",
    pro_li7: "Branding avanzado y estilo personalizado",
    switch_to_pro: "Cambiar al Plan PRO",

    cancel_subscription: "Cancelar suscripciÃ³n",

    choose_plan_title: "Elige tu plan para continuar",
    no_active: "âš ï¸ No hay suscripciÃ³n activa.",
    active_sub: "âœ… Tienes una suscripciÃ³n activa.",

    modal_title: "Datos de facturaciÃ³n (solo empresas)",
    close: "Cerrar",
    business_name: "RazÃ³n social*",
    business_name_ph: "OSTERIA SRL",
    vat_label: "NIF/IVA* <small>(IT###########)</small>",
    sdi_label: "CÃ³digo SDI <small>(o PEC)</small>",
    pec_label: "Correo PEC <small>(o SDI)</small>",
    required: "Obligatorio.",
    vat_err: "Formato esperado: IT + 11 dÃ­gitos.",
    sdi_err: "Debe tener 7 caracteres.",
    pec_err: "Introduce un correo PEC vÃ¡lido.",
    modal_hint: "* Campos obligatorios. Introduce <b>SDI</b> <em>o</em> <b>PEC</b>.",
    modal_cancel: "Cancelar",
    modal_continue: "Continuar",

    err_user_email: "Error al obtener el email del usuario.",
    wait: "Esperaâ€¦",
    err_checkout: "Error al crear el checkout.",
    network_err: "Error de red. IntÃ©ntalo de nuevo.",
    confirm_cancel: "Â¿Seguro que quieres cancelar la suscripciÃ³n?",
    cancel_ok: "SuscripciÃ³n cancelada correctamente.",
    err_generic: "Error genÃ©rico"
  }
};

function normalizeLang(raw){
  const s = (raw || "").toLowerCase();
  if (s.startsWith("it")) return "it";
  if (s.startsWith("fr")) return "fr";
  if (s.startsWith("es")) return "es";
  return "en";
}

function t(key){
  const dict = TRANSLATIONS[currentLang] || TRANSLATIONS.en;
  return (dict && dict[key]) || (TRANSLATIONS.en && TRANSLATIONS.en[key]) || key;
}

function setLang(lang, persist=true){
  currentLang = SUPPORTED_LANGS.includes(normalizeLang(lang)) ? normalizeLang(lang) : "en";
  document.documentElement.lang = currentLang;

  if (persist){
    localStorage.setItem("wf_lang", currentLang);
    if (typeof RESTAURANT_ID === "string" && RESTAURANT_ID){
      localStorage.setItem(`wf_lang_${RESTAURANT_ID}`, currentLang);
    }
  }

  const sel = document.getElementById("langSelect");
  if (sel) sel.value = currentLang;

  applyTranslations();
}

function initLanguage(){
  const qp = new URLSearchParams(window.location.search);
  const langFromUrl = qp.get("lang");

  const perRest = (typeof RESTAURANT_ID === "string" && RESTAURANT_ID)
    ? localStorage.getItem(`wf_lang_${RESTAURANT_ID}`)
    : null;

  const saved = perRest || localStorage.getItem("wf_lang");
  const auto  = normalizeLang(navigator.language || "");

  setLang(langFromUrl || saved || auto, !saved);

  const sel = document.getElementById("langSelect");
  if (sel){
    sel.addEventListener("change", (e) => setLang(e.target.value, true));
  }

  // link back coerente
  const back = document.getElementById("backToDashboard");
  if (back && RESTAURANT_ID){
    back.href = `dashboard.html?ristorante_id=${RESTAURANT_ID}&lang=${currentLang}`;
    back.textContent = t("back_dashboard");
  }
}

function applyTranslations(){
  // title + h1
  document.title = t("page_title");
  const h1 = document.getElementById("pageTitle");
  if (h1) h1.textContent = t("page_title");

  // label lingua
  const langLbl = document.getElementById("langLabel");
  if (langLbl) langLbl.textContent = t("language");

  // data-i18n (testi semplici)
  document.querySelectorAll("[data-i18n]").forEach(el => {
    const key = el.getAttribute("data-i18n");
    // alcune stringhe contengono HTML (small/b/em)
    if (key === "vat_label" || key === "sdi_label" || key === "pec_label" || key === "modal_hint") {
      el.innerHTML = t(key);
    } else {
      el.textContent = t(key);
    }
  });

  // placeholders
  document.querySelectorAll("[data-i18n-placeholder]").forEach(el => {
    const key = el.getAttribute("data-i18n-placeholder");
    el.setAttribute("placeholder", t(key));
  });

  // aria-label
  document.querySelectorAll("[data-i18n-aria]").forEach(el => {
    const key = el.getAttribute("data-i18n-aria");
    el.setAttribute("aria-label", t(key));
  });

  // back link (testo + href sempre coerenti)
const back = document.getElementById("backToDashboard");
if (back && RESTAURANT_ID) {
  back.textContent = t("back_dashboard");
  back.href = `dashboard.html?ristorante_id=${RESTAURANT_ID}&lang=${currentLang}`;
}
}

    document.addEventListener("DOMContentLoaded", async () => {
      try {
        const { data: { user }, error } = await sb.auth.getUser();
        if (error || !user) return window.location.href = "/login.html";
        RESTAURANT_ID = user.id;
        initLanguage();          // <-- qui, ora che RESTAURANT_ID esiste
        mostraPianoUtente();

      } catch (err) {
        console.error("Errore nel caricamento utente:", err);
        return window.location.href = "/login.html";
      }

      // Modal wiring
      document.getElementById('closeModal').addEventListener('click', closeModal);
      document.getElementById('cancelModal').addEventListener('click', closeModal);
      document.getElementById('continueModal').addEventListener('click', onContinueFromModal);
      document.getElementById('b2bModal').addEventListener('click', (e) => { if (e.target.id === 'b2bModal') closeModal(); });
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });
    });

    async function mostraPianoUtente() {
      const { data, error } = await sb
        .from("ristoranti")
        .select("subscription_plan, subscription_status")
        .eq("id", RESTAURANT_ID)
        .single();

      if (error || !data) return;

      const { subscription_plan, subscription_status } = data;
      const base = document.getElementById("pianoBase");
      const pro = document.getElementById("pianoPro");
      const trialText = document.getElementById("statusTrial");

      if (!subscription_status) {
        document.getElementById("pageTitle").textContent = t("choose_plan_title");
        trialText.style.display = "none";
        document.getElementById("passaBase").style.display = "inline-block";
        document.getElementById("passaPro").style.display = "inline-block";
        document.getElementById("annullaAbbonamento").style.display = "none";
        // Bind buttons to OPEN MODAL
        bindPlanButtons();
        return;
      }

      if (subscription_status === "canceled") {
        trialText.textContent = t("no_active");
        document.getElementById("passaBase").style.display = "inline-block";
        document.getElementById("passaPro").style.display = "inline-block";
        bindPlanButtons();
        return;
      }

      if (subscription_status === "active") {
        trialText.textContent = t("active_sub");
      }

      if (subscription_plan === "pro") {
        pro.classList.add("attivo");
        document.getElementById("passaBase").style.display = "inline-block";
        bindPlanButtons();
      } else {
        base.classList.add("attivo");
        document.getElementById("passaPro").style.display = "inline-block";
        bindPlanButtons();
      }
    }

    function bindPlanButtons() {
      document.getElementById("passaPro").onclick = () => openModal('pro');
      document.getElementById("passaBase").onclick = () => openModal('base');
    }

    function openModal(plan) {
      SELECTED_PLAN = plan;
      clearFieldStates();
      document.getElementById('b2bModal').classList.add('show');
      document.getElementById('businessName').focus();
    }

    function closeModal() {
      document.getElementById('b2bModal').classList.remove('show');
      SELECTED_PLAN = null;
    }

    function clearFieldStates() {
      ['fBusinessName','fVat','fSdi','fPec'].forEach(id => document.getElementById(id).classList.remove('invalid'));
    }

    async function onContinueFromModal() {
      if (!SELECTED_PLAN) return closeModal();
      // Validazione client-side
      clearFieldStates();

      const businessName = document.getElementById("businessName").value.trim();
      let vat = document.getElementById("vat").value.trim().toUpperCase();
      const sdi = document.getElementById("sdi").value.trim().toUpperCase();
      const pec = document.getElementById("pec").value.trim();

      let hasError = false;
      if (!businessName) { document.getElementById('fBusinessName').classList.add('invalid'); hasError = true; }
      if (!vat) { document.getElementById('fVat').classList.add('invalid'); hasError = true; }
      if (!sdi && !pec) { document.getElementById('fSdi').classList.add('invalid'); document.getElementById('fPec').classList.add('invalid'); hasError = true; }
      if (vat && !vat.startsWith('IT')) vat = 'IT' + vat.replace(/\s+/g, '');
      if (vat && !/^IT\d{11}$/.test(vat)) { document.getElementById('fVat').classList.add('invalid'); hasError = true; }
      if (sdi && sdi.length !== 7) { document.getElementById('fSdi').classList.add('invalid'); hasError = true; }
      if (hasError) return;

      // Call backend (stessa logica di prima)
      const { data: { user }, error } = await sb.auth.getUser();
      if (error || !user || !user.email) return alert(t("err_user_email"));

      const btn = document.getElementById('continueModal');
      btn.disabled = true; btn.textContent = t("wait");
      try {
        const res = await fetch("/api/create-checkout", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({  plan: SELECTED_PLAN,  email: user.email,  businessName,  vat,  sdi,  pec,  ristorante_id: RESTAURANT_ID})
        });
        const json = await res.json();
        if (res.ok && json.url) {
          window.location.href = json.url;
        } else {
          alert(json.error || t("err_checkout"));
          console.error(json);
          btn.disabled = false; btn.textContent = t("modal_continue");
        }
      } catch (e) {
        alert(t("network_err"));
        btn.disabled = false; btn.textContent = t("modal_continue");
      }
    }

    document.getElementById("annullaAbbonamento").addEventListener("click", async () => {
      const confirmCancel = confirm(t("confirm_cancel"));
      if (!confirmCancel) return;

      const res = await fetch("https://ldunvbftxhbtuyabgxwh.supabase.co/functions/v1/cancel-subscription", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: RESTAURANT_ID })
      });

      const result = await res.json();
      if (!res.ok) return alert("Errore: " + (result.error || t("err_generic")));
      alert(t("cancel_ok"));
      window.location.reload();
    });
  </script>
</body>
</html>


