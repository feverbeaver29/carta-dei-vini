<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestisci Abbonamento</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 1rem;
      background-color: #f4f4f4;
    }
    .container {
      max-width: 600px;
      margin: auto;
      background: white;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .piani {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .piano {
      padding: 1rem;
      border: 2px solid #ccc;
      border-radius: 1rem;
    }
    .piano.attivo {
      border-color: #b00;
    }
    .btn {
      display: inline-block;
      padding: 0.5rem 1rem;
      margin-top: 1rem;
      border: none;
      border-radius: 0.5rem;
      background-color: #b00;
      color: white;
      cursor: pointer;
    }
    .btn.secondary {
      background-color: #ddd;
      color: #333;
    }
    .btn.cancel {
      background-color: transparent;
      color: #999;
      font-size: 0.9rem;
      border: none;
      margin-top: 2rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Gestisci Abbonamento</h1>
    <div class="piani">
      <div id="pianoBase" class="piano">
        <h2>Piano Base - 14,99€/mese</h2>
        <p>Include: accesso limitato, gestione vini base</p>
        <button id="passaBase" class="btn" style="display:none">Passa al Piano Base</button>
      </div>
      <div id="pianoPro" class="piano">
        <h2>Piano PRO - 29,99€/mese</h2>
        <p>Include: tutte le funzionalità del piano base + funzioni avanzate</p>
        <button id="passaPro" class="btn" style="display:none">Passa al Piano PRO</button>
      </div>
    </div>
    <button id="annullaAbbonamento" class="btn cancel">Annulla abbonamento</button>
  </div>

  <script>
    const supabase = window.supabase.createClient(
      'https://ldunvbftxhbtuyabgxwh.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkdW52YmZ0eGhidHV5YWJneHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0NTMyOTYsImV4cCI6MjA2MjAyOTI5Nn0.0hjJASFktfHZHjVQzX9bq8xGBrf7o1Fya6lqnA2tvPo' // la tua public anon key
    );

    let RESTAURANT_ID;

    document.addEventListener("DOMContentLoaded", async () => {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return window.location.href = "/login.html";
      RESTAURANT_ID = user.id;
      mostraPianoUtente();
    });

async function mostraPianoUtente() {
  const { data, error } = await supabase
    .from("ristoranti")
    .select("subscription_plan, subscription_status")
    .eq("id", RESTAURANT_ID)
    .single();

  if (error || !data) return;

  const { subscription_plan, subscription_status } = data;
  const base = document.getElementById("pianoBase");
  const pro = document.getElementById("pianoPro");

  if (subscription_status === "canceled") {
    document.getElementById("passaBase").style.display = "inline-block";
    document.getElementById("passaPro").style.display = "inline-block";
    return;
  }

  if (subscription_plan === "pro") {
    pro.classList.add("attivo");
    document.getElementById("passaBase").style.display = "inline-block";
  } else {
    base.classList.add("attivo");
    document.getElementById("passaPro").style.display = "inline-block";
  }
}

    document.getElementById("passaPro").addEventListener("click", () => {
      window.location.href = "/checkout.html?plan=pro";
    });

    document.getElementById("passaBase").addEventListener("click", () => {
      window.location.href = "/checkout.html?plan=base";
    });

document.getElementById("annullaAbbonamento").addEventListener("click", async () => {
  const confirmCancel = confirm("Sei sicuro di voler annullare l'abbonamento?");
  if (!confirmCancel) return;

  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return alert("Utente non trovato.");

  const res = await fetch("https://ldunvbftxhbtuyabgxwh.supabase.co/functions/v1/cancel-subscription", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id: user.id }) // invece di email
  });

  if (!res.ok) return alert("Errore durante l'annullamento su Stripe.");
  alert("Abbonamento annullato correttamente.");
  window.location.reload();
});
  </script>
</body>
</html>
