<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Carta dei Vini</title>
<style id="dynamic-style">
body { font-family: sans-serif; background: #fff9f4; color: #333; margin: 0; padding-top: 60px; }
nav { position: fixed; top: 0; left: 0; right: 0; background: #fff; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em; border-bottom: 1px solid #ddd; z-index: 1000; }
nav button { background: none; border: none; font-size: 1em; cursor: pointer; color: #b00; }
.category-list, .subcategory-list, .wine-list { padding: 1em; margin-top: 100px; }
.category, .wine-card { background: #fff; margin-bottom: 0.6em; padding: 1em; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; }
.subcategory-list { display: grid; grid-template-columns: 1fr 1fr; gap: 0.6em; }
.subcategory { background: #fff; padding: 1em; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; text-align: center; }
</style>
</head>
<body>

<nav>
  <button onclick="goBack()">â¬…</button>
  <span id="restaurantName"><strong>CARTA DEI VINI</strong></span>
  <button onclick="goToCategories()">Categorie</button>
</nav>

<div id="app">
  <div class="category-list" id="category-list"></div>
  <div class="subcategory-list" id="subcategory-list"></div>
  <div class="wine-list" id="wine-list"></div>
</div>

<script>
const SUPABASE_URL = "https://ldunvbftxhbtuyabgxwh.supabase.co";
const SUPABASE_API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkdW52YmZ0eGhidHV5YWJneHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0NTMyOTYsImV4cCI6MjA2MjAyOTI5Nn0.0hjJASFktfHZHjVQzX9bq8xGBrf7o1Fya6lqnA2tvPo";
const urlParams = new URLSearchParams(window.location.search);
const RESTAURANT_ID = urlParams.get("ristorante_id");

let wines = [];
let currentCategory = '';
let currentView = 'categories';

async function loadRestaurantData() {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/ristoranti?id=eq.${RESTAURANT_ID}`, {
    headers: { 'apikey': SUPABASE_API_KEY, 'Accept': 'application/json' }
  });
  const data = await res.json();
  const ristorante = data[0];

  if (ristorante) {
    document.getElementById("restaurantName").innerHTML = `<strong>${ristorante.nome || 'Carta dei Vini'}</strong>`;
    applyPalette(ristorante.palette_color);
  }
}

function applyPalette(palette) {
  let primary = "#b00";
  let background = "#fff9f4";
  let cardBackground = "#fff";

  if (palette === "oro") {
    primary = "#c9a64d";
    background = "#fff";
    cardBackground = "#fff8dc";
  } else if (palette === "scuro") {
    primary = "#fff";
    background = "#333";
    cardBackground = "#444";
  }

  document.body.style.backgroundColor = background;
  document.body.style.color = primary;

  document.querySelectorAll('nav button').forEach(btn => {
    btn.style.color = primary;
  });

  document.querySelectorAll('.category, .wine-card, .subcategory').forEach(card => {
    card.style.backgroundColor = cardBackground;
    card.style.color = primary;
  });
}

function normalize(str) {
  return str ? str.toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu, "").trim() : '';
}

function goToCategories() {
  currentView = 'categories';
  document.getElementById('category-list').style.display = 'block';
  document.getElementById('subcategory-list').style.display = 'none';
  document.getElementById('wine-list').style.display = 'none';
}

function goBack() {
  if (currentView === 'subcategory') goToCategories();
  else if (currentView === 'wines') showSubcategories(currentCategory);
  else goToCategories();
}

function showCategories() {
  const categories = [...new Set(wines.map(w => normalize(w.categoria)))];
  const container = document.getElementById('category-list');
  container.innerHTML = '';
  categories.forEach(cat => {
    const div = document.createElement('div');
    div.className = 'category';
    div.textContent = 'Vini ' + (cat.charAt(0).toUpperCase() + cat.slice(1));
    div.onclick = () => showSubcategories(cat);
    container.appendChild(div);
  });
}

function showSubcategories(category) {
  currentCategory = category;
  currentView = 'subcategory';
  const subcats = [...new Set(wines.filter(w => normalize(w.categoria) === category).map(w => normalize(w.sottocategoria)))];
  const container = document.getElementById('subcategory-list');
  container.innerHTML = '';
  subcats.forEach(sub => {
    const div = document.createElement('div');
    div.className = 'subcategory';
    div.textContent = sub.charAt(0).toUpperCase() + sub.slice(1);
    div.onclick = () => showWinesBySubcategory(sub);
    container.appendChild(div);
  });
  document.getElementById('category-list').style.display = 'none';
  container.style.display = 'grid';
  document.getElementById('wine-list').style.display = 'none';
}

function showWinesBySubcategory(subcat) {
  currentView = 'wines';
  const wineList = document.getElementById('wine-list');
  wineList.innerHTML = '';
  const filtered = wines.filter(w => normalize(w.categoria) === normalize(currentCategory) && normalize(w.sottocategoria) === normalize(subcat));
  filtered.forEach(w => {
    const card = document.createElement('div');
    card.className = 'wine-card';
    card.innerHTML = `<strong>${w.nome} (${w.annata})</strong><br><em>${w.prezzo}</em><br><small>Uvaggio: ${w.uvaggio}</small>`;
    wineList.appendChild(card);
  });
  document.getElementById('subcategory-list').style.display = 'none';
  wineList.style.display = 'block';
}

async function loadWineData() {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/wines?ristorante_id=eq.${RESTAURANT_ID}`, {
    headers: { 'apikey': SUPABASE_API_KEY, 'Accept': 'application/json' }
  });
  const json = await res.json();
  wines = Array.isArray(json) ? json : [];
  showCategories();
}

loadRestaurantData();
loadWineData();
</script>
</body>
</html>
