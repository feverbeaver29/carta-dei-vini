<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Carta dei Vini</title>
  <style>
    body { font-family: sans-serif; padding: 2em; text-align: center; }
    #loading { font-size: 1.2em; }
    #error { color: red; font-weight: bold; margin-top: 1em; }
  </style>
</head>
<body>
  <div id="loading">Caricamento carta dei vini...</div>
  <div id="error" style="display:none;"></div>

  <script>
    const SUPABASE_URL = "https://ldunvbftxhbtuyabgxwh.supabase.co";
    const SUPABASE_API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkdW52YmZ0eGhidHV5YWJneHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0NTMyOTYsImV4cCI6MjA2MjAyOTI5Nn0.0hjJASFktfHZHjVQzX9bq8xGBrf7o1Fya6lqnA2tvPo"; // ⚠️ Usa la chiave pubblica giusta qui

    async function start() {
      const params = new URLSearchParams(window.location.search);
      const slug = params.get("slug");
      if (!slug) return showError("Slug mancante nell'URL.");

      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/ristoranti?slug=eq.${slug}`, {
          headers: {
            apikey: SUPABASE_API_KEY,
            Accept: "application/json"
          }
        });

let data = await res.json();
if (!data.length) {
  // Proviamo a cercare per nome trasformato in slug
  const fallbackSlug = decodeURIComponent(slug).replace(/-/g, ' ').toLowerCase();

  const fallbackRes = await fetch(`${SUPABASE_URL}/rest/v1/ristoranti`, {
    headers: {
      apikey: SUPABASE_API_KEY,
      Accept: "application/json"
    }
  });
  const all = await fallbackRes.json();
  data = all.filter(r => (r.nome || '').toLowerCase() === fallbackSlug);
  if (!data.length) return showError("Ristorante non trovato.");
}

        const ristorante = data[0];
        const id = ristorante.id;
        window.location.href = `/carta.html?ristorante_id=${id}`;
      } catch (err) {
        showError("Errore durante il caricamento della carta.");
        console.error(err);
      }
    }

    function showError(msg) {
      document.getElementById("loading").style.display = "none";
      const errorDiv = document.getElementById("error");
      errorDiv.textContent = msg;
      errorDiv.style.display = "block";
    }

    start();
  </script>
</body>
</html>