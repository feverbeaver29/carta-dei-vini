<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Carta dei Vini</title>
<style id="dynamic-style">
body { font-family: sans-serif; background: #fff9f4; color: #333; margin: 0; padding-top: 60px; }
nav { position: fixed; top: 0; left: 0; right: 0; background: #fff; display: flex; justify-content: space-between; align-items: center; padding: 0.5em 1em; border-bottom: 1px solid #ddd; z-index: 1000; }
nav button { background: none; border: none; font-size: 1em; cursor: pointer; color: #b00; }
#restaurantName { display: flex; align-items: center; gap: 10px; font-size: 1.2em; }
#restaurantLogo { height: 32px; border-radius: 6px; }
.category-list, .subcategory-list, .wine-list { padding: 1em; margin-top: 100px; }
.category, .wine-card { background: #fff; margin-bottom: 0.6em; padding: 1em; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; }
.subcategory-list { display: grid; grid-template-columns: 1fr 1fr; gap: 0.6em; }
.subcategory { background: #fff; padding: 1em; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; text-align: center; }

/* Sommelier Styles */
#sommelierBtn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #b00;
  color: white;
  border: none;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  font-size: 1.5em;
  cursor: pointer;
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
}
#tooltipSommelier {
  position: fixed;
  bottom: 90px;
  right: 20px;
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 12px;
  padding: 10px 15px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  font-size: 0.9em;
  animation: tooltipSlide 3s ease-in-out;
  z-index: 999;
  display: none;
}
@keyframes tooltipSlide {
  0% { opacity: 0; transform: translateY(10px); }
  50% { opacity: 1; transform: translateY(0); }
  100% { opacity: 0; transform: translateY(-10px); }
}
#sommelierOverlay {
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.4);
  z-index: 1000;
  display: none;
  justify-content: center;
  align-items: center;
}
#sommelierPopup {
  background: #fff;
  border-radius: 16px;
  padding: 30px;
  width: 60vw;
  max-width: 500px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.2);
  position: relative;
  animation: fadeIn 0.3s ease-out;
}
#sommelierPopup h3 {
  margin-top: 0;
}
#sommelierPopup input {
  width: 100%;
  padding: 12px;
  font-size: 1em;
  border-radius: 8px;
  border: 1px solid #ccc;
  margin-top: 10px;
}
#sommelierPopup .close-btn {
  position: absolute;
  top: 10px;
  left: 10px;
  background: none;
  border: none;
  font-size: 1.2em;
  cursor: pointer;
}
@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}
</style>
</head>
<body>

<nav>
  <button onclick="goBack()">‚¨Ö</button>
  <span id="restaurantName"><strong>CARTA DEI VINI</strong></span>
  <button onclick="goToCategories()">Categorie</button>
</nav>

<div id="app">
  <div class="category-list" id="category-list"></div>
  <div class="subcategory-list" id="subcategory-list"></div>
  <div class="wine-list" id="wine-list"></div>
</div>

<!-- Sommelier UI -->
<button id="sommelierBtn">üç∑</button>
<div id="tooltipSommelier">Fatti dare una mano dal nostro sommelier artificiale</div>
<div id="sommelierOverlay">
  <div id="sommelierPopup">
    <button class="close-btn" onclick="closeSommelierPopup()">‚úñ</button>
    <h3>Dimmi che piatto hai scelto e io ti dir√≤ cosa bere!</h3>
    <input type="text" id="foodInput" placeholder="Es. Peposo, Risotto ai funghi..." onkeydown="handleSommelierKey(event)">
    <div id="wineSuggestion" style="margin-top: 15px; font-size: 0.95em;"></div>
  </div>
</div>

<script>
const SUPABASE_URL = "https://ldunvbftxhbtuyabgxwh.supabase.co";
const SUPABASE_API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkdW52YmZ0eGhidHV5YWJneHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0NTMyOTYsImV4cCI6MjA2MjAyOTI5Nn0.0hjJASFktfHZHjVQzX9bq8xGBrf7o1Fya6lqnA2tvPo";
const urlParams = new URLSearchParams(window.location.search);
const RESTAURANT_ID = urlParams.get("ristorante_id");

let wines = [];
let currentCategory = '';
let currentView = 'categories';

function toggleSommelier() {
  document.getElementById('sommelierOverlay').style.display = 'flex';
  document.getElementById('foodInput').focus();
}
function closeSommelierPopup() {
  document.getElementById('sommelierOverlay').style.display = 'none';
  document.getElementById('foodInput').value = '';
  document.getElementById('wineSuggestion').innerHTML = '';
}
function handleSommelierKey(e) {
  if (e.key === 'Enter') suggestWine();
}
function suggestWine() {
  const input = document.getElementById('foodInput').value.toLowerCase();
  const suggestion = document.getElementById('wineSuggestion');
  const matches = wines.filter(w => w.abbinamenti && w.abbinamenti.toLowerCase().includes(input));
  if (matches.length > 0) {
    suggestion.innerHTML = '<strong>Ti consigliamo:</strong><br>' + matches.map(w => `${w.nome} (${w.annata})`).join('<br>');
  } else {
    suggestion.innerText = "Nessun abbinamento trovato, prova con un altro piatto.";
  }
}
setTimeout(() => {
  const tip = document.getElementById('tooltipSommelier');
  tip.style.display = 'block';
  setTimeout(() => tip.style.display = 'none', 3000);
}, 1000);

document.getElementById('sommelierBtn').onclick = toggleSommelier;
window.addEventListener('click', e => {
  const overlay = document.getElementById('sommelierOverlay');
  if (e.target === overlay) closeSommelierPopup();
});

async function loadRestaurantData() {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/ristoranti?id=eq.${RESTAURANT_ID}`, {
    headers: { 'apikey': SUPABASE_API_KEY, 'Accept': 'application/json' }
  });
  const data = await res.json();
  const ristorante = data[0];

  if (ristorante) {
    const nameElem = document.getElementById("restaurantName");
    nameElem.innerHTML = '';
    if (ristorante.logo_url) {
      const img = document.createElement('img');
      img.src = ristorante.logo_url;
      img.alt = ristorante.nome;
      img.id = "restaurantLogo";
      nameElem.appendChild(img);
    }
    const span = document.createElement('span');
    span.textContent = ristorante.nome || 'Carta dei Vini';
    span.style.fontFamily = ristorante.font || 'sans-serif';
    nameElem.appendChild(span);
    applyPalette(ristorante.palette_color);
  }
}

function applyPalette(palette) {
  let primary = palette || "#b00";
  let background = "#fff9f4";
  let cardBackground = "#fff";

  document.body.style.backgroundColor = background;
  document.body.style.color = primary;

  document.querySelectorAll('nav button').forEach(btn => {
    btn.style.color = primary;
  });

  document.querySelectorAll('.category, .wine-card, .subcategory').forEach(card => {
    card.style.backgroundColor = cardBackground;
    card.style.color = primary;
  });
}

function normalize(str) {
  return str ? str.toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu, "").trim() : '';
}

function goToCategories() {
  currentView = 'categories';
  document.getElementById('category-list').style.display = 'block';
  document.getElementById('subcategory-list').style.display = 'none';
  document.getElementById('wine-list').style.display = 'none';
}

function goBack() {
  if (currentView === 'subcategory') goToCategories();
  else if (currentView === 'wines') showSubcategories(currentCategory);
  else goToCategories();
}

function showCategories() {
  const categories = [...new Set(wines.map(w => normalize(w.categoria)))];
  const container = document.getElementById('category-list');
  container.innerHTML = '';
  categories.forEach(cat => {
    const div = document.createElement('div');
    div.className = 'category';
    div.textContent = 'Vini ' + (cat.charAt(0).toUpperCase() + cat.slice(1));
    div.onclick = () => showSubcategories(cat);
    container.appendChild(div);
  });
}

function showSubcategories(category) {
  currentCategory = category;
  currentView = 'subcategory';
  const subcats = [...new Set(wines.filter(w => normalize(w.categoria) === category).map(w => normalize(w.sottocategoria)))];
  const container = document.getElementById('subcategory-list');
  container.innerHTML = '';
  subcats.forEach(sub => {
    const div = document.createElement('div');
    div.className = 'subcategory';
    div.textContent = sub.charAt(0).toUpperCase() + sub.slice(1);
    div.onclick = () => showWinesBySubcategory(sub);
    container.appendChild(div);
  });
  document.getElementById('category-list').style.display = 'none';
  container.style.display = 'grid';
  document.getElementById('wine-list').style.display = 'none';
}

function showWinesBySubcategory(subcat) {
  currentView = 'wines';
  const wineList = document.getElementById('wine-list');
  wineList.innerHTML = '';
  const filtered = wines.filter(w => normalize(w.categoria) === normalize(currentCategory) && normalize(w.sottocategoria) === normalize(subcat));
  filtered.forEach(w => {
    const card = document.createElement('div');
    card.className = 'wine-card';
    card.innerHTML = `<strong>${w.nome} (${w.annata})</strong><br><em>${w.prezzo}</em><br><small>Uvaggio: ${w.uvaggio}</small>`;
    wineList.appendChild(card);
  });
  document.getElementById('subcategory-list').style.display = 'none';
  wineList.style.display = 'block';
}

async function loadWineData() {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/wines?ristorante_id=eq.${RESTAURANT_ID}`, {
    headers: { 'apikey': SUPABASE_API_KEY, 'Accept': 'application/json' }
  });
  const json = await res.json();
  wines = Array.isArray(json) ? json : [];
  showCategories();
}

loadRestaurantData();
loadWineData();
</script>
</body>
</html>
